<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Employee Dashboard - Assixx</title>

    <!-- Critical Layout State - Prevents Layout Shift -->
    <script src="/scripts/critical/sidebar-init.js"></script>

    <!-- CSS Styles -->
    <link id="unified-navigation-styles" rel="stylesheet" href="/styles/unified-navigation.css" />
    <link rel="stylesheet" href="/styles/lib/fontawesome.min.css" />
    <link rel="stylesheet" href="/styles/breadcrumb-alignment.css" />
    <link rel="stylesheet" href="/styles/employee-dashboard.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="/styles/user-info-update.css" />
    <link rel="stylesheet" href="/styles/blackboard-widget.css" />

    <!-- Common Scripts with ApiClient -->
    <script type="module" src="/scripts/common.js"></script>
    <!-- Employee Dashboard TypeScript Module -->
    <script type="module" src="/scripts/dashboard/employee.ts"></script>
  </head>
  <body>
    <!-- Unified Navigation -->
    <div id="navigation-container"></div>

    <!-- Main Layout mit Sidebar -->
    <div class="layout-container">
      <!-- Main Content -->
      <main class="main-content">
        <!-- Breadcrumb Navigation -->
        <div id="breadcrumb-container"></div>

        <div class="container">
          <!-- Welcome Hero Section -->
          <div class="welcome-hero">
            <div class="floating-elements">
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
              <div class="floating-dot"></div>
            </div>

            <div class="welcome-content">
              <p class="welcome-title">Willkommen zurÃ¼ck!</p>
              <p class="welcome-subtitle">
                SchÃ¶n, dass Sie da sind,
                <span id="employee-name" class="pulse">Mitarbeiter</span>
              </p>
            </div>

            <div class="welcome-stats">
              <div class="welcome-stat">
                <span class="welcome-stat-number" id="hero-documents">12</span>
                <span class="welcome-stat-label">Dokumente</span>
              </div>
              <div class="welcome-stat">
                <span class="welcome-stat-number" id="hero-points">125</span>
                <span class="welcome-stat-label">KVP Punkte</span>
              </div>
              <div class="welcome-stat">
                <span class="welcome-stat-number" id="hero-alerts">3</span>
                <span class="welcome-stat-label">Neu</span>
              </div>
            </div>
          </div>

          <!-- Employee Info Grid -->
          <div class="info-grid">
            <div class="info-card">
              <div class="info-label">Abteilung</div>
              <div class="info-value" id="employee-department">-</div>
            </div>
            <div class="info-card">
              <div class="info-label">Team</div>
              <div class="info-value" id="employee-team">-</div>
            </div>
            <div class="info-card">
              <div class="info-label">Position</div>
              <div class="info-value" id="employee-position">Mitarbeiter</div>
            </div>
            <div class="info-card">
              <div class="info-label">Dokumente</div>
              <div class="info-value" id="document-count">-</div>
            </div>
          </div>

          <!-- Blackboard Widget -->
          <div id="blackboard-widget-container" style="margin-top: 2rem" data-sidebar-state="loading">
            <!-- Loading placeholder with same styles as final widget -->
            <div class="blackboard-widget" style="animation: subtle-pulse 2s ease-in-out infinite">
              <div class="blackboard-widget-header">
                <h3 class="blackboard-widget-title">
                  <i class="fas fa-thumbtack"></i>
                  Schwarzes Brett
                </h3>
                <a href="/blackboard" class="blackboard-widget-link" style="opacity: 0.5">
                  Alle anzeigen
                  <i class="fas fa-arrow-right"></i>
                </a>
              </div>
              <div id="blackboard-widget-content" style="min-height: 200px; display: flex; align-items: center; justify-content: center">
                <div class="text-muted" style="text-align: center">
                  <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem"></i>
                  <p>Lade EintrÃ¤ge...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Access Features -->
          <div class="dashboard-grid">
            <!-- Documents Card -->
            <div class="feature-card" data-action="navigate" data-href="/documents">
              <div class="feature-icon">ðŸ“„</div>
              <h3 class="feature-title">Meine Dokumente</h3>
              <p class="feature-description">Zugriff auf Lohnabrechnungen, Bescheinigungen und wichtige Dokumente</p>
              <span class="feature-badge" id="new-documents-badge">Neue verfÃ¼gbar</span>
            </div>

            <!-- Calendar Card -->
            <div class="feature-card" data-action="navigate" data-href="/calendar">
              <div class="feature-icon">ðŸ“…</div>
              <h3 class="feature-title">Firmenkalender</h3>
              <p class="feature-description">Termine, Events und wichtige Firmentermine im Ãœberblick</p>
              <span class="feature-badge">Immer aktuell</span>
            </div>

            <!-- KVP Card -->
            <div class="feature-card" data-action="navigate" data-href="/kvp">
              <div class="feature-icon">ðŸ’¡</div>
              <h3 class="feature-title">VerbesserungsvorschlÃ¤ge</h3>
              <p class="feature-description">Teilen Sie Ihre Ideen zur Verbesserung der ArbeitsablÃ¤ufe</p>
              <span class="feature-badge">Belohnung mÃ¶glich</span>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      let currentUser = null;

      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function () {
        checkAuth();
        loadDashboardData();
      });

      function parseToken(token) {
        try {
          return JSON.parse(atob(token.split('.')[1]));
        } catch (e) {
          return null;
        }
      }

      function isEmployeeAccess(payload) {
        if (payload.role === 'employee') {
          return true;
        }

        const isAdminAsEmployee = payload.role === 'admin' && payload.activeRole === 'employee';
        const isRootAsEmployee = payload.role === 'root' && payload.activeRole === 'employee';

        return isAdminAsEmployee || isRootAsEmployee;
      }

      function getRedirectUrl(role) {
        switch (role) {
          case 'admin':
            return '/admin-dashboard';
          case 'root':
            return '/root-dashboard';
          default:
            return '/login';
        }
      }

      function checkAuth() {
        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = '/login';
          return;
        }

        const payload = parseToken(token);
        if (!payload) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }

        currentUser = payload;

        // Update welcome message
        const nameElement = document.querySelector('#employee-name');
        if (nameElement) {
          nameElement.textContent = `${payload.first_name || payload.username}`;
        }

        // Check access rights
        if (!isEmployeeAccess(payload)) {
          console.info('[Employee Dashboard Auth] Redirecting - not authorized');
          window.location.href = getRedirectUrl(payload.role);
        }
      }

      async function loadDashboardData() {
        try {
          // Load employee profile data
          await loadEmployeeProfile();

          // Load document count
          await loadDocumentCount();
        } catch (error) {
          console.error('Error loading dashboard data:', error);
        }
      }

      async function loadEmployeeProfile() {
        try {
          const user = await apiClient.get('/users/me');

          const deptElement = document.querySelector('#employee-department');
          if (deptElement) {
            deptElement.textContent = user.departmentName || 'Nicht zugewiesen';
          }

          const teamElement = document.querySelector('#employee-team');
          if (teamElement) {
            teamElement.textContent = user.teamName || user.team_name || 'Kein Team';
          }

          const posElement = document.querySelector('#employee-position');
          if (posElement) {
            posElement.textContent = user.position || 'Mitarbeiter';
          }
        } catch (error) {
          console.error('Error loading profile:', error);
        }
      }

      async function loadDocumentCount() {
        try {
          // This would be an API call to get document count
          document.querySelector('#document-count').textContent = '12';

          // Update badge visibility
          const newDocsCount = 3;
          const badge = document.querySelector('#new-documents-badge');
          if (badge && newDocsCount > 0) {
            badge.textContent = `${newDocsCount} neue`;
            badge.style.display = 'inline-block';
          } else if (badge) {
            badge.style.display = 'none';
          }
        } catch (error) {
          console.error('Error loading document count:', error);
        }
      }

      // Event delegation for navigation
      document.addEventListener('click', function (e) {
        const target = e.target.closest('[data-action]');
        if (target) {
          const action = target.dataset.action;

          if (action === 'navigate') {
            const href = target.dataset.href;
            if (href) {
              window.location.href = href;
            }
          }
        }
      });
    </script>

    <!-- JavaScript Modules -->
    <!-- Unified Navigation -->
    <script type="module" src="/scripts/components/unified-navigation.ts"></script>
    <script type="module" src="/scripts/auth/role-switch.ts"></script>

    <!-- Force dashboard to be active on page load -->
    <script type="module">
      import { SessionManager } from '/scripts/utils/session-manager.ts';

      const session = SessionManager.getInstance();
      session.validateDashboardAccess('employee');

      document.addEventListener('DOMContentLoaded', () => {
        // Clear any stored active navigation to ensure dashboard is selected
        localStorage.removeItem('activeNavigation');
      });
    </script>

    <!-- Breadcrumb Component -->
    <script type="module">
      import { initBreadcrumb } from '/scripts/components/breadcrumb.js';
      // Breadcrumb wird automatisch generiert basierend auf der URL
      initBreadcrumb();
    </script>

    <!-- Blackboard Widget Script -->
    <script src="/scripts/blackboard/widget.js"></script>
  </body>
</html>
