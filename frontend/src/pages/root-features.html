<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Plan & Feature Management - Assixx</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- Critical Layout State - Prevents Layout Shift -->
    <script>
      // Set sidebar state IMMEDIATELY to prevent any layout shift
      (function () {
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        document.documentElement.setAttribute('data-sidebar', sidebarCollapsed ? 'collapsed' : 'expanded');
        // Also set CSS custom properties for immediate use
        document.documentElement.style.setProperty('--sidebar-width', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--content-margin', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--grid-columns', sidebarCollapsed ? '4' : '3');
        document.documentElement.style.setProperty('--widget-columns', sidebarCollapsed ? '5' : '3');
        document.documentElement.style.setProperty('--card-padding', sidebarCollapsed ? '2rem' : '1.5rem');
      })();
    </script>
    <script src="/feature-flags.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="/styles/user-info-update.css" />
    <link rel="stylesheet" href="/styles/breadcrumb-alignment.css" />
    <style>
      @import url('/styles/dashboard-theme.css');

      /* Global Box Sizing */
      * {
        box-sizing: border-box;
      }

      /* Dramatischer Hintergrund-Gradient */
      body {
        position: relative;
        min-height: 100vh;
        overflow-x: hidden;
        background: #000;
        margin: 0;
        padding: 0;
      }

      body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(5deg, transparent, rgba(0, 142, 255, 0.1) 100%, #01000482 0, rgba(0, 0, 4, 0.6) 100%, #000);
        pointer-events: none;
        z-index: -1;
      }

      /* Header wird von unified-navigation gehandelt */

      /* Layout Container - Standard Assixx Layout */
      .layout-container {
        display: flex;
        min-height: 100vh;
      }

      /* Container Styles */
      .container {
        padding: 24px;
        margin-top: -25px !important; /* Align first container with sidebar user-info-card */
      }

      /* Mobile responsiv */
      @media (max-width: 768px) {
        .layout-container {
          flex-direction: column;
        }
      }

      /* Plan Selection Header */
      .plan-header {
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 32px;
        margin-bottom: 32px;
        box-shadow: var(--shadow-sm);
        width: 100%;
        box-sizing: border-box;
        backdrop-filter: blur(20px) saturate(180%);
        background: hsla(0, 0%, 100%, 0.02);
      }

      .current-plan-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .plan-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
      }

      .plan-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: var(--accent-gradient);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
      }

      .plan-badge.enterprise {
        background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05));
        border-color: rgba(255, 215, 0, 0.3);
        color: #ffd700;
      }

      /* Plan Selection Cards */
      .plan-selection {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 24px;
      }

      .plan-card {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 24px;
        position: relative;

        cursor: pointer;
      }

      .plan-card:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
      }

      .plan-card.current {
        border-color: var(--primary-color);
        background: rgba(33, 150, 243, 0.1);
      }

      .plan-card.recommended {
        border-color: rgba(255, 215, 0, 0.5);
      }

      .plan-card.recommended::before {
        content: 'EMPFOHLEN';
        position: absolute;
        top: -12px;
        right: 20px;
        background: linear-gradient(135deg, #ffd700, #ffed4e);
        color: #000;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 700;
      }

      .plan-name {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
      }

      .plan-price {
        font-size: 36px;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 4px;
      }

      .plan-price small {
        font-size: 16px;
        color: var(--text-secondary);
        font-weight: 400;
      }

      .plan-description {
        color: var(--text-secondary);
        font-size: 14px;
        margin-bottom: 20px;
        opacity: 0.8;
      }

      .plan-limits {
        display: flex;
        gap: 16px;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .limit-item {
        flex: 1;
        text-align: center;
      }

      .limit-value {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
        display: block;
      }

      .limit-label {
        font-size: 12px;
        color: var(--text-secondary);
        opacity: 0.7;
      }

      .plan-features {
        margin-bottom: 20px;
      }

      .plan-feature {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        font-size: 14px;
        color: var(--text-secondary);
      }

      .plan-feature.included {
        color: var(--text-primary);
      }

      .plan-feature i {
        width: 16px;
        color: var(--success-color);
      }

      .plan-action {
        width: 100%;
        padding: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
        color: var(--text-primary);
        font-weight: 500;
        cursor: pointer;
      }

      .plan-action:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--primary-color);
      }

      .plan-action.current {
        background: var(--primary-color);
        border-color: var(--primary-color);
        cursor: default;
      }

      /* Features Section */
      .features-section {
        margin-top: 48px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .section-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-primary);
      }

      .feature-filters {
        display: flex;
        gap: 12px;
      }

      .filter-btn {
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        color: var(--text-secondary);
        font-size: 14px;
        cursor: pointer;
      }

      .filter-btn:hover,
      .filter-btn.active {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--primary-color);
        color: var(--primary-color);
      }

      /* Feature Categories */
      .feature-category {
        margin-bottom: 32px;
      }

      .category-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }

      .category-icon {
        font-size: 24px;
      }

      .category-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
      }

      .feature-card {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 24px;
        position: relative;
      }

      .feature-card:hover {
        background: rgba(255, 255, 255, 0.04);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      }

      .feature-card.active {
        border-color: var(--success-color);
        background: rgba(76, 175, 80, 0.1);
      }

      .feature-card.locked {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .feature-status {
        position: absolute;
        top: 12px;
        right: 12px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
      }

      .status-active {
        background: rgba(76, 175, 80, 0.2);
        color: var(--success-color);
      }

      .status-inactive {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-secondary);
      }

      .status-locked {
        background: rgba(255, 152, 0, 0.2);
        color: var(--warning-color);
      }

      .feature-name {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
      }

      .feature-description {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 12px;
        opacity: 0.8;
      }

      .feature-plan-badge {
        display: inline-block;
        padding: 4px 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 16px;
      }

      .feature-actions {
        display: flex;
        gap: 8px;
      }

      /* Feature-spezifische Buttons - nur innerhalb von Features */
      .feature-actions .btn {
        flex: 1;
        padding: 8px 16px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.02);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;

        text-align: center;
      }

      .feature-actions .btn:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.3);
      }

      .btn-activate {
        background: var(--primary-color);
        border-color: var(--primary-color);
      }

      .btn-activate:hover {
        background: var(--primary-dark);
      }

      .btn-deactivate {
        background: rgba(244, 67, 54, 0.2);
        border-color: var(--error-color);
        color: var(--error-color);
      }

      .btn-deactivate:hover {
        background: rgba(244, 67, 54, 0.3);
      }

      .feature-actions .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Add-ons Section */
      .addons-section {
        margin-top: 48px;
        margin-bottom: 100px; /* Platz f√ºr Summary Bar */
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 32px;
      }

      .addons-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }

      .addon-card {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 24px;
        text-align: center;
      }

      .addon-icon {
        font-size: 32px;
        margin-bottom: 12px;
      }

      .addon-name {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
      }

      .addon-price {
        font-size: 20px;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 4px;
      }

      .addon-unit {
        font-size: 12px;
        color: var(--text-secondary);
        opacity: 0.7;
      }

      .addon-current {
        margin: 12px 0;
        font-size: 14px;
        color: var(--text-secondary);
      }

      .addon-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
      }

      .addon-btn {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        color: var(--text-primary);
        cursor: pointer;
      }

      .addon-btn:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: var(--primary-color);
      }

      .addon-value {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        min-width: 40px;
        text-align: center;
      }

      /* Summary Bar - angepasst f√ºr Standard-Layout */
      .summary-bar {
        backdrop-filter: blur(20px);
        border-top: 1px solid hsla(0, 0%, 100%, 0.1);
        bottom: 0;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        left: var(--sidebar-width, 250px);
        padding: 12px 24px;
        position: fixed;
        right: 0;
        z-index: 900;
        transition: left 0.3s ease;
      }

      /* Mobile responsiv */
      @media (max-width: 768px) {
        .summary-bar {
          left: 0;
        }
      }

      .summary-content {
        max-width: 100%;
        margin: 0;
        padding: 0 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .summary-items {
        display: flex;
        gap: 32px;
      }

      .summary-item {
        display: flex;
        flex-direction: column;
      }

      .summary-label {
        font-size: 11px;
        color: var(--text-secondary);
        opacity: 0.7;
      }

      .summary-value {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-primary);
      }

      .summary-actions {
        display: flex;
        gap: 12px;
      }

      .btn-save {
        padding: 8px 24px;
        background: var(--primary-color);
        border: none;
        border-radius: var(--radius-md);
        color: #fff;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
      }

      .btn-save:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
      }
    </style>
    <!-- DOMPurify CDN f√ºr inline Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.7/purify.min.js"></script>
  </head>
  <body>
    <!-- Unified Navigation -->
    <div id="navigation-container"></div>

    <!-- Layout Container -->
    <div class="layout-container">
      <!-- Main Content -->
      <main class="main-content">
        <!-- Breadcrumb Navigation -->
        <div id="breadcrumb-container"></div>

        <div class="container">
          <!-- Current Plan Header -->
          <div class="plan-header">
            <div class="current-plan-info">
              <div>
                <p class="plan-title">Plan & Feature Management</p>
                <p style="color: var(--text-secondary); margin-top: 8px">
                  Verwalten Sie Ihren Plan und aktivieren Sie Features f√ºr
                  <strong id="tenant-name">Ihre Organisation</strong>
                </p>
              </div>
              <div class="plan-badge enterprise">
                <i class="fas fa-crown"></i>
                <span>Enterprise Plan</span>
              </div>
            </div>

            <!-- Plan Selection -->
            <div class="plan-selection">
              <!-- Basic Plan -->
              <div class="plan-card" data-plan="basic">
                <h3 class="plan-name">Basic</h3>
                <div class="plan-price">
                  49‚Ç¨
                  <small>/Monat</small>
                </div>
                <p class="plan-description">Perfekt f√ºr kleine Teams und Startups</p>

                <div class="plan-limits">
                  <div class="limit-item">
                    <span class="limit-value">10</span>
                    <span class="limit-label">Mitarbeiter</span>
                  </div>
                  <div class="limit-item">
                    <span class="limit-value">1</span>
                    <span class="limit-label">Admin</span>
                  </div>
                </div>

                <div class="plan-features">
                  <div class="plan-feature included">
                    <i class="fas fa-check"></i>
                    <span>Mitarbeiterverwaltung</span>
                  </div>
                  <div class="plan-feature included">
                    <i class="fas fa-check"></i>
                    <span>Dokumentenverwaltung</span>
                  </div>
                  <div class="plan-feature included">
                    <i class="fas fa-check"></i>
                    <span>E-Mail Benachrichtigungen</span>
                  </div>
                  <div class="plan-feature">
                    <i class="fas fa-times" style="color: var(--text-secondary); opacity: 0.5"></i>
                    <span style="opacity: 0.5">Erweiterte Features</span>
                  </div>
                </div>

                <button class="plan-action">Zu Basic wechseln</button>
              </div>

              <!-- Professional Plan -->
              <div class="plan-card recommended" data-plan="professional">
                <h3 class="plan-name">Professional</h3>
                <div class="plan-price">
                  149‚Ç¨
                  <small>/Monat</small>
                </div>
                <p class="plan-description">F√ºr wachsende Unternehmen</p>

                <div class="plan-limits">
                  <div class="limit-item">
                    <span class="limit-value">50</span>
                    <span class="limit-label">Mitarbeiter</span>
                  </div>
                  <div class="limit-item">
                    <span class="limit-value">3</span>
                    <span class="limit-label">Admins</span>
                  </div>
                </div>

                <div class="plan-features">
                  <div class="plan-feature included">
                    <i class="fas fa-check"></i>
                    <span>Alle Basic Features</span>
                  </div>
                  <div class="plan-feature included">
                    <i class="fas fa-check"></i>
                    <span>Schwarzes Brett & Chat</span>
                  </div>
                  <div class="plan-feature included">
                    <i class="fas fa-check"></i>
                    <span>Kalender & Teams</span>
                  </div>
                  <div class="plan-feature included">
                    <i class="fas fa-check"></i>
                    <span>Erweiterte Berichte</span>
                  </div>
                </div>

                <button class="plan-action">Zu Professional wechseln</button>
              </div>

              <!-- Enterprise Plan -->
              <div class="plan-card current" data-plan="enterprise">
                <h3 class="plan-name">Enterprise</h3>
                <div class="plan-price">
                  299‚Ç¨
                  <small>/Monat</small>
                </div>
                <p class="plan-description">F√ºr gro√üe Organisationen</p>

                <div class="plan-limits">
                  <div class="limit-item">
                    <span class="limit-value">‚àû</span>
                    <span class="limit-label">Mitarbeiter</span>
                  </div>
                  <div class="limit-item">
                    <span class="limit-value">‚àû</span>
                    <span class="limit-label">Admins</span>
                  </div>
                </div>

                <div class="plan-features">
                  <div class="plan-feature included">
                    <i class="fas fa-check"></i>
                    <span>Alle Professional Features</span>
                  </div>
                  <div class="plan-feature included">
                    <i class="fas fa-check"></i>
                    <span>Schichtplanung & KVP</span>
                  </div>
                  <div class="plan-feature included">
                    <i class="fas fa-check"></i>
                    <span>API Zugang & Automation</span>
                  </div>
                  <div class="plan-feature included">
                    <i class="fas fa-check"></i>
                    <span>Priority Support</span>
                  </div>
                </div>

                <button class="plan-action current">Aktueller Plan</button>
              </div>
            </div>
          </div>

          <!-- Features Section -->
          <div class="features-section">
            <div class="section-header">
              <h2 class="section-title">Verf√ºgbare Features</h2>
              <div class="feature-filters">
                <button class="filter-btn active" data-filter="all">Alle</button>
                <button class="filter-btn" data-filter="active">Aktiv</button>
                <button class="filter-btn" data-filter="included">Im Plan enthalten</button>
                <button class="filter-btn" data-filter="addons">Zus√§tzlich buchbar</button>
              </div>
            </div>

            <div id="features-container">
              <!-- Features werden hier dynamisch geladen -->
            </div>
          </div>

          <!-- Add-ons Section -->
          <div class="addons-section">
            <h2 class="section-title">Zus√§tzliche Ressourcen</h2>
            <p style="color: var(--text-secondary); margin-bottom: 20px">Erweitern Sie Ihre Kapazit√§ten nach Bedarf</p>

            <div class="addons-grid">
              <!-- Zus√§tzliche Mitarbeiter -->
              <div class="addon-card">
                <div class="addon-icon">üë•</div>
                <h3 class="addon-name">Zus√§tzliche Mitarbeiter</h3>
                <div class="addon-price">5‚Ç¨</div>
                <div class="addon-unit">pro Mitarbeiter/Monat</div>
                <div class="addon-current">
                  Aktuell:
                  <strong>0</strong>
                  zus√§tzlich
                </div>
                <div class="addon-controls">
                  <button class="addon-btn" onclick="adjustAddon('employees', -1)">
                    <i class="fas fa-minus"></i>
                  </button>
                  <span class="addon-value" id="addon-employees">0</span>
                  <button class="addon-btn" onclick="adjustAddon('employees', 1)">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>

              <!-- Zus√§tzliche Admins -->
              <div class="addon-card">
                <div class="addon-icon">üëî</div>
                <h3 class="addon-name">Zus√§tzliche Admins</h3>
                <div class="addon-price">10‚Ç¨</div>
                <div class="addon-unit">pro Admin/Monat</div>
                <div class="addon-current">
                  Aktuell:
                  <strong>0</strong>
                  zus√§tzlich
                </div>
                <div class="addon-controls">
                  <button class="addon-btn" onclick="adjustAddon('admins', -1)">
                    <i class="fas fa-minus"></i>
                  </button>
                  <span class="addon-value" id="addon-admins">0</span>
                  <button class="addon-btn" onclick="adjustAddon('admins', 1)">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>

              <!-- Zus√§tzlicher Speicher -->
              <div class="addon-card">
                <div class="addon-icon">üíæ</div>
                <h3 class="addon-name">Zus√§tzlicher Speicher</h3>
                <div class="addon-price">10‚Ç¨</div>
                <div class="addon-unit">pro 100GB/Monat</div>
                <div class="addon-current">
                  Aktuell:
                  <strong>100GB</strong>
                  inklusive
                </div>
                <div class="addon-controls">
                  <button class="addon-btn" onclick="adjustAddon('storage', -100)">
                    <i class="fas fa-minus"></i>
                  </button>
                  <span class="addon-value" id="addon-storage">0</span>
                  <button class="addon-btn" onclick="adjustAddon('storage', 100)">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- End of container -->

        <!-- Summary Bar -->
        <div class="summary-bar">
          <div class="summary-content">
            <div class="summary-items">
              <div class="summary-item">
                <span class="summary-label">Aktueller Plan</span>
                <span class="summary-value" id="summary-plan">Enterprise</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Aktive Features</span>
                <span class="summary-value" id="summary-features">9 / 9</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Monatliche Kosten</span>
                <span class="summary-value" id="summary-cost">299,00‚Ç¨</span>
              </div>
            </div>
            <div class="summary-actions">
              <button class="btn-save" onclick="saveChanges()">
                <i class="fas fa-save"></i>
                √Ñnderungen speichern
              </button>
            </div>
          </div>
        </div>
      </main>
    </div>
    <!-- End main-content -->

    <!-- Font Awesome -->
    <!-- Font Awesome already loaded in head - removed duplicate -->

    <!-- Scripts -->
    <script type="module" src="/scripts/components/unified-navigation.ts"></script>
    <script type="module" src="/scripts/role-switch.ts"></script>
    <script>
      // Plan data will be loaded from API
      let plans = {
        basic: {
          id: 1,
          name: 'Basic',
          price: 49.0,
          maxEmployees: 10,
          maxAdmins: 1,
          features: ['basic_employees', 'document_upload'],
        },
        professional: {
          id: 2,
          name: 'Professional',
          price: 149.0,
          maxEmployees: 50,
          maxAdmins: 3,
          features: ['basic_employees', 'document_upload', 'blackboard', 'chat', 'calendar'],
        },
        enterprise: {
          id: 3,
          name: 'Enterprise',
          price: 299.0,
          maxEmployees: Infinity,
          maxAdmins: Infinity,
          features: ['all'],
        },
      };
      let allPlans = [];

      const featureCategories = {
        'Kern-Features': {
          icon: '‚öôÔ∏è',
          features: [
            {
              code: 'basic_employees',
              name: 'Mitarbeiterverwaltung',
              description: 'Verwalten Sie Ihre Mitarbeiter effizient',
              minPlan: 'basic',
              active: true,
            },
            {
              code: 'document_upload',
              name: 'Dokumentenverwaltung',
              description: 'Zentrale Ablage f√ºr alle Dokumente',
              minPlan: 'basic',
              active: true,
            },
          ],
        },
        Kommunikation: {
          icon: 'üí¨',
          features: [
            {
              code: 'blackboard',
              name: 'Schwarzes Brett',
              description: 'Unternehmensweite Ank√ºndigungen',
              minPlan: 'professional',
              active: true,
            },
            {
              code: 'chat',
              name: 'Chat System',
              description: 'Echtzeit-Kommunikation im Team',
              minPlan: 'professional',
              active: true,
            },
            {
              code: 'surveys',
              name: 'Umfragen',
              description: 'Mitarbeiterfeedback sammeln',
              minPlan: 'enterprise',
              active: true,
            },
          ],
        },
        Organisation: {
          icon: 'üìä',
          features: [
            {
              code: 'calendar',
              name: 'Firmenkalender',
              description: 'Termine und Events verwalten',
              minPlan: 'professional',
              active: true,
            },
            {
              code: 'shift_planning',
              name: 'Schichtplanung',
              description: 'Automatisierte Schichtpl√§ne',
              minPlan: 'enterprise',
              active: true,
            },
            {
              code: 'kvp',
              name: 'KVP System',
              description: 'Kontinuierliche Verbesserung',
              minPlan: 'enterprise',
              active: false,
            },
          ],
        },
      };

      let currentPlan = null;
      const currentTenant = null;
      const activeFeatures = [];
      let tenantAddons = {};
      let currentTenantId = null;
      const token = localStorage.getItem('token');

      // Decode JWT to get tenant ID
      function parseJwt(token) {
        try {
          return JSON.parse(atob(token.split('.')[1]));
        } catch (e) {
          return null;
        }
      }

      // Get tenant ID from token
      if (token) {
        const decoded = parseJwt(token);
        if (decoded && decoded.tenant_id) {
          currentTenantId = decoded.tenant_id;
        }
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', async () => {
        if (!token) {
          window.location.href = '/login';
          return;
        }

        await loadInitialData();

        // Plan selection
        document.querySelectorAll('.plan-card').forEach((card) => {
          card.addEventListener('click', () => selectPlan(card.dataset.plan));
        });

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.filter-btn').forEach((b) => b.classList.remove('active'));
            btn.classList.add('active');
            filterFeatures(btn.dataset.filter);
          });
        });
      });

      // Load all initial data
      async function loadInitialData() {
        try {
          // Load available plans - using simple route for now
          const plansResponse = await fetch('/api/plans/simple', {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!plansResponse.ok) {
            console.error('Failed to load plans:', plansResponse.status);
            throw new Error('Failed to load plans');
          }

          const plansData = await plansResponse.json();
          console.info('Loaded plans response:', plansData);

          // Extract the data array from the response
          allPlans = plansData.data || plansData;

          // Check if response is an array
          if (!Array.isArray(allPlans)) {
            console.error('Plans response is not an array:', allPlans);
            throw new Error('Invalid plans response');
          }

          // Convert to object format for compatibility, keeping defaults if load fails
          const loadedPlans = {};
          allPlans.forEach((plan) => {
            loadedPlans[plan.code] = {
              id: plan.id,
              name: plan.name,
              price: plan.base_price,
              maxEmployees: plan.max_employees || Infinity,
              maxAdmins: plan.max_admins || Infinity,
              features: plan.features.map((f) => f.feature_code),
            };
          });

          // Only replace plans if we got valid data
          if (Object.keys(loadedPlans).length > 0) {
            plans = loadedPlans;
          }

          // Load current tenant plan
          const currentPlanResponse = await fetch('/api/plans/current', {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (!currentPlanResponse.ok) {
            console.error('Failed to load current plan:', currentPlanResponse.status);
            // Fallback to basic plan if no plan found
            currentPlan = 'basic';
            tenantAddons = {};
          } else {
            const currentPlanData = await currentPlanResponse.json();
            console.info('Current plan data:', currentPlanData);

            if (currentPlanData.plan && currentPlanData.plan.plan_code) {
              currentPlan = currentPlanData.plan.plan_code;
              // Handle trial status by mapping to actual plan
              if (currentPlan === 'trial' || currentPlanData.plan.status === 'trial') {
                // Get actual plan from plan_id
                const planId = currentPlanData.plan.plan_id;
                if (planId === 1) currentPlan = 'basic';
                else if (planId === 2) currentPlan = 'professional';
                else if (planId === 3) currentPlan = 'enterprise';
                else currentPlan = 'basic'; // Default fallback
              }
              tenantAddons = currentPlanData.addons.reduce((acc, addon) => {
                acc[addon.addon_type] = addon.quantity;
                return acc;
              }, {});
            } else {
              console.warn('No plan data found, using fallback');
              currentPlan = 'basic';
              tenantAddons = {};
            }
          }

          // Update UI with current plan
          updatePlanUI();

          // Load tenant features
          await loadTenantFeatures();

          // Update summary
          updateSummary();

          // Hide Add-ons filter for Enterprise plan on load
          if (currentPlan === 'enterprise') {
            document.querySelector('[data-filter="addons"]').style.display = 'none';
          }
        } catch (error) {
          console.error('Error loading initial data:', error);
          alert('Fehler beim Laden der Daten');
        }
      }

      // Load tenant features
      async function loadTenantFeatures() {
        try {
          const response = await fetch('/api/features/my-features', {
            headers: { Authorization: `Bearer ${token}` },
          });
          const featuresData = await response.json();
          console.info('Loaded tenant features response:', featuresData);

          // Extract the data array from the response
          const features = featuresData.data || featuresData;

          // Update feature states in categories
          Object.values(featureCategories).forEach((category) => {
            category.features.forEach((feature) => {
              const tenantFeature = features.find((f) => f.code === feature.code);
              if (tenantFeature) {
                feature.active = tenantFeature.is_available === 1;
              }
            });
          });

          loadFeatures();
        } catch (error) {
          console.error('Error loading tenant features:', error);
        }
      }

      // Update plan UI
      function updatePlanUI() {
        // Update plan cards
        document.querySelectorAll('.plan-card').forEach((card) => {
          card.classList.remove('current');
          const btn = card.querySelector('.plan-action');
          btn.classList.remove('current');
          btn.textContent = `Zu ${card.querySelector('.plan-name').textContent} wechseln`;
        });

        const currentCard = document.querySelector(`[data-plan="${currentPlan}"]`);
        if (currentCard) {
          currentCard.classList.add('current');
          const btn = currentCard.querySelector('.plan-action');
          btn.classList.add('current');
          btn.textContent = 'Aktueller Plan';
        }

        // Update plan badge
        const badge = document.querySelector('.plan-badge span');
        if (badge) {
          const planName = plans[currentPlan]?.name || currentPlan || 'Basic';
          badge.textContent = `${planName} Plan`;
        }

        // Update addons
        if (tenantAddons.employees) {
          document.querySelector('#addon-employees').textContent = tenantAddons.employees;
        }
        if (tenantAddons.admins) {
          document.querySelector('#addon-admins').textContent = tenantAddons.admins;
        }
        if (tenantAddons.storage_gb) {
          document.querySelector('#addon-storage').textContent = `${tenantAddons.storage_gb}GB`;
        }
      }

      function loadFeatures() {
        const container = document.querySelector('#features-container');
        container.innerHTML = '';

        Object.entries(featureCategories).forEach(([categoryName, categoryData]) => {
          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'feature-category';

          // Safe: HTML is generated from server data and sanitized with DOMPurify
          // eslint-disable-next-line no-unsanitized/property
          categoryDiv.innerHTML = DOMPurify.sanitize(`
            <div class="category-header">
              <div class="category-icon">${categoryData.icon}</div>
              <h3 class="category-title">${categoryName}</h3>
            </div>
            <div class="features-grid">
              ${categoryData.features
                .map((feature) => {
                  const isIncludedInPlan = isFeatureIncludedInPlan(feature.code, currentPlan);
                  const canActivate = canActivateFeature(feature.minPlan, currentPlan);
                  const isActive = feature.active;

                  return `
                  <div class="feature-card ${isActive ? 'active' : ''} ${!canActivate ? 'locked' : ''}"
                       data-feature="${feature.code}"
                       data-min-plan="${feature.minPlan}">
                    <span class="feature-status ${isActive ? 'status-active' : !canActivate ? 'status-locked' : 'status-inactive'}">
                      ${isActive ? 'Aktiv' : !canActivate ? 'Gesperrt' : 'Inaktiv'}
                    </span>
                    <h4 class="feature-name">${feature.name}</h4>
                    <p class="feature-description">${feature.description}</p>
                    <div class="feature-plan-badge">
                      ${getPlanBadge(feature.minPlan)}
                    </div>
                    <div class="feature-actions">
                      ${
                        canActivate
                          ? isActive
                            ? `<button class="btn btn-deactivate" onclick="toggleFeature('${feature.code}', false)">
                            Deaktivieren
                          </button>`
                            : `<button class="btn btn-activate" onclick="toggleFeature('${feature.code}', true)">
                            Aktivieren
                          </button>`
                          : `<button class="btn" disabled>
                          Upgrade ben√∂tigt
                        </button>`
                      }
                    </div>
                  </div>
                `;
                })
                .join('')}
            </div>
          `);

          container.append(categoryDiv);
        });
      }

      function isFeatureIncludedInPlan(featureCode, plan) {
        const planData = plans[plan];
        if (!planData || !planData.features) {
          console.warn(`Plan data not found for plan: ${plan}`);
          return false;
        }
        return planData.features.includes('all') || planData.features.includes(featureCode);
      }

      function canActivateFeature(minPlan, currentPlan) {
        const planOrder = ['basic', 'professional', 'enterprise'];
        return planOrder.indexOf(currentPlan) >= planOrder.indexOf(minPlan);
      }

      function getPlanBadge(plan) {
        const badges = {
          basic: 'Ab Basic',
          professional: 'Ab Professional',
          enterprise: 'Enterprise Only',
        };
        return badges[plan] || plan;
      }

      async function selectPlan(plan) {
        if (plan === currentPlan) return;

        const planName = plans[plan]?.name || plan;
        if (!confirm(`M√∂chten Sie wirklich zum ${planName} Plan wechseln?`)) {
          return;
        }

        try {
          const response = await fetch('/api/plans/change', {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              tenantId: currentTenantId,
              newPlanCode: plan,
            }),
          });

          if (!response.ok) {
            throw new Error('Plan-Wechsel fehlgeschlagen');
          }

          const result = await response.json();

          // Update local state
          currentPlan = plan;

          // Update UI
          updatePlanUI();

          // Hide or show Add-ons filter based on plan
          const addonsFilterBtn = document.querySelector('[data-filter="addons"]');
          if (plan === 'enterprise') {
            addonsFilterBtn.style.display = 'none';
            if (addonsFilterBtn.classList.contains('active')) {
              document.querySelector('[data-filter="all"]').click();
            }
          } else {
            addonsFilterBtn.style.display = 'inline-flex';
          }

          // Reload features for new plan
          await loadTenantFeatures();
          updateSummary();

          alert('Plan erfolgreich ge√§ndert!');
        } catch (error) {
          console.error('Error changing plan:', error);
          alert('Fehler beim Plan-Wechsel');
        }
      }

      async function toggleFeature(featureCode, activate) {
        try {
          const endpoint = activate ? '/api/features/activate' : '/api/features/deactivate';
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              tenantId: currentTenantId,
              featureCode: featureCode,
            }),
          });

          if (!response.ok) {
            throw new Error('Feature-√Ñnderung fehlgeschlagen');
          }

          // Update local state
          Object.values(featureCategories).forEach((category) => {
            const feature = category.features.find((f) => f.code === featureCode);
            if (feature) {
              feature.active = activate;
            }
          });

          loadFeatures();
          updateSummary();
        } catch (error) {
          console.error('Error toggling feature:', error);
          alert('Fehler beim √Ñndern des Features');
        }
      }

      function filterFeatures(filter) {
        const cards = document.querySelectorAll('.feature-card');

        cards.forEach((card) => {
          let show = true;

          switch (filter) {
            case 'active':
              show = card.classList.contains('active');
              break;
            case 'included':
              show = isFeatureIncludedInPlan(card.dataset.feature, currentPlan);
              break;
            case 'addons':
              show = !isFeatureIncludedInPlan(card.dataset.feature, currentPlan) && !card.classList.contains('locked');
              break;
          }

          card.style.display = show ? 'block' : 'none';
        });
      }

      function adjustAddon(type, change) {
        // Map frontend names to backend names
        const addonMap = {
          employees: 'employees',
          admins: 'admins',
          storage: 'storage_gb',
        };

        const backendType = addonMap[type];
        const currentValue = tenantAddons[backendType] || 0;
        const newValue = Math.max(0, currentValue + change);

        tenantAddons[backendType] = newValue;
        document.querySelector(`addon-${type}`).textContent = type === 'storage' ? `${newValue}GB` : newValue;
        updateSummary();
      }

      function updateSummary() {
        // Count active features
        let activeCount = 0;
        let totalCount = 0;

        Object.values(featureCategories).forEach((category) => {
          category.features.forEach((feature) => {
            if (canActivateFeature(feature.minPlan, currentPlan)) {
              totalCount++;
              if (feature.active) activeCount++;
            }
          });
        });

        // Get plan data with fallback
        const planData = plans[currentPlan] || { price: 0, name: currentPlan || 'Basic' };

        // Calculate cost
        let totalCost = planData.price || 0;
        totalCost += (tenantAddons.employees || 0) * 5;
        totalCost += (tenantAddons.admins || 0) * 10;
        totalCost += ((tenantAddons.storage_gb || 0) / 100) * 10;

        // Update UI
        document.querySelector('#summary-plan').textContent = planData.name;
        document.querySelector('#summary-features').textContent = `${activeCount} / ${totalCount}`;
        document.querySelector('#summary-cost').textContent = `${totalCost.toFixed(2)}‚Ç¨`;
      }

      async function saveChanges() {
        try {
          // Save addons
          const response = await fetch('/api/plans/addons', {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              tenantId: currentTenantId,
              addons: tenantAddons,
            }),
          });

          if (!response.ok) {
            throw new Error('Speichern fehlgeschlagen');
          }

          const result = await response.json();

          // Update cost display
          if (result.costs) {
            const totalCost = result.costs.totalCost;
            document.querySelector('#summary-cost').textContent = `${totalCost.toFixed(2)}‚Ç¨`;
          }

          alert('√Ñnderungen erfolgreich gespeichert!');
        } catch (error) {
          console.error('Error saving changes:', error);
          alert('Fehler beim Speichern der √Ñnderungen');
        }
      }
    </script>

    <!-- Breadcrumb Component -->
    <script type="module">
      import { initBreadcrumb } from '/scripts/components/breadcrumb.js';
      // Breadcrumb wird automatisch generiert basierend auf der URL
      initBreadcrumb();
    </script>
  </body>
</html>
