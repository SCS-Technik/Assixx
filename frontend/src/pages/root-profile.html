<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Root Profil - Assixx</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- Critical Layout State - Prevents Layout Shift -->
    <script>
      // Set sidebar state IMMEDIATELY to prevent any layout shift
      (function () {
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        document.documentElement.setAttribute('data-sidebar', sidebarCollapsed ? 'collapsed' : 'expanded');
        // Also set CSS custom properties for immediate use
        document.documentElement.style.setProperty('--sidebar-width', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--content-margin', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--grid-columns', sidebarCollapsed ? '4' : '3');
        document.documentElement.style.setProperty('--widget-columns', sidebarCollapsed ? '5' : '3');
        document.documentElement.style.setProperty('--card-padding', sidebarCollapsed ? '2rem' : '1.5rem');
      })();
    </script>
    <script src="/feature-flags.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      @import url('/styles/dashboard-theme.css');
      @import url('/styles/breadcrumb-alignment.css');
      /* Glassmorphismus Design-Standards */

      /* Dramatischer Hintergrund-Gradient */
      body {
        position: relative;
        min-height: 100vh;
        overflow-x: hidden;
        background: #000;
      }

      body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(5deg, transparent, rgba(0, 142, 255, 0.1) 100%, #01000482 0, rgba(0, 0, 4, 0.6) 100%, #000);
        pointer-events: none;
        z-index: -1;
      }

      /* Profil Container */
      .profile-container {
        margin: 0 auto;
      }

      h1 {
        color: var(--primary-color);
        margin-bottom: 32px;
        font-size: 2.5rem;
        /* animation: fadeInUp 0.6s ease-out; */
      }

      /* Glassmorphismus Cards */
      .profile-card {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: var(--shadow-sm);
        border-radius: var(--radius-md);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-lg);
        /* animation: fadeInUp 0.6s ease-out; */
      }

      /* Card Title with accent bar */
      .card-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 var(--spacing-lg) 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .card-title::before {
        content: '';
        width: 4px;
        height: 24px;
        background: linear-gradient(180deg, var(--primary-color), var(--primary-light));
        border-radius: 2px;
      }

      /* Profilbild Section */
      .profile-picture-section {
        display: flex;
        align-items: center;
        gap: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
      }

      .profile-picture-container {
        position: relative;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.05);
        border: 3px solid rgba(0, 142, 255, 0.3);
        box-shadow: var(--shadow-sm);
      }

      .profile-picture {
        width: 100%;
        height: 100%;
        object-fit: cover;
        padding: 24px;
      }

      .profile-picture-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        color: var(--primary-color);
        background: rgba(0, 142, 255, 0.1);
      }

      /* More specific selector to override global styles */
      #profile-picture-display.profile-picture-placeholder.avatar-initials {
        background: linear-gradient(135deg, #2196f3, #42a5f5) !important;
        color: white !important;
        font-weight: 600 !important;
        font-size: 3rem !important;
        text-transform: uppercase !important;
      }

      .profile-picture-actions {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      /* Form Styling */
      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
      }

      .form-group {
        margin-bottom: var(--spacing-md);
      }

      .form-label {
        display: block;
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        margin-bottom: 8px;
      }

      /* Form Controls mit Glassmorphismus */
      .form-control {
        width: 100%;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(10px);
        border: 1px solid hsla(0, 0%, 100%, 0.1);
        border-radius: var(--radius-sm);
        color: #fff;
        font-size: 15px;
        transition: all 0.3s ease;
      }

      .form-control:focus {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(0, 142, 255, 0.5);
        box-shadow:
          0 0 0 3px rgba(0, 142, 255, 0.15),
          inset 0 1px 2px rgba(0, 0, 0, 0.2);
        outline: none;
      }

      .form-control:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Password Section */
      .password-section {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: var(--spacing-lg);
        margin-top: var(--spacing-lg);
      }

      /* Buttons mit Glassmorphismus und Shine-Effekt */
      .btn {
        position: relative;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
        padding: 12px 24px;
        border-radius: var(--radius-sm);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn-primary {
        background: linear-gradient(135deg, rgba(0, 142, 255, 0.2), rgba(0, 142, 255, 0.1));
        border-color: rgba(0, 142, 255, 0.3);
        color: white;
      }

      .btn-secondary {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        border-color: rgba(255, 255, 255, 0.2);
        color: var(--text-secondary);
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
      }

      .btn::after {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
        transform: rotate(45deg) translate(-70%, -70%);
        transition: transform 0.6s;
      }

      .btn:hover::after {
        transform: rotate(45deg) translate(-30%, -30%);
      }

      /* Success/Error Messages */
      .alert {
        padding: var(--spacing-md);
        border-radius: var(--radius-sm);
        margin-bottom: var(--spacing-md);
        backdrop-filter: blur(10px);
        /* animation: fadeInUp 0.3s ease-out; */
      }

      .alert-success {
        background: rgba(76, 175, 80, 0.1);
        border: 1px solid rgba(76, 175, 80, 0.3);
        color: #4caf50;
      }

      .alert-error {
        background: rgba(244, 67, 54, 0.1);
        border: 1px solid rgba(244, 67, 54, 0.3);
        color: #f44336;
      }

      /* Animationen */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Danger Button */
      .btn-danger {
        background: linear-gradient(135deg, rgba(244, 67, 54, 0.2), rgba(244, 67, 54, 0.1));
        border-color: rgba(244, 67, 54, 0.3);
        color: #f44336;
      }

      .btn-danger:hover {
        background: linear-gradient(135deg, rgba(244, 67, 54, 0.3), rgba(244, 67, 54, 0.2));
        border-color: #f44336;
        box-shadow: 0 8px 20px rgba(244, 67, 54, 0.3);
      }

      /* Modal Styles - Glassmorphismus nach Design Standards */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        /* animation: fadeIn 0.3s ease-out; */
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal-content {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        /* animation: fadeInUp 0.3s ease-out; */
        padding: 25px;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: var(--spacing-lg);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: #f44336;
      }

      .modal-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
      }

      .modal-header i {
        font-size: 24px;
      }

      .modal-body {
        padding: var(--spacing-lg);
      }

      .warning-box {
        background: rgba(244, 67, 54, 0.1);
        border: 1px solid rgba(244, 67, 54, 0.3);
        border-radius: var(--radius-sm);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        backdrop-filter: blur(10px);
      }

      .confirmation-input {
        margin-top: var(--spacing-lg);
      }

      .modal-footer {
        display: flex;
        gap: var(--spacing-md);
        justify-content: flex-end;
        padding: var(--spacing-lg);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* Success Animation */
      .success-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        /* animation: fadeIn 0.3s ease-out; */
      }

      .success-message {
        background: rgba(76, 175, 80, 0.1);
        border: 2px solid #4caf50;
        backdrop-filter: blur(20px);
        border-radius: var(--radius-md);
        padding: var(--spacing-xl) calc(var(--spacing-xl) * 2);
        text-align: center;
        /* animation: scaleIn 0.5s ease-out; */
      }

      .success-icon {
        font-size: 4rem;
        color: #4caf50;
        margin-bottom: var(--spacing-lg);
        /* animation: checkmark 0.6s ease-out 0.3s both; */
      }

      .success-text {
        font-size: 1.5rem;
        color: var(--text-primary);
        font-weight: 600;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes scaleIn {
        from {
          transform: scale(0.8);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      @keyframes checkmark {
        0% {
          transform: scale(0) rotate(0deg);
        }
        50% {
          transform: scale(1.2) rotate(360deg);
        }
        100% {
          transform: scale(1) rotate(360deg);
        }
      }

      /* Info boxes in deletion status modal */
      .approval-required-info,
      .cooling-off-info,
      .grace-period-info {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-sm);
        padding: var(--spacing-md);
        margin: var(--spacing-sm) 0;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .approval-required-info {
        border-color: rgba(0, 142, 255, 0.3);
        background: rgba(0, 142, 255, 0.05);
      }

      .approval-required-info i {
        color: var(--primary-color);
      }

      .cooling-off-info {
        border-color: rgba(255, 193, 7, 0.3);
        background: rgba(255, 193, 7, 0.05);
      }

      .cooling-off-info i {
        color: #ffc107;
      }

      .grace-period-info {
        border-color: rgba(76, 175, 80, 0.3);
        background: rgba(76, 175, 80, 0.05);
      }

      .grace-period-info i {
        color: #4caf50;
      }

      /* Approval Section */
      .approval-section {
        background: rgba(255, 193, 7, 0.05);
        border: 1px solid rgba(255, 193, 7, 0.2);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
      }

      .approval-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
      }

      .approval-header i {
        font-size: 24px;
        color: #ffc107;
      }

      .approval-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .approval-item {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-sm);
        padding: var(--spacing-md);
        transition: all 0.3s ease;
      }

      .approval-item:hover {
        background: rgba(255, 255, 255, 0.05);
        transform: translateY(-2px);
      }

      .approval-item-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: var(--spacing-sm);
      }

      .approval-item-info {
        flex: 1;
      }

      .approval-item-actions {
        display: flex;
        gap: var(--spacing-sm);
      }

      .approval-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
      }

      .approval-status.pending {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
      }

      .cooling-off-warning {
        background: rgba(255, 152, 0, 0.1);
        border: 1px solid rgba(255, 152, 0, 0.3);
        border-radius: var(--radius-sm);
        padding: var(--spacing-sm);
        margin-top: var(--spacing-sm);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: 13px;
      }

      .cooling-off-warning i {
        color: #ff9800;
      }

      /* Deletion Status Modal Styles - Glassmorphismus Design Standards */
      .deletion-status-container {
        display: flex;
        align-items: center;
        gap: var(--spacing-xl);
        padding: var(--spacing-xl);
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-xl);
      }

      .status-icon {
        flex-shrink: 0;
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(0, 142, 255, 0.1), rgba(0, 142, 255, 0.05));
        border-radius: 50%;
        border: 2px solid rgba(0, 142, 255, 0.2);
        /* animation: pulse 2s ease-in-out infinite; */
      }

      .status-icon i {
        color: var(--primary-color);
        filter: drop-shadow(0 0 10px rgba(0, 142, 255, 0.3));
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.05);
          opacity: 0.8;
        }
      }

      .status-message {
        flex: 1;
      }

      .status-message .lead {
        font-size: 1.1rem;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
        font-weight: 500;
      }

      .deletion-date {
        font-size: 1rem;
        color: var(--text-secondary);
        margin-bottom: var(--spacing-md);
      }

      .deletion-date strong {
        color: var(--primary-color);
        font-weight: 600;
      }

      .grace-period-info {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        padding: var(--spacing-sm) var(--spacing-md);
        background: rgba(255, 193, 7, 0.1);
        border: 1px solid rgba(255, 193, 7, 0.2);
        border-radius: var(--radius-sm);
        color: #ffc107;
      }

      .grace-period-info i {
        font-size: 1.2rem;
      }

      .status-actions {
        display: flex;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-xl);
        flex-wrap: wrap;
      }

      .status-actions .btn {
        flex: 1;
        min-width: 150px;
      }

      .export-reminder {
        padding: var(--spacing-lg);
        background: rgba(0, 142, 255, 0.05);
        border: 1px solid rgba(0, 142, 255, 0.1);
        border-radius: var(--radius-md);
        text-align: center;
      }

      .export-reminder h4 {
        color: var(--primary-color);
        margin-bottom: var(--spacing-md);
        font-size: 1.2rem;
        font-weight: 600;
      }

      .export-reminder p {
        color: var(--text-secondary);
        margin-bottom: var(--spacing-lg);
      }

      .export-reminder .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        border: none;
        box-shadow: 0 4px 16px rgba(0, 142, 255, 0.3);
        transition: all var(--transition-fast);
      }

      .export-reminder .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 142, 255, 0.4);
      }

      /* Button Variants for Deletion Modal */
      .btn-warning {
        background: rgba(255, 193, 7, 0.2);
        border: 1px solid #ffc107;
        color: #ffc107;
        transition: all var(--transition-fast);
      }

      .btn-warning:hover {
        background: rgba(255, 193, 7, 0.3);
        border-color: #ffca28;
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(255, 193, 7, 0.3);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--text-primary);
        transition: all var(--transition-fast);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.3);
      }

      /* Responsive */
      @media (max-width: 768px) {
        .profile-picture-section {
          flex-direction: column;
          text-align: center;
        }

        .form-grid {
          grid-template-columns: 1fr;
        }

        .modal-content {
          margin: 20px;
          padding: 0;
        }

        .deletion-status-container {
          flex-direction: column;
          text-align: center;
        }

        .status-actions {
          flex-direction: column;
        }

        .status-actions .btn {
          width: 100%;
        }
      }
    </style>
    <link rel="stylesheet" href="/styles/user-info-update.css" />
  </head>
  <body>
    <!-- Unified Navigation -->
    <div id="navigation-container"></div>

    <!-- Main Layout with Sidebar -->
    <div class="layout-container">
      <!-- Main Content Area -->
      <main class="main-content">
        <!-- Breadcrumb Navigation -->
        <div id="breadcrumb-container"></div>

        <div class="container">
          <div class="profile-container">
            <!-- Success/Error Messages -->
            <div id="message-container"></div>

            <!-- Pending Approvals Section -->
            <div id="approvalSection" class="approval-section" class="u-hidden">
              <div class="approval-header">
                <i class="fas fa-hourglass-half"></i>
                <div>
                  <h3>Ausstehende Löschgenehmigungen</h3>
                  <p>Diese Löschanfragen warten auf Ihre Genehmigung</p>
                </div>
              </div>
              <div id="approvalList" class="approval-list">
                <!-- Approval items will be inserted here -->
              </div>
            </div>

            <!-- Profile Picture Card -->
            <div class="profile-card">
              <h2 class="card-title">Profilbild</h2>
              <div class="profile-picture-section">
                <div class="profile-picture-container">
                  <div id="profile-picture-display" class="profile-picture-placeholder avatar-initials">
                    <!-- Initials will be set by JavaScript -->
                  </div>
                </div>
                <div class="profile-picture-actions">
                  <input type="file" id="profile-picture-input" accept="image/*" class="u-hidden" />
                  <button class="btn btn-primary" onclick="document.getElementById('profile-picture-input').click()">
                    <i class="fas fa-camera"></i>
                    Bild ändern
                  </button>
                  <button class="btn btn-secondary" id="remove-picture-btn" class="u-hidden">
                    <i class="fas fa-trash"></i>
                    Bild entfernen
                  </button>
                </div>
              </div>
            </div>

            <!-- Personal Information Card -->
            <div class="profile-card">
              <h2 class="card-title">Persönliche Informationen</h2>
              <form id="profile-form">
                <div class="form-grid">
                  <div class="form-group">
                    <label class="form-label">E-Mail</label>
                    <input type="email" id="email" name="email" class="form-control" required />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Vorname</label>
                    <input type="text" id="first_name" name="first_name" class="form-control" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Nachname</label>
                    <input type="text" id="last_name" name="last_name" class="form-control" />
                  </div>
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save"></i>
                  Änderungen speichern
                </button>
              </form>
            </div>

            <!-- Password Change Card -->
            <div class="profile-card">
              <h2 class="card-title">Passwort ändern</h2>
              <form id="password-form" autocomplete="off">
                <div class="form-group">
                  <label class="form-label">Aktuelles Passwort</label>
                  <input
                    type="password"
                    id="current_password"
                    name="current_password"
                    class="form-control"
                    autocomplete="current-password"
                    required
                  />
                </div>
                <div class="form-group">
                  <label class="form-label">Neues Passwort</label>
                  <input type="password" id="new_password" name="new_password" class="form-control" autocomplete="new-password" required />
                </div>
                <div class="form-group">
                  <label class="form-label">Neues Passwort bestätigen</label>
                  <input
                    type="password"
                    id="confirm_password"
                    name="confirm_password"
                    class="form-control"
                    autocomplete="new-password"
                    required
                  />
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-key"></i>
                  Passwort ändern
                </button>
              </form>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Font Awesome für Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <!-- JavaScript -->
    <script type="module" src="/scripts/components/unified-navigation.ts"></script>
    <script type="module" src="/scripts/role-switch.ts"></script>
    <script>
      // Authentication Check
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login';
      }

      // Decode JWT to get user info
      function parseJwt(token) {
        try {
          const base64Url = token.split('.')[1];
          const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
          const jsonPayload = decodeURIComponent(
            atob(base64)
              .split('')
              .map(function (c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
              })
              .join(''),
          );
          return JSON.parse(jsonPayload);
        } catch (e) {
          return null;
        }
      }

      const userInfo = parseJwt(token);
      if (userInfo && userInfo.role !== 'root') {
        window.location.href = '/login';
      }

      // User info wird durch header-user-info.ts geladen

      // Load current profile data
      async function loadProfile() {
        try {
          const useV2Users = window.FEATURE_FLAGS?.USE_API_V2_USERS;
          const endpoint = useV2Users ? '/api/v2/users/me' : '/api/user/profile';

          const response = await fetch(endpoint, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            console.info('[Root Profile] API Response:', data);

            // Handle different response formats
            const user = data.data || data.user || data;

            // Handle both camelCase (v2) and snake_case (v1)
            const firstName = user.firstName || user.first_name || '';
            const lastName = user.lastName || user.last_name || '';
            const profilePicture = user.profilePictureUrl || user.profile_picture || '';

            // Fill form fields
            document.getElementById('email').value = user.email || '';
            document.getElementById('first_name').value = firstName;
            document.getElementById('last_name').value = lastName;

            // Load profile picture if exists
            if (profilePicture) {
              displayProfilePicture(profilePicture);
              // Header wird automatisch durch header-user-info.ts aktualisiert
            } else {
              // Show initials if no profile picture
              const container = document.getElementById('profile-picture-display');
              if (container) {
                const firstInitial = firstName.charAt(0).toUpperCase() || '';
                const lastInitial = lastName.charAt(0).toUpperCase() || '';
                const initials = firstInitial || lastInitial ? `${firstInitial}${lastInitial}` : 'U';

                console.info('[Root Profile] User data:', user);
                console.info('[Root Profile] Setting initials:', { firstName, lastName, initials });
                container.classList.add('avatar-initials');
                container.innerHTML = initials;
              }
            }
          } else {
            showMessage('Fehler beim Laden des Profils', 'error');
          }
        } catch (error) {
          console.error('Error loading profile:', error);
          showMessage('Fehler beim Laden des Profils', 'error');
        }
      }

      // Initialize all event listeners when DOM is ready
      function initializeEventListeners() {
        // Profile form submission
        const profileForm = document.getElementById('profile-form');
        if (profileForm) {
          profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
              const useV2Users = window.FEATURE_FLAGS?.USE_API_V2_USERS;
              const endpoint = useV2Users ? '/api/v2/users/me/profile' : '/api/user/profile';

              const response = await fetch(endpoint, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(data),
              });

              if (response.ok) {
                showMessage('Profil erfolgreich aktualisiert', 'success');
                // Reload page after 1 second to update navigation
                setTimeout(() => {
                  window.location.reload();
                }, 1000);
              } else {
                const error = await response.json();
                showMessage(error.message || 'Fehler beim Aktualisieren', 'error');
              }
            } catch (error) {
              console.error('Error updating profile:', error);
              showMessage('Fehler beim Aktualisieren des Profils', 'error');
            }
          });
        }

        // Password form submission
        const passwordForm = document.getElementById('password-form');
        if (passwordForm) {
          passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;

            if (newPassword !== confirmPassword) {
              showMessage('Die Passwörter stimmen nicht überein', 'error');
              return;
            }

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
              const useV2Users = window.FEATURE_FLAGS?.USE_API_V2_USERS;
              const endpoint = useV2Users ? '/api/v2/users/me/password' : '/api/users/profile/password';

              const response = await fetch(endpoint, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                  currentPassword: data.current_password,
                  newPassword: data.new_password,
                }),
              });

              if (response.ok) {
                showMessage('Passwort erfolgreich geändert', 'success');
                showSuccessOverlay('Passwort erfolgreich geändert!');
                e.target.reset();
              } else {
                const error = await response.json();
                showMessage(error.message || 'Fehler beim Ändern des Passworts', 'error');
              }
            } catch (error) {
              console.error('Error changing password:', error);
              showMessage('Fehler beim Ändern des Passworts', 'error');
            }
          });
        }

        // Profile picture upload
        const pictureInput = document.getElementById('profile-picture-input');
        if (pictureInput) {
          pictureInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('profilePicture', file);

            try {
              const useV2Users = window.FEATURE_FLAGS?.USE_API_V2_USERS;
              const endpoint = useV2Users ? '/api/v2/users/me/profile-picture' : '/api/user/profile-picture';

              const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                  Authorization: `Bearer ${token}`,
                },
                body: formData,
              });

              if (response.ok) {
                const data = await response.json();
                displayProfilePicture(data.profilePicture);
                showMessage('Profilbild erfolgreich aktualisiert', 'success');
              } else {
                showMessage('Fehler beim Hochladen des Profilbilds', 'error');
              }
            } catch (error) {
              console.error('Error uploading profile picture:', error);
              showMessage('Fehler beim Hochladen des Profilbilds', 'error');
            }
          });
        }

        // Remove profile picture
        const removePictureBtn = document.getElementById('remove-picture-btn');
        if (removePictureBtn) {
          removePictureBtn.addEventListener('click', async () => {
            if (!confirm('Möchten Sie Ihr Profilbild wirklich entfernen?')) return;

            try {
              const useV2Users = window.FEATURE_FLAGS?.USE_API_V2_USERS;
              const endpoint = useV2Users ? '/api/v2/users/me/profile-picture' : '/api/user/profile-picture';

              const response = await fetch(endpoint, {
                method: 'DELETE',
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              });

              if (response.ok) {
                const container = document.getElementById('profile-picture-display');
                if (container) {
                  // Get current user data to restore initials
                  const firstName = document.getElementById('first_name').value || '';
                  const lastName = document.getElementById('last_name').value || '';
                  const firstInitial = firstName.charAt(0).toUpperCase() || '';
                  const lastInitial = lastName.charAt(0).toUpperCase() || '';
                  const initials = firstInitial || lastInitial ? `${firstInitial}${lastInitial}` : 'U';

                  container.classList.add('avatar-initials');
                  container.innerHTML = initials;
                }
                document.getElementById('remove-picture-btn').style.display = 'none';
                showMessage('Profilbild erfolgreich entfernt', 'success');
              } else {
                showMessage('Fehler beim Entfernen des Profilbilds', 'error');
              }
            } catch (error) {
              console.error('Error removing profile picture:', error);
              showMessage('Fehler beim Entfernen des Profilbilds', 'error');
            }
          });
        }
      }

      // Display profile picture
      function displayProfilePicture(url) {
        const container = document.getElementById('profile-picture-display');
        if (container) {
          container.classList.remove('avatar-initials');
          container.innerHTML = `<img src="${url}" alt="Profilbild" class="profile-picture">`;
          const removeBtn = document.getElementById('remove-picture-btn');
          if (removeBtn) {
            removeBtn.style.display = 'block';
          }
        }
      }

      // Show success/error messages
      function showMessage(message, type) {
        const container = document.getElementById('message-container');
        if (container) {
          container.innerHTML = `
                <div class="alert alert-${type}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    ${message}
                </div>
            `;

          setTimeout(() => {
            container.innerHTML = '';
          }, 5000);
        }
      }

      // Show success overlay animation - nach Design-Standards
      function showSuccessOverlay(text = 'Erfolgreich!') {
        const overlay = document.createElement('div');
        overlay.className = 'success-overlay';
        overlay.innerHTML = `
          <div class="success-message">
            <div class="success-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="success-text">
              ${text}
            </div>
          </div>
        `;
        document.body.appendChild(overlay);

        // Remove after animation - immer 2 Sekunden
        setTimeout(() => {
          overlay.remove();
        }, 2000);
      }

      // Logout
      // Wait for navigation to load before attaching logout handler
      setTimeout(() => {
        const logoutBtn = document.getElementById('logout-btn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('token');
            localStorage.removeItem('role');
            window.location.href = '/login';
          });
        }
      }, 500);

      // Approval Functions
      async function loadPendingApprovals() {
        try {
          const useV2Root = window.FEATURE_FLAGS?.USE_API_V2_ROOT;
          const endpoint = useV2Root ? '/api/v2/root/deletion-approvals/pending' : '/api/root/deletion-approvals/pending';

          const response = await fetch(endpoint, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) throw new Error('Failed to load approvals');

          const data = await response.json();
          console.info('Deletion approvals response:', data);

          let approvals = [];
          if (data && data.success && Array.isArray(data.data)) {
            approvals = data.data;
          } else if (Array.isArray(data)) {
            approvals = data;
          }

          console.info('Processed approvals:', approvals);

          const approvalSection = document.getElementById('approvalSection');
          const approvalList = document.getElementById('approvalList');

          if (approvals.length > 0) {
            approvalSection.style.display = 'block';
            approvalList.innerHTML = approvals.map((approval) => createApprovalItem(approval)).join('');
          } else {
            approvalSection.style.display = 'none';
            approvalList.innerHTML = ''; // Clear any existing content
          }
        } catch (error) {
          console.error('Error loading approvals:', error);
        }
      }

      function createApprovalItem(approval) {
        // Validate approval object
        if (!approval || !approval.queue_id) {
          console.error('Invalid approval object:', approval);
          return '';
        }

        const requestedAt = new Date(approval.requested_at);
        const hoursSince = (Date.now() - requestedAt.getTime()) / (1000 * 60 * 60);
        const coolingOffRemaining = Math.max(0, 24 - hoursSince);
        const canApprove = coolingOffRemaining === 0;

        return `
          <div class="approval-item">
            <div class="approval-item-header">
              <div class="approval-item-info">
                <h4>${approval.company_name}</h4>
                <p>Subdomain: ${approval.subdomain}</p>
                <p>Beantragt von: ${approval.requester_name}</p>
                <p>Beantragt am: ${requestedAt.toLocaleString('de-DE')}</p>
                <span class="approval-status pending">Ausstehend</span>
              </div>
              <div class="approval-item-actions">
                ${
                  canApprove
                    ? `
                  <button class="btn btn-success" onclick="approveDeletion(${approval.queue_id})">
                    <i class="fas fa-check"></i> Genehmigen
                  </button>
                `
                    : ''
                }
                <button class="btn btn-danger" onclick="rejectDeletion(${approval.queue_id})">
                  <i class="fas fa-times"></i> Ablehnen
                </button>
              </div>
            </div>
            ${
              !canApprove
                ? `
              <div class="cooling-off-warning">
                <i class="fas fa-clock"></i>
                <span>Cooling-off Periode: Noch ${Math.ceil(coolingOffRemaining)} Stunden warten</span>
              </div>
            `
                : ''
            }
          </div>
        `;
      }

      async function approveDeletion(queueId) {
        if (
          !confirm(
            'Möchten Sie diese Löschung wirklich genehmigen?\n\nDer Tenant wird nach der 30-tägigen Grace Period endgültig gelöscht.',
          )
        ) {
          return;
        }

        try {
          const useV2Root = window.FEATURE_FLAGS?.USE_API_V2_ROOT;
          const endpoint = useV2Root
            ? `/api/v2/root/deletion-approvals/${queueId}/approve`
            : `/api/root/deletion-approvals/${queueId}/approve`;

          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          });

          if (response.ok) {
            showSuccessOverlay('Löschung genehmigt!');
            await loadPendingApprovals();
          } else {
            const error = await response.json();
            showMessage(error.message || 'Fehler bei der Genehmigung', 'error');
          }
        } catch (error) {
          console.error('Error approving deletion:', error);
          showMessage('Fehler bei der Genehmigung', 'error');
        }
      }

      async function rejectDeletion(queueId) {
        const reason = prompt('Bitte geben Sie einen Grund für die Ablehnung an:');
        if (!reason) return;

        try {
          const useV2Root = window.FEATURE_FLAGS?.USE_API_V2_ROOT;
          const endpoint = useV2Root
            ? `/api/v2/root/deletion-approvals/${queueId}/reject`
            : `/api/root/deletion-approvals/${queueId}/reject`;

          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ reason }),
          });

          if (response.ok) {
            showSuccessOverlay('Löschung abgelehnt!');
            await loadPendingApprovals();
          } else {
            const error = await response.json();
            showMessage(error.message || 'Fehler bei der Ablehnung', 'error');
          }
        } catch (error) {
          console.error('Error rejecting deletion:', error);
          showMessage('Fehler bei der Ablehnung', 'error');
        }
      }

      // Make functions globally available
      window.approveDeletion = approveDeletion;
      window.rejectDeletion = rejectDeletion;

      // Set initial placeholder while loading
      function setInitialPlaceholder() {
        const container = document.getElementById('profile-picture-display');
        if (container && !container.innerHTML.trim()) {
          // Get user info from token if available
          const token = localStorage.getItem('token');
          if (token) {
            try {
              const userInfo = parseJwt(token);
              if (userInfo) {
                // Try to get initials from token data
                const firstName = userInfo.first_name || userInfo.firstName || '';
                const lastName = userInfo.last_name || userInfo.lastName || '';
                const firstInitial = firstName.charAt(0).toUpperCase() || '';
                const lastInitial = lastName.charAt(0).toUpperCase() || '';
                const initials = firstInitial || lastInitial ? `${firstInitial}${lastInitial}` : '...';
                container.innerHTML = initials;
              } else {
                container.innerHTML = '...';
              }
            } catch (e) {
              container.innerHTML = '...';
            }
          } else {
            container.innerHTML = '...';
          }
        }
      }

      // Initialize everything when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setInitialPlaceholder();
          initializeEventListeners();
          loadProfile();
          loadPendingApprovals();

          // Enable delete button only when user types "LÖSCHEN"
          const deleteConfirmInput = document.getElementById('deleteConfirmation');
          if (deleteConfirmInput) {
            deleteConfirmInput.addEventListener('input', (e) => {
              const confirmBtn = document.getElementById('confirmDeleteBtn');
              if (confirmBtn) {
                confirmBtn.disabled = e.target.value !== 'LÖSCHEN';
              }
            });
          }

          // Close modal on overlay click
          const deleteModal = document.getElementById('deleteModal');
          if (deleteModal) {
            deleteModal.addEventListener('click', (e) => {
              if (e.target.id === 'deleteModal') {
                closeDeleteModal();
              }
            });
          }
        });
      } else {
        // DOM already loaded
        setInitialPlaceholder();
        initializeEventListeners();
        loadProfile();
        loadPendingApprovals();

        // Enable delete button only when user types "LÖSCHEN"
        const deleteConfirmInput = document.getElementById('deleteConfirmation');
        if (deleteConfirmInput) {
          deleteConfirmInput.addEventListener('input', (e) => {
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            if (confirmBtn) {
              confirmBtn.disabled = e.target.value !== 'LÖSCHEN';
            }
          });
        }

        // Close modal on overlay click
        const deleteModal = document.getElementById('deleteModal');
        if (deleteModal) {
          deleteModal.addEventListener('click', (e) => {
            if (e.target.id === 'deleteModal') {
              closeDeleteModal();
            }
          });
        }
      }
    </script>
    <script type="module" src="/scripts/components/breadcrumb.js"></script>
  </body>
</html>
