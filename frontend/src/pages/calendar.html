<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firmenkalender - Assixx</title>

    <!-- Critical Layout State - Prevents Layout Shift -->
    <script src="/scripts/critical/sidebar-init.js"></script>

    <!-- Unified Navigation CSS - Load immediately to prevent FOUC -->
    <link id="unified-navigation-styles" rel="stylesheet" href="/styles/unified-navigation.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <!-- FullCalendar CSS -->
    <link rel="stylesheet" href="/styles/lib/fullcalendar.min.css" />

    <!-- Dashboard Theme - General theme styles -->
    <link rel="stylesheet" href="/styles/dashboard-theme.css" />
    <link rel="stylesheet" href="/styles/breadcrumb-alignment.css" />
    <!-- Calendar spezifische Styles -->
    <link rel="stylesheet" href="/styles/calendar.css" />
    <link rel="stylesheet" href="/styles/user-info-update.css" />
  </head>
  <body>
    <!-- Unified Navigation -->
    <div id="navigation-container"></div>

    <!-- Main Layout mit Sidebar -->
    <div class="layout-container">
      <!-- Main Content -->
      <main class="main-content">
        <!-- Breadcrumb -->
        <div id="breadcrumb-container"></div>

        <div class="container">
          <!-- Filterleiste -->
          <div class="card mb-4">
            <div class="card-header">
              <div class="flex flex-between align-center">
                <h3 class="card-title">Filter & Anzeige</h3>
                <div class="flex gap-2">
                  <div class="btn-group view-selector">
                    <button id="monthView" class="btn btn-sm btn-primary active">Monat</button>
                    <button id="weekView" class="btn btn-sm btn-outline-primary">Woche</button>
                    <button id="dayView" class="btn btn-sm btn-outline-primary">Tag</button>
                    <button id="listView" class="btn btn-sm btn-outline-primary">Liste</button>
                  </div>
                  <button id="newEventBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i>
                    Neuer Termin
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="flex gap-4 flex-wrap">
                <div class="form-group">
                  <label for="levelFilter" class="form-label">Filter</label>
                  <div class="tab-navigation mb-2" id="levelFilter">
                    <button class="tab-btn active" data-value="all" id="filterAll">Gesamt</button>
                    <button class="tab-btn" data-value="company" id="filterCompany">Firma</button>
                    <button class="tab-btn" data-value="department" id="filterDepartment">Abteilung</button>
                    <button class="tab-btn" data-value="team" id="filterTeam">Team</button>
                    <button class="tab-btn" data-value="personal" id="filterPersonal">Meine</button>
                  </div>
                </div>

                <div class="form-group">
                  <label for="searchInput" class="form-label">Suche</label>
                  <div class="search-input-wrapper">
                    <input type="text" id="searchInput" class="search-input" placeholder="Termine durchsuchen..." />
                    <button class="search-button" type="button" id="searchButton">
                      <i class="fas fa-search"></i>
                    </button>
                  </div>
                </div>

                <div class="flex-grow"></div>

                <div class="form-group">
                  <label class="form-label">Legende</label>
                  <div class="legend-container">
                    <div class="legend-item">
                      <span class="legend-color legend-company"></span>
                      <span class="legend-label">Firma</span>
                    </div>
                    <div class="legend-item">
                      <span class="legend-color legend-department"></span>
                      <span class="legend-label">Abteilung</span>
                    </div>
                    <div class="legend-item">
                      <span class="legend-color legend-team"></span>
                      <span class="legend-label">Team</span>
                    </div>
                    <div class="legend-item">
                      <span class="legend-color legend-personal"></span>
                      <span class="legend-label">Persönlich</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Calendar Container -->
          <div class="card calendar-card mb-4" id="calendarContainer">
            <div class="card-header">
              <div class="flex flex-between align-center">
                <h3 class="card-title">Kalender</h3>
                <div class="controls-flex-calendar">
                  <button id="fullscreenBtn" class="zoom-btn" title="Vollbild">
                    <i class="fas fa-expand"></i>
                  </button>
                  <button id="newCalendarEventBtn" class="btn btn-primary u-m-0 btn-inline-flex">
                    <i class="fas fa-plus me-2"></i>
                    Neuer Eintrag
                  </button>
                </div>
              </div>
            </div>
            <div class="card-body p-0">
              <div id="calendar"></div>
            </div>
          </div>

          <!-- Upcoming Events -->
          <div class="card mb-4">
            <div class="card-header">
              <h3 class="card-title">Anstehende Termine</h3>
            </div>
            <div class="card-body">
              <div id="upcomingEvents" class="upcoming-events">
                <!-- Wird dynamisch befüllt -->
                <div class="loading-placeholder">
                  <div class="loading-spinner"></div>
                  <p class="text-center mt-3">Termine werden geladen...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
    <!-- Ende des layout-container -->

    <!-- Alle Modals werden dynamisch erstellt -->

    <!-- Marked.js for Markdown rendering -->
    <script type="module" src="/scripts/lib/marked.min.js"></script>
    <!-- FullCalendar -->
    <!-- FullCalendar libraries (external, not bundled by Vite) -->
    <script src="/scripts/lib/fullcalendar.min.js" defer></script>
    <script src="/scripts/lib/fullcalendar-locales.min.js" defer></script>
    <!-- Standalone scripts for Calendar -->
    <script>
      // Definiere DashboardUI direkt hier, um Abhängigkeiten zu vermeiden
      window.DashboardUI = {
        openModal: function (modalId) {
          console.info('DashboardUI.openModal called for:', modalId);
          const modal = document.querySelector(modalId);
          console.info('Modal element found:', !!modal);
          if (modal) {
            // Entferne zuerst die inline styles
            modal.style.display = '';
            modal.style.opacity = '';
            modal.style.visibility = '';
            // Dann füge active Klasse hinzu
            modal.classList.add('active');
            console.info('Modal classes after open:', modal.className);
          }
        },
        closeModal: function (modalId) {
          const modal = document.querySelector(modalId);
          if (modal) {
            modal.classList.remove('active');
            // Entferne inline styles nach Animation
            setTimeout(() => {
              modal.style.display = '';
              modal.style.opacity = '';
              modal.style.visibility = '';
            }, 300);
          }
        },
        // showToast entfernt - verwendet jetzt den funktionierenden Fallback aus role-switch.ts
        formatDate: function (date) {
          if (!date) return '-';
          const d = new Date(date);
          return d.toLocaleDateString('de-DE');
        },
      };
    </script>
    <!-- Calendar Scripts -->

    <!-- MutationObserver zum Schutz der Header-Struktur -->
    <script>
      window.addEventListener('DOMContentLoaded', function () {
        const userInfoDiv = document.querySelector('#user-info');

        if (userInfoDiv) {
          // Speichere Referenzen zu den Original-Elementen
          const originalAvatar = document.querySelector('#user-avatar');
          const originalUserName = document.querySelector('#user-name');
          const originalRoleIndicator = document.querySelector('#role-indicator');

          function restoreElement(original, elementType, id, defaultContent, additionalSetup) {
            const element = original ? original.cloneNode(true) : document.createElement(elementType);
            element.id = id;
            if (defaultContent) {
              element.textContent = element.textContent || defaultContent;
            }
            if (additionalSetup) {
              additionalSetup(element);
            }
            return element;
          }

          function restoreUserInfoElements() {
            console.info('[Calendar] Restoring user-info elements');
            userInfoDiv.innerHTML = '';

            // Avatar wiederherstellen
            const newAvatar = restoreElement(originalAvatar, 'img', 'user-avatar', null, (el) => {
              el.src = '/assets/images/default-avatar.svg';
              el.alt = 'Avatar';
            });
            userInfoDiv.append(newAvatar);

            // Username wiederherstellen
            const newUserName = restoreElement(originalUserName, 'span', 'user-name', 'Lade...');
            userInfoDiv.append(newUserName);

            // Role Badge wiederherstellen
            const newRoleIndicator = restoreElement(originalRoleIndicator, 'span', 'role-indicator', 'Admin', (el) => {
              el.className = 'role-badge admin';
            });
            userInfoDiv.append(newRoleIndicator);
          }

          function checkUserInfoElements() {
            const currentAvatar = document.querySelector('#user-avatar');
            const currentUserName = document.querySelector('#user-name');
            const currentRoleIndicator = document.querySelector('#role-indicator');

            return !currentAvatar || !currentUserName || !currentRoleIndicator;
          }

          const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
              if (mutation.type !== 'childList' || mutation.target.id !== 'user-info') {
                return;
              }

              if (checkUserInfoElements()) {
                restoreUserInfoElements();
              }
            });
          });

          observer.observe(userInfoDiv, { childList: true, subtree: false });
        }
      });
    </script>

    <!-- Scripts in richtiger Reihenfolge -->
    <script type="module" src="/scripts/common.js"></script>
    <script type="module" src="/scripts/calendar/index.ts"></script>
    <!-- Unified Navigation -->
    <script type="module" src="/scripts/components/unified-navigation.ts"></script>
    <script type="module" src="/scripts/auth/role-switch.ts"></script>
    <!-- Breadcrumb -->
    <script type="module" src="/scripts/components/breadcrumb.js"></script>
  </body>
</html>
