<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Umfrage-Verwaltung - Assixx</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/styles/lib/fontawesome.min.css" />
    <!-- Font Awesome CDN als Fallback -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      @import url('/styles/dashboard-theme.css');
      /* Glassmorphismus Design-Standards */

      /* Dramatischer Hintergrund-Gradient */
      body {
        position: relative;
        min-height: 100vh;
        overflow-x: hidden;
        background: #000;
      }

      body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          135deg,
          transparent 0%,
          rgba(0, 142, 255, 0.08) 100%,
          #01000482 60%,
          rgba(0, 0, 4, 0.6) 90%,
          black 100%
        );
        pointer-events: none;
        z-index: -1;
      }

      /* Glassmorphismus für Header */
      .header {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(20px) saturate(180%);
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
      }

      /* Glassmorphismus für Sidebar */
      .sidebar {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(20px) saturate(180%);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow:
          8px 0 32px rgba(0, 0, 0, 0.3),
          inset -1px 0 0 rgba(255, 255, 255, 0.1);
      }

      /* Survey-specific styles */
      .survey-container {
        padding: var(--spacing-xl);
        max-width: 1400px;
        margin: 0 auto;
      }

      .survey-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-xl);
      }

      .survey-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      .survey-title i {
        color: var(--primary-color);
      }

      /* Survey Cards Grid */
      .surveys-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
      }

      .survey-card {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-lg);
        animation: fadeInUp 0.6s ease-out;
        padding: var(--spacing-lg);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .survey-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        border-color: var(--primary-color);
      }

      .survey-card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: var(--spacing-md);
      }

      .survey-card-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
      }

      .survey-status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
      }

      .survey-status.draft {
        background: rgba(255, 152, 0, 0.2);
        color: #ff9800;
      }

      .survey-status.active {
        background: rgba(76, 175, 80, 0.2);
        color: #4caf50;
      }

      .survey-status.closed {
        background: rgba(244, 67, 54, 0.2);
        color: #f44336;
      }

      .survey-status.archived {
        background: rgba(158, 158, 158, 0.2);
        color: #9e9e9e;
      }

      .survey-card-description {
        color: var(--text-secondary);
        margin-bottom: var(--spacing-md);
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .survey-stats {
        display: flex;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-md);
      }

      .survey-stat {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .survey-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
      }

      .survey-stat-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        text-transform: uppercase;
      }

      .survey-actions {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
      }

      .survey-action-btn {
        flex: 1;
        padding: var(--spacing-sm);
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
      }

      .survey-action-btn:hover {
        background: rgba(33, 150, 243, 0.2);
        border-color: var(--primary-color);
      }

      /* Create Survey Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(10px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-md);
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        animation: fadeInUp 0.3s ease-out;
        padding: 0;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--border-color);
      }

      .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--primary-color);
      }

      .close-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 1.5rem;
        cursor: pointer;
        padding: var(--spacing-xs);
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .close-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
      }

      .modal-content form {
        padding: var(--spacing-lg);
      }

      .modal-content .form-actions {
        padding: var(--spacing-lg);
        border-top: 1px solid var(--border-color);
        margin: 0 calc(-1 * var(--spacing-lg)) calc(-1 * var(--spacing-lg));
        background: rgba(255, 255, 255, 0.02);
      }

      /* Question Builder */
      .question-builder {
        margin-top: var(--spacing-lg);
      }

      .question-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-md);
        position: relative;
      }

      .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
      }

      .question-number {
        background: var(--primary-color);
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
      }

      .question-actions {
        display: flex;
        gap: var(--spacing-xs);
      }

      .question-action {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: var(--text-secondary);
        padding: var(--spacing-xs);
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .question-action:hover {
        background: rgba(255, 255, 255, 0.2);
        color: var(--text-primary);
      }

      .question-action.delete:hover {
        background: rgba(244, 67, 54, 0.2);
        color: #f44336;
      }

      /* Form Elements */
      .form-group {
        margin-bottom: var(--spacing-lg);
      }

      .form-label {
        display: block;
        margin-bottom: var(--spacing-sm);
        color: var(--text-primary);
        font-weight: 500;
      }

      .form-control {
        width: 100%;
        padding: var(--spacing-md);
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 1rem;
        transition: all 0.3s ease;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
      }

      textarea.form-control {
        min-height: 100px;
        resize: vertical;
      }

      select.form-control {
        cursor: pointer;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-sm);
      }

      .checkbox-group input[type='checkbox'] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      /* Options for multiple choice */
      .options-container {
        margin-top: var(--spacing-md);
      }

      .option-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-sm);
      }

      .option-input {
        flex: 1;
        padding: var(--spacing-sm) var(--spacing-md);
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
      }

      .remove-option {
        background: rgba(244, 67, 54, 0.2);
        border: none;
        color: #f44336;
        padding: var(--spacing-xs);
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .remove-option:hover {
        background: rgba(244, 67, 54, 0.3);
      }

      .add-option-btn {
        background: rgba(76, 175, 80, 0.2);
        border: none;
        color: #4caf50;
        padding: var(--spacing-sm) var(--spacing-md);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: 0.9rem;
      }

      .add-option-btn:hover {
        background: rgba(76, 175, 80, 0.3);
      }

      /* Action Buttons */
      .action-buttons {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-xl);
        justify-content: flex-end;
      }

      .btn {
        padding: var(--spacing-md) var(--spacing-xl);
        border-radius: var(--radius-md);
        border: none;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .btn-success {
        background: linear-gradient(135deg, #4caf50, #66bb6a);
        color: white;
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: var(--spacing-xl) * 2;
        color: var(--text-secondary);
      }

      .empty-state-icon {
        font-size: 4rem;
        margin-bottom: var(--spacing-lg);
        opacity: 0.5;
      }

      .empty-state-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-md);
      }

      .empty-state-description {
        max-width: 500px;
        margin: 0 auto var(--spacing-lg) auto;
        line-height: 1.6;
      }

      /* Templates Section */
      .templates-section {
        margin-top: var(--spacing-xl);
        padding-top: var(--spacing-xl);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .templates-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
      }

      .templates-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .template-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: var(--spacing-md);
      }

      .template-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .template-card:hover {
        background: rgba(33, 150, 243, 0.1);
        border-color: var(--primary-color);
        transform: translateY(-2px);
      }

      .template-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
      }

      .template-description {
        font-size: 0.9rem;
        color: var(--text-secondary);
        line-height: 1.4;
      }

      /* Custom Dropdowns */
      .custom-dropdown {
        position: relative;
        width: 100%;
      }

      .dropdown-display {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-md);
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: var(--radius-sm);
        color: #fff;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .dropdown-display:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .dropdown-display svg {
        transition: transform 0.3s ease;
      }

      .dropdown-display.active svg {
        transform: rotate(180deg);
      }

      .dropdown-options {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        background: rgba(18, 18, 18, 0.95);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: var(--radius-sm);
        box-shadow:
          0 8px 32px rgba(0, 0, 0, 0.4),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        max-height: 200px;
        overflow-y: auto;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        z-index: 1001;
      }

      .dropdown-options.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-option {
        padding: 10px 12px;
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.2s ease;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      .dropdown-option:last-child {
        border-bottom: none;
      }

      .dropdown-option:hover {
        background: rgba(33, 150, 243, 0.2);
        color: white;
        padding-left: 16px;
      }

      /* Scrollbar styling for dropdowns */
      .dropdown-options::-webkit-scrollbar {
        width: 6px;
      }

      .dropdown-options::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
      }

      .dropdown-options::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
      }

      .dropdown-options::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
      }
    </style>
    <link rel="stylesheet" href="/styles/user-info-update.css" />
  </head>
  <body>
    <header class="header">
      <a href="/admin-dashboard" class="logo-container">
        <img src="/assets/images/logo.png" alt="Assixx Logo" class="logo" />
      </a>
      <div class="header-actions">
        <div id="user-info">
          <img id="user-avatar" src="/assets/images/default-avatar.svg" alt="Avatar" />
          <span id="user-name">Lade...</span>
        </div>
        <button id="logout-btn" class="btn-logout" class="btn btn-secondary">
          <i class="fas fa-sign-out-alt"></i>
          Abmelden
        </button>
      </div>
    </header>

    <div class="layout-container">
      <aside class="sidebar">
        <!-- Navigation wird durch unified-navigation.js injiziert -->
      </aside>

      <main class="main-content">
        <div class="survey-container">
          <div class="survey-header">
            <h1 class="survey-title">
              <i class="fas fa-poll"></i>
              Umfrage-Verwaltung
            </h1>
            <button class="btn btn-primary" onclick="showCreateModal()">
              <i class="fas fa-plus"></i>
              Neue Umfrage
            </button>
          </div>

          <!-- Active Surveys -->
          <h2>Aktive Umfragen</h2>
          <div id="activeSurveys" class="surveys-grid">
            <!-- Surveys will be loaded here -->
          </div>

          <!-- Draft Surveys -->
          <h2 style="margin-top: var(--spacing-xl)">Entwürfe</h2>
          <div id="draftSurveys" class="surveys-grid">
            <!-- Draft surveys will be loaded here -->
          </div>

          <!-- Templates Section -->
          <div class="templates-section">
            <div class="templates-header">
              <h2 class="templates-title">Vorlagen</h2>
            </div>
            <div id="surveyTemplates" class="template-grid">
              <!-- Templates will be loaded here -->
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Create/Edit Survey Modal -->
    <div id="surveyModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modalTitle">Neue Umfrage erstellen</h2>
          <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>

        <form id="surveyForm">
          <div class="form-group">
            <label class="form-label">Titel der Umfrage</label>
            <input type="text" id="surveyTitle" class="form-control" required />
          </div>

          <div class="form-group">
            <label class="form-label">Beschreibung</label>
            <textarea id="surveyDescription" class="form-control"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Einstellungen</label>
            <div class="checkbox-group">
              <input type="checkbox" id="isAnonymous" />
              <label for="isAnonymous">Anonyme Umfrage (Antworten können nicht zu Mitarbeitern zurückverfolgt werden)</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="isMandatory" />
              <label for="isMandatory">Verpflichtende Teilnahme</label>
            </div>
            <p style="margin-top: var(--spacing-sm); color: var(--text-secondary); font-size: 0.85rem">
              <i class="fas fa-info-circle"></i>
              Bei anonymen Umfragen werden keine Benutzerdaten gespeichert. Sie können nicht sehen, wer geantwortet hat.
            </p>
          </div>

          <div class="form-group">
            <label class="form-label">Laufzeit</label>
            <div style="display: flex; gap: var(--spacing-md)">
              <div style="flex: 1">
                <label class="form-label" style="font-size: 0.9rem">Startdatum</label>
                <input type="datetime-local" id="startDate" class="form-control" />
              </div>
              <div style="flex: 1">
                <label class="form-label" style="font-size: 0.9rem">Enddatum</label>
                <input type="datetime-local" id="endDate" class="form-control" />
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Zielgruppe</label>
            <div class="custom-dropdown">
              <div class="dropdown-display" id="assignmentDropdownDisplay" onclick="toggleDropdown('assignmentDropdown')">
                <span>Alle Mitarbeiter</span>
                <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                  <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
              </div>
              <div class="dropdown-options" id="assignmentDropdownDropdown">
                <div class="dropdown-option" onclick="selectAssignmentOption('all_users', 'Alle Mitarbeiter')">Alle Mitarbeiter</div>
                <div class="dropdown-option" onclick="selectAssignmentOption('department', 'Bestimmte Abteilung')">Bestimmte Abteilung</div>
                <div class="dropdown-option" onclick="selectAssignmentOption('team', 'Bestimmtes Team')">Bestimmtes Team</div>
                <div class="dropdown-option" onclick="selectAssignmentOption('individual', 'Einzelne Mitarbeiter')">
                  Einzelne Mitarbeiter
                </div>
              </div>
              <input type="hidden" id="assignmentType" value="all_users" />
            </div>
          </div>

          <div class="question-builder">
            <h3 style="margin-bottom: var(--spacing-md)">Fragen</h3>
            <div id="questionsList">
              <!-- Questions will be added here -->
            </div>
            <button type="button" class="btn btn-secondary" onclick="addQuestion()">
              <i class="fas fa-plus"></i>
              Frage hinzufügen
            </button>
          </div>

          <div class="action-buttons">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Abbrechen</button>
            <button type="button" class="btn btn-primary" onclick="saveSurvey('draft')">
              <i class="fas fa-save"></i>
              Als Entwurf speichern
            </button>
            <button type="button" class="btn btn-success" onclick="saveSurvey('active')">
              <i class="fas fa-paper-plane"></i>
              Umfrage starten
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module" src="/scripts/components/unified-navigation.ts"></script>
    <script>
      let currentSurveyId = null;
      let questionCounter = 0;

      // Initialize
      document.addEventListener('DOMContentLoaded', function () {
        loadSurveys();
        loadTemplates();
      });

      // Custom dropdown functions
      function toggleDropdown(dropdownId) {
        const dropdown = document.getElementById(dropdownId + 'Dropdown');
        const display = document.getElementById(dropdownId + 'Display');

        // Close all other dropdowns
        document.querySelectorAll('.dropdown-options').forEach((d) => {
          if (d !== dropdown) {
            d.classList.remove('active');
          }
        });
        document.querySelectorAll('.dropdown-display').forEach((d) => {
          if (d !== display) {
            d.classList.remove('active');
          }
        });

        dropdown.classList.toggle('active');
        display.classList.toggle('active');
      }

      function selectAssignmentOption(value, text) {
        document.getElementById('assignmentType').value = value;
        document.getElementById('assignmentDropdownDisplay').querySelector('span').textContent = text;
        document.getElementById('assignmentDropdownDropdown').classList.remove('active');
        document.getElementById('assignmentDropdownDisplay').classList.remove('active');
      }

      function selectQuestionType(questionId, type, text) {
        document.getElementById(questionId + '_typeValue').value = type;
        document.getElementById(questionId + '_typeDisplay').querySelector('span').textContent = text;
        document.getElementById(questionId + '_typeDropdown').classList.remove('active');
        document.getElementById(questionId + '_typeDisplay').classList.remove('active');
        handleQuestionTypeChange(questionId, type);
      }

      // Close dropdowns when clicking outside
      document.addEventListener('click', function (event) {
        if (!event.target.closest('.custom-dropdown')) {
          document.querySelectorAll('.dropdown-options').forEach((d) => {
            d.classList.remove('active');
          });
          document.querySelectorAll('.dropdown-display').forEach((d) => {
            d.classList.remove('active');
          });
        }
      });

      // Load surveys
      async function loadSurveys() {
        try {
          const response = await fetch('/api/surveys', {
            headers: {
              Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
          });

          if (response.ok) {
            const surveys = await response.json();
            displaySurveys(surveys);
          }
        } catch (error) {
          console.error('Error loading surveys:', error);
        }
      }

      // Display surveys
      function displaySurveys(surveys) {
        const activeSurveys = surveys.filter((s) => s.status === 'active');
        const draftSurveys = surveys.filter((s) => s.status === 'draft');

        const activeContainer = document.getElementById('activeSurveys');
        const draftContainer = document.getElementById('draftSurveys');

        activeContainer.innerHTML =
          activeSurveys.length > 0
            ? activeSurveys.map((survey) => createSurveyCard(survey)).join('')
            : '<div class="empty-state"><p>Keine aktiven Umfragen</p></div>';

        draftContainer.innerHTML =
          draftSurveys.length > 0
            ? draftSurveys.map((survey) => createSurveyCard(survey)).join('')
            : '<div class="empty-state"><p>Keine Entwürfe vorhanden</p></div>';
      }

      // Helper function to convert Buffer to text
      function getTextFromBuffer(value) {
        if (typeof value === 'string') {
          return value;
        }
        if (value && value.type === 'Buffer' && Array.isArray(value.data)) {
          return String.fromCharCode.apply(null, value.data);
        }
        if (value && typeof value === 'object') {
          return ''; // Return empty string for other objects
        }
        return value || '';
      }

      // Create survey card
      function createSurveyCard(survey) {
        const responseRate = survey.response_count > 0 ? Math.round((survey.completed_count / survey.response_count) * 100) : 0;

        return `
                <div class="survey-card" onclick="viewSurvey(${survey.id})">
                    <div class="survey-card-header">
                        <h3 class="survey-card-title">${getTextFromBuffer(survey.title)}</h3>
                        <span class="survey-status ${survey.status}">${getStatusText(survey.status)}</span>
                    </div>
                    <p class="survey-card-description">${getTextFromBuffer(survey.description) || 'Keine Beschreibung'}</p>
                    <div class="survey-stats">
                        <div class="survey-stat">
                            <span class="survey-stat-value">${survey.response_count}</span>
                            <span class="survey-stat-label">Antworten</span>
                        </div>
                        <div class="survey-stat">
                            <span class="survey-stat-value">${responseRate}%</span>
                            <span class="survey-stat-label">Abschlussrate</span>
                        </div>
                    </div>
                    <div class="survey-actions">
                        <button class="survey-action-btn" onclick="event.stopPropagation(); editSurvey(${survey.id})">
                            <i class="fas fa-edit"></i>
                            Bearbeiten
                        </button>
                        <button class="survey-action-btn" onclick="event.stopPropagation(); viewResults(${survey.id})">
                            <i class="fas fa-chart-bar"></i>
                            Ergebnisse
                        </button>
                        <button class="survey-action-btn" onclick="event.stopPropagation(); deleteSurvey(${survey.id})">
                            <i class="fas fa-trash"></i>
                            Löschen
                        </button>
                    </div>
                </div>
            `;
      }

      // Load templates
      async function loadTemplates() {
        try {
          const response = await fetch('/api/surveys/templates', {
            headers: {
              Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
          });

          if (response.ok) {
            const templates = await response.json();
            displayTemplates(templates);
          }
        } catch (error) {
          console.error('Error loading templates:', error);
        }
      }

      // Display templates
      function displayTemplates(templates) {
        const container = document.getElementById('surveyTemplates');
        container.innerHTML = templates
          .map(
            (template) => `
                <div class="template-card" onclick="createFromTemplate(${template.id})">
                    <h4 class="template-name">${template.name}</h4>
                    <p class="template-description">${template.description}</p>
                </div>
            `,
          )
          .join('');
      }

      // Create from template
      async function createFromTemplate(templateId) {
        if (confirm('Möchten Sie eine neue Umfrage basierend auf dieser Vorlage erstellen?')) {
          try {
            const response = await fetch(`/api/surveys/from-template/${templateId}`, {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${localStorage.getItem('token')}`,
              },
            });

            if (response.ok) {
              const result = await response.json();
              alert('Umfrage wurde aus Vorlage erstellt');
              loadSurveys();
            }
          } catch (error) {
            console.error('Error creating from template:', error);
            alert('Fehler beim Erstellen der Umfrage');
          }
        }
      }

      // Show create modal
      function showCreateModal() {
        currentSurveyId = null;
        document.getElementById('modalTitle').textContent = 'Neue Umfrage erstellen';
        document.getElementById('surveyForm').reset();
        document.getElementById('questionsList').innerHTML = '';
        questionCounter = 0;
        addQuestion(); // Add first question by default
        document.getElementById('surveyModal').style.display = 'flex';
      }

      // Close modal
      function closeModal() {
        document.getElementById('surveyModal').style.display = 'none';
      }

      // Add question
      function addQuestion() {
        questionCounter++;
        const questionId = `question_${questionCounter}`;
        const questionHtml = `
                <div class="question-item" id="${questionId}">
                    <div class="question-header">
                        <span class="question-number">${questionCounter}</span>
                        <div class="question-actions">
                            <button type="button" class="question-action delete" onclick="removeQuestion('${questionId}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Fragetext eingeben..." required>
                    </div>
                    <div class="form-group">
                        <div class="custom-dropdown">
                            <div class="dropdown-display" id="${questionId}_typeDisplay" onclick="toggleDropdown('${questionId}_type')">
                                <span>Textantwort</span>
                                <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                                    <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="dropdown-options" id="${questionId}_typeDropdown">
                                <div class="dropdown-option" onclick="selectQuestionType('${questionId}', 'text', 'Textantwort')">Textantwort</div>
                                <div class="dropdown-option" onclick="selectQuestionType('${questionId}', 'single_choice', 'Einzelauswahl')">Einzelauswahl</div>
                                <div class="dropdown-option" onclick="selectQuestionType('${questionId}', 'multiple_choice', 'Mehrfachauswahl')">Mehrfachauswahl</div>
                                <div class="dropdown-option" onclick="selectQuestionType('${questionId}', 'rating', 'Bewertung (1-5)')">Bewertung (1-5)</div>
                                <div class="dropdown-option" onclick="selectQuestionType('${questionId}', 'yes_no', 'Ja/Nein')">Ja/Nein</div>
                                <div class="dropdown-option" onclick="selectQuestionType('${questionId}', 'number', 'Zahl')">Zahl</div>
                                <div class="dropdown-option" onclick="selectQuestionType('${questionId}', 'date', 'Datum')">Datum</div>
                            </div>
                            <input type="hidden" id="${questionId}_typeValue" value="text" />
                        </div>
                    </div>
                    <div class="options-container" id="${questionId}_options" style="display: none;">
                        <!-- Options will be added here for choice questions -->
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="${questionId}_required" checked>
                        <label for="${questionId}_required">Pflichtfrage</label>
                    </div>
                </div>
            `;
        document.getElementById('questionsList').insertAdjacentHTML('beforeend', questionHtml);
      }

      // Handle question type change
      function handleQuestionTypeChange(questionId, type) {
        const optionsContainer = document.getElementById(`${questionId}_options`);

        if (type === 'single_choice' || type === 'multiple_choice') {
          optionsContainer.style.display = 'block';
          optionsContainer.innerHTML = `
                    <div id="${questionId}_option_list">
                        <div class="option-item">
                            <input type="text" class="option-input" placeholder="Option 1">
                            <button type="button" class="remove-option" onclick="removeOption(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="option-item">
                            <input type="text" class="option-input" placeholder="Option 2">
                            <button type="button" class="remove-option" onclick="removeOption(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="add-option-btn" onclick="addOption('${questionId}')">
                        <i class="fas fa-plus"></i>
                        Option hinzufügen
                    </button>
                `;
        } else {
          optionsContainer.style.display = 'none';
          optionsContainer.innerHTML = '';
        }
      }

      // Add option
      function addOption(questionId) {
        const optionList = document.getElementById(`${questionId}_option_list`);
        const optionCount = optionList.children.length + 1;
        const optionHtml = `
                <div class="option-item">
                    <input type="text" class="option-input" placeholder="Option ${optionCount}">
                    <button type="button" class="remove-option" onclick="removeOption(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        optionList.insertAdjacentHTML('beforeend', optionHtml);
      }

      // Remove option
      function removeOption(button) {
        button.parentElement.remove();
      }

      // Remove question
      function removeQuestion(questionId) {
        document.getElementById(questionId).remove();
        updateQuestionNumbers();
      }

      // Update question numbers
      function updateQuestionNumbers() {
        const questions = document.querySelectorAll('.question-item');
        questions.forEach((question, index) => {
          question.querySelector('.question-number').textContent = index + 1;
        });
      }

      // Save survey
      async function saveSurvey(status) {
        const surveyData = {
          title: document.getElementById('surveyTitle').value,
          description: document.getElementById('surveyDescription').value,
          is_anonymous: document.getElementById('isAnonymous').checked,
          is_mandatory: document.getElementById('isMandatory').checked,
          start_date: document.getElementById('startDate').value || null,
          end_date: document.getElementById('endDate').value || null,
          status: status,
          questions: getQuestionsData(),
          assignments: [
            {
              type: document.getElementById('assignmentType').value,
            },
          ],
        };

        try {
          const url = currentSurveyId ? `/api/surveys/${currentSurveyId}` : '/api/surveys';
          const method = currentSurveyId ? 'PUT' : 'POST';

          const response = await fetch(url, {
            method: method,
            headers: {
              Authorization: `Bearer ${localStorage.getItem('token')}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(surveyData),
          });

          if (response.ok) {
            alert('Umfrage erfolgreich gespeichert');
            closeModal();
            loadSurveys();
          } else {
            const error = await response.json();
            alert('Fehler: ' + error.error);
          }
        } catch (error) {
          console.error('Error saving survey:', error);
          alert('Fehler beim Speichern der Umfrage');
        }
      }

      // Get questions data
      function getQuestionsData() {
        const questions = [];
        const questionElements = document.querySelectorAll('.question-item');

        questionElements.forEach((element, index) => {
          const questionText = element.querySelector('input[type="text"]').value;
          const questionTypeInput = element.querySelector('input[type="hidden"][id$="_typeValue"]');
          const questionType = questionTypeInput ? questionTypeInput.value : 'text';
          const isRequired = element.querySelector('input[type="checkbox"]').checked;

          const question = {
            question_text: questionText,
            question_type: questionType,
            is_required: isRequired,
            order_position: index + 1,
          };

          // Get options for choice questions
          if (questionType === 'single_choice' || questionType === 'multiple_choice') {
            const options = [];
            element.querySelectorAll('.option-input').forEach((input) => {
              if (input.value.trim()) {
                options.push(input.value.trim());
              }
            });
            question.options = options;
          }

          questions.push(question);
        });

        return questions;
      }

      // Get status text
      function getStatusText(status) {
        const statusTexts = {
          draft: 'Entwurf',
          active: 'Aktiv',
          closed: 'Geschlossen',
          archived: 'Archiviert',
        };
        return statusTexts[status] || status;
      }

      // View survey
      function viewSurvey(surveyId) {
        window.location.href = `/survey-details?id=${surveyId}`;
      }

      // Edit survey
      async function editSurvey(surveyId) {
        // Load survey data and populate form
        try {
          const response = await fetch(`/api/surveys/${surveyId}`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
          });

          if (response.ok) {
            const survey = await response.json();
            populateSurveyForm(survey);
            currentSurveyId = surveyId;
            document.getElementById('modalTitle').textContent = 'Umfrage bearbeiten';
            document.getElementById('surveyModal').style.display = 'flex';
          }
        } catch (error) {
          console.error('Error loading survey:', error);
          alert('Fehler beim Laden der Umfrage');
        }
      }

      // View results
      function viewResults(surveyId) {
        window.location.href = `/survey-results?id=${surveyId}`;
      }

      // Delete survey
      async function deleteSurvey(surveyId) {
        if (confirm('Möchten Sie diese Umfrage wirklich löschen?')) {
          try {
            const response = await fetch(`/api/surveys/${surveyId}`, {
              method: 'DELETE',
              headers: {
                Authorization: `Bearer ${localStorage.getItem('token')}`,
              },
            });

            if (response.ok) {
              alert('Umfrage erfolgreich gelöscht');
              loadSurveys();
            }
          } catch (error) {
            console.error('Error deleting survey:', error);
            alert('Fehler beim Löschen der Umfrage');
          }
        }
      }

      // Populate survey form (for editing)
      function populateSurveyForm(survey) {
        // Handle title (might be Buffer)
        document.getElementById('surveyTitle').value = getTextFromBuffer(survey.title);

        // Handle description (might be Buffer)
        document.getElementById('surveyDescription').value = getTextFromBuffer(survey.description);

        // Handle boolean fields (might be strings)
        document.getElementById('isAnonymous').checked =
          survey.is_anonymous === '1' || survey.is_anonymous === 1 || survey.is_anonymous === true;

        document.getElementById('isMandatory').checked =
          survey.is_mandatory === '1' || survey.is_mandatory === 1 || survey.is_mandatory === true;
        document.getElementById('startDate').value = survey.start_date ? new Date(survey.start_date).toISOString().slice(0, 16) : '';
        document.getElementById('endDate').value = survey.end_date ? new Date(survey.end_date).toISOString().slice(0, 16) : '';

        // Clear existing questions
        document.getElementById('questionsList').innerHTML = '';
        questionCounter = 0;

        // Add questions
        survey.questions.forEach((question) => {
          addQuestion();
          const questionElement = document.querySelector('.question-item:last-child');
          // Set question text
          questionElement.querySelector('input[type="text"]').value = getTextFromBuffer(question.question_text);

          // Set question type using custom dropdown
          const typeInput = questionElement.querySelector('input[type="hidden"][id$="_typeValue"]');
          if (typeInput) {
            typeInput.value = question.question_type;
            // Update dropdown display
            const typeDisplay = questionElement.querySelector('[id$="_typeDisplay"] span');
            if (typeDisplay) {
              const typeLabels = {
                text: 'Textantwort',
                single_choice: 'Einzelauswahl',
                multiple_choice: 'Mehrfachauswahl',
                rating: 'Bewertung (1-5)',
                yes_no: 'Ja/Nein',
                number: 'Zahl',
                date: 'Datum',
              };
              typeDisplay.textContent = typeLabels[question.question_type] || 'Textantwort';
            }
          }

          // Set required checkbox
          const requiredCheckbox = questionElement.querySelector('input[type="checkbox"]');
          if (requiredCheckbox) {
            requiredCheckbox.checked = question.is_required === '1' || question.is_required === 1 || question.is_required === true;
          }

          // Handle options
          if (question.options && question.options.length > 0) {
            handleQuestionTypeChange(`question_${questionCounter}`, question.question_type);
            const optionsList = questionElement.querySelector(`#question_${questionCounter}_option_list`);
            optionsList.innerHTML = '';

            question.options.forEach((option) => {
              // Handle option text (might be string or object)
              const optionText = typeof option === 'string' ? option : option.option_text || '';

              const optionHtml = `
                            <div class="option-item">
                                <input type="text" class="option-input" value="${optionText}">
                                <button type="button" class="remove-option" onclick="removeOption(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
              optionsList.insertAdjacentHTML('beforeend', optionHtml);
            });
          }
        });
      }
    </script>
    <!-- Header User Info Loading -->
    <script type="module" src="/scripts/header-user-info.ts"></script>
  </body>
</html>
