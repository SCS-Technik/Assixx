<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Umfrage-Verwaltung - Assixx</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- Critical Layout State - Prevents Layout Shift -->
    <script>
      // Set sidebar state IMMEDIATELY to prevent any layout shift
      (function () {
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        document.documentElement.setAttribute('data-sidebar', sidebarCollapsed ? 'collapsed' : 'expanded');
        // Also set CSS custom properties for immediate use
        document.documentElement.style.setProperty('--sidebar-width', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--content-margin', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--grid-columns', sidebarCollapsed ? '4' : '3');
        document.documentElement.style.setProperty('--widget-columns', sidebarCollapsed ? '5' : '3');
        document.documentElement.style.setProperty('--card-padding', sidebarCollapsed ? '2rem' : '1.5rem');
      })();
    </script>
    <script src="/feature-flags.js"></script>

    <!-- Unified Navigation CSS - Load immediately to prevent FOUC -->
    <link id="unified-navigation-styles" rel="stylesheet" href="/styles/unified-navigation.css" />
    <link rel="stylesheet" href="/styles/lib/fontawesome.min.css" />
    <!-- Font Awesome CDN als Fallback -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <!-- CSS Styles -->
    <link rel="stylesheet" href="/styles/dashboard-theme.css" />
    <link rel="stylesheet" href="/styles/breadcrumb-alignment.css" />
    <link rel="stylesheet" href="/styles/survey-admin.css" />
    <link rel="stylesheet" href="/styles/user-info-update.css" />
  </head>
  <body>
    <!-- Unified Navigation -->
    <div id="navigation-container"></div>

    <!-- Main Layout with Sidebar -->
    <div class="layout-container">
      <main class="main-content">
        <!-- Breadcrumb -->
        <div id="breadcrumb-container"></div>

        <div class="container">
          <div class="card">
            <div class="card-header">
              <div>
                <h2 class="card-title">Umfrage-Verwaltung</h2>
                <p class="text-secondary">Erstellen und verwalten Sie Mitarbeiterumfragen</p>
              </div>
            </div>
            <div class="card-body">
              <!-- Active Surveys -->
              <h2>Aktive Umfragen</h2>
              <div id="activeSurveys" class="surveys-grid">
                <!-- Surveys will be loaded here -->
              </div>

              <!-- Draft Surveys -->
              <div class="drafts-section">
                <div class="drafts-header">
                  <h2 class="drafts-title">Entwürfe</h2>
                </div>
                <div id="draftSurveys" class="surveys-grid">
                  <!-- Draft surveys will be loaded here -->
                </div>
              </div>

              <!-- Templates Section -->
              <div class="templates-section">
                <div class="templates-header">
                  <h2 class="templates-title">Vorlagen</h2>
                </div>
                <div id="surveyTemplates" class="template-grid">
                  <!-- Templates will be loaded here -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Create/Edit Survey Modal -->
    <div id="surveyModal" class="modal">
      <div class="modal-content modal-container">
        <div class="modal-header">
          <h2 class="modal-title" id="modalTitle">Neue Umfrage erstellen</h2>
          <button class="close-btn" data-action="close">&times;</button>
        </div>

        <form id="surveyForm">
          <div class="form-group">
            <label class="form-label">Titel der Umfrage</label>
            <input type="text" id="surveyTitle" class="form-control" required />
          </div>

          <div class="form-group">
            <label class="form-label">Beschreibung</label>
            <textarea id="surveyDescription" class="form-control"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Einstellungen</label>
            <div class="checkbox-group">
              <input type="checkbox" id="isAnonymous" />
              <label for="isAnonymous">Anonyme Umfrage (Antworten können nicht zu Mitarbeitern zurückverfolgt werden)</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="isMandatory" />
              <label for="isMandatory">Verpflichtende Teilnahme</label>
            </div>
            <p style="margin-top: var(--spacing-sm); color: var(--text-secondary); font-size: 0.85rem">
              <i class="fas fa-info-circle"></i>
              Bei anonymen Umfragen werden keine Benutzerdaten gespeichert. Sie können nicht sehen, wer geantwortet hat.
            </p>
          </div>

          <div class="form-group">
            <label class="form-label">Laufzeit</label>
            <div style="display: flex; gap: var(--spacing-md)">
              <div class="u-flex-1">
                <label class="form-label" class="u-fs-09rem">Startdatum</label>
                <input type="datetime-local" id="startDate" class="form-control" />
              </div>
              <div class="u-flex-1">
                <label class="form-label" class="u-fs-09rem">Enddatum</label>
                <input type="datetime-local" id="endDate" class="form-control" />
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Zielgruppe</label>
            <div class="custom-dropdown">
              <div class="dropdown-display" id="assignmentDropdownDisplay" data-action="toggle-dropdown" data-dropdown="assignmentDropdown">
                <span>Ganze Firma</span>
                <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                  <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
              </div>
              <div class="dropdown-options" id="assignmentDropdownDropdown">
                <div class="dropdown-option" data-action="select-assignment" data-value="all_users" data-text="Ganze Firma">
                  Ganze Firma
                </div>
                <div class="dropdown-option" data-action="select-assignment" data-value="department" data-text="Abteilung">Abteilung</div>
                <div class="dropdown-option" data-action="select-assignment" data-value="team" data-text="Team">Team</div>
              </div>
              <input type="hidden" id="assignmentType" value="all_users" />
            </div>
          </div>

          <!-- Department Selection (hidden by default) -->
          <div class="form-group u-hidden" id="departmentSelection">
            <label class="form-label">Abteilungen auswählen</label>
            <select
              id="departmentSelect"
              multiple
              class="form-control"
              style="min-height: 120px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1)"
            >
              <!-- Department options will be loaded here -->
            </select>
            <small class="form-text" style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block">
              Halten Sie Strg/Cmd gedrückt für Mehrfachauswahl
            </small>
          </div>

          <!-- Team Selection (hidden by default) -->
          <div class="form-group u-hidden" id="teamSelection">
            <label class="form-label">Teams auswählen</label>
            <select
              id="teamSelect"
              multiple
              class="form-control"
              style="min-height: 120px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1)"
            >
              <!-- Team options will be loaded here -->
            </select>
            <small class="form-text" style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block">
              Halten Sie Strg/Cmd gedrückt für Mehrfachauswahl
            </small>
          </div>

          <div class="question-builder">
            <h3 style="margin-bottom: var(--spacing-md)">Fragen</h3>
            <div id="questionsList">
              <!-- Questions will be added here -->
            </div>
            <button type="button" class="btn btn-secondary" data-action="add-question">
              <i class="fas fa-plus"></i>
              Frage hinzufügen
            </button>
          </div>

          <div class="action-buttons">
            <button type="button" class="btn btn-secondary" data-action="close">Abbrechen</button>
            <button type="button" class="btn btn-primary" data-action="save-survey" data-status="draft">
              <i class="fas fa-save"></i>
              Als Entwurf speichern
            </button>
            <button type="button" class="btn btn-success" data-action="save-survey" data-status="active">
              <i class="fas fa-paper-plane"></i>
              Umfrage starten
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Floating Add Button -->
    <button class="add-survey-btn" data-action="show-create-modal">+</button>

    <script type="module" src="/scripts/auth.js"></script>
    <script type="module" src="/scripts/components/unified-navigation.ts"></script>
    <script type="module" src="/scripts/role-switch.ts"></script>
    <!-- Breadcrumb -->
    <script type="module" src="/scripts/components/breadcrumb.js"></script>

    <!-- Survey Admin Module -->
    <script type="module" src="/scripts/survey-admin.ts"></script>

    <script type="module">
      import { modalManager } from '/scripts/utils/modal-manager.ts';

      // Make modalManager available globally
      window.modalManager = modalManager;

      // Event Delegation for HTML-specific actions
      document.addEventListener('click', function (e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;

        switch (action) {
          case 'toggle-dropdown': {
            const dropdown = target.dataset.dropdown;
            if (window.surveyAdmin && window.surveyAdmin.toggleDropdown) {
              window.surveyAdmin.toggleDropdown(dropdown);
            }
            break;
          }
          case 'select-assignment': {
            const value = target.dataset.value;
            const text = target.dataset.text;
            if (window.surveyAdmin && window.surveyAdmin.selectAssignmentOption) {
              window.surveyAdmin.selectAssignmentOption(value, text);
            }
            break;
          }
          case 'add-question':
            if (window.surveyAdmin && window.surveyAdmin.addQuestion) {
              window.surveyAdmin.addQuestion();
            }
            break;
          case 'save-survey': {
            const status = target.dataset.status;
            if (window.surveyAdmin && window.surveyAdmin.saveSurvey) {
              window.surveyAdmin.saveSurvey(status);
            }
            break;
          }
          case 'show-create-modal':
            if (window.surveyAdmin && window.surveyAdmin.showCreateModal) {
              window.surveyAdmin.showCreateModal();
            }
            break;
        }
      });
    </script>
  </body>
</html>
