<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kontoeinstellungen - Assixx</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- Critical Layout State - Prevents Layout Shift -->
    <script>
      // Set sidebar state IMMEDIATELY to prevent any layout shift
      (function () {
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        document.documentElement.setAttribute('data-sidebar', sidebarCollapsed ? 'collapsed' : 'expanded');
        // Also set CSS custom properties for immediate use
        document.documentElement.style.setProperty('--sidebar-width', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--content-margin', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--grid-columns', sidebarCollapsed ? '4' : '3');
        document.documentElement.style.setProperty('--widget-columns', sidebarCollapsed ? '5' : '3');
        document.documentElement.style.setProperty('--card-padding', sidebarCollapsed ? '2rem' : '1.5rem');
      })();
    </script>
    <script src="/feature-flags.js"></script>

    <!-- Unified Navigation CSS - Load immediately to prevent FOUC -->
    <link id="unified-navigation-styles" rel="stylesheet" href="/styles/unified-navigation.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="/styles/lib/fontawesome.min.css" />

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet" />

    <!-- Dashboard Theme - WICHTIG: Enthält alle Base-Styles und CSS-Variablen -->
    <link rel="stylesheet" href="/styles/dashboard-theme.css" />

    <!-- Additional Styles -->
    <link rel="stylesheet" href="/styles/breadcrumb-alignment.css" />
    <link rel="stylesheet" href="/styles/user-info-update.css" />
    <link rel="stylesheet" href="/styles/account-settings.css" />

    <!-- Dom-utils Module für sichere HTML-Sanitization -->
    <script type="module">
      import { setHTML } from '/utils/dom-utils.js';
      // Make setHTML globally available for inline scripts
      window.setHTML = setHTML;
    </script>
  </head>
  <body>
    <!-- Unified Navigation -->
    <div id="navigation-container"></div>

    <!-- Main Layout with Sidebar -->
    <div class="layout-container">
      <!-- Main Content Area -->
      <main class="main-content">
        <!-- Breadcrumb Navigation -->
        <div id="breadcrumb-container"></div>

        <div class="container">
          <div class="settings-container">
            <!-- Danger Zone Card -->
            <div class="settings-card" style="border-color: rgba(244, 67, 54, 0.3)">
              <h2 class="card-title text-danger">Gefahrenzone</h2>
              <div style="padding: 24px; background: rgba(244, 67, 54, 0.05); border-radius: var(--radius-sm); margin-bottom: 20px">
                <p class="text-danger" style="margin-bottom: 16px">
                  <i class="fas fa-exclamation-triangle"></i>
                  <strong>Achtung:</strong>
                  Diese Aktion kann nicht rückgängig gemacht werden!
                </p>
                <p class="text-secondary" style="margin-bottom: 20px">
                  Durch das Löschen Ihres Tenants werden
                  <strong>ALLE</strong>
                  Daten unwiderruflich gelöscht:
                </p>
                <ul class="text-secondary" style="margin-bottom: 20px; padding-left: 20px">
                  <li>Alle Administratoren und Mitarbeiter</li>
                  <li>Alle Dokumente und Dateien</li>
                  <li>Alle Nachrichten und Chats</li>
                  <li>Alle Einstellungen und Konfigurationen</li>
                  <li>Die gesamte Firmenstruktur</li>
                </ul>
                <div class="button-group">
                  <button class="btn btn-danger" data-action="show-delete-modal">
                    <i class="fas fa-trash-alt"></i>
                    Tenant komplett löschen
                  </button>
                  <button
                    id="deletionStatusButton"
                    class="btn btn-info u-hidden"
                    data-action="navigate"
                    data-href="/tenant-deletion-status"
                  >
                    <i class="fas fa-tasks"></i>
                    Löschstatus anzeigen
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <i class="fas fa-exclamation-triangle fa-2x"></i>
          <h3>Tenant unwiderruflich löschen</h3>
        </div>

        <div class="modal-body">
          <div class="warning-box">
            <p class="text-danger u-mb-12" style="font-weight: bold">
              <i class="fas fa-skull-crossbones"></i>
              LETZTE WARNUNG!
            </p>
            <p class="text-primary">Sie sind dabei, Ihren gesamten Tenant zu löschen. Diese Aktion:</p>
            <ul class="text-primary" style="margin: 12px 0; padding-left: 20px">
              <li>Löscht ALLE Benutzer (Admins und Mitarbeiter)</li>
              <li>Löscht ALLE Daten und Dokumente</li>
              <li>Löscht ALLE Einstellungen</li>
              <li>Kann NICHT rückgängig gemacht werden</li>
            </ul>
          </div>

          <div class="confirmation-input">
            <p class="text-secondary u-mb-12">
              Geben Sie zur Bestätigung
              <strong class="text-danger">LÖSCHEN</strong>
              ein:
            </p>
            <input
              type="text"
              id="deleteConfirmation"
              class="form-control"
              placeholder="Geben Sie LÖSCHEN ein"
              style="border-color: rgba(244, 67, 54, 0.3)"
            />
          </div>

          <div class="form-group">
            <label for="deleteReason" class="text-secondary u-mb-8" style="display: block">Grund für die Löschung (optional):</label>
            <textarea
              id="deleteReason"
              class="form-control"
              rows="3"
              placeholder="Bitte geben Sie einen Grund an..."
              style="
                width: 100%;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                color: var(--text-primary);
                padding: 12px;
                border-radius: var(--radius-sm);
              "
            ></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-action="close-delete-modal">
            <i class="fas fa-times"></i>
            Abbrechen
          </button>
          <button class="btn btn-danger" id="confirmDeleteBtn" data-action="delete-tenant" disabled>
            <i class="fas fa-trash-alt"></i>
            Endgültig löschen
          </button>
        </div>
      </div>
    </div>

    <!-- Deletion Status Modal -->
    <div id="deletionStatusModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <i class="fas fa-hourglass-half fa-2x text-primary"></i>
          <h3 class="text-primary">Tenant wird zur Löschung vorbereitet</h3>
        </div>

        <div class="deletion-status-content">
          <div class="deletion-status-icon">
            <i class="fas fa-shield-alt"></i>
          </div>

          <h4 class="text-primary" style="margin-bottom: 16px">Zwei-Personen-Prinzip aktiv</h4>

          <div class="deletion-info">
            <p>
              <strong>Status:</strong>
              Warte auf Genehmigung
            </p>
            <p>
              <strong>Queue ID:</strong>
              <span id="queueIdDisplay">-</span>
            </p>
            <p>
              <strong>Tenant ID:</strong>
              <span id="tenantIdDisplay">-</span>
            </p>
            <p>
              <strong>Geplante Löschung:</strong>
              <span id="scheduledDateDisplay">-</span>
            </p>
          </div>

          <p class="text-secondary" style="margin: 20px 0">
            Die Löschung muss von einem zweiten Root-Benutzer genehmigt werden. Nach der Genehmigung beginnt eine 30-tägige Nachfrist.
          </p>

          <div class="button-group" style="justify-content: center">
            <button class="btn btn-secondary" data-action="close-status-modal">
              <i class="fas fa-times"></i>
              Schließen
            </button>
            <button class="btn btn-info" data-action="navigate" data-href="/tenant-deletion-status">
              <i class="fas fa-external-link-alt"></i>
              Zum Löschstatus
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Font Awesome für Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <!-- JavaScript -->
    <script type="module" src="/scripts/components/unified-navigation.ts"></script>
    <script type="module" src="/scripts/role-switch.ts"></script>
    <script type="module">
      import { fetchWithAuth, showError } from '/scripts/auth.js';
      import { showErrorAlert } from '/scripts/utils/alerts.js';

      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login';
      }

      // Helper to check if deletion data indicates active request
      function hasActiveDeletion(data) {
        if (!data) return false;
        if (Array.isArray(data)) return data.length > 0;
        return data.queueId || data.id || data.data;
      }

      // Check for pending deletion status on page load
      async function checkDeletionStatus() {
        try {
          const useV2Root = window.FEATURE_FLAGS?.USE_API_V2_ROOT;
          const endpoint = useV2Root ? '/api/v2/root/tenant/deletion-status' : '/api/root/tenant/deletion-status';
          const response = await fetchWithAuth(endpoint);

          if (!response.ok) return;

          const data = await response.json();
          if (!hasActiveDeletion(data)) return;

          const button = document.querySelector('#deletionStatusButton');
          if (button) {
            button.classList.remove('u-hidden');
          }
        } catch (error) {
          // Silent fail - button stays hidden if API fails
          console.info('No pending deletion found');
        }
      }

      // Check deletion status when page loads
      document.addEventListener('DOMContentLoaded', () => {
        checkDeletionStatus();
      });

      // Action handlers map - using Map to avoid object injection warnings
      const actionHandlers = new Map([
        ['show-delete-modal', () => window.showDeleteModal?.()],
        ['close-delete-modal', () => window.closeDeleteModal?.()],
        [
          'delete-tenant',
          (target) => {
            if (!target.disabled) window.deleteTenant?.();
          },
        ],
        ['close-status-modal', () => window.closeDeletionStatusModal?.()],
        [
          'navigate',
          (target) => {
            const href = target.dataset.href;
            if (href) window.location.href = href;
          },
        ],
      ]);

      // Handle action based on data-action attribute
      function handleAction(action, target) {
        const handler = actionHandlers.get(action);
        if (handler) handler(target);
      }

      // Event Delegation for all actions
      document.addEventListener('click', function (e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        handleAction(action, target);
      });

      // Modal functions
      window.showDeleteModal = async function () {
        // First check if there are at least 2 root users
        try {
          const useV2Root = window.FEATURE_FLAGS?.USE_API_V2_ROOT;
          const endpoint = useV2Root ? '/api/v2/root/users' : '/api/root/users';
          const response = await fetchWithAuth(endpoint);
          if (response.ok) {
            const data = await response.json();
            // API /root/users returns only root users already
            // Response structure: { users: [...] } or just array
            const rootUsers = data.users || data;

            // Ensure it's an array and count root users
            const rootUserCount = Array.isArray(rootUsers) ? rootUsers.length : 0;

            console.info(`Found ${rootUserCount} root users in tenant`);

            if (rootUserCount < 2) {
              const userText = rootUserCount === 1 ? 'Es gibt nur 1 Root-Benutzer' : 'Es gibt keine Root-Benutzer';
              showErrorAlert(
                `Tenant-Löschung nicht möglich: ${userText}. Um den Tenant zu löschen, erstellen Sie bitte mindestens einen weiteren Root-Benutzer (Zwei-Personen-Prinzip).`,
              );
              return;
            }
          }
        } catch (error) {
          console.error('Error checking root users:', error);
        }

        document.querySelector('#deleteModal').classList.add('active');
        document.querySelector('#deleteConfirmation').value = '';
        document.querySelector('#confirmDeleteBtn').disabled = true;
      };

      window.closeDeleteModal = function () {
        document.querySelector('#deleteModal').classList.remove('active');
      };

      window.showDeletionStatusModal = function (queueId, tenantId) {
        document.querySelector('#deletionStatusModal').classList.add('active');
        document.querySelector('#queueIdDisplay').textContent = queueId || '-';
        document.querySelector('#tenantIdDisplay').textContent = tenantId || '-';

        const scheduledDate = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);
        document.querySelector('#scheduledDateDisplay').textContent = scheduledDate.toLocaleDateString('de-DE', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        });
      };

      window.closeDeletionStatusModal = function () {
        document.querySelector('#deletionStatusModal').classList.remove('active');
      };

      // Delete confirmation input
      document.querySelector('#deleteConfirmation').addEventListener('input', function (e) {
        const confirmBtn = document.querySelector('#confirmDeleteBtn');
        confirmBtn.disabled = e.target.value !== 'LÖSCHEN';
      });

      // Delete tenant function
      window.deleteTenant = async function () {
        const confirmBtn = document.querySelector('#confirmDeleteBtn');
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Lösche...';

        try {
          // Use v2 endpoint with feature flag
          const useV2Root = window.FEATURE_FLAGS?.USE_API_V2_ROOT;
          const endpoint = useV2Root ? '/api/v2/root/tenants/current' : '/api/root/tenants/current';
          const response = await fetchWithAuth(endpoint, {
            method: 'DELETE',
            body: JSON.stringify({
              reason: document.querySelector('#deleteReason')?.value || 'Keine Angabe',
            }),
          });

          if (response.ok) {
            const result = await response.json();

            // Handle v2 API response format
            const data = result.data || result;

            // Show status modal with data from server response
            // The API returns the queueId and tenantId in the response
            window.showDeletionStatusModal(data.queueId || data.id, data.tenantId || data.tenant_id);

            // Close delete confirmation modal
            window.closeDeleteModal();

            // Show the deletion status button now that there's a pending deletion
            const button = document.querySelector('#deletionStatusButton');
            if (button) {
              button.classList.remove('u-hidden');
            }
          } else {
            const error = await response.json();
            showError(error.error || 'Fehler beim Löschen des Tenants');
            confirmBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Endgültig löschen';
            confirmBtn.disabled = false;
          }
        } catch (error) {
          console.error('Error deleting tenant:', error);
          showError('Fehler beim Löschen des Tenants');
          confirmBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Endgültig löschen';
          confirmBtn.disabled = false;
        }
      };

      // Close modals on escape key
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          window.closeDeleteModal();
          window.closeDeletionStatusModal();
        }
      });
    </script>

    <!-- Breadcrumb Component -->
    <script type="module">
      import { initBreadcrumb } from '/scripts/components/breadcrumb.js';
      // Breadcrumb wird automatisch generiert basierend auf der URL
      initBreadcrumb();
    </script>
  </body>
</html>
