<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat - Assixx</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- Critical Layout State - Prevents Layout Shift -->
    <script>
      // Set sidebar state IMMEDIATELY to prevent any layout shift
      (function () {
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        document.documentElement.setAttribute('data-sidebar', sidebarCollapsed ? 'collapsed' : 'expanded');
        // Also set CSS custom properties for immediate use
        document.documentElement.style.setProperty('--sidebar-width', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--content-margin', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--grid-columns', sidebarCollapsed ? '4' : '3');
        document.documentElement.style.setProperty('--widget-columns', sidebarCollapsed ? '5' : '3');
        document.documentElement.style.setProperty('--card-padding', sidebarCollapsed ? '2rem' : '1.5rem');
      })();
    </script>
    <script src="/feature-flags.js"></script>

    <!-- Unified Navigation CSS - Load immediately to prevent FOUC -->
    <link id="unified-navigation-styles" rel="stylesheet" href="/styles/unified-navigation.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="/styles/chat.css" />
    <link rel="stylesheet" href="/styles/user-info-update.css" />
  </head>
  <body>
    <!-- Unified Navigation -->
    <div id="navigation-container"></div>

    <!-- Main Layout mit Sidebar -->
    <div class="layout-container">
      <!-- Chat Container -->
      <main class="main-content" class="u-p-0">
        <div class="chat-container">
          <!-- Chat Sidebar -->
          <div class="chat-sidebar">
            <div class="chat-sidebar-header">
              <h2 class="chat-title">
                <i class="fas fa-comments"></i>
                Nachrichten
              </h2>
              <button class="new-chat-btn" id="newConversationBtn" title="Neue Unterhaltung starten">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div class="conversations-list" id="conversationsList">
              <!-- Conversations werden hier dynamisch geladen -->
            </div>
          </div>

          <!-- Main Chat Area -->
          <div class="chat-main u-hidden">
            <!-- Chat Header -->
            <div class="chat-header" id="chat-header" class="u-hidden">
              <div class="chat-header-info">
                <div class="chat-header-avatar" id="chat-avatar"></div>
                <div class="chat-header-details">
                  <h3 id="chat-partner-name"></h3>
                  <div class="status" id="chat-partner-status"></div>
                </div>
              </div>
              <div class="chat-actions">
                <button class="chat-action-btn" title="Suchen">
                  <i class="fas fa-search"></i>
                </button>
                <button class="chat-action-btn" id="deleteConversationBtn" title="Chat l√∂schen">
                  <i class="fas fa-trash"></i>
                </button>
                <button class="chat-action-btn" title="Mehr Optionen">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
              </div>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
              <div class="empty-chat" id="noChatSelected">
                <div class="empty-chat-icon">
                  <i class="fas fa-comments"></i>
                </div>
                <h3>Willkommen im Chat</h3>
                <p>W√§hlen Sie eine Unterhaltung aus der Liste oder starten Sie eine neue Nachricht.</p>
              </div>
            </div>

            <!-- Message Input -->
            <div class="message-input-container" id="chatArea" class="u-hidden">
              <div class="delivery-options">
                <div class="custom-delivery-select">
                  <div class="delivery-display" data-action="toggle-delivery-dropdown">
                    <span class="delivery-icon">‚ö°</span>
                    <span class="delivery-text">Sofort senden</span>
                    <span class="dropdown-arrow">‚ñº</span>
                  </div>
                  <div class="delivery-dropdown" id="deliveryDropdown">
                    <div
                      class="delivery-dropdown-option"
                      data-value="immediate"
                      data-action="select-delivery"
                      data-icon="‚ö°"
                      data-text="Sofort senden"
                    >
                      <span class="option-icon">‚ö°</span>
                      <span class="option-text">Sofort senden</span>
                    </div>
                    <div
                      class="delivery-dropdown-option"
                      data-value="break_time"
                      data-action="select-delivery"
                      data-icon="‚òï"
                      data-text="In der Pause"
                    >
                      <span class="option-icon">‚òï</span>
                      <span class="option-text">In der Pause</span>
                    </div>
                    <div
                      class="delivery-dropdown-option"
                      data-value="after_work"
                      data-action="select-delivery"
                      data-icon="üè†"
                      data-text="Nach Feierabend"
                    >
                      <span class="option-icon">üè†</span>
                      <span class="option-text">Nach Feierabend</span>
                    </div>
                  </div>
                  <input type="hidden" id="messageScheduling" value="immediate" />
                </div>
              </div>

              <div class="message-input-wrapper">
                <textarea id="messageInput" class="message-input" placeholder="Nachricht eingeben..." rows="1"></textarea>
                <div class="input-actions">
                  <button class="input-action-btn" id="attachmentBtn" title="Datei anh√§ngen">
                    <i class="fas fa-paperclip"></i>
                  </button>
                  <button class="input-action-btn" id="emojiBtn" title="Emoji hinzuf√ºgen">
                    <i class="fas fa-smile"></i>
                  </button>
                  <button class="send-btn" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- New Chat Modal -->
    <div id="newConversationModal" class="modal u-hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Neue Unterhaltung starten</h3>
          <button class="modal-close close" id="closeModalBtn">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <!-- Tab Selection -->
          <div class="chat-type-tabs">
            <button class="chat-type-tab active" data-type="employee" id="employeeTab">
              <i class="fas fa-users"></i>
              Mitarbeiter
            </button>
            <button class="chat-type-tab" data-type="admin" id="adminTab">
              <i class="fas fa-user-tie"></i>
              Administratoren
            </button>
          </div>

          <!-- Employee Selection -->
          <div id="employeeSelection" class="recipient-selection active">
            <!-- Department Dropdown -->
            <div class="form-group">
              <label class="form-label">Abteilung ausw√§hlen</label>
              <div class="custom-dropdown">
                <div class="dropdown-display" id="departmentDisplay" data-action="toggle-chat-dropdown" data-dropdown="department">
                  <span>Abteilung w√§hlen</span>
                  <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                    <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </div>
                <div class="dropdown-options" id="departmentDropdown">
                  <!-- Departments werden dynamisch geladen -->
                </div>
                <input type="hidden" id="selectedDepartment" />
              </div>
            </div>

            <!-- Employee Dropdown -->
            <div class="form-group" id="employeeDropdownGroup" class="u-hidden">
              <label class="form-label">Mitarbeiter ausw√§hlen</label>
              <div class="custom-dropdown">
                <div class="dropdown-display" id="employeeDisplay" data-action="toggle-chat-dropdown" data-dropdown="employee">
                  <span>Mitarbeiter w√§hlen</span>
                  <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                    <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </div>
                <div class="dropdown-options" id="employeeDropdown">
                  <!-- Employees werden dynamisch geladen -->
                </div>
                <input type="hidden" id="selectedEmployee" />
              </div>
            </div>
          </div>

          <!-- Admin Selection -->
          <div id="adminSelection" class="recipient-selection" class="u-hidden">
            <div class="form-group">
              <label class="form-label">Administrator ausw√§hlen</label>
              <div class="custom-dropdown">
                <div class="dropdown-display" id="adminDisplay" data-action="toggle-chat-dropdown" data-dropdown="admin">
                  <span>Administrator w√§hlen</span>
                  <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                    <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </div>
                <div class="dropdown-options" id="adminDropdown">
                  <!-- Admins werden dynamisch geladen -->
                </div>
                <input type="hidden" id="selectedAdmin" />
              </div>
            </div>
          </div>

          <!-- Multiple Selection for Groups -->
          <div class="form-group" id="multipleSelectionHint" style="display: none; margin-top: 15px">
            <p class="text-muted" class="u-fs-09rem">
              <i class="fas fa-info-circle"></i>
              F√ºr Gruppenchats w√§hlen Sie mehrere Empf√§nger aus
            </p>
          </div>

          <!-- Selected Recipients -->
          <div class="form-group" id="selectedRecipientsGroup" style="display: none; margin-top: 20px">
            <label class="form-label">Ausgew√§hlte Empf√§nger</label>
            <div id="selectedRecipientsList" class="selected-recipients-list">
              <!-- Selected recipients will be shown here -->
            </div>
          </div>

          <!-- Group Name (for group chats) -->
          <div class="form-group" id="groupChatOptions" style="display: none; margin-top: 20px">
            <label class="form-label">Gruppenname (optional)</label>
            <input type="text" id="groupChatName" class="form-control" placeholder="z.B. Projekt-Team, Abteilung Marketing..." />
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn-secondary" id="cancelModalBtn">Abbrechen</button>
          <button class="btn-primary" id="createConversationBtn">
            <i class="fas fa-paper-plane"></i>
            Unterhaltung starten
          </button>
        </div>
      </div>
    </div>

    <!-- File Upload Input -->
    <input type="file" id="fileInput" class="u-hidden" multiple />

    <!-- Emoji Picker Modal -->
    <div id="emojiPicker" class="emoji-picker u-hidden">
      <div class="emoji-picker-header">
        <button class="emoji-category active" data-category="smileys">üòä</button>
        <button class="emoji-category" data-category="gestures">üëç</button>
        <button class="emoji-category" data-category="hearts">‚ù§Ô∏è</button>
        <button class="emoji-category" data-category="animals">üê∂</button>
        <button class="emoji-category" data-category="food">üçï</button>
        <button class="emoji-category" data-category="activities">‚öΩ</button>
        <button class="emoji-category" data-category="objects">üí°</button>
        <button class="emoji-category" data-category="symbols">‚ú®</button>
      </div>
      <div class="emoji-picker-content" id="emojiContent">
        <!-- Emojis werden hier dynamisch eingef√ºgt -->
      </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="/scripts/components/unified-navigation.ts"></script>
    <script type="module" src="/scripts/auth/role-switch.ts"></script>
    <script type="module" src="/scripts/chat/index.ts"></script>
    <script type="module">
      document.addEventListener('DOMContentLoaded', function () {
        console.info('üöÄ Chat-Seite wird initialisiert...');

        // Navigation wird automatisch durch unified-navigation.ts initialisiert
        console.info('Navigation wird automatisch geladen...');
        // UnifiedNavigation wird bereits automatisch in unified-navigation.ts initialisiert
        // Keine zus√§tzliche Instanz erstellen!

        // Event-Listener werden bereits in chat.ts hinzugef√ºgt
        console.info('üéØ Event-Listener werden durch chat.ts verwaltet');
      });

      // Custom Delivery Select Functions
      function toggleDeliveryDropdown() {
        const select = document.querySelector('.custom-delivery-select');
        select.classList.toggle('active');

        // Close on outside click
        if (select.classList.contains('active')) {
          document.addEventListener('click', function closeDropdown(e) {
            if (!e.target.closest('.custom-delivery-select')) {
              select.classList.remove('active');
              document.removeEventListener('click', closeDropdown);
            }
          });
        }
      }

      function selectDeliveryOption(value, icon, text) {
        // Update display
        document.querySelector('.delivery-icon').textContent = icon;
        document.querySelector('.delivery-text').textContent = text;

        // Update hidden input
        document.querySelector('#messageScheduling').value = value;

        // Close dropdown
        document.querySelector('.custom-delivery-select').classList.remove('active');

        // Log selection
        console.info('üìÖ Delivery option selected:', value);
      }

      // Toggle Chat Dropdown
      window.toggleChatDropdown = function (type) {
        const display = document.querySelector(type + 'Display');
        const dropdown = document.querySelector(type + 'Dropdown');

        // Close all other dropdowns
        document.querySelectorAll('.dropdown-display').forEach((d) => {
          if (d !== display) d.classList.remove('active');
        });
        document.querySelectorAll('.dropdown-options').forEach((d) => {
          if (d !== dropdown) d.classList.remove('active');
        });

        display.classList.toggle('active');
        dropdown.classList.toggle('active');
      };

      // Select Chat Dropdown Option
      window.selectChatDropdownOption = function (type, value, text, meta = '') {
        const display = document.querySelector(type + 'Display');
        const input = document.querySelector('selected' + type.charAt(0).toUpperCase() + type.slice(1));

        // Update display text
        display.querySelector('span').textContent = text;

        // Update hidden input
        input.value = value;

        // Close dropdown
        display.classList.remove('active');
        document.querySelector(type + 'Dropdown').classList.remove('active');

        console.info(`‚úÖ ${type} selected:`, { value, text, meta });

        // Handle specific dropdown types
        if (type === 'department' && value) {
          // Department selected, show employee dropdown
          document.querySelector('#employeeDropdownGroup').style.display = 'block';
          // Load employees for this department
          if (window.chatClient) {
            window.chatClient.loadEmployeesForDepartment(value);
          }
        }
      };

      // Event Delegation for all actions
      document.addEventListener('click', function (e) {
        const target = e.target;

        // Handle toggle delivery dropdown
        const toggleDeliveryBtn = target.closest('[data-action="toggle-delivery-dropdown"]');
        if (toggleDeliveryBtn) {
          toggleDeliveryDropdown();
          return;
        }

        // Handle select delivery option
        const selectDeliveryBtn = target.closest('[data-action="select-delivery"]');
        if (selectDeliveryBtn) {
          const value = selectDeliveryBtn.dataset.value;
          const icon = selectDeliveryBtn.dataset.icon;
          const text = selectDeliveryBtn.dataset.text;
          selectDeliveryOption(value, icon, text);
          return;
        }

        // Handle toggle chat dropdown
        const toggleChatBtn = target.closest('[data-action="toggle-chat-dropdown"]');
        if (toggleChatBtn) {
          const dropdown = toggleChatBtn.dataset.dropdown;
          if (window.toggleChatDropdown) {
            window.toggleChatDropdown('#' + dropdown);
          }
          return;
        }
      });

      // Click outside to close dropdowns
      document.addEventListener('click', function (e) {
        if (!e.target.closest('.custom-dropdown')) {
          document.querySelectorAll('.dropdown-display').forEach((d) => d.classList.remove('active'));
          document.querySelectorAll('.dropdown-options').forEach((d) => d.classList.remove('active'));
        }
      });
    </script>
  </body>
</html>
