<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dokument hochladen - Assixx</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- Critical Layout State - Prevents Layout Shift -->
    <script>
      // Set sidebar state IMMEDIATELY to prevent any layout shift
      (function () {
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        document.documentElement.setAttribute('data-sidebar', sidebarCollapsed ? 'collapsed' : 'expanded');
        // Also set CSS custom properties for immediate use
        document.documentElement.style.setProperty('--sidebar-width', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--content-margin', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--grid-columns', sidebarCollapsed ? '4' : '3');
        document.documentElement.style.setProperty('--widget-columns', sidebarCollapsed ? '5' : '3');
        document.documentElement.style.setProperty('--card-padding', sidebarCollapsed ? '2rem' : '1.5rem');
      })();
    </script>
    <!-- Unified Navigation CSS - Load immediately to prevent FOUC -->
    <link id="unified-navigation-styles" rel="stylesheet" href="/styles/unified-navigation.css" />
    <link rel="stylesheet" href="/styles/document-upload.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="/styles/user-info-update.css" />
  </head>
  <body class="document-upload">
    <!-- Unified Navigation -->
    <div id="navigation-container"></div>

    <!-- Main Layout with Sidebar -->
    <div class="layout-container">
      <!-- Main Content Area -->
      <main class="main-content">
        <!-- Breadcrumb Navigation -->
        <div id="breadcrumb-container"></div>

        <div class="container">
          <div id="upload-success" class="alert alert-success u-hidden">
            <span class="icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"
                />
              </svg>
            </span>
            <div>
              <strong>Erfolg!</strong>
              <p>Dokument wurde erfolgreich hochgeladen.</p>
            </div>
          </div>

          <div id="upload-error" class="alert alert-danger u-hidden">
            <span class="icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" />
              </svg>
            </span>
            <div>
              <strong>Fehler!</strong>
              <p id="error-message">Beim Hochladen des Dokuments ist ein Fehler aufgetreten.</p>
            </div>
          </div>

          <div class="card upload-section">
            <div class="card-header">
              <h2 class="upload-title">Dokument-Informationen</h2>
            </div>
            <div class="card-body">
              <form id="upload-form" class="upload-form">
                <div class="form-row">
                  <div class="form-col">
                    <div class="form-group">
                      <label class="form-label">Empfänger-Typ</label>
                      <div class="recipient-type-selector">
                        <label class="radio-option">
                          <input type="radio" name="recipientType" value="user" checked />
                          <span>Einzelner Mitarbeiter</span>
                        </label>
                        <label class="radio-option">
                          <input type="radio" name="recipientType" value="team" />
                          <span>Team</span>
                        </label>
                        <label class="radio-option">
                          <input type="radio" name="recipientType" value="department" />
                          <span>Abteilung</span>
                        </label>
                        <label class="radio-option">
                          <input type="radio" name="recipientType" value="company" />
                          <span>Gesamte Firma</span>
                        </label>
                      </div>
                    </div>

                    <div class="form-group" id="recipientSelectorGroup">
                      <label for="user-select" class="form-label" id="recipientLabel">Mitarbeiter auswählen</label>
                      <div class="custom-dropdown" id="userDropdownContainer">
                        <div class="dropdown-display placeholder" id="userDisplay" data-dropdown="user">
                          <span>Bitte Mitarbeiter auswählen</span>
                          <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                            <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                          </svg>
                        </div>
                        <div class="dropdown-options" id="userDropdown">
                          <!-- Wird dynamisch befüllt -->
                        </div>
                        <input type="hidden" name="userId" id="userValue" />
                      </div>

                      <div class="custom-dropdown u-hidden" id="teamDropdownContainer">
                        <div class="dropdown-display placeholder" id="teamDisplay" data-dropdown="team">
                          <span>Bitte Team auswählen</span>
                          <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                            <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                          </svg>
                        </div>
                        <div class="dropdown-options" id="teamDropdown">
                          <!-- Wird dynamisch befüllt -->
                        </div>
                        <input type="hidden" name="teamId" id="teamValue" />
                      </div>

                      <div class="custom-dropdown u-hidden" id="departmentDropdownContainer">
                        <div class="dropdown-display placeholder" id="departmentDisplay" data-dropdown="department">
                          <span>Bitte Abteilung auswählen</span>
                          <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                            <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                          </svg>
                        </div>
                        <div class="dropdown-options" id="departmentDropdown">
                          <!-- Wird dynamisch befüllt -->
                        </div>
                        <input type="hidden" name="departmentId" id="departmentValue" />
                      </div>

                      <div
                        id="companyInfo"
                        style="
                          display: none;
                          padding: 12px;
                          background: rgba(33, 150, 243, 0.1);
                          border-radius: 8px;
                          border: 1px solid rgba(33, 150, 243, 0.3);
                        "
                      >
                        <i class="fas fa-info-circle text-info u-mr-8"></i>
                        Das Dokument wird für alle Mitarbeiter der Firma sichtbar sein.
                      </div>
                    </div>

                    <div class="form-group">
                      <label for="category-select" class="form-label">Kategorie</label>
                      <div class="custom-dropdown">
                        <div class="dropdown-display placeholder" id="categoryDisplay" data-dropdown="category">
                          <span>Bitte Kategorie auswählen</span>
                          <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                            <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                          </svg>
                        </div>
                        <div class="dropdown-options" id="categoryDropdown">
                          <div
                            class="dropdown-option"
                            data-action="select-option"
                            data-type="category"
                            data-value="salary"
                            data-text="Gehaltsabrechnung"
                          >
                            Gehaltsabrechnung
                          </div>
                          <div
                            class="dropdown-option"
                            data-action="select-option"
                            data-type="category"
                            data-value="contract"
                            data-text="Vertrag"
                          >
                            Vertrag
                          </div>
                          <div
                            class="dropdown-option"
                            data-action="select-option"
                            data-type="category"
                            data-value="certificate"
                            data-text="Zertifikat/Zeugnis"
                          >
                            Zertifikat/Zeugnis
                          </div>
                          <div
                            class="dropdown-option"
                            data-action="select-option"
                            data-type="category"
                            data-value="other"
                            data-text="Sonstiges"
                          >
                            Sonstiges
                          </div>
                        </div>
                        <input type="hidden" name="category" id="categoryValue" required />
                      </div>
                    </div>
                  </div>

                  <div class="form-col">
                    <div class="form-group">
                      <label for="year-input" class="form-label">Jahr (optional)</label>
                      <input type="number" id="year-input" name="year" class="form-control" min="1900" max="2100" placeholder="z.B. 2025" />
                    </div>

                    <div class="form-group">
                      <label for="month-select" class="form-label">Monat (optional)</label>
                      <div class="custom-dropdown">
                        <div class="dropdown-display placeholder" id="monthDisplay" data-dropdown="month">
                          <span>Monat auswählen (optional)</span>
                          <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                            <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                          </svg>
                        </div>
                        <div class="dropdown-options" id="monthDropdown">
                          <div class="dropdown-option" data-action="select-option" data-type="month" data-value="" data-text="Kein Monat">
                            Kein Monat
                          </div>
                          <div class="dropdown-option" data-action="select-option" data-type="month" data-value="Januar" data-text="Januar">
                            Januar
                          </div>
                          <div
                            class="dropdown-option"
                            data-action="select-option"
                            data-type="month"
                            data-value="Februar"
                            data-text="Februar"
                          >
                            Februar
                          </div>
                          <div class="dropdown-option" data-action="select-option" data-type="month" data-value="März" data-text="März">
                            März
                          </div>
                          <div class="dropdown-option" data-action="select-option" data-type="month" data-value="April" data-text="April">
                            April
                          </div>
                          <div class="dropdown-option" data-action="select-option" data-type="month" data-value="Mai" data-text="Mai">
                            Mai
                          </div>
                          <div class="dropdown-option" data-action="select-option" data-type="month" data-value="Juni" data-text="Juni">
                            Juni
                          </div>
                          <div class="dropdown-option" data-action="select-option" data-type="month" data-value="Juli" data-text="Juli">
                            Juli
                          </div>
                          <div class="dropdown-option" data-action="select-option" data-type="month" data-value="August" data-text="August">
                            August
                          </div>
                          <div
                            class="dropdown-option"
                            data-action="select-option"
                            data-type="month"
                            data-value="September"
                            data-text="September"
                          >
                            September
                          </div>
                          <div
                            class="dropdown-option"
                            data-action="select-option"
                            data-type="month"
                            data-value="Oktober"
                            data-text="Oktober"
                          >
                            Oktober
                          </div>
                          <div
                            class="dropdown-option"
                            data-action="select-option"
                            data-type="month"
                            data-value="November"
                            data-text="November"
                          >
                            November
                          </div>
                          <div
                            class="dropdown-option"
                            data-action="select-option"
                            data-type="month"
                            data-value="Dezember"
                            data-text="Dezember"
                          >
                            Dezember
                          </div>
                        </div>
                        <input type="hidden" name="month" id="monthValue" />
                      </div>
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label for="description-input" class="form-label">Beschreibung (optional)</label>
                  <textarea
                    id="description-input"
                    name="description"
                    class="form-control"
                    rows="3"
                    placeholder="Zusätzliche Informationen zum Dokument"
                  ></textarea>
                </div>

                <div class="file-drop-area" id="drop-area">
                  <span class="file-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
                    </svg>
                  </span>
                  <div class="file-message">Datei hierher ziehen oder klicken, um auszuwählen</div>
                  <p class="text-secondary">(Nur PDF-Dateien erlaubt, max. 5MB)</p>
                  <div class="file-restrictions">
                    <small>Erlaubte Dateitypen: PDF (.pdf)</small>
                    <br />
                    <small>Maximale Dateigröße: 5 MB</small>
                  </div>
                  <input type="file" id="file-input" name="document" class="file-input" accept=".pdf" required />
                </div>

                <div class="file-info" id="file-info">
                  <div class="file-name" id="file-name">document.pdf</div>
                  <div class="file-size" id="file-size">0 KB</div>
                </div>

                <div class="pdf-preview-container" id="pdf-preview-container">
                  <div class="preview-controls">
                    <span class="preview-title">Dokument-Vorschau</span>
                    <button type="button" class="preview-close" id="preview-close">×</button>
                  </div>
                  <iframe class="pdf-preview" id="pdf-preview"></iframe>
                </div>

                <div class="form-group" style="text-align: center; margin-top: 30px">
                  <button type="submit" class="btn btn-primary" id="upload-button">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                      <path
                        d="M14,13V17H10V13H7L12,8L17,13M19.35,10.03C18.67,6.59 15.64,4 12,4C9.11,4 6.6,5.64 5.35,8.03C2.34,8.36 0,10.9 0,14A6,6 0 0,0 6,20H19A5,5 0 0,0 24,15C24,12.36 21.95,10.22 19.35,10.03Z"
                      />
                    </svg>
                    Dokument hochladen
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Constants
      const FILE_INPUT_SELECTOR = '#file-input';

      document.addEventListener('DOMContentLoaded', () => {
        console.info('Document upload page loaded');

        // Datei-Upload-Bereich einrichten
        setupFileUpload();

        // Mitarbeiter-Liste laden
        loadEmployees();
        loadTeams();
        loadDepartments();

        // Formular-Einreichung einrichten
        const uploadForm = document.querySelector('#upload-form');
        if (uploadForm) {
          uploadForm.addEventListener('submit', uploadDocument);
        }

        // Dropdown-Funktionalität einrichten
        setupDropdowns();

        // Event Delegation for dynamic content
        setupEventDelegation();
      });

      // Event Delegation setup
      function setupEventDelegation() {
        // Handle recipient type changes
        document.addEventListener('change', function (e) {
          if (e.target.name === 'recipientType') {
            updateRecipientSelector(e.target.value);
          }
        });

        // Handle dropdown and option clicks
        document.addEventListener('click', function (e) {
          const target = e.target;

          // Dropdown toggle
          const dropdownDisplay = target.closest('[data-dropdown]');
          if (dropdownDisplay) {
            e.preventDefault();
            e.stopPropagation();
            const type = dropdownDisplay.dataset.dropdown;
            toggleDropdown(type);
            return;
          }

          // Option selection
          const option = target.closest('[data-action="select-option"]');
          if (option) {
            e.preventDefault();
            const type = option.dataset.type;
            const value = option.dataset.value;
            const text = option.dataset.text;
            selectOption(type, value, text);
            return;
          }
        });
      }

      // Empfänger-Selector aktualisieren
      function updateRecipientSelector(type) {
        const userContainer = document.querySelector('#userDropdownContainer');
        const teamContainer = document.querySelector('#teamDropdownContainer');
        const departmentContainer = document.querySelector('#departmentDropdownContainer');
        const companyInfo = document.querySelector('#companyInfo');
        const recipientLabel = document.querySelector('#recipientLabel');

        // Alle Container verstecken
        userContainer.style.display = 'none';
        teamContainer.style.display = 'none';
        departmentContainer.style.display = 'none';
        companyInfo.style.display = 'none';

        // Required-Attribute zurücksetzen
        document.querySelector('#userValue').removeAttribute('required');
        document.querySelector('#teamValue').removeAttribute('required');
        document.querySelector('#departmentValue').removeAttribute('required');

        // Je nach Typ anzeigen
        switch (type) {
          case 'user':
            userContainer.style.display = 'block';
            document.querySelector('#userValue').setAttribute('required', 'required');
            recipientLabel.textContent = 'Mitarbeiter auswählen';
            break;
          case 'team':
            teamContainer.style.display = 'block';
            document.querySelector('#teamValue').setAttribute('required', 'required');
            recipientLabel.textContent = 'Team auswählen';
            break;
          case 'department':
            departmentContainer.style.display = 'block';
            document.querySelector('#departmentValue').setAttribute('required', 'required');
            recipientLabel.textContent = 'Abteilung auswählen';
            break;
          case 'company':
            companyInfo.style.display = 'block';
            recipientLabel.textContent = 'Empfänger';
            break;
        }
      }

      // Teams laden
      async function loadTeams() {
        const token = localStorage.getItem('token');
        try {
          const response = await fetch('/api/v2/teams', {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            const result = await response.json();
            const teams = result.data || [];
            const teamDropdown = document.querySelector('#teamDropdown');

            // Clear existing options
            teamDropdown.innerHTML = '';

            // Add teams using DOM methods
            teams.forEach((team) => {
              const option = document.createElement('div');
              option.className = 'dropdown-option';
              option.setAttribute('data-action', 'select-option');
              option.setAttribute('data-type', 'team');
              option.setAttribute('data-value', team.id.toString());
              option.setAttribute('data-text', team.name);
              option.textContent = team.name;
              teamDropdown.append(option);
            });
          }
        } catch (error) {
          console.error('Error loading teams:', error);
        }
      }

      // Abteilungen laden
      async function loadDepartments() {
        const token = localStorage.getItem('token');
        try {
          const response = await fetch('/api/v2/departments', {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            const result = await response.json();
            const departments = result.data || [];
            const departmentDropdown = document.querySelector('#departmentDropdown');

            // Clear existing options
            departmentDropdown.innerHTML = '';

            // Add departments using DOM methods
            departments.forEach((dept) => {
              const option = document.createElement('div');
              option.className = 'dropdown-option';
              option.setAttribute('data-action', 'select-option');
              option.setAttribute('data-type', 'department');
              option.setAttribute('data-value', dept.id.toString());
              option.setAttribute('data-text', dept.name);
              option.textContent = dept.name;
              departmentDropdown.append(option);
            });
          }
        } catch (error) {
          console.error('Error loading departments:', error);
        }
      }

      // Bestätigungsdialog anzeigen
      function showConfirmationDialog(formData, callback) {
        const recipientType = document.querySelector('input[name="recipientType"]:checked').value;
        let recipientDisplay = '';

        switch (recipientType) {
          case 'user':
            recipientDisplay = `Mitarbeiter: ${document.querySelector('#userDisplay').querySelector('span').textContent}`;
            break;
          case 'team':
            recipientDisplay = `Team: ${document.querySelector('#teamDisplay').querySelector('span').textContent}`;
            break;
          case 'department':
            recipientDisplay = `Abteilung: ${document.querySelector('#departmentDisplay').querySelector('span').textContent}`;
            break;
          case 'company':
            recipientDisplay = 'Empfänger: Gesamte Firma';
            break;
        }

        const categoryDisplay = document.querySelector('#categoryDisplay').querySelector('span').textContent;
        const fileInput = document.querySelector(FILE_INPUT_SELECTOR);
        const fileName = fileInput.files[0].name;

        const confirmMsg =
          `Bitte bestätigen Sie den Dokument-Upload:\n\n` +
          `${recipientDisplay}\n` +
          `Kategorie: ${categoryDisplay}\n` +
          `Dateiname: ${fileName}\n` +
          (formData.get('year') ? `Jahr: ${formData.get('year')}\n` : '') +
          (formData.get('month') ? `Monat: ${formData.get('month')}\n` : '') +
          (formData.get('description') ? `\nBeschreibung: ${formData.get('description')}` : '');

        if (confirm(confirmMsg)) {
          callback();
        }
      }

      // Datei-Upload-Bereich einrichten
      function setupFileUpload() {
        const dropArea = document.querySelector('#drop-area');
        const fileInput = document.querySelector(FILE_INPUT_SELECTOR);
        const fileInfo = document.querySelector('#file-info');
        const fileName = document.querySelector('#file-name');
        const fileSize = document.querySelector('#file-size');

        if (!dropArea || !fileInput) return;

        // Drag & Drop Events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach((eventName) => {
          dropArea.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
          });
        });

        ['dragenter', 'dragover'].forEach((eventName) => {
          dropArea.addEventListener(eventName, () => {
            dropArea.classList.add('drag-over');
          });
        });

        ['dragleave', 'drop'].forEach((eventName) => {
          dropArea.addEventListener(eventName, () => {
            dropArea.classList.remove('drag-over');
          });
        });

        // Datei fallen lassen
        dropArea.addEventListener('drop', (e) => {
          const dt = e.dataTransfer;
          const files = dt.files;

          if (files.length > 0) {
            fileInput.files = files;
            updateFileInfo(files[0]);
          }
        });

        // Datei auswählen
        fileInput.addEventListener('change', () => {
          if (fileInput.files.length > 0) {
            updateFileInfo(fileInput.files[0]);
          } else {
            fileInfo.classList.remove('active');
          }
        });

        // Datei-Informationen aktualisieren und Vorschau anzeigen
        function updateFileInfo(file) {
          if (!file) return;

          // Überprüfen, ob es eine PDF-Datei ist
          if (!file.type || file.type !== 'application/pdf') {
            const fileExt = file.name.split('.').pop().toLowerCase();

            // Detaillierte Fehlermeldung basierend auf dem Dateityp
            if (fileExt === 'jpg' || fileExt === 'jpeg' || fileExt === 'png' || fileExt === 'gif') {
              showError('Bilddateien sind nicht erlaubt. Bitte konvertieren Sie das Bild in ein PDF-Dokument.');
            } else if (fileExt === 'doc' || fileExt === 'docx') {
              showError('Word-Dokumente sind nicht erlaubt. Bitte exportieren Sie die Datei als PDF.');
            } else if (fileExt === 'xls' || fileExt === 'xlsx') {
              showError('Excel-Dateien sind nicht erlaubt. Bitte exportieren Sie die Datei als PDF.');
            } else if (fileExt === 'txt') {
              showError('Textdateien sind nicht erlaubt. Bitte konvertieren Sie die Datei in ein PDF-Dokument.');
            } else {
              showError(`Dateityp "${fileExt}" wird nicht unterstützt. Nur PDF-Dateien sind erlaubt.`);
            }

            // Dateiauswahl zurücksetzen
            const fileInput = document.querySelector(FILE_INPUT_SELECTOR);
            if (fileInput) {
              fileInput.value = '';
            }

            return;
          }

          // Überprüfen Sie die Dateigröße (max. 5 MB)
          const maxSize = 5 * 1024 * 1024; // 5 MB in Bytes
          if (file.size > maxSize) {
            showError(`Die Datei ist zu groß (${formatFileSize(file.size)}). Die maximale Dateigröße beträgt 5 MB.`);

            // Dateiauswahl zurücksetzen
            const fileInput = document.querySelector(FILE_INPUT_SELECTOR);
            if (fileInput) {
              fileInput.value = '';
            }

            return;
          }

          // Fehlermeldung ausblenden, wenn alles in Ordnung ist
          hideError();

          fileName.textContent = file.name;
          fileSize.textContent = formatFileSize(file.size);
          fileInfo.classList.add('active');

          // PDF-Vorschau erstellen
          const pdfPreviewContainer = document.querySelector('#pdf-preview-container');
          const pdfPreview = document.querySelector('#pdf-preview');
          const previewClose = document.querySelector('#preview-close');

          if (pdfPreviewContainer && pdfPreview) {
            // Datei-URL erstellen
            const fileUrl = URL.createObjectURL(file);

            // iframe-Quelle setzen
            pdfPreview.src = fileUrl;

            // Container anzeigen
            pdfPreviewContainer.classList.add('active');

            // Schließen-Button-Funktionalität
            if (previewClose) {
              previewClose.addEventListener('click', () => {
                pdfPreviewContainer.classList.remove('active');
                // Optional: URL-Objekt freigeben, wenn die Vorschau geschlossen wird
                URL.revokeObjectURL(fileUrl);
              });
            }
          }
        }

        // Dateigröße formatieren
        function formatFileSize(bytes) {
          if (bytes === 0) return '0 Bytes';

          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));

          // Ensure i is within bounds to prevent object injection
          const sizeIndex = Math.min(Math.max(0, i), sizes.length - 1);

          // eslint-disable-next-line security/detect-object-injection -- sizeIndex is mathematically bounded between 0 and sizes.length-1
          return parseFloat((bytes / Math.pow(k, sizeIndex)).toFixed(2)) + ' ' + sizes[sizeIndex];
        }
      }

      // Mitarbeiter für das Dropdown laden
      async function loadEmployees() {
        const token = localStorage.getItem('token');
        let userDropdown = document.querySelector('#userDropdown');

        if (!userDropdown) return;

        try {
          const response = await fetch('/api/v2/users?role=employee', {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            // Handle v2 API response format: {success: true, data: [...], pagination: {...}}
            const employees = data.data || [];
            console.info(`Loaded ${employees.length} employees`);

            // Re-query DOM element after await to avoid race condition
            // eslint-disable-next-line require-atomic-updates
            userDropdown = document.querySelector('#userDropdown');
            if (!userDropdown) return;

            // Dropdown leeren
            userDropdown.innerHTML = '';

            // Mitarbeiter zum Dropdown hinzufügen
            if (employees.length > 0) {
              employees.forEach((employee) => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.setAttribute('data-action', 'select-option');
                option.setAttribute('data-type', 'user');
                option.setAttribute('data-value', employee.id.toString());
                option.setAttribute('data-text', `${employee.first_name} ${employee.last_name}`);
                option.textContent = `${employee.first_name} ${employee.last_name}`;
                userDropdown.append(option);
              });
            } else {
              // Show placeholder when no employees
              const placeholder = document.createElement('div');
              placeholder.className = 'dropdown-option disabled';
              placeholder.textContent = 'Keine Mitarbeiter vorhanden';
              placeholder.style.opacity = '0.5';
              placeholder.style.cursor = 'default';
              userDropdown.append(placeholder);
            }
          } else {
            console.error('Failed to load employees');
            showError('Mitarbeiterliste konnte nicht geladen werden.');
          }
        } catch (error) {
          console.error('Error loading employees:', error);
          showError('Fehler beim Laden der Mitarbeiterliste: ' + error.message);
        }
      }

      // Dokument hochladen
      async function uploadDocument(e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData(form);
        const token = localStorage.getItem('token');
        const uploadButton = document.querySelector('#upload-button');

        // Empfänger-Typ ermitteln
        const recipientType = document.querySelector('input[name="recipientType"]:checked').value;
        formData.append('recipientType', recipientType);

        // Überprüfen, ob alle erforderlichen Felder ausgefüllt sind
        const category = formData.get('category');
        const fileInput = document.querySelector(FILE_INPUT_SELECTOR);

        let recipientId = null;
        // recipientName wird für zukünftige Features vorbereitet
        let recipientName = '';

        switch (recipientType) {
          case 'user':
            recipientId = formData.get('userId');
            recipientName = document.querySelector('#userDisplay').querySelector('span').textContent;
            if (!recipientId || recipientId === '') {
              showError('Bitte wählen Sie einen Mitarbeiter aus.');
              return;
            }
            break;
          case 'team':
            recipientId = formData.get('teamId');
            recipientName = document.querySelector('#teamDisplay').querySelector('span').textContent;
            if (!recipientId || recipientId === '') {
              showError('Bitte wählen Sie ein Team aus.');
              return;
            }
            break;
          case 'department':
            recipientId = formData.get('departmentId');
            recipientName = document.querySelector('#departmentDisplay').querySelector('span').textContent;
            if (!recipientId || recipientId === '') {
              showError('Bitte wählen Sie eine Abteilung aus.');
              return;
            }
            break;
          case 'company':
            recipientName = 'Gesamte Firma';
            // Kein recipientId nötig für company
            break;
        }

        if (!category || !fileInput.files.length) {
          showError('Bitte füllen Sie alle erforderlichen Felder aus und wählen Sie eine Datei aus.');
          return;
        }

        // Entferne nicht benötigte Felder aus FormData
        const cleanFormData = new FormData();

        // Füge nur die benötigten Felder hinzu
        cleanFormData.append('recipientType', recipientType);
        cleanFormData.append('document', fileInput.files[0]);
        cleanFormData.append('category', category);

        // Füge optionale Felder nur hinzu, wenn sie einen Wert haben
        const description = formData.get('description');
        if (description) cleanFormData.append('description', description);

        const year = formData.get('year');
        if (year) cleanFormData.append('year', year);

        const month = formData.get('month');
        if (month) cleanFormData.append('month', month);

        // Füge nur den relevanten Empfänger hinzu
        switch (recipientType) {
          case 'user':
            cleanFormData.append('userId', formData.get('userId'));
            break;
          case 'team':
            cleanFormData.append('teamId', formData.get('teamId'));
            break;
          case 'department':
            cleanFormData.append('departmentId', formData.get('departmentId'));
            break;
          // Bei 'company' wird kein spezifischer Empfänger benötigt
        }

        // Bestätigungsdialog anzeigen
        showConfirmationDialog(cleanFormData, async () => {
          // Button-Zustand ändern
          if (uploadButton) {
            uploadButton.disabled = true;
            // Clear button content
            while (uploadButton.firstChild) {
              uploadButton.firstChild.remove();
            }

            // Add spinner SVG
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '20');
            svg.setAttribute('height', '20');
            svg.setAttribute('viewBox', '0 0 24 24');
            svg.setAttribute('fill', 'currentColor');
            svg.classList.add('loading-spinner');

            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', 'M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z');
            svg.append(path);

            uploadButton.append(svg);
            uploadButton.append(document.createTextNode(' Wird hochgeladen...'));
          }

          // Erfolgs- und Fehlerelemente
          hideError();
          hideSuccess();

          try {
            const useV2Documents = window.FEATURE_FLAGS?.USE_API_V2_DOCUMENTS;
            const endpoint = useV2Documents ? '/api/v2/documents/upload' : '/api/documents/upload';
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${token}`,
              },
              body: cleanFormData,
            });

            const result = await response.json();

            if (response.ok) {
              console.info('Upload successful:', result);
              form.reset();

              // Dropdowns zurücksetzen
              document.querySelector('#userDisplay').querySelector('span').textContent = 'Bitte Mitarbeiter auswählen';
              document.querySelector('#userDisplay').classList.add('placeholder');
              document.querySelector('#teamDisplay').querySelector('span').textContent = 'Bitte Team auswählen';
              document.querySelector('#teamDisplay').classList.add('placeholder');
              document.querySelector('#departmentDisplay').querySelector('span').textContent = 'Bitte Abteilung auswählen';
              document.querySelector('#departmentDisplay').classList.add('placeholder');
              document.querySelector('#categoryDisplay').querySelector('span').textContent = 'Bitte Kategorie auswählen';
              document.querySelector('#categoryDisplay').classList.add('placeholder');
              document.querySelector('#monthDisplay').querySelector('span').textContent = 'Monat auswählen (optional)';
              document.querySelector('#monthDisplay').classList.add('placeholder');

              // Empfänger-Typ zurück auf 'user' setzen
              document.querySelector('input[name="recipientType"][value="user"]').checked = true;
              updateRecipientSelector('user');

              // Datei-Info und Vorschau zurücksetzen
              const fileInfo = document.querySelector('#file-info');
              const pdfPreviewContainer = document.querySelector('#pdf-preview-container');
              const pdfPreview = document.querySelector('#pdf-preview');

              if (fileInfo) {
                fileInfo.classList.remove('active');
              }

              if (pdfPreviewContainer) {
                pdfPreviewContainer.classList.remove('active');
              }

              if (pdfPreview && pdfPreview.src) {
                // URL-Objekt freigeben
                URL.revokeObjectURL(pdfPreview.src);
                pdfPreview.src = '';
              }

              showSuccess('Dokument wurde erfolgreich hochgeladen!');
            } else {
              console.error('Upload failed:', result);
              showError('Fehler: ' + (result.message || 'Unbekannter Fehler'));
            }
          } catch (error) {
            console.error('Error uploading document:', error);
            showError('Fehler: ' + (error.message || 'Unbekannter Fehler'));
          } finally {
            // Button-Zustand zurücksetzen
            if (uploadButton) {
              uploadButton.disabled = false;
              // Clear button content
              while (uploadButton.firstChild) {
                uploadButton.firstChild.remove();
              }

              // Add upload SVG
              const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
              svg.setAttribute('width', '20');
              svg.setAttribute('height', '20');
              svg.setAttribute('viewBox', '0 0 24 24');
              svg.setAttribute('fill', 'currentColor');

              const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
              path.setAttribute(
                'd',
                'M14,13V17H10V13H7L12,8L17,13M19.35,10.03C18.67,6.59 15.64,4 12,4C9.11,4 6.6,5.64 5.35,8.03C2.34,8.36 0,10.9 0,14A6,6 0 0,0 6,20H19A5,5 0 0,0 24,15C24,12.36 21.95,10.22 19.35,10.03Z',
              );
              svg.append(path);

              uploadButton.append(svg);
              uploadButton.append(document.createTextNode(' Dokument hochladen'));
            }
          }
        });
      }

      // Erfolgsmeldung anzeigen
      function showSuccess(message) {
        const successAlert = document.querySelector('#upload-success');
        if (successAlert) {
          const messageElement = successAlert.querySelector('p');
          if (messageElement) {
            messageElement.textContent = message;
          }
          successAlert.style.display = 'flex';

          // Nach 5 Sekunden ausblenden
          setTimeout(() => {
            successAlert.style.display = 'none';
          }, 5000);
        }
      }

      // Erfolgsmeldung ausblenden
      function hideSuccess() {
        const successAlert = document.querySelector('#upload-success');
        if (successAlert) {
          successAlert.style.display = 'none';
        }
      }

      // Fehlermeldung anzeigen
      function showError(message) {
        const errorAlert = document.querySelector('#upload-error');
        if (errorAlert) {
          const messageElement = document.querySelector('#error-message');
          if (messageElement) {
            messageElement.textContent = message;
          }
          errorAlert.style.display = 'flex';
        }
      }

      // Fehlermeldung ausblenden
      function hideError() {
        const errorAlert = document.querySelector('#upload-error');
        if (errorAlert) {
          errorAlert.style.display = 'none';
        }
      }

      // Dropdown-Funktionen
      function toggleDropdown(type) {
        const display = document.querySelector('#' + type + 'Display');
        const dropdown = document.querySelector('#' + type + 'Dropdown');

        // Alle anderen schließen
        document.querySelectorAll('.dropdown-display').forEach((d) => {
          if (d !== display) d.classList.remove('active');
        });
        document.querySelectorAll('.dropdown-options').forEach((d) => {
          if (d !== dropdown) d.classList.remove('active');
        });

        display.classList.toggle('active');
        dropdown.classList.toggle('active');
      }

      function selectOption(type, value, text) {
        const display = document.querySelector('#' + type + 'Display');
        const dropdown = document.querySelector('#' + type + 'Dropdown');
        const input = document.querySelector('#' + type + 'Value');

        display.querySelector('span').textContent = text;
        display.classList.remove('placeholder');
        input.value = value;

        display.classList.remove('active');
        dropdown.classList.remove('active');

        // Markiere ausgewählte Option
        dropdown.querySelectorAll('.dropdown-option').forEach((opt) => {
          opt.classList.remove('selected');
          if (opt.textContent === text) {
            opt.classList.add('selected');
          }
        });
      }

      function setupDropdowns() {
        // Click-Outside-to-Close
        document.addEventListener('click', function (e) {
          if (!e.target.closest('.custom-dropdown')) {
            document.querySelectorAll('.dropdown-display').forEach((d) => d.classList.remove('active'));
            document.querySelectorAll('.dropdown-options').forEach((d) => d.classList.remove('active'));
          }
        });
      }
    </script>

    <!-- Unified Navigation -->
    <script type="module" src="/scripts/components/unified-navigation.ts"></script>
    <script type="module" src="/scripts/components/breadcrumb.js"></script>
  </body>
</html>
