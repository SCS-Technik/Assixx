<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Feature Management - Assixx</title>
    <link rel="stylesheet" href="/styles/breadcrumb-alignment.css" />
    <link rel="stylesheet" href="/styles/dashboard-theme.css" />
    <link rel="stylesheet" href="/styles/feature-management.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="/styles/user-info-update.css" />
  </head>
  <body>
    <!-- Unified Navigation -->
    <div id="navigation-container"></div>

    <!-- Main Layout mit Sidebar -->
    <div class="layout-container">
      <!-- Main Content -->
      <main class="main-content">
        <!-- Breadcrumb -->
        <div id="breadcrumb-container"></div>

        <div class="container">
          <!-- Tenant Auswahl -->
          <div class="card mb-4">
            <div class="card-header">
              <h2 class="card-title">Tenant Auswahl</h2>
              <p class="text-secondary" class="u-mt-text">Wählen Sie einen Tenant zur Feature-Verwaltung</p>
            </div>
            <div class="card-body">
              <select id="tenant-select" class="form-control">
                <option value="">Bitte Tenant wählen...</option>
              </select>
            </div>
          </div>

          <!-- Feature Übersicht -->
          <div id="features-container" class="u-hidden">
            <div class="card mb-4">
              <div class="card-header">
                <h2 class="card-title">Verfügbare Features</h2>
                <p class="text-secondary" class="u-mt-text">Übersicht aller Features und deren Aktivierungsstatus</p>
              </div>
              <div class="card-body">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Feature</th>
                      <th>Kategorie</th>
                      <th>Beschreibung</th>
                      <th>Basispreis</th>
                      <th>Status</th>
                      <th>Gültig bis</th>
                      <th>Nutzung</th>
                      <th>Aktionen</th>
                    </tr>
                  </thead>
                  <tbody id="features-table-body">
                    <!-- Features werden hier eingefügt -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Feature Aktivierung -->
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Feature Aktivierung</h2>
                <p class="text-secondary" class="u-mt-text">Features aktivieren oder deaktivieren</p>
              </div>
              <div class="card-body">
                <form id="activate-feature-form">
                  <div class="form-group">
                    <label>Feature auswählen</label>
                    <select id="feature-select" class="form-control">
                      <option value="">Bitte wählen...</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label>Gültig ab</label>
                    <input type="date" id="valid-from" class="form-control" required />
                  </div>
                  <div class="form-group">
                    <label>Gültig bis (optional)</label>
                    <input type="date" id="valid-until" class="form-control" />
                  </div>
                  <div class="form-group">
                    <label>Testphase (Tage)</label>
                    <input type="number" id="trial-days" class="form-control" min="0" value="0" />
                  </div>
                  <div class="form-group">
                    <label>Nutzungslimit (optional)</label>
                    <input type="number" id="usage-limit" class="form-control" min="0" />
                  </div>
                  <div class="form-group">
                    <label>Sonderpreis (optional)</label>
                    <input type="number" id="custom-price" class="form-control" min="0" step="0.01" />
                  </div>
                  <button type="submit" class="btn btn-primary">Feature aktivieren</button>
                </form>
              </div>
            </div>
          </div>
        </div>

        <script>
          const token = localStorage.getItem('token');
          let currentTenantId = null;
          const allFeatures = [];

          // Tenants laden
          async function loadTenants() {
            try {
              const response = await fetch('/admin/tenants', {
                headers: { Authorization: `Bearer ${token}` },
              });

              if (response.ok) {
                const tenants = await response.json();
                const select = document.querySelector('#tenant-select');

                tenants.forEach((tenant) => {
                  const option = document.createElement('option');
                  option.value = tenant.id;
                  option.textContent = `${tenant.company_name} (${tenant.subdomain})`;
                  select.append(option);
                });
              }
            } catch (error) {
              console.error('Error loading tenants:', error);
              showError('Fehler beim Laden der Tenants');
            }
          }

          // Features für Tenant laden
          async function loadTenantFeatures() {
            const tenantId = document.querySelector('#tenant-select').value;
            if (!tenantId) {
              document.querySelector('#features-container').style.display = 'none';
              return;
            }

            currentTenantId = tenantId;
            document.querySelector('#features-container').style.display = 'block';

            try {
              const response = await fetch(`/features/tenant/${tenantId}`, {
                headers: { Authorization: `Bearer ${token}` },
              });

              if (response.ok) {
                const features = await response.json();
                displayFeatures(features);
                populateFeatureSelect(features);
              }
            } catch (error) {
              console.error('Error loading features:', error);
              showError('Fehler beim Laden der Features');
            }
          }

          // Features anzeigen
          function displayFeatures(features) {
            const tbody = document.querySelector('#features-table-body');
            tbody.innerHTML = '';

            features.forEach((feature) => {
              const row = document.createElement('tr');
              const status = feature.status || 'disabled';
              const statusClass = `status-${status}`;
              const categoryClass = `category-${feature.category}`;

              // Create cells safely without innerHTML
              const cells = [
                feature.name,
                null, // category with special formatting
                feature.description,
                `€${feature.base_price}`,
                null, // status with special formatting
                feature.valid_until || '-',
                `${feature.current_usage || 0} / ${feature.usage_limit || '∞'}`,
                null, // action button
              ];

              // Name cell
              const nameCell = document.createElement('td');
              nameCell.textContent = cells[0];
              row.append(nameCell);

              // Category cell
              const categoryCell = document.createElement('td');
              const categorySpan = document.createElement('span');
              categorySpan.className = categoryClass;
              categorySpan.textContent = feature.category.toUpperCase();
              categoryCell.append(categorySpan);
              row.append(categoryCell);

              // Description cell
              const descCell = document.createElement('td');
              descCell.textContent = cells[2];
              row.append(descCell);

              // Price cell
              const priceCell = document.createElement('td');
              priceCell.textContent = cells[3];
              row.append(priceCell);

              // Status cell
              const statusCell = document.createElement('td');
              const statusSpan = document.createElement('span');
              statusSpan.className = statusClass;
              statusSpan.textContent = status.toUpperCase();
              statusCell.append(statusSpan);
              row.append(statusCell);

              // Valid until cell
              const validCell = document.createElement('td');
              validCell.textContent = cells[5];
              row.append(validCell);

              // Usage cell
              const usageCell = document.createElement('td');
              usageCell.textContent = cells[6];
              row.append(usageCell);

              // Action cell
              const actionCell = document.createElement('td');
              const button = document.createElement('button');
              if (status === 'active' || status === 'trial') {
                button.className = 'btn btn-sm btn-danger';
                button.textContent = 'Deaktivieren';
                button.setAttribute('data-action', 'deactivate');
                button.setAttribute('data-feature-code', feature.code);
              } else {
                button.className = 'btn btn-sm btn-success';
                button.textContent = 'Aktivieren';
                button.setAttribute('data-action', 'activate');
                button.setAttribute('data-feature-code', feature.code);
              }
              actionCell.append(button);
              row.append(actionCell);

              tbody.append(row);
            });
          }

          // Feature-Select befüllen
          function populateFeatureSelect(features) {
            const select = document.querySelector('#feature-select');
            select.innerHTML = '<option value="">Bitte wählen...</option>';

            const inactiveFeatures = features.filter((f) => !f.status || f.status === 'disabled' || f.status === 'expired');

            inactiveFeatures.forEach((feature) => {
              const option = document.createElement('option');
              option.value = feature.code;
              option.textContent = `${feature.name} (€${feature.base_price})`;
              select.append(option);
            });
          }

          // Feature aktivieren Form anzeigen
          function showActivateForm(featureCode) {
            document.querySelector('#feature-select').value = featureCode;
            document.querySelector('#activate-feature-form').scrollIntoView({ behavior: 'smooth' });
          }

          // Feature aktivieren
          document.querySelector('#activate-feature-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const featureCode = document.querySelector('#feature-select').value;
            if (!featureCode) {
              showError('Bitte ein Feature auswählen');
              return;
            }

            const options = {
              validFrom: document.querySelector('#valid-from').value,
              validUntil: document.querySelector('#valid-until').value || null,
              trialDays: parseInt(document.querySelector('#trial-days').value) || 0,
              usageLimit: parseInt(document.querySelector('#usage-limit').value) || null,
              customPrice: parseFloat(document.querySelector('#custom-price').value) || null,
            };

            try {
              const response = await fetch('/features/activate', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                  tenantId: currentTenantId,
                  featureCode,
                  options,
                }),
              });

              if (response.ok) {
                showSuccess('Feature erfolgreich aktiviert');
                loadTenantFeatures();
                document.querySelector('#activate-feature-form').reset();
              } else {
                const error = await response.json();
                showError(`Fehler: ${error.error}`);
              }
            } catch (error) {
              console.error('Error activating feature:', error);
              showError('Fehler beim Aktivieren des Features');
            }
          });

          // Feature deaktivieren
          async function deactivateFeature(featureCode) {
            if (!confirm('Feature wirklich deaktivieren?')) {
              return;
            }

            try {
              const response = await fetch('/features/deactivate', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                  tenantId: currentTenantId,
                  featureCode,
                }),
              });

              if (response.ok) {
                showSuccess('Feature erfolgreich deaktiviert');
                loadTenantFeatures();
              } else {
                const error = await response.json();
                showError(`Fehler: ${error.error}`);
              }
            } catch (error) {
              console.error('Error deactivating feature:', error);
              showError('Fehler beim Deaktivieren des Features');
            }
          }

          // Event Delegation for dynamic content
          document.addEventListener('click', function (e) {
            const target = e.target;

            // Handle feature actions
            if (target.hasAttribute('data-action')) {
              const action = target.getAttribute('data-action');
              const featureCode = target.getAttribute('data-feature-code');

              if (action === 'deactivate') {
                deactivateFeature(featureCode);
              } else if (action === 'activate') {
                showActivateForm(featureCode);
              }
            }
          });

          // Tenant select change handler
          document.querySelector('#tenant-select')?.addEventListener('change', function () {
            loadTenantFeatures();
          });

          // Initialisierung
          document.addEventListener('DOMContentLoaded', () => {
            // Heute als Standard für "Gültig ab"
            document.querySelector('#valid-from').value = new Date().toISOString().split('T')[0];

            loadTenants();
          });

          // Notification functions
          function showError(message) {
            const notification = document.createElement('div');
            notification.className = 'notification notification-error';

            const icon = document.createElement('i');
            icon.className = 'fas fa-exclamation-circle';
            const span = document.createElement('span');
            span.textContent = message;

            notification.append(icon);
            notification.append(span);
            document.body.append(notification);

            setTimeout(() => {
              notification.classList.add('show');
            }, 100);

            setTimeout(() => {
              notification.classList.remove('show');
              setTimeout(() => {
                notification.remove();
              }, 300);
            }, 4000);
          }

          function showSuccess(message) {
            const notification = document.createElement('div');
            notification.className = 'notification notification-success';

            const icon = document.createElement('i');
            icon.className = 'fas fa-check-circle';
            const span = document.createElement('span');
            span.textContent = message;

            notification.append(icon);
            notification.append(span);
            document.body.append(notification);

            setTimeout(() => {
              notification.classList.add('show');
            }, 100);

            setTimeout(() => {
              notification.classList.remove('show');
              setTimeout(() => {
                notification.remove();
              }, 300);
            }, 3000);
          }

          function showInfo(message) {
            const notification = document.createElement('div');
            notification.className = 'notification notification-info';

            const icon = document.createElement('i');
            icon.className = 'fas fa-info-circle';
            const span = document.createElement('span');
            span.textContent = message;

            notification.append(icon);
            notification.append(span);
            document.body.append(notification);

            setTimeout(() => {
              notification.classList.add('show');
            }, 100);

            setTimeout(() => {
              notification.classList.remove('show');
              setTimeout(() => {
                notification.remove();
              }, 300);
            }, 3500);
          }
        </script>
      </main>
    </div>
    <!-- Unified Navigation -->
    <script type="module" src="/scripts/components/unified-navigation.ts"></script>
    <!-- Breadcrumb -->
    <script type="module" src="/scripts/components/breadcrumb.js"></script>
  </body>
</html>
