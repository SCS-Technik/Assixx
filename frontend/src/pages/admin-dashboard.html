<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Assixx</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- Critical Layout State - Prevents Layout Shift -->
    <script>
      // Set sidebar state IMMEDIATELY to prevent any layout shift
      (function () {
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        document.documentElement.setAttribute('data-sidebar', sidebarCollapsed ? 'collapsed' : 'expanded');
        // Also set CSS custom properties for immediate use
        document.documentElement.style.setProperty('--sidebar-width', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--content-margin', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--grid-columns', sidebarCollapsed ? '4' : '3');
      })();
    </script>
    <!-- Admin Dashboard CSS extracted to external file -->
    <link rel="stylesheet" href="/styles/admin-dashboard.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="/styles/lib/fontawesome.min.css" />
    <link rel="stylesheet" href="/styles/user-info-update.css" />
    <link rel="stylesheet" href="/styles/blackboard-widget.css" />
    <!-- Feature Flags -->
    <script src="/feature-flags.js"></script>

    <!-- Unified Navigation CSS - Load immediately to prevent FOUC -->
    <link id="unified-navigation-styles" rel="stylesheet" href="/styles/unified-navigation.css" />
    <!-- Dom-utils Module für sichere HTML-Sanitization -->
    <script type="module">
      import { setHTML } from '/utils/dom-utils.js';
      // Make setHTML globally available for inline scripts
      window.setHTML = setHTML;
    </script>
  </head>
  <body class="admin-dashboard">
    <!-- Unified Navigation -->
    <div id="navigation-container"></div>

    <!-- Main Layout with Sidebar -->
    <div class="layout-container">
      <!-- Main Content Area -->
      <main class="main-content">
        <!-- Breadcrumb Navigation (außerhalb der Sections für permanente Sichtbarkeit) -->
        <div id="breadcrumb-container"></div>

        <div class="container">
          <!-- Dashboard Section -->
          <section id="dashboard-section" class="content-section">
            <!-- Dashboard Stats Grid -->
            <div class="dashboard-grid">
              <div class="stat-card">
                <div class="stat-value" id="employee-count">0</div>
                <div class="stat-label">Mitarbeiter</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="document-count">0</div>
                <div class="stat-label">Dokumente</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="department-count">0</div>
                <div class="stat-label">Abteilungen</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="team-count">0</div>
                <div class="stat-label">Teams</div>
              </div>
            </div>

            <!-- Blackboard Widget -->
            <div id="blackboard-widget-container" style="margin-top: 2rem" data-sidebar-state="loading">
              <!-- Loading placeholder with same styles as final widget -->
              <div class="blackboard-widget" style="animation: subtle-pulse 2s ease-in-out infinite">
                <div class="blackboard-widget-header">
                  <h3 class="blackboard-widget-title">
                    <i class="fas fa-thumbtack"></i>
                    Schwarzes Brett
                  </h3>
                  <a href="/blackboard" class="blackboard-widget-link" style="opacity: 0.5">
                    Alle anzeigen
                    <i class="fas fa-arrow-right"></i>
                  </a>
                </div>
                <div id="blackboard-widget-content" style="min-height: 200px; display: flex; align-items: center; justify-content: center">
                  <div class="text-muted" style="text-align: center">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem"></i>
                    <p>Lade Einträge...</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Main Grid Container -->
            <div class="admin-grid">
              <!-- Employee Card -->
              <div class="card compact-card">
                <div class="card-header">
                  <h2 class="card-title">Mitarbeiter</h2>
                  <p class="text-secondary" class="u-mt-text">Mitarbeiter verwalten und hinzufügen</p>
                </div>
                <div class="compact-content">
                  <a
                    href="/pages/manage-employees.html"
                    class="btn btn-primary btn-block mb-3"
                    style="display: flex; align-items: center; justify-content: center; text-decoration: none"
                  >
                    Mitarbeiter verwalten
                  </a>
                  <div class="compact-list" id="recent-employees">
                    <!-- Wird dynamisch gefüllt: Letzte 5 Mitarbeiter -->
                  </div>
                  <a href="/manage-employees" class="view-all-link" id="manage-employees-link">
                    Alle anzeigen
                    <span class="arrow">→</span>
                  </a>
                </div>
              </div>

              <!-- Document Card -->
              <div class="card compact-card">
                <div class="card-header">
                  <h2 class="card-title">Dokumente</h2>
                  <p class="text-secondary" class="u-mt-text">Dokumente hochladen und verwalten</p>
                </div>
                <div class="compact-content">
                  <a href="/document-upload" class="btn btn-primary btn-block mb-3">Dokument hochladen</a>
                  <div class="compact-list" id="recent-documents">
                    <!-- Wird dynamisch gefüllt: Letzte 5 Dokumente -->
                  </div>
                  <a href="/documents-search" class="view-all-link" id="manage-documents-link">
                    Verwalten
                    <span class="arrow">→</span>
                  </a>
                </div>
              </div>

              <!-- Department Card -->
              <div class="card compact-card">
                <div class="card-header">
                  <h2 class="card-title">Abteilungen</h2>
                  <p class="text-secondary" class="u-mt-text">Abteilungsstruktur organisieren</p>
                </div>
                <div class="compact-content">
                  <a href="/manage-departments" class="btn btn-primary btn-block mb-3">Abteilungen verwalten</a>
                  <div class="compact-list" id="department-list">
                    <!-- Wird dynamisch gefüllt -->
                  </div>
                  <a href="#" class="view-all-link" id="manage-departments-link">
                    Verwalten
                    <span class="arrow">→</span>
                  </a>
                </div>
              </div>

              <!-- Team Card -->
              <div class="card compact-card">
                <div class="card-header">
                  <h2 class="card-title">Teams</h2>
                  <p class="text-secondary" class="u-mt-text">Teams erstellen und verwalten</p>
                </div>
                <div class="compact-content">
                  <button class="btn btn-primary btn-block mb-3" data-action="show-team-modal">Neues Team</button>
                  <div class="compact-list" id="team-list">
                    <!-- Wird dynamisch gefüllt -->
                  </div>
                  <a href="#" class="view-all-link" data-action="show-all-teams">
                    Verwalten
                    <span class="arrow">→</span>
                  </a>
                </div>
              </div>

              <!-- Kalender Card -->
              <div class="card compact-card">
                <div class="card-header">
                  <h2 class="card-title">Kalender</h2>
                  <p class="text-secondary" class="u-mt-text">Termine und Events verwalten</p>
                </div>
                <div class="compact-content">
                  <a href="/calendar" class="btn btn-primary btn-block mb-3">Kalender öffnen</a>
                  <div class="compact-list" id="calendar-events-list">
                    <!-- Wird dynamisch gefüllt -->
                    <div class="list-item">
                      <div class="list-item-content">
                        <strong>Nächste Termine</strong>
                        <p class="text-secondary">Keine anstehenden Termine</p>
                      </div>
                    </div>
                  </div>
                  <a href="/calendar" class="view-all-link">
                    Alle anzeigen
                    <span class="arrow">→</span>
                  </a>
                </div>
              </div>
            </div>

            <!-- Recently Added Section -->
            <div class="card mt-4">
              <div class="card-header">
                <h2 class="card-title">Kürzlich hinzugefügt</h2>
                <p class="text-secondary" class="u-mt-text">Neueste Mitarbeiter und Dokumente</p>
              </div>
              <div class="recent-activity-grid">
                <div class="recent-section">
                  <h3>Neue Mitarbeiter</h3>
                  <ul id="recent-employees-list" class="recent-list">
                    <!-- Wird dynamisch gefüllt -->
                  </ul>
                </div>
                <div class="recent-section">
                  <h3>Neue Dokumente</h3>
                  <ul id="recent-documents-list" class="recent-list">
                    <!-- Wird dynamisch gefüllt -->
                  </ul>
                </div>
                <div class="recent-section">
                  <h3>Aktivitäten</h3>
                  <ul id="recent-activities-list" class="recent-list">
                    <!-- Wird dynamisch gefüllt -->
                  </ul>
                </div>
              </div>
            </div>
          </section>

          <!-- Payslips Section removed - now using documents-payroll.html -->

          <!-- Employees Section moved to /manage-employees -->

          <!-- Departments Section -->

          <!-- Departments Section -->
          <!-- Departments Section wurde nach departments.html verschoben -->

          <!-- Teams Section moved to /manage-teams -->

          <!-- Machines Section moved to /manage-machines -->

          <!-- Settings Section -->
          <section id="settings-section" class="content-section" class="u-hidden">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">System-Einstellungen</h2>
              </div>
              <p>Einstellungen werden hier implementiert...</p>
            </div>
          </section>
        </div>
      </main>
    </div>

    <!-- Modals -->
    <!-- Department Modal wurde nach departments.html verschoben -->

    <!-- Team Modal moved to /manage-teams -->

    <!-- Employee Status Modal -->
    <!-- Employee Status Modal removed - functionality moved to manage-employees.html -->

    <!-- Document Modal removed - functionality moved to /document-upload page -->

    <!-- Department Modal ist bereits weiter oben definiert -->
    <!-- Team Modal ist bereits weiter oben definiert -->

    <!-- Modal Styles -->

    <!-- Custom Dropdown Styles -->

    <!-- JavaScript -->
    <!-- Verhindert mehrfache Bestätigungsdialoge -->
    <script type="module" src="/scripts/confirm-once.ts"></script>

    <script>
      console.info('Admin dashboard HTML loaded');

      // Globale Modal-Funktionen direkt definieren
      window.showModal = function (modalId) {
        console.info('showModal called with:', modalId);
        const modal = document.querySelector(modalId);
        if (modal) {
          console.info('Modal element found, showing it');
          modal.style.display = 'flex';
        } else {
          console.error('Modal element not found:', modalId);
        }
      };

      window.hideModal = function (modalId) {
        const modal = document.querySelector(modalId);
        if (modal) {
          modal.style.display = 'none';
        } else {
          console.error('Modal element not found:', modalId);
        }
      };
    </script>

    <!-- Performance Monitoring Script -->
    <script>
      // Add performance monitoring to all fetch requests
      (function () {
        const originalFetch = window.fetch;
        let requestCounter = 0;

        window.fetch = function (...args) {
          const requestId = ++requestCounter;
          const url = args[0];
          const startTime = performance.now();

          console.info(`[Performance] Request #${requestId} starting: ${url}`);

          return originalFetch
            .apply(this, args)
            .then((response) => {
              const endTime = performance.now();
              const duration = (endTime - startTime).toFixed(2);
              console.info(`[Performance] Request #${requestId} completed: ${url} - ${duration}ms (Status: ${response.status})`);
              return response;
            })
            .catch((error) => {
              const endTime = performance.now();
              const duration = (endTime - startTime).toFixed(2);
              console.error(`[Performance] Request #${requestId} failed: ${url} - ${duration}ms`, error);
              throw error;
            });
        };

        // Log page load performance
        window.addEventListener('load', () => {
          const perfData = performance.getEntriesByType('navigation')[0];
          if (perfData) {
            console.info('[Performance] Page Load Metrics:');
            console.info(`  - DOM Content Loaded: ${perfData.domContentLoadedEventEnd.toFixed(2)}ms`);
            console.info(`  - Load Complete: ${perfData.loadEventEnd.toFixed(2)}ms`);
            console.info(`  - Total Resources: ${performance.getEntriesByType('resource').length}`);
          }
        });
      })();
    </script>

    <!-- Unified Navigation -->
    <script type="module" src="/scripts/components/unified-navigation.ts"></script>
    <script type="module" src="/scripts/show-section.ts"></script>
    <script type="module" src="/scripts/admin-dashboard.ts"></script>
    <script type="module" src="/scripts/role-switch.ts"></script>

    <!-- Breadcrumb Component -->
    <script type="module">
      import { initBreadcrumb } from '/scripts/components/breadcrumb.js';

      // Breadcrumb wird automatisch generiert basierend auf der URL
      initBreadcrumb();
    </script>

    <!-- Initialize dashboard on page load -->
    <script type="module">
      // Import ApiClient for dropdown functions
      import { ApiClient } from '/utils/api-client.js';
      window.ApiClient = ApiClient;

      // Check if user should be on admin dashboard by reading from JWT token
      const token = localStorage.getItem('token');
      let activeRole = null;
      let userRole = localStorage.getItem('userRole');

      // Parse the JWT token to get the actual active role
      if (token) {
        try {
          const payload = JSON.parse(atob(token.split('.')[1]));
          activeRole = payload.activeRole || payload.role;
          userRole = payload.role;

          // Update localStorage to match token
          localStorage.setItem('activeRole', activeRole);
          if (userRole) {
            localStorage.setItem('userRole', userRole);
          }

          console.info('[Admin Dashboard] Token analysis:', {
            tokenRole: payload.role,
            tokenActiveRole: payload.activeRole,
            finalActiveRole: activeRole,
          });
        } catch (e) {
          console.error('[Admin Dashboard] Error parsing token:', e);
          activeRole = localStorage.getItem('activeRole') || userRole;
        }
      } else {
        activeRole = localStorage.getItem('activeRole') || userRole;
      }

      // Admin and root users can access admin dashboard when in admin mode
      if ((userRole === 'admin' || userRole === 'root') && activeRole === 'admin') {
        // User is correctly on admin dashboard
        console.info('[Admin Dashboard] User has admin access');
      } else if ((userRole === 'admin' || userRole === 'root') && activeRole === 'employee') {
        // User has switched to employee role - redirect
        console.info('[Admin Dashboard] User has switched to employee - redirecting');
        window.location.replace('/employee-dashboard');
      } else if (userRole === 'root' && activeRole === 'root') {
        // Root user is in root mode - redirect to root dashboard
        console.info('[Admin Dashboard] Root user in root mode - redirecting to root dashboard');
        window.location.replace('/root-dashboard');
      } else if (userRole === 'employee') {
        // Employee trying to access admin dashboard - redirect
        console.info('[Admin Dashboard] Employee detected - redirecting to employee dashboard');
        window.location.replace('/employee-dashboard');
      } else if (!userRole) {
        // No user role - redirect to login
        console.info('[Admin Dashboard] No user role - redirecting to login');
        window.location.replace('/login');
      }

      // Ensure dashboard section is shown on page load
      document.addEventListener('DOMContentLoaded', () => {
        // Small delay to ensure all modules are loaded
        setTimeout(() => {
          // Check if a specific section was requested in URL
          const urlParams = new URLSearchParams(window.location.search);
          const requestedSection = urlParams.get('section');

          // If no specific section or 'dashboard-section' requested, show dashboard
          if (!requestedSection || requestedSection === 'dashboard-section' || requestedSection === 'dashboard') {
            // Fallback to direct DOM manipulation since showSection is not imported
            const dashboardSection = document.querySelector('#dashboard-section');
            if (dashboardSection) {
              // Hide all sections
              document.querySelectorAll('.content-section').forEach((section) => {
                section.style.display = 'none';
              });
              // Show dashboard
              dashboardSection.style.display = 'block';
            }
          }
        }, 100);
      });
    </script>
    <script>
      // Direkte Event-Listener hinzufügen
      console.info('Adding direct event listeners');

      document.addEventListener('DOMContentLoaded', () => {
        console.info('[Performance] DOMContentLoaded event fired');
        // Event-Listener für das Schließen des Mitarbeiter-Modals (neu mit data-action)
        const employeeModal = document.querySelector('#employee-modal');

        // Handler für alle Buttons mit data-action="close-employee-modal"
        document.querySelectorAll('[data-action="close-employee-modal"]').forEach((button) => {
          button.addEventListener('click', function () {
            console.info('Close employee modal button clicked');
            if (employeeModal) {
              employeeModal.style.display = 'none';
            }
          });
        });

        // Schließen des Modals beim Klick außerhalb
        employeeModal?.addEventListener('click', function (event) {
          if (event.target === employeeModal) {
            console.info('Clicked outside modal content, hiding employee modal');
            employeeModal.style.display = 'none';
          }
        });

        // Neue dedizierte Funktionen für Active Status Dropdown (Aktiv/Inaktiv)
        window.toggleActiveStatusDropdown = function () {
          console.info('toggleActiveStatusDropdown called');
          const dropdown = document.querySelector('#employee-active-status-dropdown');
          const display = document.querySelector('#employee-active-status-display');

          if (dropdown && display) {
            // Close all other dropdowns first
            document.querySelectorAll('.dropdown-options').forEach((d) => {
              if (d !== dropdown) d.classList.remove('active', 'show');
            });
            document.querySelectorAll('.dropdown-display').forEach((d) => {
              if (d !== display) d.classList.remove('active');
            });

            // Toggle this dropdown
            const isActive = dropdown.classList.contains('active');
            if (isActive) {
              dropdown.classList.remove('active', 'show');
              display.classList.remove('active');
              console.info('Active Status dropdown closed');
            } else {
              dropdown.classList.add('active', 'show');
              display.classList.add('active');
              console.info('Active Status dropdown opened - should be visible now!');
              console.info('Dropdown element:', dropdown);
              console.info('Classes on dropdown:', dropdown.className);
            }
          } else {
            console.error('Active Status dropdown elements not found');
          }
        };

        window.selectActiveStatusOption = function (value, text) {
          console.info('selectActiveStatusOption called:', value, text);
          const hiddenInput = document.querySelector('#employee-active-status-select');
          const display = document.querySelector('#employee-active-status-display');
          const dropdown = document.querySelector('#employee-active-status-dropdown');

          if (hiddenInput && display && dropdown) {
            hiddenInput.value = value;
            const span = display.querySelector('span');
            if (span) {
              span.textContent = text;
            }
            dropdown.classList.remove('active', 'show');
            display.classList.remove('active');
            console.info('Active Status selected:', value, text);
          }
        };

        // Global click handler to close dropdown when clicking outside
        document.addEventListener('click', function (e) {
          if (!e.target.closest('#employeeActiveStatusWrapper')) {
            const dropdown = document.querySelector('#employee-active-status-dropdown');
            const display = document.querySelector('#employee-active-status-display');
            if (dropdown && display) {
              dropdown.classList.remove('active', 'show');
              display.classList.remove('active');
            }
          }
        });

        // Helper functions for notifications
        function showSuccess(message) {
          // Create success toast/notification
          console.info('Success:', message);
          Toastify({
            text: message,
            duration: 3000,
            gravity: 'top',
            position: 'right',
            backgroundColor: '#22c55e',
          }).showToast();
        }

        function showError(message) {
          // Create error toast/notification
          console.error('Error:', message);
          Toastify({
            text: 'Fehler: ' + message,
            duration: 3000,
            gravity: 'top',
            position: 'right',
            backgroundColor: '#ef4444',
          }).showToast();
        }

        // Employee form submit handler
        const employeeForm = document.querySelector('#create-employee-form');
        if (employeeForm) {
          employeeForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const mode = this.dataset.mode || 'create';
            const employeeId = this.dataset.employeeId;

            // Convert FormData to object (safe from injection)
            const data = Object.create(null); // Use null prototype to prevent prototype pollution
            formData.forEach((value, key) => {
              // Convert to camelCase for API v2
              const camelKey = key.replace(/_([a-z])/g, (g) => g[1].toUpperCase());
              // Validate key to prevent injection
              if (typeof camelKey === 'string' && camelKey.length > 0) {
                // eslint-disable-next-line security/detect-object-injection
                data[camelKey] = value;
              }
            });

            // Get dropdown values
            data.departmentId = document.querySelector('#employee-department-select')?.value || null;
            data.teamId = document.querySelector('#employee-team-select')?.value || null;
            data.isActive = document.querySelector('#employee-active-status-select')?.value === '1';

            console.info('Submitting employee data:', data, 'Mode:', mode);

            try {
              const token = localStorage.getItem('token');
              let response;

              if (mode === 'edit' && employeeId) {
                // Update existing employee
                response = await fetch(`/api/v2/users/${employeeId}`, {
                  method: 'PUT',
                  headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`,
                  },
                  body: JSON.stringify(data),
                });
              } else {
                // Create new employee
                data.password = data.password || 'AssixxTemp123!'; // Default password for new users
                response = await fetch('/api/v2/users', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`,
                  },
                  body: JSON.stringify(data),
                });
              }

              if (response.ok) {
                await response.json();
                showSuccess(mode === 'edit' ? 'Mitarbeiter aktualisiert' : 'Mitarbeiter erstellt');

                // Close modal
                document.querySelector('#employee-modal').style.display = 'none';

                // Reset form
                employeeForm.reset();
                delete employeeForm.dataset.mode;
                delete employeeForm.dataset.employeeId;

                // Reload employees table if function exists
                if (typeof window.loadEmployeesTable === 'function') {
                  window.loadEmployeesTable();
                }
              } else {
                const error = await response.json();
                showError(error.message || 'Fehler beim Speichern');
              }
            } catch (error) {
              console.error('Error saving employee:', error);
              showError('Fehler beim Speichern des Mitarbeiters');
            }
          });
        }

        // Function to show new employee modal
        window.showNewEmployeeModal = function () {
          const modal = document.querySelector('#employee-modal');
          const form = document.querySelector('#create-employee-form');

          if (modal && form) {
            // Reset form
            form.reset();
            delete form.dataset.mode;
            delete form.dataset.employeeId;

            // Reset modal title
            const modalTitle = modal.querySelector('.modal-title');
            if (modalTitle) {
              modalTitle.textContent = 'Neuer Mitarbeiter';
            }

            // Make password fields required again for new employee
            const passwordInput = form.querySelector('input[name="password"]');
            const passwordConfirmInput = form.querySelector('input[name="passwordConfirm"]');
            if (passwordInput) passwordInput.setAttribute('required', 'required');
            if (passwordConfirmInput) passwordConfirmInput.setAttribute('required', 'required');

            // Show email confirm field again
            const emailConfirmGroup = form.querySelector('input[name="emailConfirm"]')?.closest('.form-group');
            if (emailConfirmGroup) emailConfirmGroup.style.display = 'block';

            // Reset submit button
            const submitBtn = document.querySelector('#employee-submit-btn');
            if (submitBtn) {
              submitBtn.innerHTML = '<i class="fas fa-save"></i> <span>Mitarbeiter erstellen</span>';
            }

            // Reset dropdowns
            if (typeof window.selectDropdownOption === 'function') {
              window.selectDropdownOption('employee-department', '', 'Keine Abteilung');
              window.selectDropdownOption('employee-team', '', 'Kein Team');
            }
            if (typeof window.selectActiveStatusOption === 'function') {
              window.selectActiveStatusOption('1', 'Aktiv');
            }

            // Show modal
            modal.style.display = 'flex';

            // Load departments for dropdown
            if (typeof window.loadDepartmentsForEmployeeSelect === 'function') {
              window.loadDepartmentsForEmployeeSelect();
            }
          }
        };

        console.info('DOM loaded, setting up debugging handlers');

        // Debug-Funktionen für alle Buttons (ENTFERNT - blockiert role-switch)
        // document.querySelectorAll('button').forEach((button) => {
        //   console.info('Found button:', button.textContent || button.innerHTML);
        //   button.addEventListener('click', function (e) {
        //     console.info('Button clicked:', this.textContent || this.innerHTML);
        //   });
        // });

        // Spezieller Listener für den Dokument-Upload-Button
        const docUploadBtn = document.querySelector('button[type="submit"]');
        if (docUploadBtn && docUploadBtn.textContent.includes('Gehaltsabrechnung hochladen')) {
          console.info('Dokument Upload Button gefunden:', docUploadBtn.textContent);
          // Button ist bereits Teil eines Formulars, kein zusätzlicher Listener nötig
        } else {
          console.info('Dokument Upload Button ist ein Submit-Button im Formular');
        }

        // Direkter Link für Sidebar-Links
        document.querySelectorAll('.sidebar-link').forEach((link) => {
          link.addEventListener('click', function (e) {
            const href = this.getAttribute('href');

            if (href === '#departments') {
              e.preventDefault();
              window.location.href = '/manage-departments';
            } else if (href === '#employees') {
              e.preventDefault();
              e.stopPropagation();
              console.info('Showing employees section');
              if (typeof window.showSection === 'function') {
                window.showSection('employees');
              }
            } else if (href === '#documents') {
              e.preventDefault();
              e.stopPropagation();
              console.info('Showing documents section');
              if (typeof window.showSection === 'function') {
                window.showSection('documents');
              }
            } else if (href === '#teams') {
              e.preventDefault();
              e.stopPropagation();
              console.info('Showing teams section');
              if (typeof window.showSection === 'function') {
                window.showSection('teams');
              }
            } else if (href === '#settings') {
              e.preventDefault();
              e.stopPropagation();
              console.info('Showing settings section');
              if (typeof window.showSection === 'function') {
                window.showSection('settings');
              }
            }
          });
        });

        // Department button code removed - button doesn't exist in HTML

        // Listener für "Abteilungen verwalten" Link wurde entfernt - Navigation erfolgt jetzt direkt
      });
    </script>
    <script>
      // Custom Dropdown Funktionen - Global definiert für Employee Modal
      // Using the same pattern as chat.html that works!
      function toggleDropdown(dropdownId) {
        console.info('toggleDropdown called for:', dropdownId);
        const dropdown = document.querySelector(dropdownId + '-dropdown');
        const display = document.querySelector(dropdownId + '-display');

        if (dropdown && display) {
          // Close all other dropdowns
          document.querySelectorAll('.dropdown-display').forEach((d) => {
            if (d !== display) d.classList.remove('active');
          });
          document.querySelectorAll('.dropdown-options').forEach((d) => {
            if (d !== dropdown) d.classList.remove('active');
          });

          // Toggle current dropdown
          display.classList.toggle('active');
          dropdown.classList.toggle('active');

          console.info('Dropdown toggled:', dropdown.classList.contains('active') ? 'opened' : 'closed');
        } else {
          console.error('Dropdown elements not found for:', dropdownId);
        }
      }

      // Add global click handler like in chat.html
      document.addEventListener('click', function (e) {
        if (!e.target.closest('.custom-dropdown')) {
          document.querySelectorAll('.dropdown-display').forEach((d) => d.classList.remove('active'));
          document.querySelectorAll('.dropdown-options').forEach((d) => d.classList.remove('active'));
        }
      });

      // Event Delegation for all data-action buttons (replacing onclick handlers)
      /* global showTeamModal, closeTeamModal, saveTeam, showMachineModal, closeMachineModal, saveMachine, showAreaModal, closeAreaModal, saveArea, showEmployeeModal, showAllTeams, hideModal, toggleDropdown, selectDropdownOption */
      document.addEventListener('click', function (e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;

        switch (action) {
          // Modal controls
          case 'show-team-modal':
            if (typeof showTeamModal === 'function') showTeamModal();
            break;
          case 'close-team-modal':
            if (typeof closeTeamModal === 'function') closeTeamModal();
            break;
          case 'save-team':
            if (typeof saveTeam === 'function') saveTeam();
            break;
          case 'show-machine-modal':
            if (typeof showMachineModal === 'function') showMachineModal();
            break;
          case 'close-machine-modal':
            if (typeof closeMachineModal === 'function') closeMachineModal();
            break;
          case 'save-machine':
            if (typeof saveMachine === 'function') saveMachine();
            break;
          case 'show-area-modal':
            if (typeof showAreaModal === 'function') showAreaModal();
            break;
          case 'close-area-modal':
            if (typeof closeAreaModal === 'function') closeAreaModal();
            break;
          case 'save-area':
            if (typeof saveArea === 'function') saveArea();
            break;
          case 'show-employee-modal':
            if (typeof showEmployeeModal === 'function') showEmployeeModal();
            break;
          case 'show-all-teams':
            e.preventDefault();
            if (typeof showAllTeams === 'function') showAllTeams();
            break;
          case 'hide-modal': {
            const modalId = target.dataset.modal;
            if (modalId && typeof hideModal === 'function') hideModal(modalId);
            break;
          }

          // Dropdown controls
          case 'toggle-dropdown': {
            const dropdownId = target.dataset.dropdown;
            if (dropdownId && typeof toggleDropdown === 'function') toggleDropdown(dropdownId);
            break;
          }
          case 'select-dropdown': {
            const dropdown = target.dataset.dropdown;
            const value = target.dataset.value || '';
            const display = target.dataset.display || '';
            if (typeof selectDropdownOption === 'function') {
              selectDropdownOption(dropdown, value, display);
            }
            break;
          }
        }
      });

      function selectDropdownOption(dropdownId, value, text) {
        console.info('selectDropdownOption called:', dropdownId, value, text);
        // Try both ID formats for compatibility
        let hiddenInput = document.querySelector(dropdownId + '-select');
        if (!hiddenInput) {
          hiddenInput = document.querySelector(dropdownId + 'Select');
        }
        const display = document.querySelector(dropdownId + '-display');
        const dropdown = document.querySelector(dropdownId + '-dropdown');

        if (hiddenInput && display && dropdown) {
          hiddenInput.value = value;
          const span = display.querySelector('span');
          if (span) {
            span.textContent = text;
          }
          dropdown.classList.remove('active'); // USE ACTIVE NOT SHOW!
          display.classList.remove('active');

          // Log successful selection
          console.info('✅ dropdown selected:', { dropdownId, value, text });

          // Spezielle Logik für Employee Status Dropdown
          if (dropdownId === 'employee-status') {
            const startDateInput = document.querySelector('#availability-start-date');
            const endDateInput = document.querySelector('#availability-end-date');

            if (startDateInput && endDateInput) {
              if (value === 'available') {
                // Bei "Verfügbar" Datumsfelder deaktivieren und leeren
                startDateInput.disabled = true;
                endDateInput.disabled = true;
                startDateInput.value = '';
                endDateInput.value = '';
                startDateInput.removeAttribute('required');
                endDateInput.removeAttribute('required');
              } else {
                // Bei anderen Status Datumsfelder aktivieren
                startDateInput.disabled = false;
                endDateInput.disabled = false;
                startDateInput.setAttribute('required', 'required');
                endDateInput.setAttribute('required', 'required');
              }
            }
          }

          // Trigger change event for dependent dropdowns
          if (dropdownId === 'employeeDepartment') {
            // Reload teams when department changes
            if (typeof window.loadTeamsForEmployeeSelect === 'function') {
              window.loadTeamsForEmployeeSelect();
            }
          }
        } else {
          console.error('Dropdown elements not found for selection:', dropdownId);
        }
      }

      // Ensure functions are available globally
      window.toggleDropdown = toggleDropdown;
      window.selectDropdownOption = selectDropdownOption;
    </script>
    <script>
      /* global DOMPurify */
      // Funktionstabelle direkt definieren

      // Load documents table
      async function loadDocumentsTable() {
        console.info('Loading documents table');
        const token = localStorage.getItem('token');

        try {
          const response = await fetch('/api/documents', {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            const data = await response.json();
            const documents = data.documents || data;
            console.info(`Loaded ${documents.length} documents`);

            const tbody = document.querySelector('#documents-table-body');
            if (tbody) {
              // Safe: HTML is generated from server data and sanitized with dom-utils
              const htmlContent = documents
                .map((doc) => {
                  // Bestimme den Empfänger-Text basierend auf recipient_type
                  let recipientDisplay = '-';
                  if (doc.recipient_type === 'user' && doc.employee_name) {
                    recipientDisplay = doc.employee_name;
                  } else if (doc.recipient_type === 'team' && doc.team_name) {
                    recipientDisplay = `Team: ${doc.team_name}`;
                  } else if (doc.recipient_type === 'department' && doc.department_name) {
                    recipientDisplay = `Abteilung: ${doc.department_name}`;
                  } else if (doc.recipient_type === 'company') {
                    recipientDisplay = 'Gesamte Firma';
                  } else if (doc.employee_name) {
                    // Fallback für alte Dokumente
                    recipientDisplay = doc.employee_name;
                  }

                  return `
                    <tr>
                      <td>${doc.file_name || doc.filename || '-'}</td>
                      <td>${recipientDisplay}</td>
                      <td>${doc.category || '-'}</td>
                      <td>${doc.upload_date ? new Date(doc.upload_date).toLocaleDateString('de-DE') : '-'}</td>
                      <td>
                        <span class="badge ${doc.is_archived ? 'badge-secondary' : 'badge-success'}">
                          ${doc.is_archived ? 'Archiviert' : 'Aktiv'}
                        </span>
                      </td>
                      <td>
                        <div class="btn-group" role="group">
                          <button class="btn btn-sm btn-primary" data-action="download-document" data-doc-id="${doc.id}" title="Herunterladen">
                            <i class="fas fa-download me-1"></i>
                            Download
                          </button>
                          ${
                            !doc.is_archived
                              ? `
                            <button class="btn btn-sm btn-warning" data-action="archive-document" data-doc-id="${doc.id}" title="Archivieren">
                              <i class="fas fa-archive me-1"></i>
                              Archiv
                            </button>
                          `
                              : ''
                          }
                          <button class="btn btn-sm btn-danger" data-action="delete-document" data-doc-id="${doc.id}" title="Löschen">
                            <i class="fas fa-trash me-1"></i>
                            Löschen
                          </button>
                        </div>
                      </td>
                    </tr>
                  `;
                })
                .join('');
              // Use dom-utils setHTML for safe sanitization
              window.setHTML(tbody, htmlContent);

              // Event delegation for document actions
              if (!tbody.dataset.delegationInitialized) {
                tbody.dataset.delegationInitialized = 'true';
                tbody.addEventListener('click', (e) => {
                  const button = e.target.closest('[data-action]');
                  if (button) {
                    const action = button.dataset.action;
                    const docId = button.dataset.docId;

                    switch (action) {
                      case 'download-document':
                        if (window.downloadDocument) window.downloadDocument(parseInt(docId));
                        break;
                      case 'archive-document':
                        if (window.archiveDocument) window.archiveDocument(parseInt(docId));
                        break;
                      case 'delete-document':
                        if (window.deleteDocument) window.deleteDocument(parseInt(docId));
                        break;
                    }
                  }
                });
              }
            }
          }
        } catch (error) {
          console.error('Error loading documents:', error);
        }
      }

      // Mitarbeiter-Status ändern
      window.changeEmployeeStatus = async function (employeeId) {
        console.info(`Changing status for employee ${employeeId}`);
        const token = localStorage.getItem('token');

        try {
          // Mitarbeiter-Daten laden
          const response = await (window.FEATURE_FLAGS?.USE_API_V2_USERS
            ? fetch(`/api/v2/users/${employeeId}`, {
                method: 'GET',
                headers: {
                  Authorization: `Bearer ${localStorage.getItem('accessToken') || token}`,
                },
              })
            : fetch(`/api/users/${employeeId}`, {
                headers: { Authorization: `Bearer ${token}` },
              }));

          if (!response.ok) {
            console.error('Response not OK:', response.status, response.statusText);
            const errorData = await response.text();
            console.error('Error data:', errorData);
            throw new Error('Failed to load employee data');
          }

          const responseData = await response.json();
          // Handle v2 API response structure
          const employee =
            window.FEATURE_FLAGS?.USE_API_V2_USERS && responseData.success !== undefined ? responseData.data || {} : responseData;
          console.info('Employee data loaded:', employee);

          // Modal-Felder befüllen
          console.info('Looking for modal elements...');
          const modal = document.querySelector('#employee-status-modal');
          console.info('Modal found:', !!modal);

          const employeeIdInput = document.querySelector('#status-employee-id');
          const employeeName = document.querySelector('#status-employee-name');
          const statusDropdown = document.querySelector('#employee-status-dropdown');
          const statusDisplay = document.querySelector('#employee-status-display');

          console.info('Elements found:', {
            employeeIdInput: !!employeeIdInput,
            employeeName: !!employeeName,
            statusDropdown: !!statusDropdown,
            statusDisplay: !!statusDisplay,
          });

          console.info('DOM Elements:', {
            employeeIdInput: employeeIdInput,
            employeeName: employeeName,
            employeeNameType: employeeName ? employeeName.tagName : 'null',
          });

          if (employeeIdInput) {
            employeeIdInput.value = employeeId;
            console.info('Set employee ID:', employeeId);
          }
          if (employeeName) {
            // Handle both v1 (snake_case) and v2 (camelCase) field names
            const firstName = employee.firstName || employee.first_name || '';
            const lastName = employee.lastName || employee.last_name || '';
            const fullName = `${firstName} ${lastName}`;
            employeeName.value = fullName;
            console.info('Set employee name:', fullName);
          } else {
            console.error('Employee name input not found! Element might not exist in DOM.');
            // Try to recover by checking if modal exists
            const modalCheck = document.querySelector('#employee-status-modal');
            if (!modalCheck) {
              console.error('Modal itself not found! Cannot proceed.');
              alert('Ein Fehler ist aufgetreten. Bitte laden Sie die Seite neu.');
              return;
            }
          }

          // Aktuellen Status setzen - handle both v1 and v2 field names
          let currentStatus = employee.availabilityStatus || employee.availability_status || 'available';
          // Map v2 API's "other" back to "unavailable" for display
          if (window.FEATURE_FLAGS?.USE_API_V2_USERS && currentStatus === 'other') {
            currentStatus = 'unavailable';
          }
          if (statusDisplay) {
            // Use Map to avoid object injection vulnerability
            const statusMap = new Map([
              ['available', 'Verfügbar'],
              ['vacation', 'Urlaub'],
              ['sick', 'Krank'],
              ['unavailable', 'Nicht verfügbar'],
            ]);
            const statusText = statusMap.get(currentStatus) || 'Verfügbar';
            statusDisplay.querySelector('span').textContent = statusText;
          }

          // Datumsfelder initial setzen
          const startDateInput = document.querySelector('#availability-start-date');
          const endDateInput = document.querySelector('#availability-end-date');

          if (startDateInput && endDateInput) {
            if (currentStatus === 'available') {
              // Bei "Verfügbar" Datumsfelder deaktivieren
              startDateInput.disabled = true;
              endDateInput.disabled = true;
              startDateInput.value = '';
              endDateInput.value = '';
              startDateInput.removeAttribute('required');
              endDateInput.removeAttribute('required');
            } else {
              // Bei anderen Status Datumsfelder aktivieren und vorhandene Werte setzen
              startDateInput.disabled = false;
              endDateInput.disabled = false;
              startDateInput.setAttribute('required', 'required');
              endDateInput.setAttribute('required', 'required');

              // Vorhandene Daten setzen falls vorhanden
              if (employee.availability_start) {
                startDateInput.value = employee.availability_start.split('T')[0];
              }
              if (employee.availability_end) {
                endDateInput.value = employee.availability_end.split('T')[0];
              }
            }
          }

          // Modal öffnen (reuse the already declared modal variable)
          if (modal) {
            modal.style.display = 'flex';
            console.info('Modal opened');

            // Form zurücksetzen - NACH dem Setzen der Werte!
            // Das war das Problem - form.reset() löscht alle Werte
            const form = document.querySelector('#employee-status-form');
            if (form) {
              // Nur die Date-Felder und Notes zurücksetzen, nicht alle Felder
              const startDate = form.querySelector('input[name="start_date"]');
              const endDate = form.querySelector('input[name="end_date"]');
              const notes = form.querySelector('textarea[name="notes"]');

              if (startDate) startDate.value = '';
              if (endDate) endDate.value = '';
              if (notes) notes.value = '';

              // Hidden input für status setzen
              const hiddenInput = form.querySelector('input[name="status"]');
              if (hiddenInput) hiddenInput.value = currentStatus;
            }
          }
        } catch (error) {
          console.error('Error loading employee for status change:', error);
          alert('Fehler beim Laden der Mitarbeiterdaten');
        }
      };

      // Employee Status Form Submit Handler
      document.addEventListener('DOMContentLoaded', () => {
        const statusForm = document.querySelector('#employee-status-form');
        if (statusForm) {
          statusForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(statusForm);
            const employeeId = document.querySelector('#status-employee-id').value;
            const token = localStorage.getItem('token');

            // Get the status and map "unavailable" to "other" for v2 API
            const rawStatus = formData.get('status');
            const v2Status = rawStatus === 'unavailable' ? 'other' : rawStatus;

            // Get dates and convert to ISO format for v2
            const startDate = formData.get('start_date');
            const endDate = formData.get('end_date');

            // Build the data object based on API version
            const statusData = window.FEATURE_FLAGS?.USE_API_V2_USERS
              ? (() => {
                  // v2 API expects camelCase and specific status values
                  const data = {
                    availabilityStatus: v2Status,
                  };
                  // Only include dates if they have values (v2 validation expects ISO format or nothing)
                  if (startDate) {
                    data.availabilityStart = new Date(startDate).toISOString();
                  }
                  if (endDate) {
                    data.availabilityEnd = new Date(endDate).toISOString();
                  }
                  const notes = formData.get('notes');
                  if (notes) {
                    data.availabilityNotes = notes;
                  }
                  return data;
                })()
              : {
                  // v1 API expects snake_case
                  availability_status: formData.get('status'),
                  availability_start: formData.get('start_date'),
                  availability_end: formData.get('end_date'),
                  availability_notes: formData.get('notes'),
                };

            try {
              const response = await (window.FEATURE_FLAGS?.USE_API_V2_USERS
                ? fetch(`/api/v2/users/${employeeId}/availability`, {
                    method: 'PUT',
                    headers: {
                      'Content-Type': 'application/json',
                      Authorization: `Bearer ${localStorage.getItem('accessToken') || token}`,
                    },
                    body: JSON.stringify(statusData),
                  })
                : fetch(`/api/users/${employeeId}/availability`, {
                    method: 'PUT',
                    headers: {
                      'Content-Type': 'application/json',
                      Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify(statusData),
                  }));

              if (response.ok) {
                alert('Verfügbarkeitsstatus erfolgreich aktualisiert');
                hideModal('employee-status-modal');
                // Seite neu laden für vollständige Aktualisierung
                window.location.reload();
              } else {
                const errorData = await response.json();
                console.error('API Error Response:', errorData);
                // Handle v2 API error format
                const errorMessage = window.FEATURE_FLAGS?.USE_API_V2_USERS
                  ? errorData.error?.message || errorData.message || 'Status konnte nicht aktualisiert werden'
                  : errorData.message || 'Status konnte nicht aktualisiert werden';
                alert(`Fehler: ${errorMessage}`);
                // Log the full request data for debugging
                console.info('Request data sent was:', statusData);
              }
            } catch (error) {
              console.error('Error updating availability status:', error);
              alert('Ein Fehler ist aufgetreten beim Aktualisieren des Status');
            }
          });
        }
      });

      // Abteilung löschen
      window.deleteDepartment = async function (departmentId) {
        console.info(`Deleting department ${departmentId}`);
        if (!confirm('Sind Sie sicher, dass Sie diese Abteilung löschen möchten?')) {
          return;
        }

        const token = localStorage.getItem('token');

        try {
          const response = await (window.FEATURE_FLAGS?.USE_API_V2_DEPARTMENTS
            ? fetch(`/api/v2/departments/${departmentId}`, {
                method: 'DELETE',
                headers: {
                  Authorization: `Bearer ${localStorage.getItem('accessToken') || token}`,
                },
              })
            : fetch(`/api/departments/${departmentId}`, {
                method: 'DELETE',
                headers: { Authorization: `Bearer ${token}` },
              }));

          if (response.ok) {
            alert('Abteilung erfolgreich gelöscht');
            if (typeof window.loadDepartmentsTable === 'function') {
              window.loadDepartmentsTable();
            }
          } else {
            const error = await response.json();
            alert(`Fehler: ${error.message}`);
          }
        } catch (error) {
          console.error('Error deleting department:', error);
          alert('Ein Fehler ist aufgetreten.');
        }
      };

      // OLD editEmployeeAsync - REMOVED (replaced by new editEmployee function above)

      // Mitarbeiter löschen - moved to manage-employees.ts

      // Mitarbeiterstatus ändern
      window.toggleEmployeeStatus = async function (employeeId, currentStatus) {
        console.info(`Toggling employee ${employeeId} status from ${currentStatus}`);
        const token = localStorage.getItem('token');
        const newStatus = currentStatus === 'inactive' ? 'active' : 'inactive';

        try {
          const response = await fetch(`/admin/toggle-employee-status/${employeeId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ status: newStatus }),
          });

          if (response.ok) {
            alert(`Mitarbeiterstatus wurde zu "${newStatus}" geändert`);
            loadEmployeesTable('reload');
          } else {
            const error = await response.json();
            alert(`Fehler: ${error.message}`);
          }
        } catch (error) {
          console.error('Error toggling employee status:', error);
          alert('Ein Fehler ist aufgetreten.');
        }
      };

      // Add event listener for payslip upload form
      document.addEventListener('DOMContentLoaded', () => {
        // Payslip form removed - now using documents-payroll.html
      });

      // Upload payslip function removed - now using documents-payroll.html
      // Logo und Übersicht verarbeiten
      document.addEventListener('DOMContentLoaded', () => {
        // Logo-Klick behandeln
        const logoContainer = document.querySelector('.logo-container');
        if (logoContainer) {
          logoContainer.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = '/admin-dashboard';
          });
        }

        // Übersicht-Link in der Seitennavigation
        const dashboardLink = document.querySelector('.sidebar-link[href="#dashboard"]');
        if (dashboardLink) {
          dashboardLink.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.reload();
          });
        }

        // Logout wird von unified-navigation behandelt
      });

      // Modal functions redefined for redundancy
      function showModal(modalId) {
        console.info('Inline showModal called with:', modalId);
        const modal = document.querySelector(modalId);
        if (modal) {
          console.info('Modal element found in inline function, showing it');
          modal.style.display = 'flex';
        } else {
          console.error('Modal element not found in inline function:', modalId);
        }
      }

      function hideModal(modalId) {
        console.info('hideModal called for:', modalId);
        const modal = document.querySelector(modalId);
        if (modal) {
          console.info('Modal element found in hideModal, hiding it');
          modal.style.display = 'none';
        } else {
          console.error('Modal element not found in hideModal:', modalId);
        }
      }

      // REMOVED: Duplicate dropdown functions - using the ones defined earlier (line 2011)

      // Lade Abteilungen für Employee Modal
      // Cache for departments to prevent multiple API calls
      let departmentsCache = null;
      let departmentsCacheTime = 0;
      const CACHE_DURATION = 30000; // 30 seconds

      async function loadDepartmentsForEmployeeSelect() {
        try {
          // Check cache first
          if (departmentsCache && Date.now() - departmentsCacheTime < CACHE_DURATION) {
            const dropdown = document.querySelector('#employeeDepartment-dropdown');
            if (dropdown && departmentsCache) {
              updateDepartmentDropdown(dropdown, departmentsCache);
            }
            return;
          }

          // Ensure ApiClient is available and create instance
          if (typeof ApiClient === 'undefined') {
            console.error('ApiClient not loaded yet');
            return;
          }

          const apiClient = new ApiClient();
          const response = await apiClient.get('/departments');

          // API v2 returns { success: true, data: [...] }
          const departments = response.data || response;

          // Store in cache (atomic update to prevent race condition)
          // eslint-disable-next-line require-atomic-updates
          departmentsCache = departments;
          // eslint-disable-next-line require-atomic-updates
          departmentsCacheTime = Date.now();

          const dropdown = document.querySelector('#employeeDepartment-dropdown');

          if (dropdown && departments) {
            updateDepartmentDropdown(dropdown, departments);
          }
        } catch (error) {
          console.error('Error loading departments:', error);
        }
      }

      function updateDepartmentDropdown(dropdown, departments) {
        if (dropdown && departments) {
          // Clear existing options and add default
          dropdown.innerHTML = `
              <div class="dropdown-option" data-value="" data-action="select-dropdown" data-dropdown="employeeDepartment" data-display="Keine Abteilung">
                <i class="fas fa-times-circle"></i> Keine Abteilung
              </div>
            `;

          // Add department options
          departments.forEach((dept) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'dropdown-option';
            optionDiv.setAttribute('data-value', dept.id.toString());
            optionDiv.setAttribute('data-text', dept.name);
            // Escape HTML to prevent XSS
            const textNode = document.createTextNode(dept.name);
            const iconElement = document.createElement('i');
            iconElement.className = 'fas fa-building';
            optionDiv.append(iconElement);
            optionDiv.append(document.createTextNode(' '));
            optionDiv.append(textNode);
            dropdown.append(optionDiv);
          });

          // Setup event delegation for dropdown clicks
          const dropdownEl = document.querySelector('#employee-department-dropdown');
          if (dropdownEl && !dropdownEl.hasAttribute('data-listener-attached')) {
            dropdownEl.setAttribute('data-listener-attached', 'true');
            dropdownEl.addEventListener('click', (event) => {
              const target = event.target;
              const option = target.closest('.dropdown-option');
              if (option) {
                const value = option.getAttribute('data-value') || '';
                const text = option.getAttribute('data-text') || '';
                if (typeof window.selectDropdownOption === 'function') {
                  window.selectDropdownOption('employeeDepartment', value, text);
                }
              }
            });
          }

          console.info('Loaded departments for employee select:', departments.length);
        } else {
          console.error('[loadDepartmentsForEmployeeSelect] Missing dropdown or departments!');
          console.error('Dropdown:', dropdown);
          console.error('Departments:', departments);
        }
      }

      // Lade Teams für Employee Modal
      async function loadTeamsForEmployeeSelect() {
        try {
          // Ensure ApiClient is available
          if (typeof ApiClient === 'undefined') {
            console.error('ApiClient not loaded yet');
            return;
          }

          const apiClient = new ApiClient();

          // Get selected department to filter teams
          const selectedDeptId = document.querySelector('#employeeDepartmentSelect')?.value;

          const response = await apiClient.get('/teams');
          // API v2 returns { success: true, data: [...] }
          const allTeams = response.data || response;
          const dropdown = document.querySelector('#employeeTeam-dropdown');

          if (dropdown && allTeams) {
            // Filter teams by department if one is selected
            let teams = allTeams;
            if (selectedDeptId) {
              teams = allTeams.filter((team) => team.departmentId == selectedDeptId);
            }

            // Clear existing options and add default
            dropdown.innerHTML = `
              <div class="dropdown-option" data-value="" data-action="select-dropdown" data-dropdown="employeeTeam" data-display="Kein Team">
                <i class="fas fa-times-circle"></i> Kein Team
              </div>
            `;

            // Add team options
            teams.forEach((team) => {
              const optionDiv = document.createElement('div');
              optionDiv.className = 'dropdown-option';
              optionDiv.setAttribute('data-value', team.id.toString());
              const teamDisplay = team.departmentName ? `${team.name} (${team.departmentName})` : team.name;
              optionDiv.setAttribute('data-text', teamDisplay);
              // Escape HTML to prevent XSS
              const textNode = document.createTextNode(teamDisplay);
              const iconElement = document.createElement('i');
              iconElement.className = 'fas fa-users';
              optionDiv.append(iconElement);
              optionDiv.append(document.createTextNode(' '));
              optionDiv.append(textNode);
              dropdown.append(optionDiv);
            });

            // Setup event delegation for dropdown clicks
            const dropdownEl = document.querySelector('#employee-team-dropdown');
            if (dropdownEl && !dropdownEl.hasAttribute('data-listener-attached')) {
              dropdownEl.setAttribute('data-listener-attached', 'true');
              dropdownEl.addEventListener('click', (event) => {
                const target = event.target;
                const option = target.closest('.dropdown-option');
                if (option) {
                  const value = option.getAttribute('data-value') || '';
                  const text = option.getAttribute('data-text') || '';
                  if (typeof window.selectDropdownOption === 'function') {
                    window.selectDropdownOption('employeeTeam', value, text);
                  }
                }
              });
            }

            console.info(
              `Loaded teams for employee select: ${teams.length} teams ${selectedDeptId ? 'for department ' + selectedDeptId : '(all)'}`,
            );
          }
        } catch (error) {
          console.error('Error loading teams:', error);
        }
      }

      function showEmployeeModal() {
        console.info('showEmployeeModal function called');
        const modal = document.querySelector('#employee-modal');
        if (modal) {
          console.info('employee-modal found, showing directly');
          modal.style.display = 'flex';

          // Warte kurz bis Modal vollständig gerendert ist
          setTimeout(() => {
            console.info('Loading departments and teams for employee modal...');

            // Abteilungen für das Formular laden
            if (typeof loadDepartmentsForEmployeeSelect === 'function') {
              loadDepartmentsForEmployeeSelect();
            } else {
              console.error('loadDepartmentsForEmployeeSelect is not a function');
            }

            // Teams für das Formular laden
            if (typeof loadTeamsForEmployeeSelect === 'function') {
              loadTeamsForEmployeeSelect();
            } else {
              console.warn('loadTeamsForEmployeeSelect is not defined yet');
            }
          }, 100);
        } else {
          console.error('employee-modal not found');
          alert('Das Mitarbeiterformular konnte nicht geöffnet werden.');
        }
      }

      // showDocumentModal removed - functionality moved to /document-upload page

      // Make functions globally available
      window.showEmployeeModal = showEmployeeModal;
      window.loadDepartmentsForEmployeeSelect = loadDepartmentsForEmployeeSelect;
      window.loadTeamsForEmployeeSelect = loadTeamsForEmployeeSelect;
      window.showModal = showModal;
      window.hideModal = hideModal;
      // eslint-disable-next-line no-undef
      window.toggleDropdown = toggleDropdown;
      // selectDropdownOption is defined above in line 1636
      // Safe to use here as it's defined in the same scope
      // eslint-disable-next-line no-undef
      window.selectDropdownOption = selectDropdownOption;

      // Global click handler to close dropdowns when clicking outside
      document.addEventListener('click', function (e) {
        if (!e.target.closest('.custom-dropdown') && !e.target.closest('.dropdown-display')) {
          document.querySelectorAll('.dropdown-options').forEach((d) => {
            d.classList.remove('active', 'show');
          });
          document.querySelectorAll('.dropdown-display').forEach((d) => {
            d.classList.remove('active');
          });
        }
      });

      // showDepartmentModal wurde nach departments.html verschoben

      window.showTeamModal = function () {
        showModal('team-modal');
        // Abteilungen für Select laden
        if (typeof window.loadDepartmentsForSelect === 'function') {
          window.loadDepartmentsForSelect();
        }
      };

      window.hideTeamModal = function () {
        hideModal('team-modal');
      };

      // Modal schließen bei Klick außerhalb
      window.addEventListener('click', function (event) {
        const modals = ['employee-modal', 'team-modal'];
        modals.forEach((modalId) => {
          const modal = document.querySelector(modalId);
          if (event.target == modal) {
            console.info(`Clicked outside of ${modalId}, closing it`);
            modal.style.display = 'none';
          }
        });
      });

      // Placeholder functions for "view all" links
      window.showAllEmployees = function () {
        console.info('Show all employees');
      };

      // Load employees table
      async function loadEmployeesTable() {
        console.info('Loading employees table...');
        const token = localStorage.getItem('token');

        try {
          const response = await (window.FEATURE_FLAGS?.USE_API_V2_USERS
            ? fetch('/api/v2/users?role=employee', {
                method: 'GET',
                headers: {
                  Authorization: `Bearer ${localStorage.getItem('accessToken') || token}`,
                },
              })
            : fetch('/api/users?role=employee', {
                headers: {
                  Authorization: `Bearer ${token}`,
                },
              }));

          if (!response.ok) {
            throw new Error('Failed to load employees');
          }

          const responseData = await response.json();
          console.info('Loaded employees response:', responseData); // Debug

          // Handle v2 API response structure
          let employees;
          if (window.FEATURE_FLAGS?.USE_API_V2_USERS && responseData.success !== undefined) {
            // v2 API returns { success: true, data: [...] }
            employees = responseData.data || [];
          } else {
            // v1 API returns array directly
            employees = responseData;
          }

          console.info('Processed employees:', employees); // Debug
          const tableBody = document.querySelector('#employees-table-body');

          if (!tableBody) {
            console.error('employees-table-body not found');
            return;
          }

          tableBody.innerHTML = '';

          if (!employees || !Array.isArray(employees) || employees.length === 0) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="8" class="text-center text-muted">Keine Mitarbeiter gefunden</td>
              </tr>
            `;
            return;
          }

          employees.forEach((employee) => {
            const row = document.createElement('tr');

            // Handle both v1 (snake_case) and v2 (camelCase) field names for availability
            let availabilityStatus = employee.availabilityStatus || employee.availability_status || 'available';
            // Map v2 API's "other" back to "unavailable" for display
            if (window.FEATURE_FLAGS?.USE_API_V2_USERS && availabilityStatus === 'other') {
              availabilityStatus = 'unavailable';
            }
            const availabilityStart = employee.availabilityStart || employee.availability_start;
            const availabilityEnd = employee.availabilityEnd || employee.availability_end;

            // Verfügbarkeitsstatus bestimmen - prüfe ob innerhalb des Datumbereichs
            let effectiveStatus = availabilityStatus;
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Zeit auf Mitternacht setzen für korrekten Vergleich

            // Debug-Ausgabe für ersten Mitarbeiter
            if (employee.id === 19) {
              console.info('Employee 19 debug:', {
                availability_status: availabilityStatus,
                availability_start: availabilityStart,
                availability_end: availabilityEnd,
                today: today.toISOString(),
              });
            }

            // Prüfe ob Verfügbarkeitsdaten vorhanden sind und ob wir im Zeitraum sind
            if (availabilityStatus !== 'available' && availabilityStart && availabilityEnd) {
              const startDate = new Date(availabilityStart);
              const endDate = new Date(availabilityEnd);
              startDate.setHours(0, 0, 0, 0);
              endDate.setHours(23, 59, 59, 999);

              // Debug für Employee 19
              if (employee.id === 19) {
                console.info('Date comparison:', {
                  startDate: startDate.toISOString(),
                  endDate: endDate.toISOString(),
                  todayIsAfterStart: today >= startDate,
                  todayIsBeforeEnd: today <= endDate,
                  shouldShowStatus: today >= startDate && today <= endDate,
                });
              }

              // Wenn heute außerhalb des Zeitraums liegt, ist der Mitarbeiter verfügbar
              if (today < startDate || today > endDate) {
                effectiveStatus = 'available';
              }
            }

            // Use Map to avoid object injection vulnerability
            const badgeClassMap = new Map([
              ['available', 'badge-success'],
              ['vacation', 'badge-warning'],
              ['sick', 'badge-danger'],
              ['unavailable', 'badge-secondary'],
            ]);
            const availabilityBadgeClass = badgeClassMap.get(effectiveStatus) || 'badge-success';

            // Use Map to avoid object injection vulnerability
            const availabilityTextMap = new Map([
              ['available', 'Verfügbar'],
              ['vacation', 'Urlaub'],
              ['sick', 'Krank'],
              ['unavailable', 'Beurlaubt'],
            ]);
            const availabilityText = availabilityTextMap.get(effectiveStatus) || 'Verfügbar';

            // Handle both v1 (snake_case) and v2 (camelCase) field names
            const firstName = employee.firstName || employee.first_name || '';
            const lastName = employee.lastName || employee.last_name || '';

            // Safe: HTML is generated from server data and sanitized with dom-utils
            const rowHtml = `
              <td>${firstName} ${lastName}</td>
              <td>${employee.email || ''}</td>
              <td>${employee.employeeId || employee.employee_id || employee.id || ''}</td>
              <td>${employee.departmentName || employee.department || 'Keine Abteilung'}</td>
              <td>
                <span class="badge ${(employee.isActive ?? employee.is_active) ? 'badge-success' : 'badge-danger'}">
                  ${(employee.isActive ?? employee.is_active) ? 'Aktiv' : 'Inaktiv'}
                </span>
              </td>
              <td>
                <span class="badge ${availabilityBadgeClass}">
                  ${availabilityText}
                </span>
                ${
                  effectiveStatus !== 'available' && availabilityStart && availabilityEnd
                    ? `<br><small class="text-muted">${new Date(availabilityStart).toLocaleDateString('de-DE')} - ${new Date(availabilityEnd).toLocaleDateString('de-DE')}</small>`
                    : ''
                }
              </td>
              <td>
                <button class="btn btn-sm btn-info" data-action="change-employee-status" data-employee-id="${employee.id}">
                  <i class="fas fa-user-clock"></i> Status ändern
                </button>
                <button class="btn btn-sm btn-secondary" data-action="edit-employee" data-employee-id="${employee.id}">
                  <i class="fas fa-edit"></i> Bearbeiten
                </button>
                <a href="/manage-employees" class="btn btn-sm btn-danger">
                  <i class="fas fa-users-cog"></i> Verwalten
                </a>
              </td>
            `;
            // Use dom-utils setHTML for safe sanitization
            window.setHTML(row, rowHtml);
            tableBody.append(row);
          });

          // Event delegation for employee actions
          if (!tableBody.dataset.delegationInitialized) {
            tableBody.dataset.delegationInitialized = 'true';
            tableBody.addEventListener('click', (e) => {
              const button = e.target.closest('[data-action]');
              if (button) {
                const action = button.dataset.action;
                const employeeId = button.dataset.employeeId;

                switch (action) {
                  case 'change-employee-status':
                    if (window.changeEmployeeStatus) window.changeEmployeeStatus(parseInt(employeeId));
                    break;
                  case 'edit-employee':
                    if (window.editEmployee) window.editEmployee(parseInt(employeeId));
                    break;
                }
              }
            });
          }
        } catch (error) {
          console.error('Error loading employees:', error);
          const tableBody = document.querySelector('#employees-table-body');
          if (tableBody) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="7" class="text-center text-danger">Fehler beim Laden der Mitarbeiter</td>
              </tr>
            `;
          }
        }
      }

      // Make functions globally available (delay to ensure they're defined)
      document.addEventListener('DOMContentLoaded', () => {
        window.loadEmployeesTable = loadEmployeesTable;
        window.editEmployee = editEmployee;
        // deleteEmployee moved to manage-employees.ts
        window.loadDocumentsTable = loadDocumentsTable || (() => console.info('loadDocumentsTable not implemented'));
        // loadPayslipsTable removed - now using documents-payroll.html
        // loadEmployeesForPayslipSelect removed - now using documents-payroll.html
        // Define loadDepartmentsTable function
        window.loadDepartmentsTable = function () {
          console.info('loadDepartmentsTable called - redirecting to departments page');
          // Since we're using a separate departments page, just reload if needed
          if (window.location.pathname.includes('departments')) {
            window.location.reload();
          }
        };
        // Temporary fix: Define loadTeamsTable if not available
        window.loadTeamsTable =
          window.loadTeamsTable ||
          function () {
            console.info('loadTeamsTable called but not yet implemented');
            // TODO: Implement team loading functionality
          };
        window.loadRecentEmployees = window.loadRecentEmployees || (() => console.info('loadRecentEmployees not implemented'));
        window.loadDashboardStats = window.loadDashboardStats || (() => console.info('loadDashboardStats not implemented'));
      });

      // Edit employee - Opens the employee modal with existing data
      async function editEmployee(employeeId) {
        console.info(`Editing employee ${employeeId}`);
        const token = localStorage.getItem('token');

        try {
          // Load employee data
          const response = await fetch(`/api/v2/users/${employeeId}`, {
            method: 'GET',
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error('Failed to load employee data');
          }

          const responseData = await response.json();
          const employee = responseData.data || responseData;
          console.info('Employee data loaded:', employee);

          // Open the employee modal
          const modal = document.querySelector('#employee-modal');
          if (modal) {
            modal.style.display = 'flex';

            // Change modal title
            const modalTitle = modal.querySelector('.modal-title');
            if (modalTitle) {
              modalTitle.textContent = 'Mitarbeiter bearbeiten';
            }

            // Fill the form with employee data
            const form = document.querySelector('#create-employee-form');
            if (form) {
              // Store employee ID for update
              form.dataset.employeeId = employeeId;
              form.dataset.mode = 'edit';

              // Make password fields optional for edit mode
              const passwordInput = form.querySelector('input[name="password"]');
              const passwordConfirmInput = form.querySelector('input[name="passwordConfirm"]');
              if (passwordInput) passwordInput.removeAttribute('required');
              if (passwordConfirmInput) passwordConfirmInput.removeAttribute('required');

              // Hide email confirm field for edit mode
              const emailConfirmGroup = form.querySelector('input[name="emailConfirm"]')?.closest('.form-group');
              if (emailConfirmGroup) emailConfirmGroup.style.display = 'none';

              // Fill basic fields
              const usernameInput = form.querySelector('input[name="username"]');
              if (usernameInput) usernameInput.value = employee.username || '';

              const emailInput = form.querySelector('input[name="email"]');
              if (emailInput) emailInput.value = employee.email || '';

              const firstNameInput = form.querySelector('input[name="firstName"]');
              if (firstNameInput) firstNameInput.value = employee.first_name || employee.firstName || '';

              const lastNameInput = form.querySelector('input[name="lastName"]');
              if (lastNameInput) lastNameInput.value = employee.last_name || employee.lastName || '';

              const phoneInput = form.querySelector('input[name="phone"]');
              if (phoneInput) phoneInput.value = employee.phone || '';

              const positionInput = form.querySelector('input[name="position"]');
              if (positionInput) positionInput.value = employee.position || '';

              const employeeNumberInput = form.querySelector('input[name="employeeNumber"]');
              if (employeeNumberInput) employeeNumberInput.value = employee.employee_id || employee.employeeId || '';

              const birthdayInput = form.querySelector('input[name="birthday"]');
              if (birthdayInput && employee.birthday) {
                birthdayInput.value = employee.birthday.split('T')[0];
              }

              // Set department dropdown
              if (employee.department_id || employee.departmentId) {
                const deptId = employee.department_id || employee.departmentId;
                const deptName = employee.department_name || employee.departmentName || 'Unbekannte Abteilung';
                if (typeof window.selectDropdownOption === 'function') {
                  window.selectDropdownOption('employee-department', deptId, deptName);
                }
              }

              // Set team dropdown if exists
              if (employee.team_id || employee.teamId) {
                const teamId = employee.team_id || employee.teamId;
                const teamName = employee.team_name || employee.teamName || 'Unbekanntes Team';
                if (typeof window.selectDropdownOption === 'function') {
                  window.selectDropdownOption('employee-team', teamId, teamName);
                }
              }

              // Set active status
              const isActive = employee.is_active !== undefined ? employee.is_active : 1;
              if (typeof window.selectActiveStatusOption === 'function') {
                window.selectActiveStatusOption(isActive ? '1' : '0', isActive ? 'Aktiv' : 'Inaktiv');
              }

              // Change submit button text
              const submitBtn = form.querySelector('button[type="submit"]');
              if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Änderungen speichern';
              }

              // Load departments and teams for dropdowns
              if (typeof loadDepartmentsForEmployeeSelect === 'function') {
                loadDepartmentsForEmployeeSelect();
              }
              if (employee.department_id || employee.departmentId) {
                const deptId = employee.department_id || employee.departmentId;
                if (typeof loadTeamsForEmployeeSelect === 'function') {
                  loadTeamsForEmployeeSelect(deptId);
                }
              }
            }
          }
        } catch (error) {
          console.error('Error loading employee:', error);
          if (typeof window.showError === 'function') {
            window.showError('Fehler beim Laden der Mitarbeiterdaten');
          } else {
            alert('Fehler beim Laden der Mitarbeiterdaten');
          }
        }
      }

      // Delete employee functionality moved to manage-employees.ts

      window.showAllDocuments = function () {
        console.info('Show all documents');
      };

      window.showAllDepartments = function () {
        window.location.href = '/manage-departments';
      };

      window.showAllTeams = function () {
        console.info('Show all teams');
      };

      // Dokument herunterladen
      window.downloadDocument = async function (documentId) {
        const token = localStorage.getItem('token');
        try {
          window.location.href = `/api/documents/download/${documentId}?token=${token}`;
        } catch (error) {
          console.error('Error downloading document:', error);
          alert('Fehler beim Herunterladen des Dokuments');
        }
      };

      // Dokument archivieren
      window.archiveDocument = async function (documentId) {
        if (!confirm('Möchten Sie dieses Dokument archivieren?')) {
          return;
        }

        const token = localStorage.getItem('token');
        try {
          const response = await fetch(`/api/documents/archive/${documentId}`, {
            method: 'PUT',
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
          });

          if (response.ok) {
            alert('Dokument erfolgreich archiviert');
            loadDocumentsTable();
          } else {
            const error = await response.json();
            alert(`Fehler: ${error.message || 'Unbekannter Fehler'}`);
          }
        } catch (error) {
          console.error('Error archiving document:', error);
          alert('Fehler beim Archivieren des Dokuments');
        }
      };

      // Dokument löschen
      window.deleteDocument = async function (documentId) {
        if (
          !confirm(
            'Sind Sie sicher, dass Sie dieses Dokument dauerhaft löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden.',
          )
        ) {
          return;
        }

        const token = localStorage.getItem('token');
        try {
          const response = await fetch(`/api/documents/${documentId}`, {
            method: 'DELETE',
            headers: { Authorization: `Bearer ${token}` },
          });

          if (response.ok) {
            alert('Dokument erfolgreich gelöscht');
            loadDocumentsTable();
          } else {
            const error = await response.json();
            alert(`Fehler: ${error.message || 'Unbekannter Fehler'}`);
          }
        } catch (error) {
          console.error('Error deleting document:', error);
          alert('Fehler beim Löschen des Dokuments');
        }
      };

      // Section Navigation is now handled by show-section.ts module
    </script>

    <!-- Floating Action Buttons -->
    <button class="add-employee-btn u-hidden" id="floating-add-employee" data-action="show-employee-modal">+</button>
    <button class="add-employee-btn u-hidden" id="floating-add-team" data-action="show-team-modal">+</button>
    <button class="add-employee-btn u-hidden" id="floating-add-machine" data-action="show-machine-modal">+</button>
    <button class="add-employee-btn u-hidden" id="floating-add-area" data-action="show-area-modal">+</button>

    <!-- Team Creation Modal -->
    <div class="modal-overlay" id="teamModal">
      <div class="modal-container">
        <div class="modal-header">
          <h2 class="modal-title">
            <i class="fas fa-users"></i>
            Neues Team erstellen
          </h2>
          <button type="button" class="modal-close" data-action="close-team-modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="teamForm">
            <div class="form-group">
              <label for="teamName">
                <i class="fas fa-tag"></i>
                Team Name
                <span class="required">*</span>
              </label>
              <input type="text" class="form-control" id="teamName" name="name" placeholder="z.B. Produktionsteam Alpha" required />
            </div>

            <div class="form-group">
              <label for="teamDescription">
                <i class="fas fa-align-left"></i>
                Beschreibung
              </label>
              <textarea
                class="form-control"
                id="teamDescription"
                name="description"
                rows="3"
                placeholder="Beschreibung des Teams"
              ></textarea>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="teamType">
                  <i class="fas fa-th-list"></i>
                  Team Typ
                </label>
                <select class="form-control" id="teamType" name="teamType">
                  <option value="production">Produktion</option>
                  <option value="quality">Qualität</option>
                  <option value="maintenance">Wartung</option>
                  <option value="logistics">Logistik</option>
                  <option value="administration">Verwaltung</option>
                  <option value="other">Sonstiges</option>
                </select>
              </div>

              <div class="form-group">
                <label for="teamStatus">
                  <i class="fas fa-info-circle"></i>
                  Status
                </label>
                <select class="form-control" id="teamStatus" name="status">
                  <option value="active">Aktiv</option>
                  <option value="inactive">Inaktiv</option>
                  <option value="restructuring">Umstrukturierung</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="teamMaxMembers">
                  <i class="fas fa-users"></i>
                  Max. Mitglieder
                </label>
                <input type="number" class="form-control" id="teamMaxMembers" name="maxMembers" min="1" max="100" placeholder="z.B. 15" />
              </div>

              <div class="form-group">
                <label for="teamDepartment">
                  <i class="fas fa-building"></i>
                  Abteilung
                </label>
                <div class="custom-dropdown">
                  <div class="dropdown-display" id="team-department-display" data-action="toggle-dropdown" data-dropdown="team-department">
                    <span>Keine Abteilung</span>
                    <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                      <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                  </div>
                  <div class="dropdown-options" id="team-department-dropdown">
                    <div
                      class="dropdown-option"
                      data-value=""
                      data-action="select-dropdown"
                      data-dropdown="team-department"
                      data-display="Keine Abteilung"
                    >
                      Keine Abteilung
                    </div>
                    <!-- Will be populated dynamically -->
                  </div>
                  <input type="hidden" name="departmentId" id="team-department-select" />
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="teamMachines">
                <i class="fas fa-cogs"></i>
                Zugewiesene Maschinen
              </label>
              <div class="custom-dropdown">
                <div class="dropdown-display" id="team-machines-display" data-action="toggle-dropdown" data-dropdown="team-machines">
                  <span>Keine Maschinen zugewiesen</span>
                  <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                    <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </div>
                <div class="dropdown-options" id="team-machines-dropdown" style="max-height: 200px; overflow-y: auto">
                  <!-- Will be populated with checkboxes for multiple selection -->
                </div>
                <input type="hidden" name="machineIds" id="team-machines-select" />
              </div>
            </div>

            <div class="form-group">
              <label for="teamUsers">
                <i class="fas fa-users"></i>
                Team-Mitglieder
              </label>
              <div class="custom-dropdown">
                <div class="dropdown-display" id="team-users-display" data-action="toggle-dropdown" data-dropdown="team-users">
                  <span>Keine Mitglieder zugewiesen</span>
                  <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                    <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                  </svg>
                </div>
                <div class="dropdown-options" id="team-users-dropdown" style="max-height: 200px; overflow-y: auto">
                  <!-- Will be populated with checkboxes for multiple user selection -->
                </div>
                <input type="hidden" name="userIds" id="team-users-select" />
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-action="close-team-modal">Abbrechen</button>
          <button type="button" class="btn btn-primary" data-action="save-team">
            <i class="fas fa-save"></i>
            Team erstellen
          </button>
        </div>
      </div>
    </div>

    <!-- Machine Creation Modal -->
    <div class="modal-overlay" id="machineModal">
      <div class="modal-container">
        <div class="modal-header">
          <h2 class="modal-title">
            <i class="fas fa-cogs"></i>
            Neue Maschine hinzufügen
          </h2>
          <button type="button" class="modal-close" data-action="close-machine-modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="machineForm">
            <div class="form-group">
              <label for="machineName">
                <i class="fas fa-tag"></i>
                Maschinen Name
                <span class="required">*</span>
              </label>
              <input type="text" class="form-control" id="machineName" name="name" placeholder="z.B. CNC Fräsmaschine 001" required />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="machineModel">
                  <i class="fas fa-cube"></i>
                  Modell
                </label>
                <input type="text" class="form-control" id="machineModel" name="model" placeholder="z.B. DMU 50" />
              </div>

              <div class="form-group">
                <label for="machineManufacturer">
                  <i class="fas fa-industry"></i>
                  Hersteller
                </label>
                <input type="text" class="form-control" id="machineManufacturer" name="manufacturer" placeholder="z.B. DMG MORI" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="machineSerialNumber">
                  <i class="fas fa-barcode"></i>
                  Seriennummer
                </label>
                <input type="text" class="form-control" id="machineSerialNumber" name="serialNumber" placeholder="z.B. SN-2024-001" />
              </div>

              <div class="form-group">
                <label for="machineAssetNumber">
                  <i class="fas fa-hashtag"></i>
                  Inventarnummer
                </label>
                <input type="text" class="form-control" id="machineAssetNumber" name="assetNumber" placeholder="z.B. ASSET-001" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="machineType">
                  <i class="fas fa-th-list"></i>
                  Maschinen Typ
                </label>
                <select class="form-control" id="machineType" name="machineType">
                  <option value="production">Produktion</option>
                  <option value="packaging">Verpackung</option>
                  <option value="quality_control">Qualitätskontrolle</option>
                  <option value="logistics">Logistik</option>
                  <option value="utility">Versorgung</option>
                  <option value="other">Sonstiges</option>
                </select>
              </div>

              <div class="form-group">
                <label for="machineStatus">
                  <i class="fas fa-info-circle"></i>
                  Status
                </label>
                <select class="form-control" id="machineStatus" name="status">
                  <option value="operational">Betriebsbereit</option>
                  <option value="maintenance">In Wartung</option>
                  <option value="repair">In Reparatur</option>
                  <option value="standby">Standby</option>
                  <option value="decommissioned">Außer Betrieb</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="machineDepartment">
                  <i class="fas fa-building"></i>
                  Abteilung
                </label>
                <div class="custom-dropdown">
                  <div
                    class="dropdown-display"
                    id="machine-department-display"
                    data-action="toggle-dropdown"
                    data-dropdown="machine-department"
                  >
                    <span>Keine Abteilung</span>
                    <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                      <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                  </div>
                  <div class="dropdown-options" id="machine-department-dropdown">
                    <div
                      class="dropdown-option"
                      data-value=""
                      data-action="select-dropdown"
                      data-dropdown="machine-department"
                      data-display="Keine Abteilung"
                    >
                      Keine Abteilung
                    </div>
                    <!-- Will be populated dynamically -->
                  </div>
                  <input type="hidden" name="departmentId" id="machine-department-select" />
                </div>
              </div>
              <div class="form-group">
                <label for="machineArea">
                  <i class="fas fa-map-marker-alt"></i>
                  Bereich
                </label>
                <div class="custom-dropdown">
                  <div class="dropdown-display" id="machine-area-display" data-action="toggle-dropdown" data-dropdown="machine-area">
                    <span>Kein Bereich</span>
                    <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                      <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                  </div>
                  <div class="dropdown-options" id="machine-area-dropdown">
                    <div
                      class="dropdown-option"
                      data-value=""
                      data-action="select-dropdown"
                      data-dropdown="machine-area"
                      data-display="Kein Bereich"
                    >
                      Kein Bereich
                    </div>
                    <!-- Will be populated dynamically -->
                  </div>
                  <input type="hidden" name="areaId" id="machine-area-select" />
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="machineLocation">
                <i class="fas fa-map-marker-alt"></i>
                Standort
              </label>
              <input type="text" class="form-control" id="machineLocation" name="location" placeholder="z.B. Halle A, Bereich 3" />
            </div>

            <div class="form-group">
              <label for="machineNotes">
                <i class="fas fa-sticky-note"></i>
                Notizen
              </label>
              <textarea
                class="form-control"
                id="machineNotes"
                name="notes"
                rows="3"
                placeholder="Zusätzliche Informationen zur Maschine"
              ></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-action="close-machine-modal">Abbrechen</button>
          <button type="button" class="btn btn-primary" data-action="save-machine">
            <i class="fas fa-save"></i>
            Maschine hinzufügen
          </button>
        </div>
      </div>
    </div>

    <!-- Area Creation Modal -->
    <div class="modal-overlay" id="areaModal">
      <div class="modal-container">
        <div class="modal-header">
          <h2 class="modal-title">
            <i class="fas fa-map-marker-alt"></i>
            Neuen Bereich erstellen
          </h2>
          <button type="button" class="modal-close" data-action="close-area-modal">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="areaForm">
            <div class="form-group">
              <label for="areaName">
                <i class="fas fa-tag"></i>
                Bereichsname
                <span class="required">*</span>
              </label>
              <input type="text" class="form-control" id="areaName" name="name" placeholder="z.B. Halle A" required />
            </div>
            <div class="form-group">
              <label for="areaDescription">
                <i class="fas fa-align-left"></i>
                Beschreibung
              </label>
              <textarea
                class="form-control"
                id="areaDescription"
                name="description"
                rows="3"
                placeholder="Beschreibung des Bereichs"
              ></textarea>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="areaType">
                  <i class="fas fa-th-list"></i>
                  Bereichstyp
                </label>
                <select class="form-control" id="areaType" name="type">
                  <option value="production">Produktion</option>
                  <option value="warehouse">Lager</option>
                  <option value="office">Büro</option>
                  <option value="building">Gebäude</option>
                  <option value="outdoor">Außenbereich</option>
                  <option value="other">Sonstiges</option>
                </select>
              </div>
              <div class="form-group">
                <label for="areaCapacity">
                  <i class="fas fa-users"></i>
                  Kapazität
                </label>
                <input type="number" class="form-control" id="areaCapacity" name="capacity" min="1" placeholder="z.B. 50" />
              </div>
            </div>
            <div class="form-group">
              <label for="areaAddress">
                <i class="fas fa-map-marked-alt"></i>
                Adresse
              </label>
              <textarea
                class="form-control"
                id="areaAddress"
                name="address"
                rows="2"
                placeholder="Vollständige Adresse des Bereichs"
              ></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-action="close-area-modal">Abbrechen</button>
          <button type="button" class="btn btn-primary" data-action="save-area">
            <i class="fas fa-save"></i>
            Bereich erstellen
          </button>
        </div>
      </div>
    </div>

    <!-- Mark body as loaded after all scripts -->
    <script>
      window.addEventListener('load', function () {
        // Add 'loaded' class after initial load
        setTimeout(() => {
          document.body.classList.add('loaded');
        }, 100);
      });

      // Show/hide floating button based on section
      document.addEventListener('DOMContentLoaded', function () {
        const floatingBtnEmployee = document.querySelector('#floating-add-employee');
        const floatingBtnTeam = document.querySelector('#floating-add-team');
        const floatingBtnMachine = document.querySelector('#floating-add-machine');
        const floatingBtnArea = document.querySelector('#floating-add-area');

        // Function to check which section is active
        function updateFloatingButton() {
          const urlParams = new URLSearchParams(window.location.search);
          const section = urlParams.get('section');

          // Hide all buttons first
          if (floatingBtnEmployee) floatingBtnEmployee.style.display = 'none';
          if (floatingBtnTeam) floatingBtnTeam.style.display = 'none';
          if (floatingBtnMachine) floatingBtnMachine.style.display = 'none';
          if (floatingBtnArea) floatingBtnArea.style.display = 'none';

          // Show the appropriate button
          if (section === 'employees' && floatingBtnEmployee) {
            floatingBtnEmployee.style.display = 'flex';
          } else if (section === 'teams' && floatingBtnTeam) {
            floatingBtnTeam.style.display = 'flex';
          } else if (section === 'machines' && floatingBtnMachine) {
            floatingBtnMachine.style.display = 'flex';
          } else if (section === 'areas' && floatingBtnArea) {
            floatingBtnArea.style.display = 'flex';
          }
        }

        // Check on page load
        updateFloatingButton();

        // Also check when URL changes (for SPA navigation)
        window.addEventListener('popstate', updateFloatingButton);

        // Listen for section changes
        const observer = new MutationObserver(function () {
          updateFloatingButton();
        });

        // Start observing
        const targetNode = document.body;
        const config = { childList: true, subtree: true };
        observer.observe(targetNode, config);
      });
    </script>
  </body>
</html>
