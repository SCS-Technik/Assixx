<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Umfrage-Verwaltung - Assixx</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- Critical Layout State - Prevents Layout Shift -->
    <script>
      // Set sidebar state IMMEDIATELY to prevent any layout shift
      (function () {
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        document.documentElement.setAttribute('data-sidebar', sidebarCollapsed ? 'collapsed' : 'expanded');
        // Also set CSS custom properties for immediate use
        document.documentElement.style.setProperty('--sidebar-width', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--content-margin', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--grid-columns', sidebarCollapsed ? '4' : '3');
        document.documentElement.style.setProperty('--widget-columns', sidebarCollapsed ? '5' : '3');
        document.documentElement.style.setProperty('--card-padding', sidebarCollapsed ? '2rem' : '1.5rem');
      })();
    </script>
    <script src="/feature-flags.js"></script>
    <link rel="stylesheet" href="/styles/lib/fontawesome.min.css" />
    <!-- Font Awesome CDN als Fallback -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      @import url('/styles/dashboard-theme.css');
      @import url('/styles/breadcrumb-alignment.css');
      /* Glassmorphismus Design-Standards */

      /* Dramatischer Hintergrund-Gradient */
      body {
        position: relative;
        min-height: 100vh;
        overflow-x: hidden;
        background: #000;
      }

      body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(5deg, transparent, rgba(0, 142, 255, 0.1) 100%, #01000482 0, rgba(0, 0, 4, 0.6) 100%, #000);
        pointer-events: none;
        z-index: -1;
      }

      /* Header und Sidebar werden von unified-navigation gehandelt */

      /* Survey-specific styles */
      .survey-container {
        margin: 0 auto;
      }

      .survey-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-xl);
      }

      .survey-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
      }

      .survey-title i {
        color: var(--primary-color);
      }

      /* Survey Cards Grid */
      .surveys-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
      }

      .survey-card {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: var(--shadow-sm);
        border-radius: var(--radius-md);
        /* animation: fadeInUp 0.6s ease-out; */
        padding: var(--spacing-lg);

        cursor: pointer;
        margin-top: 10px;
        margin-left: -5px;
      }

      .survey-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        border-color: var(--primary-color);
      }

      .survey-card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: var(--spacing-md);
      }

      .survey-card-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
      }

      .survey-status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
      }

      .survey-status.draft {
        background: rgba(255, 152, 0, 0.2);
        color: #ff9800;
      }

      .survey-status.active {
        background: rgba(76, 175, 80, 0.2);
        color: #4caf50;
      }

      .survey-status.closed {
        background: rgba(244, 67, 54, 0.2);
        color: #f44336;
      }

      .survey-status.archived {
        background: rgba(158, 158, 158, 0.2);
        color: #9e9e9e;
      }

      .survey-card-description {
        color: var(--text-secondary);
        margin-bottom: var(--spacing-md);
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .survey-stats {
        display: flex;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-md);
      }

      .survey-stat {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .survey-stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--primary-color);
      }

      .survey-stat-label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        text-transform: uppercase;
      }

      .survey-actions {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
      }

      .survey-action-btn {
        flex: 1;
        padding: var(--spacing-2sm);
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 0.9rem;
        cursor: pointer;

        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
      }

      .survey-action-btn:hover {
        background: rgba(33, 150, 243, 0.2);
        border-color: var(--primary-color);
      }

      /* Create Survey Modal */
      .modal,
      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        backdrop-filter: blur(10px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        transition:
          opacity 0.1s ease,
          visibility 0.1s ease;
      }

      .modal-overlay {
        display: flex;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.1s ease,
          visibility 0.1s ease;
      }

      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .modal-content,
      .modal-container {
        backdrop-filter: blur(20px) saturate(500%);
        background: hsla(0, 0%, 8%, 0.84);
        border: 1px solid hsla(0, 0%, 100%, 0.1);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        max-height: 90vh;
        max-width: 900px;
        overflow-y: auto;
        padding: 24px;
        width: 90%;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-lg);
        border-bottom: 1px solid var(--border-color);
      }

      .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--primary-color);
      }

      .close-btn {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 1.5rem;
        cursor: pointer;
        padding: var(--spacing-xs);
        border-radius: 50%;
      }

      .close-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
      }

      .modal-content form {
        padding: var(--spacing-lg);
      }

      .modal-content .form-actions {
        padding: var(--spacing-lg);
        border-top: 1px solid var(--border-color);
        margin: 0 calc(-1 * var(--spacing-lg)) calc(-1 * var(--spacing-lg));
        background: rgba(255, 255, 255, 0.02);
      }

      /* Question Builder */
      .question-builder {
        margin-top: var(--spacing-lg);
      }

      .question-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        margin-bottom: var(--spacing-md);
        position: relative;
      }

      .question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-md);
      }

      .question-number {
        background: var(--primary-color);
        color: #fff;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
      }

      .question-actions {
        display: flex;
        gap: var(--spacing-xs);
      }

      .question-action {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: var(--text-secondary);
        padding: var(--spacing-xs);
        border-radius: 50%;
        cursor: pointer;

        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .question-action:hover {
        background: rgba(255, 255, 255, 0.2);
        color: var(--text-primary);
      }

      .question-action.delete:hover {
        background: rgba(244, 67, 54, 0.2);
        color: #f44336;
      }

      /* Form Elements */
      .form-group {
        margin-bottom: var(--spacing-lg);
      }

      .form-label {
        display: block;
        margin-bottom: var(--spacing-sm);
        color: var(--text-primary);
        font-weight: 500;
      }

      .form-control {
        width: 100%;
        padding: var(--spacing-2sm);
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 1rem;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
      }

      textarea.form-control {
        min-height: 100px;
        resize: vertical;
      }

      select.form-control {
        cursor: pointer;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-sm);
      }

      .checkbox-group input[type='checkbox'] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      /* Options for multiple choice */
      .options-container {
        margin-top: var(--spacing-md);
      }

      .option-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-sm);
      }

      .option-input {
        flex: 1;
        padding: var(--spacing-2sm);
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
      }

      .remove-option {
        background: rgba(244, 67, 54, 0.2);
        border: none;
        color: #f44336;
        padding: var(--spacing-xs);
        border-radius: 50%;
        cursor: pointer;

        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .remove-option:hover {
        background: rgba(244, 67, 54, 0.3);
      }

      .add-option-btn {
        background: rgba(76, 175, 80, 0.2);
        border: none;
        color: #4caf50;
        padding: var(--spacing-2sm);
        border-radius: var(--radius-sm);
        cursor: pointer;

        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        font-size: 0.9rem;
      }

      .add-option-btn:hover {
        background: rgba(76, 175, 80, 0.3);
      }

      /* Action Buttons */
      .action-buttons {
        display: flex;
        gap: var(--spacing-md);
        margin-top: var(--spacing-xl);
        justify-content: flex-end;
      }

      .btn {
        padding: var(--spacing-2sm);
        border-radius: var(--radius-md);
        border: none;
        font-weight: 500;
        cursor: pointer;

        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
        color: #fff;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(33, 150, 243, 0.3);
      }

      .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .btn-success {
        background: linear-gradient(135deg, #4caf50, #66bb6a);
        color: #fff;
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: var(--spacing-xl) * 2;
        color: var(--text-secondary);
      }

      .empty-state-icon {
        font-size: 40px;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .empty-state-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-md);
      }

      .empty-state-description {
        max-width: 500px;
        margin: 0 auto var(--spacing-lg) auto;
        line-height: 1.6;
      }

      /* Templates Section */
      .templates-section {
        margin-top: var(--spacing-xl);
        padding-top: var(--spacing-xl);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .templates-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
      }

      .templates-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .template-grid {
        display: grid;
        gap: var(--spacing-lg);
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        margin-bottom: var(--spacing-xl);
      }

      .template-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-md);
        padding: var(--spacing-lg);
        cursor: pointer;
      }

      .template-card:hover {
        background: rgba(33, 150, 243, 0.1);
        border-color: var(--primary-color);
        transform: translateY(-2px);
      }

      .template-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
      }

      .template-description {
        font-size: 0.9rem;
        color: var(--text-secondary);
        line-height: 1.4;
      }

      /* Custom Dropdowns */
      .custom-dropdown {
        position: relative;
        width: 100%;
      }

      .dropdown-display {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-2sm);
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(10px);
        border: 1px solid hsla(0, 0%, 100%, 0.1);
        border-radius: var(--radius-sm);
        color: #fff;
        cursor: pointer;
      }

      .dropdown-display:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
      }

      .dropdown-display svg {
        transition: transform 0.3s ease;
      }

      .dropdown-display.active svg {
        transform: rotate(180deg);
      }

      .dropdown-options {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        background: rgba(18, 18, 18, 0.95);
        backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid hsla(0, 0%, 100%, 0.1);
        border-radius: var(--radius-sm);
        box-shadow: var(--shadow-sm);
        max-height: 200px;
        overflow-y: auto;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);

        z-index: 1001;
      }

      .dropdown-options.active {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-option {
        padding: 10px 12px;
        color: var(--text-primary);
        cursor: pointer;

        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      }

      .dropdown-option:last-child {
        border-bottom: none;
      }

      /* Scrollbar styling for dropdowns */
      .dropdown-options::-webkit-scrollbar {
        width: 6px;
      }

      .dropdown-options::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
      }

      .dropdown-options::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
      }

      .dropdown-options::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      /* Floating Add Button */
      .add-survey-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: rgba(33, 150, 243, 0.2);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(33, 150, 243, 0.3);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: var(--primary-color);
        cursor: pointer;
        box-shadow: 0 4px 16px rgba(33, 150, 243, 0.3);
        z-index: 100;
        transition: all 0.3s ease;
      }

      .add-survey-btn:hover {
        background: rgba(33, 150, 243, 0.3);
        transform: scale(1.1);
        box-shadow: 0 6px 24px rgba(33, 150, 243, 0.4);
      }
    </style>
    <link rel="stylesheet" href="/styles/user-info-update.css" />
  </head>
  <body>
    <!-- Unified Navigation -->
    <div id="navigation-container"></div>

    <!-- Main Layout with Sidebar -->
    <div class="layout-container">
      <main class="main-content">
        <!-- Breadcrumb -->
        <div id="breadcrumb-container"></div>

        <div class="container">
          <div class="card">
            <div class="card-header">
              <div>
                <h2 class="card-title">Umfrage-Verwaltung</h2>
                <p class="text-secondary">Erstellen und verwalten Sie Mitarbeiterumfragen</p>
              </div>
            </div>
            <div class="card-body">
              <!-- Active Surveys -->
              <h2>Aktive Umfragen</h2>
              <div id="activeSurveys" class="surveys-grid">
                <!-- Surveys will be loaded here -->
              </div>

              <!-- Draft Surveys -->
              <h2 style="margin-top: var(--spacing-xl); border-top: 1px solid hsla(0, 0%, 100%, 0.1)">Entw√ºrfe</h2>
              <div id="draftSurveys" class="surveys-grid">
                <!-- Draft surveys will be loaded here -->
              </div>

              <!-- Templates Section -->
              <div class="templates-section">
                <div class="templates-header">
                  <h2 class="templates-title">Vorlagen</h2>
                </div>
                <div id="surveyTemplates" class="template-grid">
                  <!-- Templates will be loaded here -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Create/Edit Survey Modal -->
    <div id="surveyModal" class="modal">
      <div class="modal-content modal-container">
        <div class="modal-header">
          <h2 class="modal-title" id="modalTitle">Neue Umfrage erstellen</h2>
          <button class="close-btn" data-action="close">&times;</button>
        </div>

        <form id="surveyForm">
          <div class="form-group">
            <label class="form-label">Titel der Umfrage</label>
            <input type="text" id="surveyTitle" class="form-control" required />
          </div>

          <div class="form-group">
            <label class="form-label">Beschreibung</label>
            <textarea id="surveyDescription" class="form-control"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Einstellungen</label>
            <div class="checkbox-group">
              <input type="checkbox" id="isAnonymous" />
              <label for="isAnonymous">Anonyme Umfrage (Antworten k√∂nnen nicht zu Mitarbeitern zur√ºckverfolgt werden)</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="isMandatory" />
              <label for="isMandatory">Verpflichtende Teilnahme</label>
            </div>
            <p style="margin-top: var(--spacing-sm); color: var(--text-secondary); font-size: 0.85rem">
              <i class="fas fa-info-circle"></i>
              Bei anonymen Umfragen werden keine Benutzerdaten gespeichert. Sie k√∂nnen nicht sehen, wer geantwortet hat.
            </p>
          </div>

          <div class="form-group">
            <label class="form-label">Laufzeit</label>
            <div style="display: flex; gap: var(--spacing-md)">
              <div class="u-flex-1">
                <label class="form-label" class="u-fs-09rem">Startdatum</label>
                <input type="datetime-local" id="startDate" class="form-control" />
              </div>
              <div class="u-flex-1">
                <label class="form-label" class="u-fs-09rem">Enddatum</label>
                <input type="datetime-local" id="endDate" class="form-control" />
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Zielgruppe</label>
            <div class="custom-dropdown">
              <div class="dropdown-display" id="assignmentDropdownDisplay" onclick="toggleDropdown('assignmentDropdown')">
                <span>Ganze Firma</span>
                <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                  <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                </svg>
              </div>
              <div class="dropdown-options" id="assignmentDropdownDropdown">
                <div class="dropdown-option" onclick="selectAssignmentOption('all_users', 'Ganze Firma')">Ganze Firma</div>
                <div class="dropdown-option" onclick="selectAssignmentOption('department', 'Abteilung')">Abteilung</div>
                <div class="dropdown-option" onclick="selectAssignmentOption('team', 'Team')">Team</div>
              </div>
              <input type="hidden" id="assignmentType" value="all_users" />
            </div>
          </div>

          <!-- Department Selection (hidden by default) -->
          <div class="form-group" id="departmentSelection" class="u-hidden">
            <label class="form-label">Abteilungen ausw√§hlen</label>
            <select
              id="departmentSelect"
              multiple
              class="form-control"
              style="min-height: 120px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1)"
            >
              <!-- Department options will be loaded here -->
            </select>
            <small class="form-text" style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block">
              Halten Sie Strg/Cmd gedr√ºckt f√ºr Mehrfachauswahl
            </small>
          </div>

          <!-- Team Selection (hidden by default) -->
          <div class="form-group" id="teamSelection" class="u-hidden">
            <label class="form-label">Teams ausw√§hlen</label>
            <select
              id="teamSelect"
              multiple
              class="form-control"
              style="min-height: 120px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1)"
            >
              <!-- Team options will be loaded here -->
            </select>
            <small class="form-text" style="color: var(--text-secondary); font-size: 12px; margin-top: 4px; display: block">
              Halten Sie Strg/Cmd gedr√ºckt f√ºr Mehrfachauswahl
            </small>
          </div>

          <div class="question-builder">
            <h3 style="margin-bottom: var(--spacing-md)">Fragen</h3>
            <div id="questionsList">
              <!-- Questions will be added here -->
            </div>
            <button type="button" class="btn btn-secondary" onclick="addQuestion()">
              <i class="fas fa-plus"></i>
              Frage hinzuf√ºgen
            </button>
          </div>

          <div class="action-buttons">
            <button type="button" class="btn btn-secondary" data-action="close">Abbrechen</button>
            <button type="button" class="btn btn-primary" onclick="saveSurvey('draft')">
              <i class="fas fa-save"></i>
              Als Entwurf speichern
            </button>
            <button type="button" class="btn btn-success" onclick="saveSurvey('active')">
              <i class="fas fa-paper-plane"></i>
              Umfrage starten
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Floating Add Button -->
    <button class="add-survey-btn" onclick="showCreateModal()">+</button>

    <script type="module" src="/scripts/auth.js"></script>
    <script type="module" src="/scripts/components/unified-navigation.ts"></script>
    <script type="module" src="/scripts/role-switch.ts"></script>
    <!-- Breadcrumb -->
    <script type="module" src="/scripts/components/breadcrumb.js"></script>
    <script type="module">
      import { modalManager } from '/scripts/utils/modal-manager.ts';

      // Make modalManager available globally
      window.modalManager = modalManager;

      // Wait for both DOM and other scripts to load
      window.addEventListener('load', function () {
        // Register survey modal template
        if (window.registerSurveyModalTemplate) {
          window.registerSurveyModalTemplate();
        }

        if (window.loadSurveys) {
          window.loadSurveys();
        }
        if (window.loadTemplates) {
          window.loadTemplates();
        }
      });
    </script>
    <script type="module">
      import { showAlert, showSuccessAlert, showErrorAlert, showConfirm } from '/scripts/utils/alerts.js';

      let currentSurveyId = null;
      let questionCounter = 0;

      // Register the survey modal template with the modal manager
      window.registerSurveyModalTemplate = function () {
        // Get the existing modal HTML
        const surveyModal = document.querySelector('surveyModal');
        if (surveyModal && window.modalManager) {
          // Clone the modal to preserve it
          const modalClone = surveyModal.cloneNode(true);

          // Add modal-overlay class to the modal
          modalClone.classList.add('modal-overlay');

          // Register the template
          window.modalManager.registerTemplate('surveyModal', modalClone.outerHTML);

          // Remove the original modal from DOM
          surveyModal.remove();
        }
      };

      // Custom dropdown functions
      window.toggleDropdown = function (dropdownId) {
        const dropdown = document.querySelector(dropdownId + 'Dropdown');
        const display = document.querySelector(dropdownId + 'Display');

        // Close all other dropdowns
        document.querySelectorAll('.dropdown-options').forEach((d) => {
          if (d !== dropdown) {
            d.classList.remove('active');
          }
        });
        document.querySelectorAll('.dropdown-display').forEach((d) => {
          if (d !== display) {
            d.classList.remove('active');
          }
        });

        dropdown.classList.toggle('active');
        display.classList.toggle('active');
      };

      window.selectAssignmentOption = function (value, text) {
        document.querySelector('assignmentType').value = value;
        document.querySelector('assignmentDropdownDisplay').querySelector('span').textContent = text;
        document.querySelector('assignmentDropdownDropdown').classList.remove('active');
        document.querySelector('assignmentDropdownDisplay').classList.remove('active');
      };

      window.selectQuestionType = function (questionId, type, text) {
        document.querySelector(questionId + '_typeValue').value = type;
        document.querySelector(questionId + '_typeDisplay').querySelector('span').textContent = text;
        document.querySelector(questionId + '_typeDropdown').classList.remove('active');
        document.querySelector(questionId + '_typeDisplay').classList.remove('active');
        handleQuestionTypeChange(questionId, type);
      };

      // Select assignment option (target group)
      window.selectAssignmentOption = async function (type, text) {
        document.querySelector('assignmentType').value = type;
        document.querySelector('assignmentDropdownDisplay').querySelector('span').textContent = text;
        document.querySelector('assignmentDropdownDropdown').classList.remove('active');
        document.querySelector('assignmentDropdownDisplay').classList.remove('active');

        // Show/hide department selection
        const departmentSelection = document.querySelector('departmentSelection');
        const teamSelection = document.querySelector('teamSelection');

        if (type === 'department') {
          departmentSelection.style.display = 'block';
          teamSelection.style.display = 'none';
          await loadUserDepartments();
        } else if (type === 'team') {
          departmentSelection.style.display = 'none';
          teamSelection.style.display = 'block';
          await loadUserTeams();
        } else {
          departmentSelection.style.display = 'none';
          teamSelection.style.display = 'none';
        }
      };

      // Load departments that the admin has access to
      async function loadUserDepartments() {
        try {
          // First get the current user info
          const userResponse = await fetch('/api/user/profile', {
            headers: {
              Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
          });

          if (!userResponse.ok) {
            throw new Error('Failed to load user profile');
          }

          const userData = await userResponse.json();

          // Log to debug
          console.log('User profile response:', userData);

          // The response is wrapped with success/data structure
          const userId = userData.data?.id;
          let departments = [];

          if (!userId) {
            console.error('User ID not found in profile response');
            // Skip permissions check and load all departments
            const allDeptsResponse = await fetch('/api/departments', {
              headers: {
                Authorization: `Bearer ${localStorage.getItem('token')}`,
              },
            });
            if (allDeptsResponse.ok) {
              departments = await allDeptsResponse.json();
            }
          } else {
            // Try to get admin permissions, but don't fail if it's not available
            // Skip this for regular admins to avoid unnecessary 403 errors
            try {
              // First check if we should even try the permissions endpoint
              // Regular admins will just load all departments directly
              const permissionsResponse = await fetch(`/api/admin-permissions/${userId}`, {
                headers: {
                  Authorization: `Bearer ${localStorage.getItem('token')}`,
                },
              });

              if (permissionsResponse.ok) {
                const permissionsData = await permissionsResponse.json();
                console.info('Admin permissions response:', permissionsData);

                // Handle the wrapped response structure
                const permData = permissionsData.data || permissionsData;

                if (permData.hasAllAccess) {
                  // Admin has all access - load all departments
                  console.info('Admin has all access, loading all departments');
                  const allDeptsResponse = await fetch('/api/departments', {
                    headers: {
                      Authorization: `Bearer ${localStorage.getItem('token')}`,
                    },
                  });
                  if (allDeptsResponse.ok) {
                    departments = await allDeptsResponse.json();
                  }
                } else if (permData.departments && permData.departments.length > 0) {
                  // Admin has specific departments
                  console.info('Admin has specific departments:', permData.departments);
                  departments = permData.departments;
                }
              } else if (permissionsResponse.status === 403) {
                // 403 means user doesn't have permission to access this endpoint
                // This is expected for regular admins - just load all departments they can see
                console.info('Admin permissions endpoint returned 403 - loading available departments');
              }
            } catch (permError) {
              console.info('Could not fetch admin permissions, will load available departments');
            }

            // If no departments found from permissions, load all available departments
            // (This is the normal flow for most admins)
            if (departments.length === 0) {
              const allDeptsResponse = await fetch('/api/departments', {
                headers: {
                  Authorization: `Bearer ${localStorage.getItem('token')}`,
                },
              });
              if (allDeptsResponse.ok) {
                const allDepartments = await allDeptsResponse.json();
                console.info('All departments loaded:', allDepartments);
                departments = allDepartments;
              }
            }
          } // End of else block (when userId exists)

          if (departments.length > 0) {
            displayDepartmentOptions(departments);
          } else {
            document.querySelector('departmentSelect').innerHTML = '<option disabled>Keine Abteilungen verf√ºgbar</option>';
          }
        } catch (error) {
          console.error('Error loading departments:', error);
          document.querySelector('departmentSelect').innerHTML = '<option disabled>Fehler beim Laden der Abteilungen</option>';
        }
      }

      // Display department options in select
      function displayDepartmentOptions(departments) {
        const select = document.querySelector('departmentSelect');
        select.innerHTML = '';

        // Debug: log first department to see structure
        if (departments.length > 0) {
          console.info('First department structure:', departments[0]);
        }

        departments.forEach((dept) => {
          const option = document.createElement('option');
          option.value = dept.id.toString();

          // Just show the department name without description for now
          option.textContent = dept.name || 'Unnamed Department';

          select.appendChild(option);
        });
      }

      // Load teams that the user has access to
      async function loadUserTeams() {
        try {
          const response = await fetch('/api/teams', {
            headers: {
              Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
          });

          if (!response.ok) {
            console.error('Failed to load teams');
            return;
          }

          const teams = await response.json();
          const select = document.querySelector('teamSelect');

          // Clear existing options
          select.innerHTML = '';

          // Add team options
          teams.forEach((team) => {
            const option = document.createElement('option');
            option.value = team.id.toString();
            option.textContent = team.name || 'Unnamed Team';
            select.appendChild(option);
          });
        } catch (error) {
          console.error('Error loading teams:', error);
          showAlert('Fehler beim Laden der Teams');
        }
      }

      // Close dropdowns when clicking outside
      document.addEventListener('click', function (event) {
        if (!event.target.closest('.custom-dropdown')) {
          document.querySelectorAll('.dropdown-options').forEach((d) => {
            d.classList.remove('active');
          });
          document.querySelectorAll('.dropdown-display').forEach((d) => {
            d.classList.remove('active');
          });
        }
      });

      // Load surveys
      window.loadSurveys = async function () {
        try {
          const useV2 = window.FEATURE_FLAGS?.USE_API_V2_SURVEYS ?? false;
          const endpoint = useV2 ? '/api/v2/surveys' : '/api/surveys';

          const response = await fetch(endpoint, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
          });

          if (response.ok) {
            const result = await response.json();
            // Handle v2 API response structure
            const surveys = useV2 && result.success ? result.data : result.data || result.surveys || result;
            // Ensure surveys is an array
            if (Array.isArray(surveys)) {
              displaySurveys(surveys);
            } else {
              console.error('Invalid surveys data format:', surveys);
              displaySurveys([]);
            }
          }
        } catch (error) {
          console.error('Error loading surveys:', error);
        }
      };

      // Display surveys
      function displaySurveys(surveys) {
        const activeSurveys = surveys.filter((s) => s.status === 'active');
        const draftSurveys = surveys.filter((s) => s.status === 'draft');

        const activeContainer = document.querySelector('activeSurveys');
        const draftContainer = document.querySelector('draftSurveys');

        activeContainer.innerHTML =
          activeSurveys.length > 0
            ? activeSurveys.map((survey) => createSurveyCard(survey)).join('')
            : `<div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <h3 class="empty-state-title">Keine aktiven Umfragen</h3>
                <p>Es gibt aktuell keine aktiven Umfragen. Erstellen Sie eine neue Umfrage √ºber den Plus-Button.</p>
              </div>`;

        draftContainer.innerHTML =
          draftSurveys.length > 0
            ? draftSurveys.map((survey) => createSurveyCard(survey)).join('')
            : `<div class="empty-state">
                <div class="empty-state-icon">üìÑ</div>
                <h3 class="empty-state-title">Keine Entw√ºrfe</h3>
                <p>Es gibt aktuell keine Umfrage-Entw√ºrfe.</p>
              </div>`;
      }

      // Helper function to convert Buffer to text
      function getTextFromBuffer(value) {
        if (typeof value === 'string') {
          return value;
        }
        if (value && value.type === 'Buffer' && Array.isArray(value.data)) {
          return String.fromCharCode.apply(null, value.data);
        }
        if (value && typeof value === 'object') {
          return ''; // Return empty string for other objects
        }
        return value || '';
      }

      // Create survey card
      function createSurveyCard(survey) {
        const responseRate = survey.responseCount > 0 ? Math.round((survey.completedCount / survey.responseCount) * 100) : 0;
        const isDraft = survey.status === 'draft';
        const onClickAction = isDraft ? 'editSurvey' : 'viewResults';

        return `
                <div class="survey-card" onclick="${onClickAction}(${survey.id})">
                    <div class="survey-card-header">
                        <h3 class="survey-card-title">${getTextFromBuffer(survey.title)}</h3>
                        <span class="survey-status ${survey.status}">${getStatusText(survey.status)}</span>
                    </div>
                    <p class="survey-card-description">${getTextFromBuffer(survey.description) || 'Keine Beschreibung'}</p>
                    <div class="survey-stats">
                        <div class="survey-stat">
                            <span class="survey-stat-value">${survey.responseCount || 0}</span>
                            <span class="survey-stat-label">Antworten</span>
                        </div>
                        <div class="survey-stat">
                            <span class="survey-stat-value">${responseRate}%</span>
                            <span class="survey-stat-label">Abschlussrate</span>
                        </div>
                    </div>
                    <div class="survey-actions">
                        ${
                          // Only show edit button if no responses yet
                          survey.responseCount === 0 || survey.responseCount === null || survey.responseCount === undefined
                            ? `
                        <button class="survey-action-btn" onclick="event.stopPropagation(); editSurvey(${survey.id})">
                            <i class="fas fa-edit"></i>
                            Bearbeiten
                        </button>
                        `
                            : ''
                        }
                        ${
                          !isDraft
                            ? `
                        <button class="survey-action-btn" onclick="event.stopPropagation(); viewResults(${survey.id})">
                            <i class="fas fa-chart-bar"></i>
                            Ergebnisse
                        </button>
                        `
                            : ''
                        }
                        <button class="survey-action-btn" onclick="event.stopPropagation(); deleteSurvey(${survey.id})">
                            <i class="fas fa-trash"></i>
                            L√∂schen
                        </button>
                    </div>
                </div>
            `;
      }

      // Load templates
      window.loadTemplates = async function () {
        try {
          const useV2 = window.FEATURE_FLAGS?.USE_API_V2_SURVEYS ?? false;
          const endpoint = useV2 ? '/api/v2/surveys/templates' : '/api/surveys/templates';

          const response = await fetch(endpoint, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
          });

          if (response.ok) {
            const result = await response.json();
            // Handle v2 API response structure
            const templates = useV2 && result.success ? result.data : result.data || result.templates || result;
            // Ensure templates is an array
            if (Array.isArray(templates)) {
              displayTemplates(templates);
            } else {
              console.error('Invalid templates data format:', templates);
              displayTemplates([]);
            }
          }
        } catch (error) {
          console.error('Error loading templates:', error);
        }
      };

      // Display templates
      function displayTemplates(templates) {
        const container = document.querySelector('surveyTemplates');
        container.innerHTML =
          templates && templates.length > 0
            ? templates
                .map(
                  (template) => `
                    <div class="template-card" onclick="createFromTemplate(${template.id})">
                        <h4 class="template-name">${template.name}</h4>
                        <p class="template-description">${template.description}</p>
                    </div>
                `,
                )
                .join('')
            : `<div class="empty-state">
                <div class="empty-state-icon">üìë</div>
                <h3 class="empty-state-title">Keine Vorlagen</h3>
                <p>Es sind noch keine Umfrage-Vorlagen verf√ºgbar.</p>
              </div>`;
      }

      // Create from template
      window.createFromTemplate = async function (templateId) {
        if (confirm('M√∂chten Sie eine neue Umfrage basierend auf dieser Vorlage erstellen?')) {
          try {
            const useV2 = window.FEATURE_FLAGS?.USE_API_V2_SURVEYS ?? false;
            // v2 uses different endpoint structure
            const endpoint = useV2 ? `/api/v2/surveys/templates/${templateId}` : `/api/surveys/from-template/${templateId}`;

            const response = await fetch(endpoint, {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${localStorage.getItem('token')}`,
              },
            });

            if (response.ok) {
              const result = await response.json();
              showSuccessAlert('Umfrage wurde aus Vorlage erstellt');
              loadSurveys();
            }
          } catch (error) {
            console.error('Error creating from template:', error);
            showErrorAlert('Fehler beim Erstellen der Umfrage');
          }
        }
      };

      // Show create modal
      window.showCreateModal = function () {
        currentSurveyId = null;

        // Show modal using modal manager
        window.modalManager.show('surveyModal', {
          onOpen: () => {
            document.querySelector('modalTitle').textContent = 'Neue Umfrage erstellen';
            document.querySelector('surveyForm').reset();
            document.querySelector('questionsList').innerHTML = '';
            questionCounter = 0;

            // Reset assignment type to "Ganze Firma"
            document.querySelector('assignmentType').value = 'all_users';
            document.querySelector('assignmentDropdownDisplay').querySelector('span').textContent = 'Ganze Firma';
            document.querySelector('departmentSelection').style.display = 'none';
            document.querySelector('teamSelection').style.display = 'none';

            // Set default dates: today at 00:00 and 14 days later at 00:00
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const endDate = new Date(today);
            endDate.setDate(endDate.getDate() + 14);

            // Format dates for datetime-local input
            const formatDate = (date) => {
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              return `${year}-${month}-${day}T00:00`;
            };

            document.querySelector('startDate').value = formatDate(today);
            document.querySelector('endDate').value = formatDate(endDate);

            addQuestion(); // Add first question by default
          },
        });
      };

      // Close modal
      window.closeModal = function () {
        window.modalManager.hide('surveyModal');
      };

      // Add question
      window.addQuestion = function () {
        questionCounter++;
        const questionId = `question_${questionCounter}`;
        const questionHtml = `
                <div class="question-item" id="${questionId}">
                    <div class="question-header">
                        <span class="question-number">${questionCounter}</span>
                        <div class="question-actions">
                            <button type="button" class="question-action delete" onclick="removeQuestion('${questionId}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Fragetext eingeben (min. 5 Zeichen)..." required minlength="5" maxlength="500">
                    </div>
                    <div class="form-group">
                        <div class="custom-dropdown">
                            <div class="dropdown-display" id="${questionId}_typeDisplay" onclick="toggleDropdown('${questionId}_type')">
                                <span>Textantwort</span>
                                <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                                    <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="dropdown-options" id="${questionId}_typeDropdown">
                                <div class="dropdown-option" onclick="selectQuestionType('${questionId}', 'text', 'Textantwort')">Textantwort</div>
                                <div class="dropdown-option" onclick="selectQuestionType('${questionId}', 'single_choice', 'Einzelauswahl')">Einzelauswahl</div>
                                <div class="dropdown-option" onclick="selectQuestionType('${questionId}', 'multiple_choice', 'Mehrfachauswahl')">Mehrfachauswahl</div>
                                <div class="dropdown-option" onclick="selectQuestionType('${questionId}', 'rating', 'Bewertung (1-5)')">Bewertung (1-5)</div>
                                <div class="dropdown-option" onclick="selectQuestionType('${questionId}', 'yes_no', 'Ja/Nein')">Ja/Nein</div>
                                <div class="dropdown-option" onclick="selectQuestionType('${questionId}', 'number', 'Zahl')">Zahl</div>
                                <div class="dropdown-option" onclick="selectQuestionType('${questionId}', 'date', 'Datum')">Datum</div>
                            </div>
                            <input type="hidden" id="${questionId}_typeValue" value="text" />
                        </div>
                    </div>
                    <div class="options-container" id="${questionId}_options" class="u-hidden">
                        <!-- Options will be added here for choice questions -->
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="${questionId}_required" checked>
                        <label for="${questionId}_required">Pflichtfrage</label>
                    </div>
                </div>
            `;
        document.querySelector('questionsList').insertAdjacentHTML('beforeend', questionHtml);
      };

      // Handle question type change
      function handleQuestionTypeChange(questionId, type) {
        const optionsContainer = document.querySelector(`${questionId}_options`);

        if (type === 'single_choice' || type === 'multiple_choice') {
          optionsContainer.style.display = 'block';
          optionsContainer.innerHTML = `
                    <div id="${questionId}_option_list">
                        <div class="option-item">
                            <input type="text" class="option-input" placeholder="Option 1">
                            <button type="button" class="remove-option" onclick="removeOption(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="option-item">
                            <input type="text" class="option-input" placeholder="Option 2">
                            <button type="button" class="remove-option" onclick="removeOption(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="add-option-btn" onclick="addOption('${questionId}')">
                        <i class="fas fa-plus"></i>
                        Option hinzuf√ºgen
                    </button>
                `;
        } else {
          optionsContainer.style.display = 'none';
          optionsContainer.innerHTML = '';
        }
      }

      // Add option
      function addOption(questionId) {
        const optionList = document.querySelector(`${questionId}_option_list`);
        const optionCount = optionList.children.length + 1;
        const optionHtml = `
                <div class="option-item">
                    <input type="text" class="option-input" placeholder="Option ${optionCount}">
                    <button type="button" class="remove-option" onclick="removeOption(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        optionList.insertAdjacentHTML('beforeend', optionHtml);
      }

      // Remove option
      window.removeOption = function (button) {
        button.parentElement.remove();
      };

      // Remove question
      window.removeQuestion = function (questionId) {
        document.querySelector(questionId).remove();
        updateQuestionNumbers();
      };

      // Update question numbers
      window.updateQuestionNumbers = function () {
        const questions = document.querySelectorAll('.question-item');
        questions.forEach((question, index) => {
          question.querySelector('.question-number').textContent = index + 1;
        });
      };

      // Save survey
      window.saveSurvey = async function (status) {
        const assignmentType = document.querySelector('assignmentType').value;
        const assignments = [];

        // Handle different assignment types
        if (assignmentType === 'all_users') {
          assignments.push({ type: 'all_users' });
        } else if (assignmentType === 'department') {
          // Get selected departments from select element
          const select = document.querySelector('departmentSelect');
          const selectedDepts = Array.from(select.selectedOptions).map((option) => parseInt(option.value));

          if (selectedDepts.length === 0) {
            showAlert('Bitte w√§hlen Sie mindestens eine Abteilung aus');
            return;
          }

          selectedDepts.forEach((deptId) => {
            assignments.push({
              type: 'department',
              departmentId: deptId,
            });
          });
        } else if (assignmentType === 'team') {
          // Get selected teams from select element
          const select = document.querySelector('teamSelect');
          const selectedTeams = Array.from(select.selectedOptions).map((option) => parseInt(option.value));

          if (selectedTeams.length === 0) {
            showAlert('Bitte w√§hlen Sie mindestens ein Team aus');
            return;
          }

          selectedTeams.forEach((teamId) => {
            assignments.push({
              type: 'team',
              teamId: teamId,
            });
          });
        }

        // Validate survey title
        const title = document.querySelector('surveyTitle').value.trim();
        if (title.length < 3 || title.length > 255) {
          showAlert('Der Umfragetitel muss zwischen 3 und 255 Zeichen lang sein');
          return;
        }

        const surveyData = {
          title: title,
          description: document.querySelector('surveyDescription').value,
          isAnonymous: document.querySelector('isAnonymous').checked,
          isMandatory: document.querySelector('isMandatory').checked,
          startDate: document.querySelector('startDate').value || null,
          endDate: document.querySelector('endDate').value || null,
          status: status,
          questions: getQuestionsData(),
          assignments: assignments,
        };

        // Validate questions
        if (surveyData.questions.length === 0) {
          showAlert('Bitte f√ºgen Sie mindestens eine Frage hinzu');
          return;
        }

        // Validate each question
        for (let i = 0; i < surveyData.questions.length; i++) {
          const question = surveyData.questions[i];
          if (question.questionText.length < 5 || question.questionText.length > 500) {
            showAlert(`Frage ${i + 1}: Der Fragetext muss zwischen 5 und 500 Zeichen lang sein`);
            return;
          }

          // Validate options for choice questions
          if (question.questionType === 'single_choice' || question.questionType === 'multiple_choice') {
            if (!question.options || question.options.length < 2) {
              showAlert(`Frage ${i + 1}: Auswahlfragen ben√∂tigen mindestens 2 Optionen`);
              return;
            }
          }
        }

        try {
          const useV2 = window.FEATURE_FLAGS?.USE_API_V2_SURVEYS ?? false;
          const url = currentSurveyId
            ? useV2
              ? `/api/v2/surveys/${currentSurveyId}`
              : `/api/surveys/${currentSurveyId}`
            : useV2
              ? '/api/v2/surveys'
              : '/api/surveys';
          const method = currentSurveyId ? 'PUT' : 'POST';

          const response = await fetch(url, {
            method: method,
            headers: {
              Authorization: `Bearer ${localStorage.getItem('token')}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(surveyData),
          });

          if (response.ok) {
            showSuccessAlert('Umfrage erfolgreich gespeichert');
            closeModal();
            loadSurveys();
          } else {
            const error = await response.json();
            // Handle different error response formats
            const errorMessage = error.message || error.error || 'Unbekannter Fehler';
            console.error('Server error:', error);
            showErrorAlert('Fehler: ' + errorMessage);
          }
        } catch (error) {
          console.error('Error saving survey:', error);
          showErrorAlert('Fehler beim Speichern der Umfrage');
        }
      };

      // Get questions data
      window.getQuestionsData = function () {
        const questions = [];
        const questionElements = document.querySelectorAll('.question-item');

        questionElements.forEach((element, index) => {
          const questionText = element.querySelector('input[type="text"]').value.trim();
          const questionTypeInput = element.querySelector('input[type="hidden"][id$="_typeValue"]');
          const questionType = questionTypeInput ? questionTypeInput.value : 'text';
          const isRequired = element.querySelector('input[type="checkbox"]').checked;

          const question = {
            questionText: questionText,
            questionType: questionType,
            isRequired: isRequired,
            orderPosition: index + 1,
          };

          // Get options for choice questions
          if (questionType === 'single_choice' || questionType === 'multiple_choice') {
            const options = [];
            element.querySelectorAll('.option-input').forEach((input) => {
              if (input.value.trim()) {
                options.push(input.value.trim());
              }
            });
            question.options = options;
          }

          questions.push(question);
        });

        return questions;
      };

      // Get status text
      window.getStatusText = function (status) {
        const statusTexts = {
          draft: 'Entwurf',
          active: 'Aktiv',
          closed: 'Geschlossen',
          archived: 'Archiviert',
        };
        return statusTexts[status] || status;
      };

      // View survey
      window.viewSurvey = function (surveyId) {
        window.location.href = `/survey-details?id=${surveyId}`;
      };

      // Edit survey
      window.editSurvey = async function (surveyId) {
        // Load survey data and populate form
        try {
          const useV2 = window.FEATURE_FLAGS?.USE_API_V2_SURVEYS ?? false;
          const endpoint = useV2 ? `/api/v2/surveys/${surveyId}` : `/api/surveys/${surveyId}`;

          const response = await fetch(endpoint, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem('token')}`,
            },
          });

          if (response.ok) {
            const result = await response.json();
            // Handle v2 API response structure
            const survey = useV2 && result.success ? result.data : result.data || result.survey || result;

            // Check if survey has responses - prevent editing if it does
            if (survey.responseCount > 0) {
              showAlert('Diese Umfrage kann nicht bearbeitet werden, da bereits Antworten vorliegen.', 'warning');
              return;
            }

            currentSurveyId = surveyId;

            // Show modal using modal manager
            window.modalManager.show('surveyModal', {
              onOpen: async () => {
                document.querySelector('modalTitle').textContent = 'Umfrage bearbeiten';
                await populateSurveyForm(survey);
              },
            });
          }
        } catch (error) {
          console.error('Error loading survey:', error);
          showErrorAlert('Fehler beim Laden der Umfrage');
        }
      };

      // View results
      window.viewResults = function (surveyId) {
        window.location.href = `/survey-results?id=${surveyId}`;
      };

      // Delete survey
      window.deleteSurvey = async function (surveyId) {
        if (await showConfirm('M√∂chten Sie diese Umfrage wirklich l√∂schen?')) {
          try {
            const useV2 = window.FEATURE_FLAGS?.USE_API_V2_SURVEYS ?? false;
            const endpoint = useV2 ? `/api/v2/surveys/${surveyId}` : `/api/surveys/${surveyId}`;

            const response = await fetch(endpoint, {
              method: 'DELETE',
              headers: {
                Authorization: `Bearer ${localStorage.getItem('token')}`,
              },
            });

            if (response.ok) {
              showSuccessAlert('Umfrage erfolgreich gel√∂scht');
              loadSurveys();
            }
          } catch (error) {
            console.error('Error deleting survey:', error);
            showErrorAlert('Fehler beim L√∂schen der Umfrage');
          }
        }
      };

      // Populate survey form (for editing)
      window.populateSurveyForm = async function (survey) {
        // Handle title (might be Buffer)
        document.querySelector('surveyTitle').value = getTextFromBuffer(survey.title);

        // Handle description (might be Buffer)
        document.querySelector('surveyDescription').value = getTextFromBuffer(survey.description);

        // Handle boolean fields (might be strings)
        document.querySelector('isAnonymous').checked =
          survey.isAnonymous === '1' || survey.isAnonymous === 1 || survey.isAnonymous === true;

        document.querySelector('isMandatory').checked =
          survey.isMandatory === '1' || survey.isMandatory === 1 || survey.isMandatory === true;
        document.querySelector('startDate').value = survey.startDate ? new Date(survey.startDate).toISOString().slice(0, 16) : '';
        document.querySelector('endDate').value = survey.endDate ? new Date(survey.endDate).toISOString().slice(0, 16) : '';

        // Handle assignments - Support both snake_case and camelCase
        if (survey.assignments && survey.assignments.length > 0) {
          const assignment = survey.assignments[0]; // Get first assignment
          // Support both assignmentType (camelCase) and assignment_type (snake_case)
          const assignType = assignment.assignmentType || assignment.assignment_type || assignment.type;

          if (assignType === 'all_users') {
            // Set to "Ganze Firma"
            document.querySelector('assignmentType').value = 'all_users';
            document.querySelector('assignmentDropdownDisplay').querySelector('span').textContent = 'Ganze Firma';
            document.querySelector('departmentSelection').style.display = 'none';
            document.querySelector('teamSelection').style.display = 'none';
          } else if (assignType === 'department') {
            // Set to "Abteilung"
            document.querySelector('assignmentType').value = 'department';
            document.querySelector('assignmentDropdownDisplay').querySelector('span').textContent = 'Abteilung';
            document.querySelector('departmentSelection').style.display = 'block';
            document.querySelector('teamSelection').style.display = 'none';

            // Load departments and set selected ones
            await loadUserDepartments();
            const departmentSelect = document.querySelector('departmentSelect');
            if (departmentSelect) {
              // Clear previous selections
              Array.from(departmentSelect.options).forEach(option => option.selected = false);
              // Set selected departments
              survey.assignments.forEach(assign => {
                const deptId = assign.departmentId || assign.department_id;
                if (deptId) {
                  const option = departmentSelect.querySelector(`option[value="${deptId}"]`);
                  if (option) option.selected = true;
                }
              });
            }
          } else if (assignType === 'team') {
            // Set to "Team"
            document.querySelector('assignmentType').value = 'team';
            document.querySelector('assignmentDropdownDisplay').querySelector('span').textContent = 'Team';
            document.querySelector('departmentSelection').style.display = 'none';
            document.querySelector('teamSelection').style.display = 'block';

            // Load teams and set selected ones
            await loadUserTeams();
            const teamSelect = document.querySelector('teamSelect');
            if (teamSelect) {
              // Clear previous selections
              Array.from(teamSelect.options).forEach(option => option.selected = false);
              // Set selected teams
              survey.assignments.forEach(assign => {
                const teamId = assign.teamId || assign.team_id;
                if (teamId) {
                  const option = teamSelect.querySelector(`option[value="${teamId}"]`);
                  if (option) option.selected = true;
                }
              });
            }
          }
        } else {
          // Default to "Ganze Firma" if no assignments
          document.querySelector('assignmentType').value = 'all_users';
          document.querySelector('assignmentDropdownDisplay').querySelector('span').textContent = 'Ganze Firma';
          document.querySelector('departmentSelection').style.display = 'none';
          document.querySelector('teamSelection').style.display = 'none';
        }

        // Clear existing questions
        document.querySelector('questionsList').innerHTML = '';
        questionCounter = 0;

        // Add questions
        survey.questions.forEach((question) => {
          addQuestion();
          const questionElement = document.querySelector('.question-item:last-child');
          // Set question text
          questionElement.querySelector('input[type="text"]').value = getTextFromBuffer(question.questionText);

          // Set question type using custom dropdown
          const typeInput = questionElement.querySelector('input[type="hidden"][id$="_typeValue"]');
          if (typeInput) {
            typeInput.value = question.questionType;
            // Update dropdown display
            const typeDisplay = questionElement.querySelector('[id$="_typeDisplay"] span');
            if (typeDisplay) {
              const typeLabels = {
                text: 'Textantwort',
                single_choice: 'Einzelauswahl',
                multiple_choice: 'Mehrfachauswahl',
                rating: 'Bewertung (1-5)',
                yes_no: 'Ja/Nein',
                number: 'Zahl',
                date: 'Datum',
              };
              typeDisplay.textContent = typeLabels[question.questionType] || 'Textantwort';
            }
          }

          // Set required checkbox
          const requiredCheckbox = questionElement.querySelector('input[type="checkbox"]');
          if (requiredCheckbox) {
            requiredCheckbox.checked = question.is_required === '1' || question.is_required === 1 || question.is_required === true;
          }

          // Handle options
          if (question.options && question.options.length > 0) {
            handleQuestionTypeChange(`question_${questionCounter}`, question.questionType);
            const optionsList = questionElement.querySelector(`#question_${questionCounter}_option_list`);
            optionsList.innerHTML = '';

            question.options.forEach((option) => {
              // Handle option text (might be string or object)
              const optionText = typeof option === 'string' ? option : option.option_text || '';

              const optionHtml = `
                            <div class="option-item">
                                <input type="text" class="option-input" value="${optionText}">
                                <button type="button" class="remove-option" onclick="removeOption(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
              optionsList.insertAdjacentHTML('beforeend', optionHtml);
            });
          }
        });
      };
    </script>
  </body>
</html>
