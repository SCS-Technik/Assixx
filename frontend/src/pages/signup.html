<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registrieren - Assixx</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/styles/dashboard-theme.css" />
    <link rel="stylesheet" href="/styles/signup.css" />
    <!-- Feature Flags for API v2 Migration -->
    <script src="/feature-flags.js"></script>
    <!-- Dom-utils Module für sichere HTML-Sanitization -->
    <script type="module">
      import { setHTML } from '/utils/dom-utils.js';
      window.setHTML = setHTML; // Make available globally
    </script>
  </head>
  <body>
    <!-- Back to Homepage Button -->
    <a href="/" class="back-button">
      <span class="icon">←</span>
      <span>Zurück zur Hauptseite</span>
    </a>

    <!-- Help Button -->
    <div class="help-button" data-action="show-help">?</div>

    <div class="signup-container">
      <!-- Header -->
      <div class="signup-header">
        <div class="header-left">
          <img src="/assets/images/logo.png" alt="Assixx Logo" class="signup-logo" data-action="reload-page" class="u-cursor-pointer" />
          <div class="header-text">
            <h1></h1>
            <!-- machen wir anders spöter -->
            <p></p>
            <!-- machen wir anders spöter -->
          </div>
        </div>
      </div>

      <!-- Success Message -->
      <div id="successMessage" class="success-message"></div>

      <!-- Compact Form -->
      <form id="signupForm">
        <div class="form-grid">
          <!-- Erste Zeile -->
          <div class="form-group">
            <label class="form-label">Firmenname *</label>
            <input
              type="text"
              name="company_name"
              class="form-control"
              required
              placeholder="Ihre Firma GmbH"
              autocomplete="organization"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Subdomain *</label>
            <div class="input-group">
              <input type="text" name="subdomain" class="form-control" required pattern="[a-z0-9\-]+" placeholder="ihre-firma" />
              <span class="input-group-suffix">.assixx.com</span>
            </div>
            <div id="subdomainError" class="error-message">Nur Kleinbuchstaben und Bindestriche</div>
          </div>
          <div class="form-group">
            <label class="form-label">E-Mail *</label>
            <input type="email" name="email" class="form-control" required placeholder="email@firma.de" autocomplete="email" />
          </div>
          <div class="form-group">
            <label class="form-label">E-Mail bestätigen *</label>
            <input type="email" name="email_confirm" class="form-control" required placeholder="email@firma.de" />
            <div id="emailMatchError" class="error-message" class="u-hidden">E-Mail-Adressen stimmen nicht überein</div>
          </div>

          <!-- Zweite Zeile -->
          <div class="form-group">
            <label class="form-label">Vorname *</label>
            <input type="text" name="first_name" class="form-control" required placeholder="" autocomplete="given-name" />
          </div>
          <div class="form-group">
            <label class="form-label">Nachname *</label>
            <input type="text" name="last_name" class="form-control" required placeholder="" autocomplete="family-name" />
          </div>
          <div class="form-group">
            <label class="form-label">Telefon *</label>
            <div class="phone-input-group">
              <div class="custom-country-select">
                <div class="country-display" data-action="toggle-country">
                  <span id="selectedFlag">🇩🇪</span>
                  <span id="selectedCode">+49</span>
                  <svg width="10" height="6" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                  </svg>
                </div>
                <div class="country-dropdown" id="countryDropdown">
                  <div class="country-option" data-action="select-country" data-flag="🇩🇪" data-code="+49">🇩🇪 +49</div>
                  <div class="country-option" data-action="select-country" data-flag="🇦🇹" data-code="+43">🇦🇹 +43</div>
                  <div class="country-option" data-action="select-country" data-flag="🇨🇭" data-code="+41">🇨🇭 +41</div>
                  <div class="country-option" data-action="select-country" data-flag="🇫🇷" data-code="+33">🇫🇷 +33</div>
                  <div class="country-option" data-action="select-country" data-flag="🇮🇹" data-code="+39">🇮🇹 +39</div>
                  <div class="country-option" data-action="select-country" data-flag="🇪🇸" data-code="+34">🇪🇸 +34</div>
                  <div class="country-option" data-action="select-country" data-flag="🇳🇱" data-code="+31">🇳🇱 +31</div>
                  <div class="country-option" data-action="select-country" data-flag="🇧🇪" data-code="+32">🇧🇪 +32</div>
                  <div class="country-option" data-action="select-country" data-flag="🇱🇺" data-code="+352">🇱🇺 +352</div>
                  <div class="country-option" data-action="select-country" data-flag="🇵🇱" data-code="+48">🇵🇱 +48</div>
                  <div class="country-option" data-action="select-country" data-flag="🇨🇿" data-code="+420">🇨🇿 +420</div>
                  <div class="country-option" data-action="select-country" data-flag="🇺🇸" data-code="+1">🇺🇸 +1</div>
                  <div class="country-option" data-action="select-country" data-flag="🇬🇧" data-code="+44">🇬🇧 +44</div>
                </div>
              </div>
              <input type="hidden" id="countryCode" value="+49" />
              <input
                type="tel"
                name="phone"
                class="form-control phone-number"
                placeholder="123 456789"
                autocomplete="tel-national"
                required
              />
            </div>
            <div id="phoneError" class="error-message">Bitte geben Sie eine gültige Telefonnummer ein (7-15 Ziffern)</div>
          </div>

          <!-- Dritte Zeile -->
          <div class="form-group">
            <label class="form-label">Passwort *</label>
            <input
              type="password"
              name="password"
              class="form-control"
              required
              minlength="8"
              placeholder="Min. 8 Zeichen"
              autocomplete="new-password"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Passwort bestätigen *</label>
            <input type="password" name="password_confirm" class="form-control" required placeholder="" autocomplete="new-password" />
            <div id="passwordError" class="error-message">Passwörter stimmen nicht überein</div>
          </div>
          <div class="form-group">
            <label class="form-label">Plan</label>
            <div class="custom-plan-select">
              <div class="plan-display" data-action="toggle-plan">
                <span id="selectedPlan">Enterprise</span>
                <svg width="10" height="6" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                </svg>
              </div>
              <div class="plan-dropdown" id="planDropdown">
                <div class="plan-option" data-action="select-plan" data-value="enterprise" data-name="Enterprise">
                  <span>Enterprise</span>
                  <span class="plan-price">€149/M</span>
                </div>
                <div class="plan-option" data-action="select-plan" data-value="professional" data-name="Professional">
                  <span>Professional</span>
                  <span class="plan-price">€99/M</span>
                </div>
                <div class="plan-option" data-action="select-plan" data-value="basic" data-name="Basic">
                  <span>Basic</span>
                  <span class="plan-price">€49/M</span>
                </div>
              </div>
            </div>
            <input type="hidden" name="plan" id="planValue" value="enterprise" />
          </div>

          <!-- Terms und Submit in einer Zeile -->
          <div class="bottom-section">
            <label class="terms-checkbox">
              <input type="checkbox" id="termsCheckbox" name="terms" required />
              <span>
                Ich akzeptiere die
                <a href="/TERMS-OF-USE.md" target="_blank" class="terms-link">Nutzungsbedingungen</a>
              </span>
            </label>
            <div class="offer-banner">
              🎁
              <strong>14 Tage kostenlos testen</strong>
            </div>
            <button type="submit" class="submit-button" id="submitButton">Jetzt registrieren →</button>
            <a href="/login" class="login-link">Bereits registriert?</a>
          </div>
        </div>
      </form>
    </div>

    <script>
      // Custom Dropdown Functions
      let currentCountryCode = '+49';
      // currentCountryFlag is updated when country is selected
      let currentPlan = 'enterprise';

      // Country Dropdown
      function toggleCountryDropdown() {
        const dropdown = document.querySelector('#countryDropdown');
        const display = document.querySelector('.country-display');

        // Close plan dropdown if open
        document.querySelector('#planDropdown').classList.remove('active');
        document.querySelector('.plan-display').classList.remove('active');

        dropdown.classList.toggle('active');
        display.classList.toggle('active');

        if (dropdown.classList.contains('active')) {
          document.addEventListener('click', closeDropdownOutside);
        }
      }

      function closeDropdownOutside(e) {
        const countrySelect = document.querySelector('.custom-country-select');
        const planSelect = document.querySelector('.custom-plan-select');

        if (!countrySelect.contains(e.target)) {
          document.querySelector('#countryDropdown').classList.remove('active');
          document.querySelector('.country-display').classList.remove('active');
        }

        if (!planSelect.contains(e.target)) {
          document.querySelector('#planDropdown').classList.remove('active');
          document.querySelector('.plan-display').classList.remove('active');
        }

        if (!countrySelect.contains(e.target) && !planSelect.contains(e.target)) {
          document.removeEventListener('click', closeDropdownOutside);
        }
      }

      function selectCountry(flag, code) {
        document.querySelector('#selectedFlag').textContent = flag;
        document.querySelector('#selectedCode').textContent = code;
        document.querySelector('#countryCode').value = code;
        currentCountryCode = code;
        // Update flag (used internally)

        document.querySelector('#countryDropdown').classList.remove('active');
        document.querySelector('.country-display').classList.remove('active');
      }

      // Plan Dropdown
      function togglePlanDropdown() {
        const dropdown = document.querySelector('#planDropdown');
        const display = document.querySelector('.plan-display');

        // Close country dropdown if open
        document.querySelector('#countryDropdown').classList.remove('active');
        document.querySelector('.country-display').classList.remove('active');

        dropdown.classList.toggle('active');
        display.classList.toggle('active');

        if (dropdown.classList.contains('active')) {
          document.addEventListener('click', closeDropdownOutside);
        }
      }

      function selectPlan(value, name) {
        document.querySelector('#selectedPlan').textContent = name;
        document.querySelector('#planValue').value = value;
        currentPlan = value;

        document.querySelector('#planDropdown').classList.remove('active');
        document.querySelector('.plan-display').classList.remove('active');
      }

      // Help function
      function showHelp() {
        alert(
          'Hilfe zur Registrierung:\n\n' +
            '1. Geben Sie Ihre Firmendaten ein\n' +
            '2. Wählen Sie eine eindeutige Subdomain\n' +
            '3. Erstellen Sie ein sicheres Passwort\n' +
            '4. 14 Tage kostenlos testen!\n\n' +
            'Bei Fragen: support@assixx.com',
        );
      }

      // Get plan from URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const selectedPlan = urlParams.get('plan');
      if (selectedPlan) {
        document.querySelector('select[name="plan"]').value = selectedPlan;
      }

      // Subdomain validation
      const subdomainInput = document.querySelector('input[name="subdomain"]');
      const subdomainError = document.querySelector('#subdomainError');

      subdomainInput.addEventListener('input', (e) => {
        const value = e.target.value.toLowerCase();
        e.target.value = value;

        if (value && !/^[a-z0-9-]+$/.test(value)) {
          subdomainError.style.display = 'block';
        } else {
          subdomainError.style.display = 'none';
        }
      });

      // Password confirmation with real-time validation
      const passwordInput = document.querySelector('input[name="password"]');
      const passwordConfirmInput = document.querySelector('input[name="password_confirm"]');
      const passwordError = document.querySelector('#passwordError');

      passwordConfirmInput.addEventListener('input', () => {
        if (passwordConfirmInput.value && passwordInput.value !== passwordConfirmInput.value) {
          passwordError.style.display = 'block';
          passwordConfirmInput.style.borderColor = '#ef4444';
        } else {
          passwordError.style.display = 'none';
          passwordConfirmInput.style.borderColor = '';
        }
      });

      // Phone validation
      const phoneInput = document.querySelector('input[name="phone"]');
      const phoneError = document.querySelector('#phoneError');

      phoneInput.addEventListener('input', () => {
        const phoneValue = phoneInput.value.trim();
        const countryCode = document.querySelector('#countryCode').value;

        // Check if phone starts with 0 for Germany/Austria/Switzerland
        if ((countryCode === '+49' || countryCode === '+43' || countryCode === '+41') && phoneValue.startsWith('0')) {
          phoneError.textContent = 'Bitte ohne führende 0 eingeben (die Ländervorwahl ersetzt die 0)';
          phoneError.style.display = 'block';
          phoneInput.style.borderColor = '#ef4444';
        } else if (phoneValue && !/^[1-9][0-9]{6,14}$/.test(phoneValue)) {
          phoneError.textContent = 'Bitte geben Sie eine gültige Telefonnummer ein (7-15 Ziffern)';
          phoneError.style.display = 'block';
          phoneInput.style.borderColor = '#ef4444';
        } else if (phoneValue === '') {
          phoneError.textContent = 'Telefonnummer ist ein Pflichtfeld';
          phoneError.style.display = 'block';
          phoneInput.style.borderColor = '#ef4444';
        } else {
          phoneError.style.display = 'none';
          phoneInput.style.borderColor = '';
        }
      });

      // Email confirmation validation
      const emailInput = document.querySelector('input[name="email"]');
      const emailConfirmInput = document.querySelector('input[name="email_confirm"]');
      const emailMatchError = document.querySelector('#emailMatchError');

      emailConfirmInput.addEventListener('input', () => {
        if (emailConfirmInput.value && emailInput.value !== emailConfirmInput.value) {
          emailMatchError.style.display = 'block';
          emailConfirmInput.style.borderColor = '#ef4444';
        } else {
          emailMatchError.style.display = 'none';
          emailConfirmInput.style.borderColor = '';
        }
      });

      // Also check when email field changes
      emailInput.addEventListener('input', () => {
        if (emailConfirmInput.value && emailInput.value !== emailConfirmInput.value) {
          emailMatchError.style.display = 'block';
          emailConfirmInput.style.borderColor = '#ef4444';
        } else {
          emailMatchError.style.display = 'none';
          emailConfirmInput.style.borderColor = '';
        }
      });

      // Event Delegation for all button actions
      document.addEventListener('click', (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;

        switch (action) {
          case 'show-help':
            showHelp();
            break;
          case 'reload-page':
            window.location.reload();
            break;
          case 'toggle-country':
            toggleCountryDropdown();
            break;
          case 'select-country': {
            const flag = target.dataset.flag;
            const code = target.dataset.code;
            selectCountry(flag, code);
            break;
          }
          case 'toggle-plan':
            togglePlanDropdown();
            break;
          case 'select-plan': {
            const value = target.dataset.value;
            const name = target.dataset.name;
            selectPlan(value, name);
            break;
          }
        }
      });

      // Form submission
      document.querySelector('#signupForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        // Validate emails match
        if (emailInput.value !== emailConfirmInput.value) {
          emailMatchError.style.display = 'block';
          emailConfirmInput.focus();
          return;
        }

        // Validate passwords match
        if (passwordInput.value !== passwordConfirmInput.value) {
          passwordError.style.display = 'block';
          passwordConfirmInput.focus();
          return;
        }

        // Validate phone number
        const phoneValue = phoneInput.value.trim();
        if (!phoneValue) {
          phoneError.textContent = 'Telefonnummer ist ein Pflichtfeld';
          phoneError.style.display = 'block';
          phoneInput.focus();
          return;
        }

        // Check for leading 0 in DACH countries
        if ((currentCountryCode === '+49' || currentCountryCode === '+43' || currentCountryCode === '+41') && phoneValue.startsWith('0')) {
          phoneError.textContent = 'Bitte ohne führende 0 eingeben (die Ländervorwahl ersetzt die 0)';
          phoneError.style.display = 'block';
          phoneInput.focus();
          return;
        }

        // General phone validation
        if (!/^[1-9][0-9]{6,14}$/.test(phoneValue)) {
          phoneError.textContent = 'Bitte geben Sie eine gültige Telefonnummer ein (7-15 Ziffern)';
          phoneError.style.display = 'block';
          phoneInput.focus();
          return;
        }

        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        // Get country code and format phone without spaces
        const phoneNumber = data.phone;
        const fullPhone = `${currentCountryCode}${phoneNumber.replace(/\s+/g, '')}`;

        // Check if v2 API should be used
        const useV2 = window.FEATURE_FLAGS && window.FEATURE_FLAGS.USE_API_V2_SIGNUP;

        // Add root user credentials - use camelCase for v2, snake_case for v1
        const signupData = useV2
          ? {
              // v2 format (camelCase)
              companyName: data.company_name,
              subdomain: data.subdomain,
              email: data.email,
              adminEmail: data.email,
              adminPassword: data.password,
              adminFirstName: data.first_name,
              adminLastName: data.last_name,
              phone: fullPhone,
              plan: currentPlan,
            }
          : {
              // v1 format (snake_case)
              company_name: data.company_name,
              subdomain: data.subdomain,
              email: data.email,
              admin_email: data.email,
              admin_password: data.password,
              admin_first_name: data.first_name,
              admin_last_name: data.last_name,
              phone: fullPhone,
              plan: currentPlan,
            };

        const submitButton = e.target.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;

        try {
          submitButton.disabled = true;
          submitButton.textContent = '⏳ Wird erstellt...';

          // API URL based on feature flag (useV2 already defined above)
          const apiUrl = useV2 ? '/api/v2/signup' : '/api/signup';

          console.info(`[Signup] Using ${useV2 ? 'v2' : 'v1'} API at ${apiUrl}`);

          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(signupData),
          });

          let result;
          const responseText = await response.text();

          try {
            result = JSON.parse(responseText);
          } catch (e) {
            console.error('Failed to parse response:', responseText, e);
            result = { message: 'Server response was not valid JSON: ' + responseText };
          }

          // Handle v2 response format
          if (useV2 && result.success === false) {
            // v2 error format
            const errorMessage = result.error?.message || result.message || 'Fehler bei der Registrierung';
            alert(errorMessage);
            submitButton.disabled = false;
            submitButton.textContent = originalText;
            return;
          }

          if (response.ok || (useV2 && result.success)) {
            // v2 response handled, data extraction not needed here

            document.querySelector('#successMessage').style.display = 'block';
            window.setHTML(
              document.querySelector('#successMessage'),
              `✅ <strong>Erfolgreich registriert!</strong> Sie werden in 3 Sekunden zur Anmeldung weitergeleitet...`,
            );

            // Clear form
            e.target.reset();

            // Redirect after 3 seconds
            setTimeout(() => {
              window.location.href = '/login';
            }, 3000);
          } else {
            // v1 error handling
            alert(result.message || 'Fehler bei der Registrierung');
            submitButton.disabled = false;
            submitButton.textContent = originalText;
          }
        } catch (error) {
          console.error('Signup error:', error);
          alert('Ein Fehler ist aufgetreten. Bitte versuchen Sie es später erneut.');
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        }
      });
    </script>
  </body>
</html>
