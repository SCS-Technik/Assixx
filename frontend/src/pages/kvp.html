<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KVP System - Assixx</title>

    <!-- Critical Layout State - Prevents Layout Shift -->
    <script src="/scripts/critical/sidebar-init.js"></script>

    <!-- Unified Navigation CSS - Load immediately to prevent FOUC -->
    <link id="unified-navigation-styles" rel="stylesheet" href="/styles/unified-navigation.css" />

    <!-- Dashboard Theme CSS -->
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/styles/lib/fontawesome.min.css" />
    <link rel="stylesheet" href="/styles/kvp.css" />
  </head>

  <body class="kvp-page">
    <!-- Navigation Container -->
    <div id="navigation-container"></div>

    <!-- Main Layout -->
    <div class="layout-container">
      <main class="main-content">
        <div id="breadcrumb-container"></div>

        <div class="container">
          <!-- Admin Info Box -->
          <div class="admin-info-box" id="adminInfoBox" class="u-hidden">
            <i class="fas fa-lightbulb"></i>
            <div>
              <strong>Tipp für Admins:</strong>
              Wechseln Sie zur Employee-Ansicht um selbst Vorschläge einzureichen. Als Admin können Sie Vorschläge verwalten und firmenweit
              teilen.
            </div>
          </div>

          <!-- Statistics Overview (Admin only) -->
          <div class="stats-overview" id="statsOverview" class="u-hidden">
            <div class="stat-card">
              <div class="stat-value" id="totalSuggestions">0</div>
              <div class="stat-label">Gesamt Vorschläge</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="openSuggestions">0</div>
              <div class="stat-label">In Bearbeitung</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="implementedSuggestions">0</div>
              <div class="stat-label">Umgesetzt</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalSavings">0€</div>
              <div class="stat-label">Einsparungen</div>
            </div>
          </div>

          <!-- Main Card Container -->
          <div class="card">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center">
              <div>
                <h2 class="card-title">KVP-Vorschläge</h2>
                <p class="text-secondary">Kontinuierlicher Verbesserungsprozess - Ihre Ideen für bessere Abläufe</p>
              </div>
            </div>
            <div class="card-body">
              <!-- Filter Bar -->
              <div class="kvp-filter-bar">
                <button class="filter-btn active" data-filter="all">
                  <i class="fas fa-list"></i>
                  Alle
                  <span class="badge" id="badgeAll">0</span>
                </button>
                <button class="filter-btn" data-filter="mine">
                  <i class="fas fa-user"></i>
                  Meine
                  <span class="badge" id="badgeMine">0</span>
                </button>
                <button class="filter-btn" data-filter="team">
                  <i class="fas fa-users"></i>
                  Team
                  <span class="badge" id="badgeTeam">0</span>
                </button>
                <button class="filter-btn" data-filter="department">
                  <i class="fas fa-building"></i>
                  Abteilung
                  <span class="badge" id="badgeDepartment">0</span>
                </button>
                <button class="filter-btn" data-filter="company">
                  <i class="fas fa-globe"></i>
                  Firmenweit
                  <span class="badge" id="badgeCompany">0</span>
                </button>
                <button class="filter-btn admin-only" data-filter="manage" class="u-hidden">
                  <i class="fas fa-tasks"></i>
                  Verwalten
                </button>
                <button class="filter-btn admin-only" data-filter="archived" class="u-hidden">
                  <i class="fas fa-archive"></i>
                  Archiv
                  <span class="badge" id="badgeArchived">0</span>
                </button>
              </div>

              <!-- Secondary Filters -->
              <div class="secondary-filters">
                <!-- Status Filter Dropdown -->
                <div class="custom-dropdown">
                  <div class="dropdown-display" id="statusDisplay" data-dropdown="status">
                    <span>Alle Status</span>
                    <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                      <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                  </div>
                  <div class="dropdown-options" id="statusDropdown">
                    <div class="dropdown-option" data-action="select-status" data-value="" data-text="Alle Status">Alle Status</div>
                    <div class="dropdown-option" data-action="select-status" data-value="new" data-text="Neu">Neu</div>
                    <div class="dropdown-option" data-action="select-status" data-value="in_review" data-text="In Prüfung">In Prüfung</div>
                    <div class="dropdown-option" data-action="select-status" data-value="approved" data-text="Genehmigt">Genehmigt</div>
                    <div class="dropdown-option" data-action="select-status" data-value="implemented" data-text="Umgesetzt">Umgesetzt</div>
                    <div class="dropdown-option" data-action="select-status" data-value="rejected" data-text="Abgelehnt">Abgelehnt</div>
                  </div>
                  <input type="hidden" name="statusFilter" id="statusFilterValue" />
                </div>

                <!-- Category Filter Dropdown -->
                <div class="custom-dropdown">
                  <div class="dropdown-display" id="categoryDisplay" data-dropdown="category">
                    <span>Alle Kategorien</span>
                    <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                      <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                  </div>
                  <div class="dropdown-options" id="categoryDropdown">
                    <div class="dropdown-option" data-action="select-category" data-value="" data-text="Alle Kategorien">
                      Alle Kategorien
                    </div>
                    <!-- Dynamisch geladen -->
                  </div>
                  <input type="hidden" name="categoryFilter" id="categoryFilterValue" />
                </div>

                <!-- Department Filter Dropdown -->
                <div class="custom-dropdown admin-only" class="u-hidden">
                  <div class="dropdown-display" id="departmentDisplay" data-dropdown="department">
                    <span>Alle Abteilungen</span>
                    <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                      <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                  </div>
                  <div class="dropdown-options" id="departmentDropdown">
                    <div class="dropdown-option" data-action="select-department" data-value="" data-text="Alle Abteilungen">
                      Alle Abteilungen
                    </div>
                    <!-- Dynamisch geladen für Admins -->
                  </div>
                  <input type="hidden" name="departmentFilter" id="departmentFilterValue" />
                </div>

                <input type="text" id="searchFilter" placeholder="Suchen..." />
              </div>

              <!-- Suggestions Container -->
              <div class="kvp-suggestions-grid" id="suggestionsContainer">
                <!-- Dynamisch geladen -->
              </div>

              <!-- Empty State -->
              <div class="empty-state" id="emptyState" class="u-hidden">
                <i class="fas fa-inbox"></i>
                <h3>Keine Vorschläge gefunden</h3>
                <p>Ändern Sie Ihre Filter oder erstellen Sie einen neuen Vorschlag</p>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Floating Add Button (only for employees) -->
    <button class="create-new-btn" id="createNewBtn" title="Neuen Vorschlag erstellen">+</button>

    <!-- Create KVP Modal -->
    <div id="createKvpModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Neuer KVP-Vorschlag</h3>
          <button class="modal-close" data-action="close-modal">&times;</button>
        </div>
        <form id="createKvpForm">
          <div class="modal-body">
            <!-- Warning Box -->
            <div class="warning-box">
              <i class="fas fa-exclamation-triangle"></i>
              <div>
                <strong>Wichtiger Hinweis:</strong>
                <br />
                Nach dem Einreichen können Sie Ihren Vorschlag nicht mehr bearbeiten oder löschen. Bitte prüfen Sie alle Angaben sorgfältig,
                bevor Sie den Vorschlag absenden.
              </div>
            </div>

            <!-- Two column grid for all fields -->
            <div class="form-grid">
              <!-- Title -->
              <div class="form-group">
                <label class="form-label" for="kvpTitle">
                  Titel
                  <span class="required">*</span>
                  <small style="color: rgba(255, 255, 255, 0.6); font-weight: normal">(3-255 Zeichen)</small>
                </label>
                <input
                  type="text"
                  id="kvpTitle"
                  name="title"
                  class="form-control"
                  placeholder="Kurze, prägnante Beschreibung"
                  required
                  minlength="3"
                  maxlength="255"
                />
              </div>

              <!-- Description -->
              <div class="form-group">
                <label class="form-label" for="kvpDescription">
                  Beschreibung
                  <span class="required">*</span>
                  <small style="color: rgba(255, 255, 255, 0.6); font-weight: normal">(10-5000 Zeichen)</small>
                </label>
                <textarea
                  id="kvpDescription"
                  name="description"
                  class="form-control"
                  placeholder="Detaillierte Beschreibung des Vorschlags..."
                  rows="4"
                  required
                  minlength="10"
                  maxlength="5000"
                ></textarea>
              </div>
              <!-- Category -->
              <div class="form-group">
                <label class="form-label" for="kvpCategory">
                  Kategorie
                  <span class="required">*</span>
                </label>
                <div class="custom-dropdown">
                  <div class="dropdown-display" id="kvpCategoryDisplay" data-dropdown="kvpCategory">
                    <span>Bitte wählen</span>
                    <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                      <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                  </div>
                  <div class="dropdown-options" id="kvpCategoryDropdown">
                    <!-- Dynamisch geladen -->
                  </div>
                  <input type="hidden" name="category_id" id="kvpCategoryValue" required />
                </div>
              </div>

              <!-- Priority -->
              <div class="form-group">
                <label class="form-label" for="kvpPriority">Priorität</label>
                <div class="custom-dropdown">
                  <div class="dropdown-display" id="kvpPriorityDisplay" data-dropdown="kvpPriority">
                    <span>Normal</span>
                    <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                      <path d="M1 1L6 6L11 1" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                    </svg>
                  </div>
                  <div class="dropdown-options" id="kvpPriorityDropdown">
                    <div class="dropdown-option" data-action="select-priority" data-value="low" data-text="Niedrig">Niedrig</div>
                    <div class="dropdown-option" data-action="select-priority" data-value="normal" data-text="Normal">Normal</div>
                    <div class="dropdown-option" data-action="select-priority" data-value="high" data-text="Hoch">Hoch</div>
                    <div class="dropdown-option" data-action="select-priority" data-value="urgent" data-text="Dringend">Dringend</div>
                  </div>
                  <input type="hidden" name="priority" id="kvpPriorityValue" value="normal" />
                </div>
              </div>
            </div>

            <!-- Expected Benefit (full width) -->
            <div class="form-group full-width">
              <label class="form-label" for="kvpBenefit">Erwarteter Nutzen</label>
              <textarea
                id="kvpBenefit"
                name="expected_benefit"
                class="form-control"
                placeholder="Welche Vorteile bringt dieser Vorschlag?"
                rows="3"
              ></textarea>
            </div>

            <!-- Photo Upload Section -->
            <div class="form-group full-width">
              <label class="form-label">
                Fotos hinzufügen (optional)
                <small class="text-muted">Max. 5 Fotos, je max. 10MB, nur JPG/PNG</small>
              </label>
              <div class="photo-upload-area">
                <input type="file" id="kvpPhotos" name="photos" accept="image/jpeg,image/jpg,image/png" multiple class="u-hidden" />
                <div class="upload-box" data-action="upload-photos">
                  <i class="fas fa-camera"></i>
                  <p>Klicken Sie hier, um Fotos auszuwählen</p>
                  <p class="small text-muted">oder ziehen Sie Dateien hierher</p>
                </div>
                <div id="photoPreview" class="photo-preview"></div>
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-action="close-modal">Abbrechen</button>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save"></i>
              Vorschlag einreichen
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Event Delegation for KVP Page (without DOMPurify) -->
    <script>
      // Photo upload handling
      let selectedPhotos = [];
      window.selectedPhotos = selectedPhotos;

      // Event Delegation Handler
      document.addEventListener('click', function (e) {
        const target = e.target;

        // Dropdown toggle
        const dropdownDisplay = target.closest('[data-dropdown]');
        if (dropdownDisplay) {
          e.preventDefault();
          e.stopPropagation();
          const type = dropdownDisplay.dataset.dropdown;
          toggleDropdown(type);
          return;
        }

        // Status selection
        const statusOption = target.closest('[data-action="select-status"]');
        if (statusOption) {
          e.preventDefault();
          selectStatus(statusOption.dataset.value, statusOption.dataset.text);
          return;
        }

        // Category selection
        const categoryOption = target.closest('[data-action="select-category"]');
        if (categoryOption) {
          e.preventDefault();
          selectCategory(categoryOption.dataset.value, categoryOption.dataset.text);
          return;
        }

        // Department selection
        const departmentOption = target.closest('[data-action="select-department"]');
        if (departmentOption) {
          e.preventDefault();
          selectDepartment(departmentOption.dataset.value, departmentOption.dataset.text);
          return;
        }

        // Priority selection
        const priorityOption = target.closest('[data-action="select-priority"]');
        if (priorityOption) {
          e.preventDefault();
          selectKvpPriority(priorityOption.dataset.value, priorityOption.dataset.text);
          return;
        }

        // Modal close
        const modalClose = target.closest('[data-action="close-modal"]');
        if (modalClose) {
          e.preventDefault();
          hideCreateModal();
          return;
        }

        // Photo upload trigger
        const uploadBox = target.closest('[data-action="upload-photos"]');
        if (uploadBox) {
          e.preventDefault();
          document.querySelector('#kvpPhotos').click();
          return;
        }

        // Remove photo
        const removePhotoBtn = target.closest('[data-action="remove-photo"]');
        if (removePhotoBtn) {
          e.preventDefault();
          const index = parseInt(removePhotoBtn.dataset.index);
          removePhoto(index);
          return;
        }

        // Close dropdowns when clicking outside
        if (!target.closest('.custom-dropdown')) {
          document.querySelectorAll('.dropdown-display').forEach((d) => d.classList.remove('active'));
          document.querySelectorAll('.dropdown-options').forEach((d) => d.classList.remove('active'));
        }
      });

      // Click outside modal to close
      document.querySelector('#createKvpModal')?.addEventListener('click', function (e) {
        if (e.target === this) {
          hideCreateModal();
        }
      });

      // File input change handler
      document.querySelector('#kvpPhotos')?.addEventListener('change', function (e) {
        handlePhotoSelection(this);
      });

      // Helper Functions
      function toggleDropdown(type) {
        const display = document.querySelector(`#${type}Display`);
        const dropdown = document.querySelector(`#${type}Dropdown`);

        // Close all other dropdowns
        document.querySelectorAll('.dropdown-display').forEach((d) => {
          if (d !== display) d.classList.remove('active');
        });
        document.querySelectorAll('.dropdown-options').forEach((d) => {
          if (d !== dropdown) d.classList.remove('active');
        });

        display.classList.toggle('active');
        dropdown.classList.toggle('active');
      }

      function selectStatus(value, text) {
        document.querySelector('#statusDisplay').querySelector('span').textContent = text;
        document.querySelector('#statusFilterValue').value = value;
        document.querySelector('#statusDisplay').classList.remove('active');
        document.querySelector('#statusDropdown').classList.remove('active');

        // Trigger filter event
        const event = new Event('change');
        document.querySelector('#statusFilterValue').dispatchEvent(event);
      }

      function selectCategory(value, text) {
        document.querySelector('#categoryDisplay').querySelector('span').textContent = text;
        document.querySelector('#categoryFilterValue').value = value;
        document.querySelector('#categoryDisplay').classList.remove('active');
        document.querySelector('#categoryDropdown').classList.remove('active');

        // Trigger filter event
        const event = new Event('change');
        document.querySelector('#categoryFilterValue').dispatchEvent(event);
      }

      function selectDepartment(value, text) {
        document.querySelector('#departmentDisplay').querySelector('span').textContent = text;
        document.querySelector('#departmentFilterValue').value = value;
        document.querySelector('#departmentDisplay').classList.remove('active');
        document.querySelector('#departmentDropdown').classList.remove('active');

        // Trigger filter event
        const event = new Event('change');
        document.querySelector('#departmentFilterValue').dispatchEvent(event);
      }

      function selectKvpCategory(value, text) {
        document.querySelector('#kvpCategoryDisplay').querySelector('span').textContent = text;
        document.querySelector('#kvpCategoryValue').value = value;
        document.querySelector('#kvpCategoryDisplay').classList.remove('active');
        document.querySelector('#kvpCategoryDropdown').classList.remove('active');
      }

      function selectKvpPriority(value, text) {
        document.querySelector('#kvpPriorityDisplay').querySelector('span').textContent = text;
        document.querySelector('#kvpPriorityValue').value = value;
        document.querySelector('#kvpPriorityDisplay').classList.remove('active');
        document.querySelector('#kvpPriorityDropdown').classList.remove('active');
      }

      function showCreateModal() {
        const modal = document.querySelector('#createKvpModal');
        if (modal) {
          modal.classList.add('active');
        }
      }

      function hideCreateModal() {
        const modal = document.querySelector('#createKvpModal');
        if (modal) {
          modal.classList.remove('active');
          // Clear selected photos when closing modal
          selectedPhotos = [];
          window.selectedPhotos = selectedPhotos;
          const preview = document.querySelector('#photoPreview');
          if (preview) preview.innerHTML = ''; // Safe here because we control the content
        }
      }

      function handlePhotoSelection(input) {
        const files = Array.from(input.files);
        const validFiles = files.filter((file) => {
          const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
          return validTypes.includes(file.type) && file.size <= 10 * 1024 * 1024; // 10MB
        });

        if (selectedPhotos.length + validFiles.length > 5) {
          alert('Sie können maximal 5 Fotos hochladen.');
          return;
        }

        validFiles.forEach((file) => {
          selectedPhotos.push(file);
          window.selectedPhotos = selectedPhotos;
          displayPhotoPreview(file, selectedPhotos.length - 1);
        });

        // Reset input
        input.value = '';
      }

      function displayPhotoPreview(file, index) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const preview = document.querySelector('#photoPreview');
          const item = document.createElement('div');
          item.className = 'photo-preview-item';

          // Create elements safely without innerHTML
          const img = document.createElement('img');
          img.src = e.target.result;
          img.alt = 'Vorschau';

          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-photo';
          removeBtn.setAttribute('data-action', 'remove-photo');
          removeBtn.setAttribute('data-index', index.toString());
          removeBtn.type = 'button';
          removeBtn.textContent = '×';

          item.append(img);
          item.append(removeBtn);
          preview.append(item);
        };
        reader.readAsDataURL(file);
      }

      function removePhoto(index) {
        selectedPhotos.splice(index, 1);
        window.selectedPhotos = selectedPhotos;
        refreshPhotoPreview();
      }

      function refreshPhotoPreview() {
        const preview = document.querySelector('#photoPreview');
        preview.innerHTML = ''; // Safe - we're just clearing
        selectedPhotos.forEach((file, index) => {
          displayPhotoPreview(file, index);
        });
      }

      // Make functions globally available for TypeScript module
      window.showCreateModal = showCreateModal;
      window.hideCreateModal = hideCreateModal;
      window.selectKvpCategory = selectKvpCategory;
    </script>

    <!-- Scripts -->
    <script type="module" src="/scripts/auth/index.ts"></script>
    <script type="module" src="/scripts/utils/modal-manager.ts"></script>
    <script type="module" src="/scripts/pages/kvp.ts"></script>
    <script type="module" src="/scripts/components/unified-navigation.ts"></script>
    <script type="module" src="/scripts/auth/role-switch.ts"></script>

    <!-- Breadcrumb Component -->
    <script type="module">
      import { initBreadcrumb } from '/scripts/components/breadcrumb.js';
      // Breadcrumb wird automatisch generiert basierend auf der URL
      initBreadcrumb();
    </script>
  </body>
</html>
