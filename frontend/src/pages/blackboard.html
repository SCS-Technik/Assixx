<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blackboard - Assixx</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- Critical Layout State - Prevents Layout Shift -->
    <script>
      // Set sidebar state IMMEDIATELY to prevent any layout shift
      (function () {
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        document.documentElement.setAttribute('data-sidebar', sidebarCollapsed ? 'collapsed' : 'expanded');
        // Also set CSS custom properties for immediate use
        document.documentElement.style.setProperty('--sidebar-width', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--content-margin', sidebarCollapsed ? '60px' : '250px');
        document.documentElement.style.setProperty('--grid-columns', sidebarCollapsed ? '4' : '3');
        document.documentElement.style.setProperty('--widget-columns', sidebarCollapsed ? '5' : '3');
        document.documentElement.style.setProperty('--card-padding', sidebarCollapsed ? '2rem' : '1.5rem');
      })();
    </script>
    <script src="/feature-flags.js"></script>
    <link rel="stylesheet" href="/styles/dashboard-theme.css" />
    <link rel="stylesheet" href="/styles/blackboard.css" />
    <link rel="stylesheet" href="/styles/user-info-update.css" />
    <link rel="stylesheet" href="/styles/breadcrumb-alignment.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/styles/lib/fontawesome.min.css" />
  </head>
  <body class="blackboard-page" data-page="blackboard">
    <div class="auto-refresh-indicator">
      <i class="fas fa-sync-alt fa-spin"></i>
      Auto-Refresh: 30s
    </div>

    <!-- Unified Navigation -->
    <div id="navigation-container"></div>

    <!-- Main Layout mit Sidebar -->
    <div class="layout-container">
      <!-- Main Content -->
      <main class="main-content">
        <!-- Breadcrumb Navigation -->
        <div id="breadcrumb-container"></div>

        <div class="container">
          <!-- Filterleiste -->
          <div class="card mb-4">
            <div class="card-header u-cursor-pointer" id="filterToggle">
              <div class="filter-header-flex">
                <h3 class="card-title u-m-0">Filter & Suche</h3>
                <i class="fas fa-chevron-down chevron-icon" id="filterToggleIcon" data-expanded="false"></i>
              </div>
            </div>
            <div class="card-body collapsed" id="filterContent">
              <!-- Moderne Filter-Kontrollen -->
              <div class="modern-filters">
                <!-- Floating Search Bar -->
                <div class="floating-search">
                  <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path
                      d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0 .41-.41.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"
                    />
                  </svg>
                  <input type="text" id="searchInput" class="search-field" placeholder="Blackboard durchsuchen..." />
                  <button type="button" id="searchButton" class="search-trigger">Suchen</button>
                </div>

                <!-- Filter Pills -->
                <div class="filter-pills">
                  <div class="pill-group">
                    <span class="pill-label">Ebene:</span>
                    <button class="filter-pill active" data-value="all" id="filterAll">
                      <span>üåê</span>
                      Alle
                    </button>
                    <button class="filter-pill" data-value="company" id="filterCompany">
                      <span>üè¢</span>
                      Firma
                    </button>
                    <button class="filter-pill" data-value="department" id="filterDepartment">
                      <span>üèõÔ∏è</span>
                      Abteilung
                    </button>
                    <button class="filter-pill" data-value="team" id="filterTeam">
                      <span>üë•</span>
                      Team
                    </button>
                  </div>

                  <div class="pill-group">
                    <span class="pill-label">Sortieren:</span>
                    <select id="sortFilter" class="modern-select">
                      <option value="created_at|DESC">üïí Neueste</option>
                      <option value="created_at|ASC">‚è∞ √Ñlteste</option>
                      <option value="priority|DESC">‚ö° Priorit√§t</option>
                      <option value="title|ASC">üî§ A-Z</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Controls unter der Filterleiste -->
          <div class="flex flex-between mb-4">
            <div class="controls-flex">
              <div class="zoom-controls zoom-controls-inline">
                <button id="zoomInBtn" class="zoom-btn" title="Vergr√∂√üern">
                  <i class="fas fa-plus"></i>
                </button>
                <span id="zoomLevel" class="zoom-level">100%</span>
                <button id="zoomOutBtn" class="zoom-btn" title="Verkleinern">
                  <i class="fas fa-minus"></i>
                </button>
                <button id="fullscreenBtn" class="zoom-btn ml-2" title="Vollbild">
                  <i class="fas fa-expand"></i>
                </button>
              </div>
              <button id="newEntryBtn" class="btn btn-primary u-m-0">
                <i class="fas fa-plus me-2"></i>
                Neuer Eintrag
              </button>
              <button id="directAttachBtn" class="btn btn-primary u-m-0">
                <i class="fas fa-paperclip me-2"></i>
                Bild/PDF anheften
              </button>
            </div>
          </div>

          <!-- Pinnwand Container -->
          <div class="blackboard-container" id="blackboardContainer">
            <!-- Initial Load Button -->
            <div class="text-center p-5" id="loadEntriesCard">
              <h3 class="text-white mb-3">Willkommen am Schwarzen Brett</h3>
              <p class="text-white opacity-75 mb-4">Klicke auf den Button, um die Eintr√§ge zu laden</p>
              <button id="loadEntriesBtn" class="btn btn-primary btn-lg">
                <i class="fas fa-thumbtack me-2"></i>
                Eintr√§ge anheften
              </button>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="text-center p-5 d-none">
              <div class="loading-spinner"></div>
              <p class="mt-3 text-white">Eintr√§ge werden geladen...</p>
            </div>

            <!-- No Entries Message -->
            <div id="noEntriesMessage" class="text-center p-5 d-none">
              <div class="pinboard-item">
                <div class="pinboard-sticky color-yellow text-center">
                  <div class="pushpin pushpin-red"></div>
                  <i class="fas fa-clipboard mb-3 empty-icon"></i>
                  <h4 class="empty-title">Noch keine Eintr√§ge</h4>
                  <p class="empty-text">Das Schwarze Brett ist noch leer.</p>
                  <button id="retryLoadBtn" class="btn btn-sm btn-outline-dark mt-3">
                    <i class="fas fa-redo"></i>
                    Erneut versuchen
                  </button>
                </div>
              </div>
            </div>

            <!-- Pinboard Grid -->
            <div id="blackboardEntries" class="pinboard-grid d-none">
              <!-- Eintr√§ge werden dynamisch eingef√ºgt -->
            </div>
          </div>

          <!-- Pagination -->
          <div class="flex flex-center mt-4 gap-2 d-none" id="paginationContainer">
            <div class="pagination" id="pagination">
              <!-- Wird dynamisch gef√ºllt -->
            </div>
          </div>
        </div>
      </main>
    </div>
    <!-- Ende des layout-container -->

    <!-- Entry Detail Modal -->
    <div class="modal-overlay u-hidden" id="entryDetailModal">
      <div class="modal-container">
        <div class="modal-header">
          <h2 id="entryDetailModalLabel">Eintrag Details</h2>
          <button type="button" class="modal-close" data-action="close">&times;</button>
        </div>
        <div class="modal-body">
          <div id="entryDetailContent" class="fade-in">
            <!-- Wird dynamisch gef√ºllt -->
          </div>
        </div>
        <div class="modal-footer" id="entryDetailFooter">
          <button type="button" class="btn btn-secondary" data-action="close">Schlie√üen</button>
          <!-- Weitere Buttons werden dynamisch hinzugef√ºgt -->
        </div>
      </div>
    </div>

    <!-- Entry Form Modal -->
    <div class="modal u-hidden" id="entryFormModal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title" id="entryFormModalLabel">Neuer Eintrag</h3>
          <button type="button" class="modal-close" data-action="hide-modal" data-modal="entryFormModal">&times;</button>
        </div>
        <form id="entryForm">
          <input type="hidden" id="entryId" name="entry_id" />

          <!-- Titel und Inhalt -->
          <div class="form-group">
            <label for="entryTitle" class="form-label">Titel</label>
            <input type="text" class="form-control" id="entryTitle" name="title" required placeholder="Was ist das Thema?" />
          </div>

          <div class="form-group">
            <label for="entryContent" class="form-label">Inhalt</label>
            <textarea
              class="form-control"
              id="entryContent"
              name="content"
              rows="6"
              required
              placeholder="Ihre Nachricht hier..."
            ></textarea>
            <small class="form-hint">Tipp: Sie k√∂nnen **Fett**, *Kursiv* und Listen verwenden!</small>
          </div>

          <!-- Organisationseinheit -->
          <div class="form-group">
            <label for="entryOrgLevel" class="form-label">Wer soll den Eintrag sehen?</label>
            <select class="form-control" id="entryOrgLevel" name="org_level" required>
              <option value="" disabled selected>-- Bitte w√§hlen --</option>
              <option value="company">Alle Mitarbeiter</option>
              <option value="department">Bestimmte Abteilung</option>
              <option value="team">Bestimmtes Team</option>
            </select>
          </div>

          <div class="form-group u-hidden" id="orgIdContainer">
            <label for="entryOrgId" class="form-label">Welche Abteilung/Team?</label>
            <select class="form-control" id="entryOrgId" name="org_id">
              <option value="" disabled selected>-- Bitte erst oben ausw√§hlen --</option>
            </select>
          </div>

          <!-- Wichtigkeit und Datum -->
          <div class="form-group">
            <label for="entryPriority" class="form-label">Wie wichtig ist der Eintrag?</label>
            <select class="form-control" id="entryPriority" name="priority_level">
              <option value="low">Niedrig</option>
              <option value="medium" selected>Normal</option>
              <option value="high">Hoch</option>
              <option value="critical">Dringend</option>
            </select>
          </div>

          <div class="form-group">
            <label for="entryExpiresAt" class="form-label">G√ºltig bis (optional)</label>
            <input type="date" class="form-control" id="entryExpiresAt" name="expires_at" />
          </div>

          <!-- Farbe ausw√§hlen -->
          <div class="form-group">
            <label class="form-label">Farbe des Eintrags</label>
            <div class="color-picker">
              <button type="button" class="color-option active" data-color="yellow">
                <span>üíõ</span>
                Gelb
              </button>
              <button type="button" class="color-option" data-color="pink">
                <span>üíó</span>
                Pink
              </button>
              <button type="button" class="color-option" data-color="blue">
                <span>üíô</span>
                Blau
              </button>
              <button type="button" class="color-option" data-color="green">
                <span>üíö</span>
                Gr√ºn
              </button>
              <button type="button" class="color-option" data-color="orange">
                <span>üß°</span>
                Orange
              </button>
            </div>
          </div>

          <!-- Tags hinzuf√ºgen -->
          <div class="form-group">
            <label for="entryTags" class="form-label">Tags (mit Komma trennen)</label>
            <input type="text" class="form-control" id="entryTags" name="tags" placeholder="Wichtig, Meeting, Update..." />
            <div class="form-hint">Beispiele: Wichtig, Meeting, Wartung, Sicherheit</div>
          </div>

          <!-- Checkbox f√ºr Best√§tigung -->
          <div class="form-group">
            <div class="simple-checkbox">
              <input type="checkbox" id="entryRequiresConfirmation" name="requires_confirmation" />
              <label for="entryRequiresConfirmation">Mitarbeiter m√ºssen best√§tigen, dass sie diesen Eintrag gelesen haben</label>
            </div>
          </div>

          <!-- Anh√§nge hinzuf√ºgen -->
          <div class="form-group">
            <label class="form-label">Anh√§nge (optional)</label>
            <div class="attachment-upload-zone" id="attachmentDropZone">
              <div class="upload-icon">
                <i class="fas fa-cloud-upload-alt"></i>
              </div>
              <p class="upload-text">Dateien hierher ziehen oder klicken zum Ausw√§hlen</p>
              <p class="upload-hint">Max. 5 Dateien, je 10MB (PDF, JPG, PNG, GIF)</p>
              <input type="file" id="attachmentInput" multiple accept=".pdf,.jpg,.jpeg,.png,.gif" class="u-hidden" />
            </div>

            <!-- Anhang-Vorschau -->
            <div id="attachmentPreview" class="attachment-preview u-hidden">
              <h4 class="preview-title">Ausgew√§hlte Dateien:</h4>
              <div id="attachmentList" class="attachment-list"></div>
            </div>
          </div>
        </form>
        <div class="button-group">
          <button type="submit" class="btn btn-primary" id="saveEntryBtn">Speichern</button>
          <button type="button" class="btn btn-secondary" data-action="hide-modal" data-modal="entryFormModal">Abbrechen</button>
        </div>
      </div>
    </div>

    <!-- Direct Attachment Modal -->
    <div class="modal u-hidden" id="directAttachModal">
      <div class="modal-content modal-content-medium">
        <div class="modal-header">
          <h3 class="modal-title">Bild/PDF direkt anheften</h3>
          <button type="button" class="modal-close" data-action="hide-modal" data-modal="directAttachModal">&times;</button>
        </div>
        <form id="directAttachForm">
          <div class="modal-body">
            <!-- File Upload Area -->
            <div class="form-group">
              <label class="form-label">Datei ausw√§hlen</label>
              <div id="directAttachDropZone" class="attachment-dropzone text-center p-4" class="attachment-dropzone text-center p-4">
                <i class="fas fa-cloud-upload-alt dropzone-icon"></i>
                <p class="mb-2">Datei hier ablegen oder klicken zum Ausw√§hlen</p>
                <p class="text-secondary mb-0 file-size-hint">Unterst√ºtzt: JPG, PNG, PDF (max. 10 MB)</p>
                <input type="file" id="directAttachInput" accept="image/jpeg,image/jpg,image/png,application/pdf" class="u-hidden" />
              </div>
            </div>

            <!-- File Preview -->
            <div id="directAttachPreview" class="form-group d-none">
              <label class="form-label">Vorschau</label>
              <div
                class="attachment-preview d-flex align-items-center gap-3 p-3"
                class="attachment-preview d-flex align-items-center gap-3 p-3 attachment-preview-box"
              >
                <div id="previewImage" class="preview-image-container"></div>
                <div class="flex-grow-1">
                  <div id="previewFileName" class="fw-bold"></div>
                  <div id="previewFileSize" class="text-secondary"></div>
                </div>
                <button type="button" class="btn btn-sm btn-danger" data-action="clear-attachment">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>

            <!-- Title -->
            <div class="form-group">
              <label for="directAttachTitle" class="form-label">Titel (optional)</label>
              <input type="text" class="form-control" id="directAttachTitle" placeholder="z.B. Urlaubsplan 2025" />
            </div>

            <!-- Organization Level -->
            <div class="form-group">
              <label for="directAttachOrgLevel" class="form-label">Sichtbarkeit</label>
              <select class="form-control" id="directAttachOrgLevel">
                <option value="company">Gesamte Firma</option>
                <option value="department">Nur meine Abteilung</option>
                <option value="team">Nur mein Team</option>
              </select>
            </div>

            <!-- Priority -->
            <div class="form-group">
              <label for="directAttachPriority" class="form-label">Priorit√§t</label>
              <select class="form-control" id="directAttachPriority">
                <option value="low">Niedrig</option>
                <option value="normal" selected>Normal</option>
                <option value="high">Hoch</option>
              </select>
            </div>

            <!-- Size Selection -->
            <div class="form-group">
              <label class="form-label">Anzeigegr√∂√üe</label>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary size-option" data-size="small">
                  <i class="fas fa-compress"></i>
                  Klein
                </button>
                <button type="button" class="btn btn-outline-secondary size-option active" data-size="medium">
                  <i class="fas fa-expand-arrows-alt"></i>
                  Mittel
                </button>
                <button type="button" class="btn btn-outline-secondary size-option" data-size="large">
                  <i class="fas fa-expand"></i>
                  Gro√ü
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-action="hide-modal" data-modal="directAttachModal">Abbrechen</button>
            <button type="button" class="btn btn-primary" id="saveDirectAttachBtn">
              <i class="fas fa-thumbtack"></i>
              Anheften
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay u-hidden" id="confirmationModal">
      <div class="modal-container modal-sm">
        <div class="modal-header">
          <h2 id="confirmationModalLabel">Best√§tigung</h2>
          <button type="button" class="modal-close" data-action="close">&times;</button>
        </div>
        <div class="modal-body">
          <p id="confirmationMessage" class="mb-0">M√∂chten Sie diesen Eintrag wirklich l√∂schen?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-action="close">Abbrechen</button>
          <button type="button" class="btn btn-danger" id="confirmActionBtn">L√∂schen</button>
        </div>
      </div>
    </div>

    <!-- Confirmation Status Modal -->
    <!-- TODO: Feature nicht implementiert - Nur UI vorhanden!
         Ben√∂tigt:
         - Button zum √ñffnen des Modals in Entry-Karten
         - JavaScript Funktion viewConfirmationStatus()
         - Backend Endpoint GET /api/v2/blackboard/:id/confirmations
         - Database Tabelle blackboard_confirmations (user_id, entry_id, read_at)
         - Integration in Entry Detail Modal oder als Icon in Karten-Header
    -->
    <div class="modal-overlay u-hidden" id="confirmationStatusModal">
      <div class="modal-container modal-lg">
        <div class="modal-header">
          <h2 id="confirmationStatusModalLabel">Lesebest√§tigungen</h2>
          <button type="button" class="modal-close" data-action="close">&times;</button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <div class="progress-bar-container">
              <div class="progress-bar-fill" id="confirmationProgress" style="width: 0%">0%</div>
            </div>
          </div>

          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Mitarbeiter</th>
                  <th>E-Mail</th>
                  <th>Status</th>
                  <th>Zeitpunkt</th>
                </tr>
              </thead>
              <tbody id="confirmationStatusList">
                <!-- Wird dynamisch gef√ºllt -->
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-action="close">Schlie√üen</button>
        </div>
      </div>
    </div>

    <!-- Marked.js for Markdown rendering -->
    <script type="module" src="/scripts/lib/marked.min.js"></script>
    <!-- Modal Functions gem√§√ü Design Standards -->
    <script>
      // Zoom Functionality
      let currentZoom = 100; // Start at 100%
      const zoomStep = 10; // 10% increments
      const maxZoom = 120;
      const minZoom = 10;

      function updateZoom(newZoom) {
        // Clamp zoom between min and max
        currentZoom = Math.max(minZoom, Math.min(maxZoom, newZoom));

        // Update display
        document.querySelector('#zoomLevel').textContent = currentZoom + '%';

        // Apply CSS zoom property instead of transform
        const container = document.querySelector('#blackboardContainer');
        container.style.zoom = currentZoom + '%';

        // Store in localStorage
        localStorage.setItem('blackboard-zoom', currentZoom.toString());
      }

      // Filter Toggle Functionality
      document.addEventListener('DOMContentLoaded', function () {
        // Initialize zoom from localStorage
        const savedZoom = localStorage.getItem('blackboard-zoom');
        if (savedZoom) {
          updateZoom(parseInt(savedZoom));
        }

        // Zoom button event listeners
        document.querySelector('#zoomInBtn').addEventListener('click', function () {
          updateZoom(currentZoom + zoomStep);
        });

        document.querySelector('#zoomOutBtn').addEventListener('click', function () {
          updateZoom(currentZoom - zoomStep);
        });

        // Keyboard shortcuts for zoom
        document.addEventListener('keydown', function (e) {
          if (e.ctrlKey || e.metaKey) {
            if (e.key === '+' || e.key === '=') {
              e.preventDefault();
              updateZoom(currentZoom + zoomStep);
            } else if (e.key === '-') {
              e.preventDefault();
              updateZoom(currentZoom - zoomStep);
            } else if (e.key === '0') {
              e.preventDefault();
              updateZoom(100); // Reset to 100%
            }
          }
        });

        const filterToggle = document.querySelector('#filterToggle');
        const filterContent = document.querySelector('#filterContent');
        const filterToggleIcon = document.querySelector('#filterToggleIcon');

        filterToggle.addEventListener('click', function () {
          if (filterContent.style.display === 'none' || filterContent.style.display === '') {
            filterContent.style.display = 'block';
            filterToggleIcon.style.transform = 'rotate(180deg)';
          } else {
            filterContent.style.display = 'none';
            filterToggleIcon.style.transform = 'rotate(0deg)';
          }
        });
      });

      // Modal Functions
      function showModal(modalId) {
        const modal = document.querySelector(modalId);
        if (modal) {
          modal.style.display = 'flex';
          setTimeout(() => {
            modal.classList.add('active');
          }, 10);
        }
      }

      function hideModal(modalId) {
        const modal = document.querySelector(modalId);
        if (modal) {
          modal.classList.remove('active');
          setTimeout(() => {
            modal.style.display = 'none';
          }, 300);
        }
      }

      // Event Delegation for modal actions
      document.addEventListener('click', function (e) {
        const target = e.target;

        // Handle hide modal
        const hideModalBtn = target.closest('[data-action="hide-modal"]');
        if (hideModalBtn) {
          const modalId = hideModalBtn.dataset.modal;
          hideModal('#' + modalId);
          return;
        }

        // Handle clear attachment
        const clearBtn = target.closest('[data-action="clear-attachment"]');
        if (clearBtn) {
          if (window.clearDirectAttachment) {
            window.clearDirectAttachment();
          }
          return;
        }
      });

      // Definiere DashboardUI direkt hier, um Abh√§ngigkeiten zu vermeiden
      window.DashboardUI = {
        openModal: showModal,
        closeModal: hideModal,
        showToast: function (message, type) {
          // Einfache Toast-Implementierung
          const toast = document.createElement('div');
          toast.className = 'toast-' + (type || 'info');
          toast.textContent = message;

          // Toast-Container erstellen
          let container = document.querySelector('.toast-container');
          if (!container) {
            container = document.createElement('div');
            container.className = 'toast-container';
            document.body.append(container);
          }

          container.append(toast);

          // Nach 3 Sekunden ausblenden
          setTimeout(function () {
            toast.remove();
          }, 3000);
        },
        formatDate: function (date) {
          if (!date) return '-';
          const d = new Date(date);
          return d.toLocaleDateString('de-DE');
        },
      };
    </script>
    <!-- Scripts with dynamic loading to prevent race condition -->
    <script type="module">
      // Wait for DOM to be ready before loading scripts
      document.addEventListener('DOMContentLoaded', async () => {
        // First load auth module
        await import('/scripts/auth.ts');
        // Then load unified navigation
        await import('/scripts/components/unified-navigation.ts');
        // Load role switch
        await import('/scripts/role-switch.ts');
        // Load breadcrumb
        const { initBreadcrumb } = await import('/scripts/components/breadcrumb.js');
        initBreadcrumb();
        // Finally load blackboard after a small delay
        setTimeout(() => {
          import('/scripts/blackboard.ts');
        }, 100);
      });
    </script>
    <!-- Update Modal to Design Standards -->
    <script src="/scripts/update-blackboard-modal.js" type="module"></script>
  </body>
</html>
