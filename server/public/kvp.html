<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KVP System - Assixx</title>
  <!-- Dashboard Theme CSS -->
  <link rel="stylesheet" href="/css/dashboard-theme.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="/css/lib/fontawesome.min.css">
  <!-- KVP spezifische Styles -->
  <style>
    /* Glassmorphismus Design-Standards */
    
    /* Dramatischer Hintergrund-Gradient */
    body {
        position: relative;
        min-height: 100vh;
        overflow-x: hidden;
        background: #000;
    }
    
    body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, transparent 0%, rgba(0, 142, 255, 0.08) 25%, #01000482 60%, rgba(0, 0, 4, 0.6) 90%, black 100%);
        pointer-events: none;
        z-index: -1;
    }
    
    /* Glassmorphismus für Header */
    .header {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(20px) saturate(180%);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    /* Glassmorphismus für Sidebar */
    .sidebar {
        background: rgba(255, 255, 255, 0.02);
        backdrop-filter: blur(20px) saturate(180%);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 8px 0 32px rgba(0, 0, 0, 0.3),
                    inset -1px 0 0 rgba(255, 255, 255, 0.1);
    }
    
    /* KVP-spezifische Erweiterungen des Dashboard-Themes */
    .kvp-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: var(--spacing-lg);
      margin-top: var(--spacing-lg);
    }

    .kvp-card {
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      transition: all 0.3s ease;
      animation: fadeInUp 0.6s ease-out;
    }

    .kvp-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5),
                  inset 0 1px 0 rgba(255, 255, 255, 0.15);
      border-color: rgba(0, 142, 255, 0.5);
      background: rgba(255, 255, 255, 0.03);
    }

    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: var(--spacing-md);
      color: var(--text-primary);
    }

    .card-icon {
      font-size: 1.5rem;
      margin-right: var(--spacing-md);
      color: var(--primary-color);
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: var(--spacing-md);
      margin-top: var(--spacing-md);
    }

    .stat-item {
      text-align: center;
      background: var(--background-dark);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      border: 1px solid var(--border-color);
    }

    .stat-number {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary-color);
      display: block;
    }

    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: var(--spacing-xs);
    }

    .suggestions-list {
      max-height: 400px;
      overflow-y: auto;
      margin-top: var(--spacing-md);
    }

    .suggestion-item {
      background: var(--background-dark);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .suggestion-item:hover {
      background: rgba(33, 150, 243, 0.1);
      border-color: var(--primary-color);
      transform: translateX(4px);
    }

    .suggestion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
    }

    .suggestion-title {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 1rem;
    }

    .status-badge {
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      transition: all 0.2s ease;
      display: inline-block;
    }
    
    .status-badge:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* Status Colors */
    .status-new { 
      background: linear-gradient(135deg, #2196F3, #1976D2); 
      color: white; 
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
    }
    
    .status-pending { 
      background: linear-gradient(135deg, #9C27B0, #7B1FA2); 
      color: white; 
      box-shadow: 0 2px 8px rgba(156, 39, 176, 0.3);
    }
    
    .status-in_review { 
      background: linear-gradient(135deg, #FF9800, #F57C00); 
      color: white; 
      box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
    }
    
    .status-approved { 
      background: linear-gradient(135deg, #4CAF50, #388E3C); 
      color: white; 
      box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
    }
    
    .status-implemented { 
      background: linear-gradient(135deg, #00C853, #00A345); 
      color: white; 
      box-shadow: 0 2px 8px rgba(0, 200, 83, 0.3);
    }
    
    .status-rejected { 
      background: linear-gradient(135deg, #F44336, #D32F2F); 
      color: white; 
      box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
    }
    
    .status-archived { 
      background: linear-gradient(135deg, #607D8B, #455A64); 
      color: white; 
      box-shadow: 0 2px 8px rgba(96, 125, 139, 0.3);
    }

    .suggestion-description {
      color: var(--text-secondary);
      margin: var(--spacing-sm) 0;
      line-height: 1.4;
    }

    .suggestion-meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    .filter-bar {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
    }

    .filter-select {
      background: var(--background-dark);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .filter-select option {
      background: var(--background-dark);
      color: var(--text-primary);
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(10px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-md);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      animation: fadeInUp 0.3s ease-out;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--border-color);
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--primary-color);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.1);
    }

    .modal-form-content {
      padding: var(--spacing-lg);
      overflow-y: auto;
      flex: 1;
      margin-top: 0;
    }

    .modal-form-actions {
      padding: var(--spacing-lg);
      border-top: 1px solid var(--border-color);
      background: rgba(255, 255, 255, 0.02);
      flex-shrink: 0;
    }

    .form-group {
      margin-bottom: var(--spacing-lg);
    }

    .form-label {
      display: block;
      margin-bottom: var(--spacing-sm);
      font-weight: 500;
      color: var(--text-primary);
    }

    .form-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.04);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: var(--radius-sm);
      padding: var(--spacing-md);
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-input:focus {
      outline: none;
      background: rgba(255, 255, 255, 0.08);
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.15),
                  inset 0 1px 2px rgba(0, 0, 0, 0.1);
      box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
    }

    .form-input::placeholder {
      color: var(--text-secondary);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .file-upload {
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      background: var(--background-dark);
    }

    .file-upload:hover {
      border-color: var(--primary-color);
      background: rgba(33, 150, 243, 0.05);
    }

    .category-pills {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
    }

    .category-pill {
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      background: var(--background-dark);
      color: var(--text-primary);
    }

    .category-pill:hover {
      border-color: var(--primary-color);
      background: rgba(33, 150, 243, 0.1);
    }

    .category-pill.selected {
      border-color: var(--primary-color);
      background: var(--primary-color);
      color: white;
    }

    .loading {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--text-secondary);
    }

    .error-message {
      background: rgba(244, 67, 54, 0.1);
      border: 1px solid var(--error-color);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin: var(--spacing-md) 0;
      color: var(--error-color);
    }

    .success-message {
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid var(--success-color);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin: var(--spacing-md) 0;
      color: var(--success-color);
    }

    #selectedFiles {
      margin-top: var(--spacing-sm);
    }

    .selected-file {
      background: var(--background-dark);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-sm);
      margin: var(--spacing-xs) 0;
      font-size: 0.9rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .form-actions {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-xl);
      justify-content: flex-end;
    }

    .empty-state {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--text-secondary);
    }

    .main-content {
      padding: var(--spacing-lg);
    }

    .page-header {
      margin-bottom: var(--spacing-xl);
    }

    .page-title {
      font-size: 2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    .page-subtitle {
      color: var(--text-secondary);
      margin-top: var(--spacing-sm);
      font-size: 1.1rem;
    }

    /* Modal Styles */
    .suggestion-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }

    .modal-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .modal-content {
      position: relative;
      background: var(--background-light);
      border-radius: var(--radius-lg);
      max-width: 800px;
      max-height: 90vh;
      width: 90%;
      overflow: hidden;
      box-shadow: var(--shadow-xl);
      animation: slideUp 0.3s ease;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--border-color);
      background: var(--background-lighter);
    }

    .modal-header h2 {
      margin: 0;
      color: var(--text-primary);
      font-size: 1.5rem;
    }


    .modal-close:hover {
      background: var(--background-hover);
      color: var(--text-primary);
    }

    .modal-body {
      padding: var(--spacing-lg);
      max-height: calc(90vh - 100px);
      overflow-y: auto;
    }

    .suggestion-detail-content {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .suggestion-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--background-lighter);
      border-radius: var(--radius-md);
    }

    .info-row {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
    }

    .suggestion-description-full h3,
    .suggestion-benefit h3,
    .suggestion-cost h3,
    .suggestion-attachments h3,
    .suggestion-comments h3 {
      color: var(--text-primary);
      margin: 0 0 var(--spacing-md) 0;
      font-size: 1.2rem;
    }

    .suggestion-description-full p,
    .suggestion-benefit p,
    .suggestion-cost p {
      color: var(--text-secondary);
      line-height: 1.6;
      margin: 0;
    }

    .attachments-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
    }

    .attachment-item {
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      overflow: hidden;
      background: var(--background-lighter);
      transition: all 0.2s ease;
    }

    .attachment-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .attachment-image {
      width: 100%;
      height: 150px;
      object-fit: contain;
      cursor: pointer;
    }

    .attachment-file {
      display: flex;
      align-items: center;
      padding: var(--spacing-lg);
      gap: var(--spacing-md);
    }

    .file-icon {
      font-size: 2rem;
    }

    .file-name {
      color: var(--text-primary);
      font-weight: 500;
    }

    .attachment-info {
      padding: var(--spacing-md);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .attachment-info small {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .download-btn {
      background: var(--primary-color);
      color: white;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      text-decoration: none;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .download-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .comments-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .comment-item {
      background: var(--background-lighter);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--primary-color);
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-sm);
    }

    .comment-header strong {
      color: var(--text-primary);
    }

    .comment-header small {
      color: var(--text-secondary);
    }

    .comment-content {
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .priority-badge {
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      font-size: 0.8rem;
      font-weight: 500;
    }

    .priority-niedrig {
      background: rgba(34, 197, 94, 0.1);
      color: rgb(34, 197, 94);
    }

    .priority-normal {
      background: rgba(59, 130, 246, 0.1);
      color: rgb(59, 130, 246);
    }

    .priority-hoch {
      background: rgba(245, 158, 11, 0.1);
      color: rgb(245, 158, 11);
    }

    .priority-kritisch {
      background: rgba(239, 68, 68, 0.1);
      color: rgb(239, 68, 68);
    }

    /* Action Buttons */
    .suggestion-actions {
      display: flex;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--background-lighter);
      border-radius: var(--radius-md);
      border-left: 3px solid var(--primary-color);
    }

    .action-btn {
      padding: var(--spacing-sm) var(--spacing-md);
      border: none;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .delete-btn {
      background: rgba(239, 68, 68, 0.1);
      color: rgb(239, 68, 68);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .delete-btn:hover {
      background: rgba(239, 68, 68, 0.2);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .archive-btn {
      background: rgba(156, 163, 175, 0.1);
      color: rgb(75, 85, 99);
      border: 1px solid rgba(156, 163, 175, 0.2);
    }

    .archive-btn:hover {
      background: rgba(156, 163, 175, 0.2);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(156, 163, 175, 0.3);
    }

    /* Image Loading and Preview */
    .attachment-image-container {
      width: 100%;
      height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--background-lighter);
      border-radius: var(--radius-sm);
    }

    .attachment-image-loader {
      color: var(--text-secondary);
      font-size: 0.9rem;
      text-align: center;
    }

    .attachment-error {
      color: rgb(239, 68, 68);
      font-size: 0.9rem;
      text-align: center;
      padding: var(--spacing-md);
    }

    /* Full-size Image Modal */
    .image-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }

    .image-modal-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
    }

    .image-modal-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .image-modal-close {
      position: absolute;
      top: -40px;
      right: 0;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      padding: var(--spacing-sm);
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .image-modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .full-size-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xl);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to { 
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .modal {
        padding: var(--spacing-sm);
      }
      
      .modal-content {
        width: 100%;
        max-height: calc(100vh - 2rem);
      }
      
      .modal-header,
      .modal-form-content,
      .modal-form-actions {
        padding: var(--spacing-md);
      }
      
      .suggestion-info {
        grid-template-columns: 1fr;
      }
      
      .attachments-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
    <link rel="stylesheet" href="/css/user-info-update.css">
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="/admin-dashboard.html" class="logo-container">
      <img src="/images/logo.png" alt="Assixx Logo" class="logo">
    </a>
    <div class="header-actions">
      <div id="user-info">
                <img id="user-avatar" src="/images/default-avatar.svg" alt="Avatar">
                <span id="user-name">Lade...</span>
            </div>
      <button id="logout-btn" class="btn-logout" class="btn btn-secondary"><i class="fas fa-sign-out-alt"></i> Abmelden</button>
    </div>
  </header>

  <!-- Main Layout mit Sidebar -->
  <div class="layout-container">
    <!-- Unified Sidebar Navigation -->
    <aside class="sidebar">
      <!-- Navigation wird durch unified-navigation.js injiziert -->
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="page-header">
        <h1 class="page-title">
          KVP System
        </h1>
        <p class="page-subtitle">Kontinuierlicher Verbesserungsprozess - Gemeinsam besser werden</p>
      </div>

      <!-- Main Grid -->
      <div class="kvp-grid">
        <!-- New Suggestion Card (nur für Employees) -->
        <div class="kvp-card" id="newSuggestionCard">
          <div class="card-header">
            <div class="card-icon">📝</div>
            <h2 class="card-title">Neuen Vorschlag einreichen</h2>
          </div>
          <p class="text-secondary">Haben Sie eine Idee zur Verbesserung? Teilen Sie Ihren Vorschlag mit Fotos und erhalten Sie Feedback!</p>
          <div style="margin-top: var(--spacing-lg);">
            <button class="btn btn-primary" id="newSuggestionBtn">
              <i class="fas fa-plus"></i> Vorschlag einreichen
            </button>
          </div>
        </div>
        
        <!-- Admin Status Management Card (nur für Admins) -->
        <div class="kvp-card" id="adminManagementCard" style="display: none;">
          <div class="card-header">
            <div class="card-icon">⚙️</div>
            <h2 class="card-title">Vorschläge verwalten</h2>
          </div>
          <p class="text-secondary">Als Administrator können Sie den Status von Verbesserungsvorschlägen ändern und Kommentare hinzufügen.</p>
          <div style="margin-top: var(--spacing-lg);">
            <div class="stats-grid">
              <div class="stat-item">
                <span class="stat-number" id="adminNewSuggestions">-</span>
                <span class="stat-label">Neue Vorschläge</span>
              </div>
              <div class="stat-item">
                <span class="stat-number" id="adminPendingSuggestions">-</span>
                <span class="stat-label">In Bearbeitung</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Statistics Card -->
        <div class="kvp-card">
          <div class="card-header">
            <div class="card-icon">📊</div>
            <h2 class="card-title">Statistiken</h2>
          </div>
          <div class="stats-grid" id="statsGrid">
            <div class="stat-item">
              <span class="stat-number" id="totalSuggestions">-</span>
              <span class="stat-label">Gesamt</span>
            </div>
            <div class="stat-item">
              <span class="stat-number" id="newSuggestions">-</span>
              <span class="stat-label">Neu</span>
            </div>
            <div class="stat-item">
              <span class="stat-number" id="implementedSuggestions">-</span>
              <span class="stat-label">Umgesetzt</span>
            </div>
            <div class="stat-item">
              <span class="stat-number" id="inProgressSuggestions">-</span>
              <span class="stat-label">In Arbeit</span>
            </div>
          </div>
        </div>

        <!-- My Suggestions Card -->
        <div class="kvp-card">
          <div class="card-header">
            <div class="card-icon">💼</div>
            <h2 class="card-title">Meine Vorschläge</h2>
          </div>
          
          <!-- Filter Bar -->
          <div class="filter-bar">
            <select class="filter-select" id="statusFilter">
              <option value="">Alle Status</option>
              <option value="new">Neu</option>
              <option value="in_review">In Prüfung</option>
              <option value="in_progress">In Arbeit</option>
              <option value="implemented">Umgesetzt</option>
              <option value="rejected">Abgelehnt</option>
            </select>
            
            <select class="filter-select" id="categoryFilter">
              <option value="">Alle Kategorien</option>
            </select>
          </div>

          <div class="suggestions-list" id="suggestionsList">
            <div class="loading">Lade Vorschläge...</div>
          </div>
        </div>

        <!-- My Points Card -->
        <div class="kvp-card">
          <div class="card-header">
            <div class="card-icon">🏆</div>
            <h2 class="card-title">Meine Punkte</h2>
          </div>
          <div class="stats-grid" id="pointsGrid">
            <div class="stat-item">
              <span class="stat-number" id="totalPoints">-</span>
              <span class="stat-label">Gesamt Punkte</span>
            </div>
            <div class="stat-item">
              <span class="stat-number" id="totalAwards">-</span>
              <span class="stat-label">Auszeichnungen</span>
            </div>
          </div>
          <p style="margin-top: var(--spacing-md); font-size: 0.9rem;" class="text-secondary">
            Sammeln Sie Punkte für eingereichte und umgesetzte Verbesserungsvorschläge!
          </p>
        </div>
      </div>
    </main>
  </div>

  <!-- New Suggestion Modal -->
  <div class="modal" id="newSuggestionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Neuen Verbesserungsvorschlag einreichen</h3>
        <button class="modal-close" onclick="document.getElementById('newSuggestionModal').style.display='none'">&times;</button>
      </div>
      
      <div class="modal-form-content">
        <form id="newSuggestionForm" enctype="multipart/form-data">
        <div class="form-group">
          <label class="form-label">Titel *</label>
          <input type="text" class="form-input" name="title" placeholder="Kurzer, aussagekräftiger Titel" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">Beschreibung *</label>
          <textarea class="form-input form-textarea" name="description" placeholder="Detaillierte Beschreibung des Problems und Ihres Lösungsvorschlags" required></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Kategorie</label>
          <div class="category-pills" id="categoryPills">
            <!-- Categories will be loaded here -->
          </div>
          <input type="hidden" name="category_id" id="selectedCategoryId">
        </div>
        
        <div class="form-group">
          <label class="form-label">Organisationsebene *</label>
          <select class="form-input" name="org_level" required>
            <option value="">Bitte wählen</option>
            <option value="company">Gesamtes Unternehmen</option>
            <option value="department">Abteilung</option>
            <option value="team">Team</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Priorität</label>
          <select class="form-input" name="priority">
            <option value="normal">Normal</option>
            <option value="low">Niedrig</option>
            <option value="high">Hoch</option>
            <option value="urgent">Dringend</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">Erwarteter Nutzen</label>
          <textarea class="form-input" name="expected_benefit" placeholder="Welchen Nutzen erwarten Sie von der Umsetzung?"></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Geschätzte Kosten (€)</label>
          <input type="number" class="form-input" name="estimated_cost" step="0.01" placeholder="0.00">
        </div>
        
        <div class="form-group">
          <label class="form-label">Fotos/Dokumente</label>
          <div class="file-upload" id="fileUploadArea">
            <div>📁 Klicken zum Dateien auswählen</div>
            <div style="font-size: 0.8rem; margin-top: var(--spacing-xs); opacity: 0.8;">
              Max. 5 Dateien, je 10MB (JPG, PNG, GIF, PDF)
            </div>
          </div>
          <input type="file" id="attachments" name="attachments" multiple accept=".jpg,.jpeg,.png,.gif,.pdf" style="display: none;">
          <div id="selectedFiles"></div>
        </div>
        </form>
      </div>
      
      <div class="modal-form-actions">
        <div class="form-actions">
          <button type="submit" class="btn btn-primary" form="newSuggestionForm">Vorschlag einreichen</button>
          <button type="button" class="btn btn-secondary" id="cancelBtn">Abbrechen</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let categories = [];
    let selectedCategoryId = null;
    let currentUser = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      checkAuth();
            loadUserInfo();
      loadCategories();
      loadSuggestions();
      loadDashboardStats();
      loadUserPoints();
      
      // Initialize logout button
      document.getElementById('logout-btn').addEventListener('click', function() {
        localStorage.removeItem('token');
        window.location.href = '/login.html';
      });
      
      // Initialize KVP buttons based on user role
      initializeButtons();
    });

    
        async function loadUserInfo() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/user/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    const userName = document.getElementById('user-name');
                    const userAvatar = document.getElementById('user-avatar');
                    
                    // Display first and last name
                    const displayName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim() || userData.username || 'Benutzer';
                    userName.textContent = displayName;
                    
                    // Update avatar if available
                    if (userData.profile_picture_url) {
                        userAvatar.src = userData.profile_picture_url;
                        userAvatar.onerror = function() {
                            this.src = '/images/default-avatar.svg';
                        };
                    }
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                // Fallback to local storage
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                const userName = document.getElementById('user-name');
                if (userName) {
                    userName.textContent = user.username || 'Benutzer';
                }
            }
        }


    function checkAuth() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }
      
      // Decode JWT to get user info (simple decode, not verification)
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        currentUser = payload;
        document.getElementById('user-info').textContent = payload.username || 'User';
      } catch(e) {
        localStorage.removeItem('token');
        window.location.href = '/login.html';
      }
    }

    function initializeButtons() {
      // Show/hide cards based on user role
      const newSuggestionCard = document.getElementById('newSuggestionCard');
      const adminManagementCard = document.getElementById('adminManagementCard');
      
      if (currentUser && currentUser.role === 'employee') {
        // Employee: Show suggestion card, hide admin card
        newSuggestionCard.style.display = 'block';
        adminManagementCard.style.display = 'none';
        
        // Initialize new suggestion button
        document.getElementById('newSuggestionBtn').addEventListener('click', openNewSuggestionModal);
      } else if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'root')) {
        // Admin: Hide suggestion card, show admin card
        newSuggestionCard.style.display = 'none';
        adminManagementCard.style.display = 'block';
        
        // Load admin statistics
        loadAdminStats();
      }
      
      // Initialize filter event listeners
      document.getElementById('statusFilter').addEventListener('change', loadSuggestions);
      document.getElementById('categoryFilter').addEventListener('change', loadSuggestions);
      
      // Initialize file upload area
      document.getElementById('fileUploadArea').addEventListener('click', function() {
        document.getElementById('attachments').click();
      });
      
      // Initialize cancel button
      document.getElementById('cancelBtn').addEventListener('click', closeNewSuggestionModal);
    }

    async function loadAdminStats() {
      try {
        const response = await apiCall('/api/kvp/dashboard');
        const data = await response.json();
        
        if (data.success) {
          const stats = data.data;
          document.getElementById('adminNewSuggestions').textContent = stats.new_suggestions || 0;
          document.getElementById('adminPendingSuggestions').textContent = (stats.in_review || 0) + (stats.in_progress || 0);
        }
      } catch (error) {
        console.error('Error loading admin stats:', error);
      }
    }

    async function apiCall(url, options = {}) {
      const token = localStorage.getItem('token');
      const defaultOptions = {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      };
      
      // Don't set Content-Type for FormData
      if (options.body instanceof FormData) {
        delete defaultOptions.headers['Content-Type'];
      }
      
      const response = await fetch(url, { ...defaultOptions, ...options });
      
      if (response.status === 401) {
        localStorage.removeItem('token');
        window.location.href = '/login.html';
        return;
      }
      
      return response;
    }

    async function loadCategories() {
      try {
        const response = await apiCall('/api/kvp/categories');
        const data = await response.json();
        
        if (data.success) {
          categories = data.data;
          renderCategoryPills();
          renderCategoryFilter();
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }

    function renderCategoryPills() {
      const container = document.getElementById('categoryPills');
      container.innerHTML = categories.map(cat => `
        <div class="category-pill" data-category-id="${cat.id}" style="border-color: ${cat.color}40;">
          <span>${cat.icon}</span>
          <span>${cat.name}</span>
        </div>
      `).join('');
      
      // Add event listeners to category pills
      container.querySelectorAll('.category-pill').forEach(pill => {
        pill.addEventListener('click', function() {
          selectCategory(parseInt(this.dataset.categoryId));
        });
      });
    }

    function renderCategoryFilter() {
      const select = document.getElementById('categoryFilter');
      select.innerHTML = '<option value="">Alle Kategorien</option>' + 
        categories.map(cat => `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`).join('');
    }

    function selectCategory(categoryId) {
      // Remove previous selection
      document.querySelectorAll('.category-pill').forEach(pill => {
        pill.classList.remove('selected');
      });
      
      // Add selection to clicked pill
      document.querySelector(`[data-category-id="${categoryId}"]`).classList.add('selected');
      
      selectedCategoryId = categoryId;
      document.getElementById('selectedCategoryId').value = categoryId;
    }

    async function loadSuggestions() {
      try {
        const statusFilter = document.getElementById('statusFilter').value;
        const categoryFilter = document.getElementById('categoryFilter').value;
        
        let url = '/api/kvp/suggestions?';
        if (statusFilter) url += `status=${statusFilter}&`;
        if (categoryFilter) url += `category_id=${categoryFilter}&`;
        
        const response = await apiCall(url);
        const data = await response.json();
        
        if (data.success) {
          renderSuggestions(data.data);
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        console.error('Error loading suggestions:', error);
        document.getElementById('suggestionsList').innerHTML = 
          '<div class="error-message">Fehler beim Laden der Vorschläge</div>';
      }
    }

    function renderSuggestions(suggestions) {
      const container = document.getElementById('suggestionsList');
      
      if (suggestions.length === 0) {
        container.innerHTML = '<div class="empty-state">Keine Vorschläge gefunden</div>';
        return;
      }
      
      const isAdmin = currentUser && (currentUser.role === 'admin' || currentUser.role === 'root');
      
      container.innerHTML = suggestions.map(suggestion => `
        <div class="suggestion-item" data-suggestion-id="${suggestion.id}" style="cursor: pointer;">
          <div class="suggestion-header">
            <div class="suggestion-title">${suggestion.title}</div>
            <div style="display: flex; gap: 8px; align-items: center;">
              <span class="status-badge status-${suggestion.status}">${getStatusText(suggestion.status)}</span>
              ${isAdmin ? `
                <select class="filter-select status-select" data-suggestion-id="${suggestion.id}" style="padding: 4px 8px; font-size: 0.8rem;">
                  <option value="new" ${suggestion.status === 'new' ? 'selected' : ''}>Neu</option>
                  <option value="in_review" ${suggestion.status === 'in_review' ? 'selected' : ''}>In Prüfung</option>
                  <option value="approved" ${suggestion.status === 'approved' ? 'selected' : ''}>Genehmigt</option>
                  <option value="implemented" ${suggestion.status === 'implemented' ? 'selected' : ''}>Umgesetzt</option>
                  <option value="rejected" ${suggestion.status === 'rejected' ? 'selected' : ''}>Abgelehnt</option>
                  <option value="archived" ${suggestion.status === 'archived' ? 'selected' : ''}>Archiviert</option>
                </select>
              ` : ''}
            </div>
          </div>
          <div class="suggestion-description">
            ${suggestion.description.length > 150 ? suggestion.description.substring(0, 150) + '...' : suggestion.description}
          </div>
          <div class="suggestion-meta">
            ${suggestion.category_name ? `<span>${suggestion.category_icon} ${suggestion.category_name}</span>` : ''}
            <span>Von: ${suggestion.submitted_by_name} ${suggestion.submitted_by_lastname}</span>
            <span>${formatDate(suggestion.created_at)}</span>
            <span>${suggestion.attachment_count} Dateien</span>
            <span>${suggestion.comment_count} Kommentare</span>
            ${suggestion.avg_rating ? `<span>⭐ ${parseFloat(suggestion.avg_rating).toFixed(1)}</span>` : ''}
          </div>
        </div>
      `).join('');
      
      // Add event listeners to status selects for admins
      if (isAdmin) {
        container.querySelectorAll('.status-select').forEach(select => {
          select.addEventListener('change', function(e) {
            e.stopPropagation();
            const suggestionId = parseInt(this.dataset.suggestionId);
            changeStatus(suggestionId, this.value);
          });
          
          select.addEventListener('click', function(e) {
            e.stopPropagation();
          });
        });
      }
      
      // Add click event listeners to suggestion items for detail view
      container.querySelectorAll('.suggestion-item').forEach(item => {
        item.addEventListener('click', function(e) {
          // Don't trigger if clicking on status select
          if (e.target.classList.contains('status-select')) {
            return;
          }
          const suggestionId = parseInt(this.dataset.suggestionId);
          viewSuggestion(suggestionId);
        });
      });
    }

    async function changeStatus(suggestionId, newStatus) {
      try {
        const response = await apiCall(`/api/kvp/suggestions/${suggestionId}/status`, {
          method: 'PUT',
          body: JSON.stringify({ 
            status: newStatus,
            reason: `Status geändert zu ${getStatusText(newStatus)}`
          })
        });

        const data = await response.json();
        
        if (data.success) {
          showSuccessMessage('Status erfolgreich geändert');
          loadSuggestions();
          loadDashboardStats();
          if (currentUser.role === 'admin' || currentUser.role === 'root') {
            loadAdminStats();
          }
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        console.error('Error changing status:', error);
        showErrorMessage('Fehler beim Ändern des Status: ' + error.message);
        loadSuggestions(); // Reload to reset the dropdown
      }
    }

    async function loadDashboardStats() {
      if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'root')) {
        try {
          const response = await apiCall('/api/kvp/dashboard');
          const data = await response.json();
          
          if (data.success) {
            const stats = data.data;
            document.getElementById('totalSuggestions').textContent = stats.total_suggestions || 0;
            document.getElementById('newSuggestions').textContent = stats.new_suggestions || 0;
            document.getElementById('implementedSuggestions').textContent = stats.implemented || 0;
            document.getElementById('inProgressSuggestions').textContent = stats.in_progress || 0;
          }
        } catch (error) {
          console.error('Error loading dashboard stats:', error);
        }
      } else {
        // Hide admin stats for employees
        document.getElementById('totalSuggestions').textContent = '👥';
        document.getElementById('newSuggestions').textContent = '👀';
        document.getElementById('implementedSuggestions').textContent = '✅';
        document.getElementById('inProgressSuggestions').textContent = '🔧';
      }
    }

    async function loadUserPoints() {
      try {
        const response = await apiCall('/api/kvp/my-points');
        const data = await response.json();
        
        if (data.success) {
          const points = data.data;
          document.getElementById('totalPoints').textContent = points.total_points || 0;
          document.getElementById('totalAwards').textContent = points.total_awards || 0;
        }
      } catch (error) {
        console.error('Error loading user points:', error);
      }
    }

    function openNewSuggestionModal() {
      document.getElementById('newSuggestionModal').style.display = 'flex';
    }

    function closeNewSuggestionModal() {
      document.getElementById('newSuggestionModal').style.display = 'none';
      document.getElementById('newSuggestionForm').reset();
      selectedCategoryId = null;
      document.querySelectorAll('.category-pill').forEach(pill => {
        pill.classList.remove('selected');
      });
      document.getElementById('selectedFiles').innerHTML = '';
    }

    // Handle file selection
    document.getElementById('attachments').addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      const container = document.getElementById('selectedFiles');
      
      container.innerHTML = files.map(file => `
        <div class="selected-file">
          <span>📎</span>
          <span>${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)</span>
        </div>
      `).join('');
    });

    // Handle form submission
    document.getElementById('newSuggestionForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      formData.set('org_id', '1'); // Default org ID for now
      
      if (selectedCategoryId) {
        formData.set('category_id', selectedCategoryId);
      }
      
      try {
        const submitButton = document.querySelector('button[form="newSuggestionForm"][type="submit"]');
        if (submitButton) {
          submitButton.textContent = 'Wird eingereicht...';
          submitButton.disabled = true;
        }
        
        const response = await apiCall('/api/kvp/suggestions', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
          closeNewSuggestionModal();
          showSuccessMessage('Verbesserungsvorschlag erfolgreich eingereicht!');
          loadSuggestions();
          loadDashboardStats();
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        console.error('Error submitting suggestion:', error);
        showErrorMessage('Fehler beim Einreichen des Vorschlags: ' + error.message);
      } finally {
        const submitButton = document.querySelector('button[form="newSuggestionForm"][type="submit"]');
        if (submitButton) {
          submitButton.textContent = 'Vorschlag einreichen';
          submitButton.disabled = false;
        }
      }
    });

    async function viewSuggestion(id) {
      try {
        const response = await apiCall(`/api/kvp/suggestions/${id}`);
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.message || 'Fehler beim Laden des Vorschlags');
        }
        
        const suggestion = data.data;
        showSuggestionModal(suggestion);
      } catch (error) {
        console.error('Error loading suggestion:', error);
        showErrorMessage('Fehler beim Laden der Vorschlag-Details: ' + error.message);
      }
    }
    
    function showSuggestionModal(suggestion) {
      const modal = document.createElement('div');
      modal.className = 'suggestion-modal';
      modal.innerHTML = `
        <div class="modal-backdrop"></div>
        <div class="modal-content">
          <div class="modal-header">
            <h2>${suggestion.title}</h2>
            <button class="modal-close">✕</button>
          </div>
          <div class="modal-body">
            <div class="suggestion-detail-content">
              <div class="suggestion-info">
                <div class="info-row">
                  <strong>Status:</strong> 
                  <span class="status-badge status-${suggestion.status}">${getStatusText(suggestion.status)}</span>
                </div>
                <div class="info-row">
                  <strong>Kategorie:</strong> 
                  ${suggestion.category_name ? `${suggestion.category_icon} ${suggestion.category_name}` : 'Keine Kategorie'}
                </div>
                <div class="info-row">
                  <strong>Eingereicht von:</strong> 
                  ${suggestion.submitted_by_name} ${suggestion.submitted_by_lastname}
                </div>
                <div class="info-row">
                  <strong>Datum:</strong> 
                  ${formatDate(suggestion.created_at)}
                </div>
                <div class="info-row">
                  <strong>Priorität:</strong> 
                  <span class="priority-badge priority-${suggestion.priority}">${getPriorityText(suggestion.priority)}</span>
                </div>
              </div>
              
              <div class="suggestion-actions">
                ${currentUser && suggestion.submitted_by === currentUser.id ? `
                  <button class="action-btn delete-btn" data-suggestion-id="${suggestion.id}">
                    🗑️ Vorschlag löschen
                  </button>
                ` : ''}
                ${currentUser && (currentUser.role === 'admin' || currentUser.role === 'root') ? `
                  <button class="action-btn archive-btn" data-suggestion-id="${suggestion.id}">
                    📦 Archivieren
                  </button>
                ` : ''}
              </div>
              
              <div class="suggestion-description-full">
                <h3>Beschreibung</h3>
                <p>${suggestion.description}</p>
              </div>
              
              ${suggestion.expected_benefit ? `
                <div class="suggestion-benefit">
                  <h3>Erwarteter Nutzen</h3>
                  <p>${suggestion.expected_benefit}</p>
                </div>
              ` : ''}
              
              ${suggestion.estimated_cost ? `
                <div class="suggestion-cost">
                  <h3>Geschätzte Kosten</h3>
                  <p>${suggestion.estimated_cost}</p>
                </div>
              ` : ''}
              
              ${suggestion.attachments && suggestion.attachments.length > 0 ? `
                <div class="suggestion-attachments">
                  <h3>Anhänge (${suggestion.attachments.length})</h3>
                  <div class="attachments-grid">
                    ${suggestion.attachments.map(attachment => `
                      <div class="attachment-item" data-attachment-id="${attachment.id}">
                        ${attachment.file_type.startsWith('image/') ? `
                          <div class="attachment-image-container">
                            <div class="attachment-image-loader">📷 Lade Bild...</div>
                          </div>
                        ` : `
                          <div class="attachment-file">
                            <span class="file-icon">📄</span>
                            <span class="file-name">${attachment.filename}</span>
                          </div>
                        `}
                        <div class="attachment-info">
                          <small>${attachment.filename}</small>
                          <button class="download-btn" data-attachment-id="${attachment.id}">
                            Herunterladen
                          </button>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
              
              ${suggestion.comments && suggestion.comments.length > 0 ? `
                <div class="suggestion-comments">
                  <h3>Kommentare (${suggestion.comments.length})</h3>
                  <div class="comments-list">
                    ${suggestion.comments.map(comment => `
                      <div class="comment-item">
                        <div class="comment-header">
                          <strong>${comment.author_name} ${comment.author_lastname}</strong>
                          <small>${formatDate(comment.created_at)}</small>
                        </div>
                        <div class="comment-content">${comment.content}</div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Event listeners
      modal.querySelector('.modal-close').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      modal.querySelector('.modal-backdrop').addEventListener('click', () => {
        document.body.removeChild(modal);
      });
      
      // Action button event listeners
      const deleteBtn = modal.querySelector('.delete-btn');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', async () => {
          if (confirm('Sind Sie sicher, dass Sie diesen Vorschlag löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden.')) {
            const suggestionId = parseInt(deleteBtn.dataset.suggestionId);
            await deleteSuggestion(suggestionId);
            document.body.removeChild(modal);
          }
        });
      }
      
      const archiveBtn = modal.querySelector('.archive-btn');
      if (archiveBtn) {
        archiveBtn.addEventListener('click', async () => {
          if (confirm('Sind Sie sicher, dass Sie diesen Vorschlag archivieren möchten?')) {
            const suggestionId = parseInt(archiveBtn.dataset.suggestionId);
            await archiveSuggestion(suggestionId);
            document.body.removeChild(modal);
          }
        });
      }
      
      // Download button event listeners
      modal.querySelectorAll('.download-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const attachmentId = btn.dataset.attachmentId;
          await downloadAttachment(attachmentId);
        });
      });
      
      // Load images asynchronously with authentication
      modal.querySelectorAll('.attachment-image-container').forEach((container) => {
        const attachmentId = container.closest('.attachment-item').dataset.attachmentId;
        loadAttachmentImage(container, attachmentId);
      });
      
      // Escape key to close
      const escapeHandler = (e) => {
        if (e.key === 'Escape') {
          document.body.removeChild(modal);
          document.removeEventListener('keydown', escapeHandler);
        }
      };
      document.addEventListener('keydown', escapeHandler);
    }
    
    function getPriorityText(priority) {
      const priorityMap = {
        'niedrig': 'Niedrig',
        'normal': 'Normal', 
        'hoch': 'Hoch',
        'kritisch': 'Kritisch'
      };
      return priorityMap[priority] || priority;
    }

    function getStatusText(status) {
      const statusMap = {
        'new': 'Neu',
        'pending': 'Wartend',
        'in_review': 'In Prüfung',
        'approved': 'Genehmigt',
        'implemented': 'Umgesetzt',
        'rejected': 'Abgelehnt',
        'archived': 'Archiviert'
      };
      return statusMap[status] || status;
    }

    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('de-DE');
    }

    // Delete suggestion function (only for owners)
    async function deleteSuggestion(suggestionId) {
      try {
        const response = await apiCall(`/api/kvp/suggestions/${suggestionId}`, {
          method: 'DELETE'
        });

        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.message || 'Fehler beim Löschen des Vorschlags');
        }
        
        showSuccessMessage('Vorschlag wurde erfolgreich gelöscht');
        await loadSuggestions(); // Reload the list
        
      } catch (error) {
        console.error('Error deleting suggestion:', error);
        showErrorMessage('Fehler beim Löschen des Vorschlags: ' + error.message);
      }
    }

    // Archive suggestion function (for admins)
    async function archiveSuggestion(suggestionId) {
      try {
        const response = await apiCall(`/api/kvp/suggestions/${suggestionId}/status`, {
          method: 'PUT',
          body: JSON.stringify({ 
            status: 'archived',
            reason: 'Vorschlag archiviert'
          })
        });

        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.message || 'Fehler beim Archivieren des Vorschlags');
        }
        
        showSuccessMessage('Vorschlag wurde erfolgreich archiviert');
        await loadSuggestions(); // Reload the list
        
      } catch (error) {
        console.error('Error archiving suggestion:', error);
        showErrorMessage('Fehler beim Archivieren des Vorschlags: ' + error.message);
      }
    }

    // Load attachment image with authentication
    async function loadAttachmentImage(container, attachmentId) {
      try {
        const response = await apiCall(`/api/kvp/attachments/${attachmentId}/download`);
        
        if (!response.ok) {
          throw new Error('Fehler beim Laden des Bildes');
        }
        
        const blob = await response.blob();
        const imageUrl = URL.createObjectURL(blob);
        
        const img = document.createElement('img');
        img.src = imageUrl;
        img.alt = 'Anhang';
        img.className = 'attachment-image';
        img.style.cursor = 'pointer';
        
        // Add click handler for full-size view
        img.addEventListener('click', () => {
          showImageModal(imageUrl);
        });
        
        container.innerHTML = '';
        container.appendChild(img);
        
      } catch (error) {
        console.error('Error loading image:', error);
        container.innerHTML = '<div class="attachment-error">❌ Bild konnte nicht geladen werden</div>';
      }
    }

    // Download attachment function
    async function downloadAttachment(attachmentId) {
      try {
        const response = await apiCall(`/api/kvp/attachments/${attachmentId}/download`);
        
        if (!response.ok) {
          throw new Error('Fehler beim Download');
        }
        
        const blob = await response.blob();
        const contentDisposition = response.headers.get('content-disposition');
        let filename = 'download';
        
        if (contentDisposition) {
          const filenameMatch = contentDisposition.match(/filename="(.+)"/);
          if (filenameMatch) {
            filename = filenameMatch[1];
          }
        }
        
        // Create download link and trigger download
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
      } catch (error) {
        console.error('Error downloading attachment:', error);
        showErrorMessage('Fehler beim Download: ' + error.message);
      }
    }

    // Show image in full-size modal
    function showImageModal(imageUrl) {
      const modal = document.createElement('div');
      modal.className = 'image-modal';
      modal.innerHTML = `
        <div class="image-modal-backdrop"></div>
        <div class="image-modal-content">
          <button class="image-modal-close">✕</button>
          <img src="${imageUrl}" alt="Vollbild" class="full-size-image">
        </div>
      `;
      
      document.body.appendChild(modal);
      
      modal.querySelector('.image-modal-close').addEventListener('click', () => {
        document.body.removeChild(modal);
        URL.revokeObjectURL(imageUrl);
      });
      
      modal.querySelector('.image-modal-backdrop').addEventListener('click', () => {
        document.body.removeChild(modal);
        URL.revokeObjectURL(imageUrl);
      });
    }

    function showSuccessMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'success-message';
      messageDiv.textContent = message;
      document.querySelector('.main-content').prepend(messageDiv);
      
      setTimeout(() => messageDiv.remove(), 5000);
    }

    function showErrorMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'error-message';
      messageDiv.textContent = message;
      document.querySelector('.main-content').prepend(messageDiv);
      
      setTimeout(() => messageDiv.remove(), 5000);
    }

    // Close modal when clicking outside
    window.addEventListener('click', function(e) {
      const modal = document.getElementById('newSuggestionModal');
      if (e.target === modal) {
        closeNewSuggestionModal();
      }
    });
  </script>
  
  <!-- Unified Navigation -->
  <script src="/js/components/unified-navigation.js"></script>
    <!-- Header User Info Loading -->
    <script src="/js/header-user-info.js"></script>
</body>
</html>