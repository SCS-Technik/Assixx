<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Assixx</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/dashboard-theme.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <a href="/admin-dashboard.html" class="logo-container">
            <img src="/images/logo.png" alt="Assixx Logo" class="logo" style="height: 40px; width: auto; filter: none;">
        </a>
        <div class="header-actions">
            <span id="user-info" class="text-secondary">Admin</span>
            <button id="logout-btn" class="btn btn-secondary">Ausloggen</button>
        </div>
    </header>

    <!-- Main Layout with Sidebar -->
    <div class="layout-container">
        <!-- Unified Sidebar Navigation -->
        <aside class="sidebar">
            <!-- Navigation wird durch unified-navigation.js injiziert -->
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="content-section">
                <h1 class="text-center mb-4">Admin Dashboard</h1>
        
        <!-- Dashboard Stats Grid -->
        <div class="dashboard-grid">
            <div class="stat-card">
                <div class="stat-value" id="employee-count">0</div>
                <div class="stat-label">Mitarbeiter</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="document-count">0</div>
                <div class="stat-label">Dokumente</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="department-count">0</div>
                <div class="stat-label">Abteilungen</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="team-count">0</div>
                <div class="stat-label">Teams</div>
            </div>
        </div>

        <!-- Main Grid Container -->
        <div class="admin-grid">
            <!-- Employee Card -->
            <div class="card compact-card">
                <div class="card-header">
                    <h2 class="card-title">Mitarbeiter</h2>
                </div>
                <div class="compact-content">
                    <button class="btn btn-primary btn-block mb-3" id="new-employee-button" onclick="showEmployeeModal()">Neuer Mitarbeiter</button>
                    <div class="compact-list" id="recent-employees">
                        <!-- Wird dynamisch gefüllt: Letzte 5 Mitarbeiter -->
                    </div>
                    <a href="#" class="view-all-link" id="manage-employees-link">Verwalten →</a>
                </div>
            </div>

            <!-- Document Card -->
            <div class="card compact-card">
                <div class="card-header">
                    <h2 class="card-title">Dokumente</h2>
                </div>
                <div class="compact-content">
                    <a href="/document-upload.html" class="btn btn-primary btn-block mb-3">Dokument hochladen</a>
                    <div class="compact-list" id="recent-documents">
                        <!-- Wird dynamisch gefüllt: Letzte 5 Dokumente -->
                    </div>
                    <a href="#" class="view-all-link" id="manage-documents-link">Verwalten →</a>
                </div>
            </div>

            <!-- Department Card -->
            <div class="card compact-card">
                <div class="card-header">
                    <h2 class="card-title">Abteilungen</h2>
                </div>
                <div class="compact-content">
                    <button class="btn btn-primary btn-block mb-3" onclick="showDepartmentModal()">Neue Abteilung</button>
                    <div class="compact-list" id="department-list">
                        <!-- Wird dynamisch gefüllt -->
                    </div>
                    <a href="#" class="view-all-link" id="manage-departments-link">Verwalten →</a>
                </div>
            </div>

            <!-- Team Card -->
            <div class="card compact-card">
                <div class="card-header">
                    <h2 class="card-title">Teams</h2>
                </div>
                <div class="compact-content">
                    <button class="btn btn-primary btn-block mb-3" onclick="showTeamModal()">Neues Team</button>
                    <div class="compact-list" id="team-list">
                        <!-- Wird dynamisch gefüllt -->
                    </div>
                    <a href="#" class="view-all-link" onclick="showAllTeams()">Verwalten →</a>
                </div>
            </div>

            <!-- Kalender Card -->
            <div class="card compact-card">
                <div class="card-header">
                    <h2 class="card-title">Kalender</h2>
                </div>
                <div class="compact-content">
                    <a href="/calendar.html" class="btn btn-primary btn-block mb-3">Kalender öffnen</a>
                    <div class="compact-list" id="calendar-events-list">
                        <!-- Wird dynamisch gefüllt -->
                        <div class="list-item">
                            <div class="list-item-content">
                                <strong>Nächste Termine</strong>
                                <p class="text-secondary">Keine anstehenden Termine</p>
                            </div>
                        </div>
                    </div>
                    <a href="/calendar.html" class="view-all-link">Alle anzeigen →</a>
                </div>
            </div>
        </div>

        <!-- Recently Added Section -->
        <div class="card mt-4">
            <div class="card-header">
                <h2 class="card-title">Kürzlich hinzugefügt</h2>
            </div>
            <div class="recent-activity-grid">
                <div class="recent-section">
                    <h3>Neue Mitarbeiter</h3>
                    <ul id="recent-employees-list" class="recent-list">
                        <!-- Wird dynamisch gefüllt -->
                    </ul>
                </div>
                <div class="recent-section">
                    <h3>Neue Dokumente</h3>
                    <ul id="recent-documents-list" class="recent-list">
                        <!-- Wird dynamisch gefüllt -->
                    </ul>
                </div>
                <div class="recent-section">
                    <h3>Aktivitäten</h3>
                    <ul id="recent-activities-list" class="recent-list">
                        <!-- Wird dynamisch gefüllt -->
                    </ul>
                </div>
            </div>
        </div>
            </section>

            <!-- Payslips Section -->
            <section id="payslips-section" class="content-section" style="display: none;">
                <h1>Gehaltsabrechnungen</h1>
                <div class="card mb-4">
                    <div class="card-header">
                        <h2 class="card-title">Gehaltsabrechnung hochladen</h2>
                    </div>
                    <form id="payslip-upload-form" enctype="multipart/form-data">
                        <div class="form-group">
                            <label class="form-label">Mitarbeiter auswählen</label>
                            <select name="employeeId" id="payslip-employee-select" class="form-control" required>
                                <option value="">Bitte wählen...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monat</label>
                            <input type="month" name="month" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Datei auswählen (PDF)</label>
                            <input type="file" name="file" class="form-control" accept="application/pdf" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Beschreibung</label>
                            <textarea name="description" class="form-control" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Gehaltsabrechnung hochladen</button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Aktuelle Gehaltsabrechnungen</h2>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Mitarbeiter</th>
                                    <th>Monat</th>
                                    <th>Hochgeladen am</th>
                                    <th>Datei</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="payslips-table-body">
                                <!-- Wird dynamisch gefüllt -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Employees Section -->
            <section id="employees-section" class="content-section" style="display: none;">
                <h1>Mitarbeiterverwaltung</h1>
                <button class="btn btn-primary mb-3" id="employees-section-new-button" onclick="showEmployeeModal()">Neuer Mitarbeiter</button>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Mitarbeiterübersicht</h2>
                    </div>
                    <div class="flex-between mb-3">
                        <div class="filter-buttons">
                            <button id="show-all-employees" class="btn btn-sm btn-primary">Alle anzeigen</button>
                            <button id="filter-employees-active" class="btn btn-sm btn-secondary">Aktive anzeigen</button>
                            <button id="filter-employees-inactive" class="btn btn-sm btn-secondary">Inaktive anzeigen</button>
                        </div>
                        <div class="search-container">
                            <input type="text" id="employee-search" class="search-input" placeholder="Name, E-Mail oder Position...">
                            <button id="employee-search-btn" class="btn btn-secondary">Suchen</button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>E-Mail</th>
                                    <th>Mitarbeiter-ID</th>
                                    <th>Position</th>
                                    <th>Abteilung</th>
                                    <th>Status</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="employees-table-body">
                                <!-- Wird dynamisch gefüllt -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Documents Section -->
            <section id="documents-section" class="content-section" style="display: none;">
                <h1>Dokumentenverwaltung</h1>
                <div class="flex-between mb-3">
                    <a href="/document-upload.html" class="btn btn-primary">Dokument hochladen</a>
                    <div class="search-container">
                        <input type="text" id="document-search" class="search-input" placeholder="Dokumentname, Mitarbeiter oder Kategorie...">
                        <button id="document-search-btn" class="btn btn-secondary">Suchen</button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <button id="show-all-documents" class="btn btn-sm btn-secondary">Alle anzeigen</button>
                    <button id="filter-documents-archived" class="btn btn-sm btn-secondary">Archivierte anzeigen</button>
                    <button id="filter-documents-active" class="btn btn-sm btn-secondary">Aktive anzeigen</button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Dokumentenübersicht</h2>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Dateiname</th>
                                    <th>Mitarbeiter</th>
                                    <th>Kategorie</th>
                                    <th>Hochgeladen am</th>
                                    <th>Status</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="documents-table-body">
                                <!-- Wird dynamisch gefüllt -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Departments Section -->
            <section id="departments-section" class="content-section" style="display: none;">
                <h1>Abteilungsverwaltung</h1>
                <button class="btn btn-primary mb-3" id="direct-department-button">Neue Abteilung</button>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Abteilungsübersicht</h2>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Beschreibung</th>
                                    <th>Status</th>
                                    <th>Sichtbarkeit</th>
                                    <th>Manager</th>
                                    <th>Mitarbeiter</th>
                                    <th>Teams</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="departments-table-body">
                                <!-- Wird dynamisch gefüllt -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Teams Section -->
            <section id="teams-section" class="content-section" style="display: none;">
                <h1>Teamverwaltung</h1>
                <button class="btn btn-primary mb-3" onclick="showTeamModal()">Neues Team</button>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Teamübersicht</h2>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Abteilung</th>
                                    <th>Beschreibung</th>
                                    <th>Mitglieder</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody id="teams-table-body">
                                <!-- Wird dynamisch gefüllt -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings-section" class="content-section" style="display: none;">
                <h1>Einstellungen</h1>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">System-Einstellungen</h2>
                    </div>
                    <p>Einstellungen werden hier implementiert...</p>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- Department Modal -->
    <div id="department-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Neue Abteilung</h3>
                <button class="modal-close" onclick="hideModal('department-modal')">&times;</button>
            </div>
            <form id="department-form">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" name="name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Beschreibung</label>
                    <textarea name="description" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-control">
                        <option value="active" selected>Aktiv</option>
                        <option value="inactive">Inaktiv</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Sichtbarkeit</label>
                    <select name="visibility" class="form-control">
                        <option value="public" selected>Öffentlich</option>
                        <option value="private">Privat</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Abteilung erstellen</button>
            </form>
        </div>
    </div>

    <!-- Team Modal -->
    <div id="team-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Neues Team</h3>
                <button class="modal-close" onclick="hideTeamModal()">&times;</button>
            </div>
            <form id="team-form">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" name="name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Beschreibung</label>
                    <textarea name="description" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Abteilung</label>
                    <select name="department_id" class="form-control">
                        <option value="">Keine Abteilung</option>
                        <!-- Wird dynamisch gefüllt -->
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Team erstellen</button>
            </form>
        </div>
    </div>

    <!-- Employee Modal -->
    <div id="employee-modal" class="modal" style="display: none;" data-debug="employee-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Neuer Mitarbeiter</h3>
                <button class="modal-close" id="close-employee-modal">&times;</button>
            </div>
            <form id="create-employee-form">
                <div class="form-group">
                    <label class="form-label">Benutzername</label>
                    <input type="text" name="username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">E-Mail</label>
                    <input type="email" name="email" id="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">E-Mail bestätigen</label>
                    <input type="email" name="email_confirm" id="email_confirm" class="form-control" required>
                    <small id="email-error" class="error-message" style="color: red; display: none;">Die E-Mail-Adressen stimmen nicht überein</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort</label>
                    <input type="password" name="password" id="password" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Passwort bestätigen</label>
                    <input type="password" name="password_confirm" id="password_confirm" class="form-control" required>
                    <small id="password-error" class="error-message" style="color: red; display: none;">Die Passwörter stimmen nicht überein</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Vorname</label>
                    <input type="text" name="first_name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Nachname</label>
                    <input type="text" name="last_name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Alter</label>
                    <input type="number" name="age" class="form-control" min="18" max="100" required>
                </div>
                <!-- Mitarbeiter-ID wird automatisch generiert -->
                <!-- IBAN-Feld wurde entfernt -->
                <div class="form-group">
                    <label class="form-label">Position</label>
                    <input type="text" name="position" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Abteilung</label>
                    <select name="department_id" class="form-control" id="employee-department-select">
                        <option value="">Keine Abteilung</option>
                        <!-- Wird dynamisch gefüllt -->
                    </select>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Mitarbeiter erstellen</button>
                    <button type="button" class="btn btn-secondary" id="cancel-employee-button">Abbrechen</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Document Modal -->
    <div id="document-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Dokument hochladen</h3>
                <button class="modal-close" onclick="hideModal('document-modal')">&times;</button>
            </div>
            <form id="document-upload-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label class="form-label">Mitarbeiter auswählen</label>
                    <select name="employeeId" id="upload-employee-select" class="form-control" required>
                        <option value="">Bitte wählen...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Dokumenttyp</label>
                    <select name="category" class="form-control">
                        <option value="payslip">Lohnabrechnung</option>
                        <option value="contract">Vertrag</option>
                        <option value="certificate">Bescheinigung</option>
                        <option value="other">Sonstiges</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Datei auswählen</label>
                    <input type="file" name="document" class="form-control" accept="application/pdf" required>
                </div>
                <button type="submit" class="btn btn-primary">Dokument hochladen</button>
            </form>
        </div>
    </div>

    <!-- Department Modal ist bereits weiter oben definiert -->
    <!-- Team Modal ist bereits weiter oben definiert -->

    <!-- Modal Styles -->
    <style>
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--background-light);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .table-row-inactive {
            background-color: rgba(255, 165, 0, 0.1);
        }
        
        .table-row-archived {
            background-color: rgba(128, 128, 128, 0.1);
        }

        .modal form {
            padding: var(--spacing-lg);
        }
    </style>

    <!-- JavaScript -->
    <!-- Verhindert mehrfache Bestätigungsdialoge -->
    <script src="/js/confirm-once.js"></script>
    
    <script>
        console.log('Admin dashboard HTML loaded');
        
        // Globale Modal-Funktionen direkt definieren
        window.showModal = function(modalId) {
            console.log('showModal called with:', modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                console.log('Modal element found, showing it');
                modal.style.display = 'flex';
            } else {
                console.error('Modal element not found:', modalId);
            }
        }
        
        window.hideModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            } else {
                console.error('Modal element not found:', modalId);
            }
        }
    </script>
    <!-- Unified Navigation -->
    <script src="/js/components/unified-navigation.js"></script>
    <script src="/js/show-section.js"></script>
    <script src="/js/admin-dashboard.js"></script>
    <script src="/js/dashboard-fix.js"></script>
    <script src="/js/debug-employee-button.js"></script>
    <script src="/js/modal-debug.js"></script>
    <script src="/js/employee-modal-fix.js"></script>
    <script src="/js/dashboard-navigation-fix.js"></script>
    <script src="/js/employee-action-debug.js"></script>
    <script src="/js/employee-table-fix.js"></script>
    <script src="/js/document-table-fix.js"></script>
    <script src="/js/employee-deletion.js"></script>
    <script>
        // Direkte Event-Listener hinzufügen
        console.log('Adding direct event listeners');
        document.addEventListener('DOMContentLoaded', () => {
            // Event-Listener für das Schließen des Mitarbeiter-Modals
            const closeEmployeeModalBtn = document.getElementById('close-employee-modal');
            const cancelEmployeeBtn = document.getElementById('cancel-employee-button');
            const employeeModal = document.getElementById('employee-modal');
            
            if (closeEmployeeModalBtn && employeeModal) {
                console.log('Close employee modal button found, adding event listener');
                closeEmployeeModalBtn.addEventListener('click', function() {
                    console.log('Close button clicked, hiding employee modal');
                    employeeModal.style.display = 'none';
                });
            }
            
            if (cancelEmployeeBtn && employeeModal) {
                console.log('Cancel employee button found, adding event listener');
                cancelEmployeeBtn.addEventListener('click', function() {
                    console.log('Cancel button clicked, hiding employee modal');
                    employeeModal.style.display = 'none';
                });
            }
            
            // Schließen des Modals beim Klick außerhalb
            employeeModal?.addEventListener('click', function(event) {
                if (event.target === employeeModal) {
                    console.log('Clicked outside modal content, hiding employee modal');
                    employeeModal.style.display = 'none';
                }
            });
            console.log('DOM loaded, setting up debugging handlers');
            
            // Debug-Funktionen für alle Buttons
            document.querySelectorAll('button').forEach(button => {
                console.log('Found button:', button.textContent || button.innerHTML);
                button.addEventListener('click', function(e) {
                    console.log('Button clicked:', this.textContent || this.innerHTML);
                });
            });
            
            // Spezieller Listener für den Dokument-Upload-Button
            const docUploadBtn = document.querySelector('button[onclick="showDocumentModal()"]');
            if (docUploadBtn) {
                console.log('Dokument Upload Button gefunden');
                docUploadBtn.addEventListener('click', function(e) {
                    console.log('Dokument Upload Button geklickt');
                    e.preventDefault();
                    e.stopPropagation();
                    // Navigiere direkt zur Upload-Seite
                    window.location.href = '/document-upload.html';
                });
            } else {
                console.error('Dokument Upload Button NICHT gefunden');
            }
            
            // Direkter Link für Sidebar-Links
            document.querySelectorAll('.sidebar-link').forEach(link => {
                console.log('Found sidebar link:', link.textContent);
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    console.log('Sidebar link clicked:', href);
                    
                    if (href === '#departments') {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Showing departments section');
                        document.querySelectorAll('.content-section').forEach(section => {
                            section.style.display = 'none';
                        });
                        document.getElementById('departments-section').style.display = 'block';
                        
                        // Update active state
                        document.querySelectorAll('.sidebar-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        this.parentElement.classList.add('active');
                    }
                });
            });
            
            // Direkter Listener für den Abteilungs-Button
            const departmentBtn = document.getElementById('direct-department-button');
            if (departmentBtn) {
                console.log("Department button found");
                departmentBtn.addEventListener('click', function() {
                    console.log("Department button clicked");
                    const deptModal = document.getElementById('department-modal');
                    if (deptModal) {
                        console.log("Department modal found, displaying it");
                        deptModal.style.display = 'flex';
                    } else {
                        console.error("Department modal NOT found");
                        alert("Das Abteilungs-Modal konnte nicht gefunden werden.");
                    }
                });
            } else {
                console.error("Department button NOT found");
            }
            
            // Listener für "Abteilungen verwalten" Link
            const manageDepartmentsLink = document.getElementById('manage-departments-link');
            if (manageDepartmentsLink) {
                console.log("Manage departments link found");
                manageDepartmentsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log("Manage departments link clicked");
                    // Zeige die Abteilungs-Sektion an
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    document.getElementById('departments-section').style.display = 'block';
                    
                    // Update active state in sidebar
                    document.querySelectorAll('.sidebar-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Finde und aktiviere die Abteilungen-Sidebar
                    document.querySelectorAll('.sidebar-link').forEach(link => {
                        if (link.getAttribute('href') === '#departments') {
                            link.parentElement.classList.add('active');
                        }
                    });
                    
                    // Lade Abteilungstabelle
                    loadDepartmentsTable();
                });
            } else {
                console.error("Manage departments link NOT found");
            }
        });
    </script>
    <script>
        // Funktionstabelle direkt definieren
        
        // Departments-Tabelle laden
        async function loadDepartmentsTable() {
            console.log("Loading departments table");
            const token = localStorage.getItem('token');
            
            try {
                const response = await fetch('/departments', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const departments = await response.json();
                    console.log(`Loaded ${departments.length} departments`);
                    
                    const tbody = document.getElementById('departments-table-body');
                    if (tbody) {
                        tbody.innerHTML = departments.map(dept => `
                            <tr>
                                <td>${dept.name}</td>
                                <td>${dept.description || '-'}</td>
                                <td>
                                    <span class="badge ${dept.status === 'active' ? 'badge-success' : 'badge-warning'}">
                                        ${dept.status === 'active' ? 'Aktiv' : 'Inaktiv'}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge ${dept.visibility === 'public' ? 'badge-primary' : 'badge-secondary'}">
                                        ${dept.visibility === 'public' ? 'Öffentlich' : 'Privat'}
                                    </span>
                                </td>
                                <td>${dept.manager_name || '-'}</td>
                                <td>${dept.employee_count || 0}</td>
                                <td>${dept.team_count || 0}</td>
                                <td>
                                    <button class="btn btn-sm btn-warning" onclick="toggleDepartmentStatus(${dept.id}, '${dept.status}')">
                                        ${dept.status === 'active' ? 'Deaktivieren' : 'Aktivieren'}
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="editDepartment(${dept.id})">Bearbeiten</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteDepartment(${dept.id})">Löschen</button>
                                </td>
                            </tr>
                        `).join('');
                    } else {
                        console.error("Departments table body not found");
                    }
                } else {
                    console.error("Failed to load departments");
                }
            } catch (error) {
                console.error('Error loading departments table:', error);
            }
        }
        
        // Abteilung-Status wechseln
        async function toggleDepartmentStatus(departmentId, currentStatus) {
            console.log(`Toggling department ${departmentId} status from ${currentStatus}`);
            const token = localStorage.getItem("token");
            const newStatus = currentStatus === "active" ? "inactive" : "active";
            
            try {
                const response = await fetch(`/departments/${departmentId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    alert(`Abteilung wurde ${newStatus === "active" ? "aktiviert" : "deaktiviert"}`);
                    loadDepartmentsTable();
                } else {
                    const error = await response.json();
                    alert(`Fehler: ${error.message}`);
                }
            } catch (error) {
                console.error("Error toggling department status:", error);
                alert("Ein Fehler ist aufgetreten.");
            }
        }
        
        // Abteilung bearbeiten
        async function editDepartment(departmentId) {
            console.log(`Editing department ${departmentId}`);
            const token = localStorage.getItem("token");
            
            try {
                const response = await fetch(`/departments/${departmentId}`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const department = await response.json();
                    console.log("Department data:", department);
                    
                    // Erstelle ein Modal für die Bearbeitung
                    const modalHTML = `
                        <div class="modal" id="edit-department-modal" style="display: flex;">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 class="modal-title">Abteilung bearbeiten</h3>
                                    <button class="modal-close" onclick="document.getElementById('edit-department-modal').remove()">&times;</button>
                                </div>
                                <form id="edit-department-form">
                                    <div class="form-group">
                                        <label class="form-label">Name</label>
                                        <input type="text" name="name" class="form-control" value="${department.name}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Beschreibung</label>
                                        <textarea name="description" class="form-control" rows="3">${department.description || ""}</textarea>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Status</label>
                                        <select name="status" class="form-control">
                                            <option value="active" ${department.status === "active" ? "selected" : ""}>Aktiv</option>
                                            <option value="inactive" ${department.status === "inactive" ? "selected" : ""}>Inaktiv</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Sichtbarkeit</label>
                                        <select name="visibility" class="form-control">
                                            <option value="public" ${department.visibility === "public" ? "selected" : ""}>Öffentlich</option>
                                            <option value="private" ${department.visibility === "private" ? "selected" : ""}>Privat</option>
                                        </select>
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="updateDepartment(${departmentId})">Änderungen speichern</button>
                                </form>
                            </div>
                        </div>
                    `;
                    
                    // Modal zum Body hinzufügen
                    document.body.insertAdjacentHTML("beforeend", modalHTML);
                } else {
                    console.error("Failed to load department data");
                    alert("Fehler beim Laden der Abteilungsdaten.");
                }
            } catch (error) {
                console.error("Error loading department:", error);
                alert("Ein Fehler ist aufgetreten.");
            }
        }
        
        // Abteilung aktualisieren
        async function updateDepartment(departmentId) {
            console.log(`Updating department ${departmentId}`);
            const token = localStorage.getItem("token");
            const form = document.getElementById('edit-department-form');
            
            if (!form) {
                console.error("Edit department form not found");
                return;
            }
            
            const formData = new FormData(form);
            const data = {
                name: formData.get('name'),
                description: formData.get('description'),
                status: formData.get('status'),
                visibility: formData.get('visibility')
            };
            
            try {
                const response = await fetch(`/departments/${departmentId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert("Abteilung erfolgreich aktualisiert");
                    // Modal schließen
                    const modal = document.getElementById('edit-department-modal');
                    if (modal) modal.remove();
                    // Tabelle neu laden
                    loadDepartmentsTable();
                } else {
                    const error = await response.json();
                    alert(`Fehler: ${error.message}`);
                }
            } catch (error) {
                console.error("Error updating department:", error);
                alert("Ein Fehler ist aufgetreten.");
            }
        }
        
        // Abteilung löschen
        async function deleteDepartment(departmentId) {
            console.log(`Deleting department ${departmentId}`);
            if (!confirm("Sind Sie sicher, dass Sie diese Abteilung löschen möchten?")) {
                return;
            }
            
            const token = localStorage.getItem("token");
            
            try {
                const response = await fetch(`/departments/${departmentId}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert("Abteilung erfolgreich gelöscht");
                    loadDepartmentsTable();
                } else {
                    const error = await response.json();
                    alert(`Fehler: ${error.message}`);
                }
            } catch (error) {
                console.error("Error deleting department:", error);
                alert("Ein Fehler ist aufgetreten.");
            }
        }
        
        // Mitarbeiter bearbeiten
        async function editEmployee(employeeId) {
            console.log(`Editing employee ${employeeId}`);
            const token = localStorage.getItem("token");
            
            try {
                const response = await fetch(`/admin/employees/${employeeId}`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const employee = await response.json();
                    console.log("Employee data:", employee);
                    
                    // Erstelle ein Modal für die Bearbeitung
                    const modalHTML = `
                        <div class="modal" id="edit-employee-modal" style="display: flex;">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 class="modal-title">Mitarbeiter bearbeiten</h3>
                                    <button type="button" class="modal-close" onclick="document.getElementById('edit-employee-modal').remove()">&times;</button>
                                </div>
                                <form id="edit-employee-form">
                                    <div class="form-group">
                                        <label class="form-label">Benutzername</label>
                                        <input type="text" name="username" class="form-control" value="${employee.username}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">E-Mail</label>
                                        <input type="email" name="email" class="form-control" value="${employee.email}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Vorname</label>
                                        <input type="text" name="first_name" class="form-control" value="${employee.first_name}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Nachname</label>
                                        <input type="text" name="last_name" class="form-control" value="${employee.last_name}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Alter</label>
                                        <input type="number" name="age" class="form-control" min="18" max="100" value="${employee.age || ''}" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Position</label>
                                        <input type="text" name="position" class="form-control" value="${employee.position || ''}">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Abteilung</label>
                                        <select name="department_id" class="form-control" id="edit-employee-department-select">
                                            <option value="">Keine Abteilung</option>
                                            <!-- Wird dynamisch gefüllt -->
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Status</label>
                                        <select name="status" class="form-control">
                                            <option value="active" ${employee.status === 'active' ? 'selected' : ''}>Aktiv</option>
                                            <option value="inactive" ${employee.status === 'inactive' ? 'selected' : ''}>Inaktiv</option>
                                        </select>
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="updateEmployee(${employeeId})">Änderungen speichern</button>
                                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('edit-employee-modal').remove()">Abbrechen</button>
                                </form>
                            </div>
                        </div>
                    `;
                    
                    // Modal zum Body hinzufügen
                    document.body.insertAdjacentHTML("beforeend", modalHTML);
                    
                    // Lade Abteilungen für das Select-Feld
                    const departmentSelect = document.getElementById('edit-employee-department-select');
                    if (departmentSelect) {
                        // Hilfsfunktion zum Laden der Abteilungen
                        const loadDepts = async () => {
                            try {
                                const deptResponse = await fetch('/departments', {
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                
                                if (deptResponse.ok) {
                                    const departments = await deptResponse.json();
                                    departmentSelect.innerHTML = '<option value="">Keine Abteilung</option>' +
                                        departments.map(dept => `
                                            <option value="${dept.id}" ${dept.id == employee.department_id ? 'selected' : ''}>
                                                ${dept.name}
                                            </option>
                                        `).join('');
                                }
                            } catch (err) {
                                console.error('Error loading departments:', err);
                            }
                        };
                        
                        loadDepts();
                    }
                } else {
                    console.error("Failed to load employee data");
                    alert("Fehler beim Laden der Mitarbeiterdaten.");
                }
            } catch (error) {
                console.error("Error loading employee:", error);
                alert("Ein Fehler ist aufgetreten.");
            }
        }
        
        // Mitarbeiter aktualisieren
        async function updateEmployee(employeeId) {
            console.log(`Updating employee ${employeeId}`);
            const token = localStorage.getItem("token");
            const form = document.getElementById('edit-employee-form');
            
            if (!form) {
                console.error("Edit employee form not found");
                return;
            }
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Bei leerer Abteilung setzen wir null statt leeren String
            if (data.department_id === "") {
                data.department_id = null;
            }
            
            try {
                const response = await fetch(`/admin/employees/${employeeId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert("Mitarbeiter erfolgreich aktualisiert");
                    // Modal schließen
                    const modal = document.getElementById('edit-employee-modal');
                    if (modal) modal.remove();
                    // Tabelle neu laden
                    loadEmployeesTable('reload');
                } else {
                    const error = await response.json();
                    alert(`Fehler: ${error.message}`);
                }
            } catch (error) {
                console.error("Error updating employee:", error);
                alert("Ein Fehler ist aufgetreten.");
            }
        }
        
        // Mitarbeiter löschen
        async function deleteEmployee(employeeId) {
            console.log(`Deleting employee ${employeeId}`);
            if (!confirm("Sind Sie sicher, dass Sie diesen Mitarbeiter löschen möchten? Dies kann nicht rückgängig gemacht werden.")) {
                return;
            }
            
            const token = localStorage.getItem("token");
            
            try {
                const response = await fetch(`/admin/delete-employee/${employeeId}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert("Mitarbeiter erfolgreich gelöscht");
                        loadEmployeesTable('reload');
                    } else {
                        alert(`Fehler: ${result.message || 'Unbekannter Fehler'}`);
                    }
                } else {
                    alert("Fehler beim Löschen des Mitarbeiters.");
                }
            } catch (error) {
                console.error("Error deleting employee:", error);
                alert("Ein Fehler ist aufgetreten.");
            }
        }
        
        // Mitarbeiterstatus ändern
        async function toggleEmployeeStatus(employeeId, currentStatus) {
            console.log(`Toggling employee ${employeeId} status from ${currentStatus}`);
            const token = localStorage.getItem("token");
            const newStatus = currentStatus === "inactive" ? "active" : "inactive";
            
            try {
                const response = await fetch(`/admin/toggle-employee-status/${employeeId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    alert(`Mitarbeiterstatus wurde zu "${newStatus}" geändert`);
                    loadEmployeesTable('reload');
                } else {
                    const error = await response.json();
                    alert(`Fehler: ${error.message}`);
                }
            } catch (error) {
                console.error("Error toggling employee status:", error);
                alert("Ein Fehler ist aufgetreten.");
            }
        }

        // Add event listener for payslip upload form
        document.addEventListener('DOMContentLoaded', () => {
            const payslipForm = document.getElementById('payslip-upload-form');
            if (payslipForm) {
                payslipForm.addEventListener('submit', uploadPayslip);
            }
        });

        // Upload payslip function
        async function uploadPayslip(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const formData = new FormData(e.target);
            
            // Set category to payslip
            formData.append('category', 'payslip');

            try {
                const response = await fetch('/documents/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (response.ok) {
                    alert('Gehaltsabrechnung erfolgreich hochgeladen');
                    e.target.reset();
                    loadPayslipsTable();
                } else {
                    const error = await response.json();
                    alert(`Fehler: ${error.message}`);
                }
            } catch (error) {
                console.error('Fehler beim Hochladen der Gehaltsabrechnung:', error);
                alert('Ein Fehler ist aufgetreten.');
            }
        }
        // Logo und Übersicht verarbeiten
        document.addEventListener('DOMContentLoaded', () => {
            // Logo-Klick behandeln
            document.querySelector('.logo-container').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.reload();
            });
            
            // Übersicht-Link in der Seitennavigation
            const dashboardLink = document.querySelector('.sidebar-link[href="#dashboard"]');
            if (dashboardLink) {
                dashboardLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.reload();
                });
            }
            
            // Logout-Button behandeln
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    if (confirm('Möchten Sie sich wirklich abmelden?')) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('role');
                        localStorage.removeItem('username');
                        window.location.href = '/';
                    }
                });
            }
        });

        // Modal functions redefined for redundancy
        function showModal(modalId) {
            console.log('Inline showModal called with:', modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                console.log('Modal element found in inline function, showing it');
                modal.style.display = 'flex';
            } else {
                console.error('Modal element not found in inline function:', modalId);
            }
        }

        function hideModal(modalId) {
            console.log('hideModal called for:', modalId);
            const modal = document.getElementById(modalId);
            if (modal) {
                console.log('Modal element found in hideModal, hiding it');
                modal.style.display = 'none';
            } else {
                console.error('Modal element not found in hideModal:', modalId);
            }
        }

        function showEmployeeModal() {
            console.log('showEmployeeModal function called');
            const modal = document.getElementById('employee-modal');
            if (modal) {
                console.log('employee-modal found, showing directly');
                modal.style.display = 'flex';
                // Abteilungen für das Formular laden
                if (typeof loadDepartmentsForEmployeeSelect === 'function') {
                    loadDepartmentsForEmployeeSelect();
                } else {
                    console.error('loadDepartmentsForEmployeeSelect is not a function');
                }
            } else {
                console.error('employee-modal not found');
                alert('Das Mitarbeiterformular konnte nicht geöffnet werden.');
            }
        }

        function showDocumentModal() {
            console.log("Document upload modal requested");
            const modal = document.getElementById('document-modal');
            if (modal) {
                console.log("Modal found, showing it");
                modal.style.display = 'flex';
                // Mitarbeiter-Select füllen
                loadEmployeesForSelect();
            } else {
                console.error("Modal element not found!");
                alert("Dokument-Upload-Formular konnte nicht geladen werden.");
            }
        }

        function showDepartmentModal() {
            showModal('department-modal');
        }

        function showTeamModal() {
            showModal('team-modal');
            // Abteilungen für Select laden
            loadDepartmentsForSelect();
        }

        function hideTeamModal() {
            hideModal('team-modal');
        }

        // Modal schließen bei Klick außerhalb
        window.addEventListener('click', function(event) {
            const modals = ['employee-modal', 'document-modal', 'department-modal', 'team-modal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target == modal) {
                    console.log(`Clicked outside of ${modalId}, closing it`);
                    modal.style.display = 'none';
                }
            });
        });

        // Placeholder functions for "view all" links
        function showAllEmployees() {
            console.log('Show all employees');
        }

        function showAllDocuments() {
            console.log('Show all documents');
        }

        function showAllDepartments() {
            showSection('departments');
        }

        function showAllTeams() {
            console.log('Show all teams');
        }

        // Section Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show the selected section
            const selectedSection = document.getElementById(sectionName + '-section');
            if (selectedSection) {
                selectedSection.style.display = 'block';
            }
            
            // Update active state in sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the clicked item
            document.querySelectorAll('.sidebar-link').forEach(link => {
                const onclickAttr = link.getAttribute('onclick');
                const hrefAttr = link.getAttribute('href');
                
                // Check if either the onclick contains the sectionName or the href matches the section
                if ((onclickAttr && onclickAttr.includes(sectionName)) || 
                    (hrefAttr && hrefAttr === '#' + sectionName)) {
                    link.parentElement.classList.add('active');
                }
            });
            
            // Load section-specific data
            switch(sectionName) {
                case 'employees':
                    loadEmployeesTable();
                    break;
                case 'documents':
                    loadDocumentsTable();
                    break;
                case 'payslips':
                    loadPayslipsTable();
                    loadEmployeesForPayslipSelect();
                    break;
                case 'departments':
                    loadDepartmentsTable();
                    break;
                case 'teams':
                    loadTeamsTable();
                    break;
            }
        }
    </script>

    <style>
        /* Search Styles */
        .search-container {
            display: flex;
            gap: var(--spacing-sm);
            margin-left: auto;
        }
        
        .search-input {
            min-width: 300px;
            padding: var(--spacing-sm) var(--spacing-md);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background-color: var(--background-dark);
            color: var(--text-primary);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
        }
        
        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-top: 20px;
        }

        .modal-content {
            background-color: var(--background-light);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background-color: var(--background-dark);
            color: var(--error-color);
        }

        .table-responsive {
            overflow-x: auto;
            margin-top: var(--spacing-md);
        }

        .btn-group {
            display: flex;
            gap: var(--spacing-sm);
        }
        
        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .badge-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .department-list,
        .team-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .department-item,
        .team-item {
            padding: var(--spacing-sm);
            background-color: var(--background-dark);
            border-radius: var(--radius-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</body>
</html>